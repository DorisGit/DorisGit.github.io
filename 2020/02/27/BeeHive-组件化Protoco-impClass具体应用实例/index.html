<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://dorisgit.github.io').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta name="description" content="概述BeeHive是基于Spring的Service理念，可以使模块间的具体实现与接口解耦。 目前BeeHive v1.2.0 全部是利用Protocol的方式，实现了模块间解耦的目的： 1.各个模块以插件的形式存在。每个都可独立，相互解耦。 2.各个模块具体实现与接口调用分离 3.各个模块也有生命周期，也可以进行管理。 官方架构图 基本架构  各个功能模块以protocol为key，以impCl">
<meta property="og:type" content="article">
<meta property="og:title" content="BeeHive-组件化Protoco-impClass具体应用实例">
<meta property="og:url" content="https://dorisgit.github.io/2020/02/27/BeeHive-%E7%BB%84%E4%BB%B6%E5%8C%96Protoco-impClass%E5%85%B7%E4%BD%93%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B/index.html">
<meta property="og:site_name" content="泡泡茶壶">
<meta property="og:description" content="概述BeeHive是基于Spring的Service理念，可以使模块间的具体实现与接口解耦。 目前BeeHive v1.2.0 全部是利用Protocol的方式，实现了模块间解耦的目的： 1.各个模块以插件的形式存在。每个都可独立，相互解耦。 2.各个模块具体实现与接口调用分离 3.各个模块也有生命周期，也可以进行管理。 官方架构图 基本架构  各个功能模块以protocol为key，以impCl">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://q6luryr3j.bkt.clouddn.com/04.png">
<meta property="og:image" content="http://q6luryr3j.bkt.clouddn.com/01.jpeg">
<meta property="og:image" content="http://q6luryr3j.bkt.clouddn.com/image2019-12-4_15-36-40.png">
<meta property="og:image" content="http://q6luryr3j.bkt.clouddn.com/03.jpeg">
<meta property="og:image" content="http://q6luryr3j.bkt.clouddn.com/02.jpeg">
<meta property="og:image" content="http://q6luryr3j.bkt.clouddn.com/image-20200227230948167.png">
<meta property="og:image" content="http://q6luryr3j.bkt.clouddn.com/image-20200228173020182.png">
<meta property="article:published_time" content="2020-02-27T14:29:19.000Z">
<meta property="article:modified_time" content="2020-03-05T13:31:44.632Z">
<meta property="article:author" content="Doris AI">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://q6luryr3j.bkt.clouddn.com/04.png">

<link rel="canonical" href="https://dorisgit.github.io/2020/02/27/BeeHive-%E7%BB%84%E4%BB%B6%E5%8C%96Protoco-impClass%E5%85%B7%E4%BD%93%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true
  };
</script>

  <title>BeeHive-组件化Protoco-impClass具体应用实例 | 泡泡茶壶</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">泡泡茶壶</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/02/27/BeeHive-%E7%BB%84%E4%BB%B6%E5%8C%96Protoco-impClass%E5%85%B7%E4%BD%93%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="泡泡茶壶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          BeeHive-组件化Protoco-impClass具体应用实例
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-02-27 22:29:19" itemprop="dateCreated datePublished" datetime="2020-02-27T22:29:19+08:00">2020-02-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-03-05 21:31:44" itemprop="dateModified" datetime="2020-03-05T21:31:44+08:00">2020-03-05</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>BeeHive是基于Spring的Service理念，可以使模块间的具体实现与接口解耦。</p>
<p>目前BeeHive v1.2.0 全部是利用Protocol的方式，实现了模块间解耦的目的：</p>
<p>1.各个模块以插件的形式存在。每个都可独立，相互解耦。</p>
<p>2.各个模块具体实现与接口调用分离</p>
<p>3.各个模块也有生命周期，也可以进行管理。</p>
<h3 id="官方架构图"><a href="#官方架构图" class="headerlink" title="官方架构图"></a>官方架构图</h3><p><img src="http://q6luryr3j.bkt.clouddn.com/04.png" alt="img"></p>
<h3 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h3><p><img src="http://q6luryr3j.bkt.clouddn.com/01.jpeg" alt="img"></p>
<ol>
<li>各个功能模块以protocol为key，以impClass为Value注册添加到Core 中</li>
<li>模块间、应用事件调用通过注册的ServiceProtocol进行</li>
<li>ModuleProtocol可调用应用事件和系统事件</li>
</ol>
<h2 id="组件通讯"><a href="#组件通讯" class="headerlink" title="组件通讯"></a>组件通讯</h2><p><img src="http://q6luryr3j.bkt.clouddn.com/image2019-12-4_15-36-40.png" alt="img"></p>
<p>【调用者】发起调用—&gt;传递调用标示（当前protocol）—&gt;告知中间件需要调用哪个组件</p>
<p>【中间层】根据调用者传递表示，返回目标组件句柄</p>
<p>【调用组件】根据调用者持有的目标组件句柄，遵循调用</p>
<h3 id="调用标示与组件一一对应"><a href="#调用标示与组件一一对应" class="headerlink" title="调用标示与组件一一对应"></a>调用标示与组件一一对应</h3><ul>
<li><p>生成映射关系</p>
<p>BeeHive使用protocol-impClass方式来表示上文所说的映射关系，protocol表示目标组件对应暴露的方法，impClass表示目标组件的句柄</p>
</li>
<li><p>存储映射关系</p>
<p>BeeHive内部使用一个可变字典来存储protocol-impClass，其中以protocol为key，impClass作为Value</p>
</li>
<li><p>获取目标句柄</p>
<p>BeeHive在调用组件时，调用者将目标组件的协议protocol作为参数传递给BeeHive，然后BeeHive返回对应的组件句柄impClass</p>
</li>
</ul>
<h2 id="Module模块"><a href="#Module模块" class="headerlink" title="Module模块"></a>Module模块</h2><h3 id="模块事件"><a href="#模块事件" class="headerlink" title="模块事件"></a>模块事件</h3><p><code>BeeHive</code>会给每个模块提供生命周期事件，用于与<code>BeeHive</code>宿主环境进行必要信息交互，感知模块生命周期的变化。</p>
<p>事件分为三种类型：</p>
<ul>
<li>系统事件</li>
<li>通用事件</li>
<li>业务自定义事件</li>
</ul>
<h4 id="系统事件"><a href="#系统事件" class="headerlink" title="系统事件"></a>系统事件</h4><p>系统事件通常指Application生命周期事件，例如DidBecomeActive、WillEnterBackground等。</p>
<p>系统事件基本工作流程图：</p>
<p><img src="http://q6luryr3j.bkt.clouddn.com/03.jpeg" alt="img"></p>
<h4 id="通用事件"><a href="#通用事件" class="headerlink" title="通用事件"></a>通用事件</h4><p>在系统事件的基础之上，扩展了应用的通用事件，例如<code>modSetup</code>、<code>modInit</code>等，可以用于编码实现各插件模块的设置与初始化。</p>
<p>扩展的通用事件如下：</p>
<p><img src="http://q6luryr3j.bkt.clouddn.com/02.jpeg" alt="img"></p>
<h4 id="业务自定义事件"><a href="#业务自定义事件" class="headerlink" title="业务自定义事件"></a>业务自定义事件</h4><p>如果觉得系统事件、通用事件不足以满足需要，我们还将事件封装简化成<code>BHAppdelgate</code>，你可以通过继承BHAppdelegate`来扩展自己的事件。</p>
<p>自定义的事件的type就是BHMDidCustomEvent = 1000</p>
<h4 id="BeeHive事件-BHModuleEventType"><a href="#BeeHive事件-BHModuleEventType" class="headerlink" title="BeeHive事件(BHModuleEventType)"></a>BeeHive事件(BHModuleEventType)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">typedef NS_ENUM(NSInteger, BHModuleEventType)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F;通用事件</span><br><span class="line">    BHMSetupEvent &#x3D; 0,</span><br><span class="line">    BHMInitEvent,&#x2F;&#x2F;特殊事件</span><br><span class="line">    BHMTearDownEvent,&#x2F;&#x2F;特殊事件</span><br><span class="line">    BHMSplashEvent,&#x2F;&#x2F;通用事件</span><br><span class="line">  </span><br><span class="line">  	&#x2F;&#x2F;3D-Touch</span><br><span class="line">    BHMQuickActionEvent,</span><br><span class="line">  </span><br><span class="line">    &#x2F;&#x2F;生命周期</span><br><span class="line">    BHMWillResignActiveEvent,</span><br><span class="line">    BHMDidEnterBackgroundEvent,</span><br><span class="line">    BHMWillEnterForegroundEvent,</span><br><span class="line">    BHMDidBecomeActiveEvent,</span><br><span class="line">    BHMWillTerminateEvent,</span><br><span class="line">  </span><br><span class="line">  	&#x2F;&#x2F;未使用</span><br><span class="line">    BHMUnmountEvent,</span><br><span class="line">    BHMOpenURLEvent,</span><br><span class="line">    BHMDidReceiveMemoryWarningEvent,</span><br><span class="line">  </span><br><span class="line">  	&#x2F;&#x2F;推送相关事件</span><br><span class="line">    BHMDidFailToRegisterForRemoteNotificationsEvent,</span><br><span class="line">    BHMDidRegisterForRemoteNotificationsEvent,</span><br><span class="line">    BHMDidReceiveRemoteNotificationEvent,</span><br><span class="line">    BHMDidReceiveLocalNotificationEvent,</span><br><span class="line">    BHMWillPresentNotificationEvent,</span><br><span class="line">    BHMDidReceiveNotificationResponseEvent,</span><br><span class="line">  </span><br><span class="line"> 		&#x2F;&#x2F;handoff和相关事件</span><br><span class="line">    BHMWillContinueUserActivityEvent,</span><br><span class="line">    BHMContinueUserActivityEvent,</span><br><span class="line">    BHMDidFailToContinueUserActivityEvent,</span><br><span class="line">    BHMDidUpdateUserActivityEvent,</span><br><span class="line">  </span><br><span class="line">    &#x2F;&#x2F;watchApp请求事件</span><br><span class="line">    BHMHandleWatchKitExtensionRequestEvent,</span><br><span class="line">    </span><br><span class="line">    BHMDidCustomEvent &#x3D; 1000&#x2F;&#x2F; 自定义业务事件</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="处理系统事件"><a href="#处理系统事件" class="headerlink" title="处理系统事件"></a>处理系统事件</h4><p>系统的事件会被传递给每个模块，让每个模块自己决定编写业务处理逻辑，比如<code>3D-Touch</code>功能</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 3D-Touch功能</span><br><span class="line">- (void)modQuickAction:(BHContext *)context &#123;</span><br><span class="line">    &#x2F;&#x2F; 模块处理</span><br><span class="line">    [BHRouter openURL:[NSURL URLWithString:BHRUsageRegister] withParams:@&#123;@&quot;params&quot;:@&#123;@&quot;user_id&quot;:@&quot;11111&quot;&#125;&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="特殊事件"><a href="#特殊事件" class="headerlink" title="特殊事件"></a>特殊事件</h4><h5 id="BHMInitEvent——初始化Module模块调用modInit-事件"><a href="#BHMInitEvent——初始化Module模块调用modInit-事件" class="headerlink" title="BHMInitEvent——初始化Module模块调用modInit:事件"></a>BHMInitEvent——初始化Module模块调用modInit:事件</h5><p>在处理Module事件时，当事件类型BHMInitEvent时，会依次遍历BHModules数组，依次对每个Module实例调用modInit:方法。这里会有异步加载的问题。如果moduleInstance重写了async方法，那么就会根据这个方法返回的值来进行是否异步加载的判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">- (void)handleModulesInitEventForTarget:(id&lt;BHModuleProtocol&gt;)target</span><br><span class="line">                        withCustomParam:(NSDictionary *)customParam &#123;</span><br><span class="line">    BHContext *context &#x3D; [BHContext shareInstance].copy;</span><br><span class="line">    context.customParam &#x3D; customParam;</span><br><span class="line">    context.customEvent &#x3D; BHMInitEvent;</span><br><span class="line">    </span><br><span class="line">    NSArray&lt;id&lt;BHModuleProtocol&gt;&gt; *moduleInstances;</span><br><span class="line">    if (target) &#123;</span><br><span class="line">        moduleInstances &#x3D; @[target];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        moduleInstances &#x3D; [self.BHModulesByEvent objectForKey:@(BHMInitEvent)];</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [moduleInstances enumerateObjectsUsingBlock:^(id&lt;BHModuleProtocol&gt; moduleInstance, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">        __weak typeof(&amp;*self) wself &#x3D; self;</span><br><span class="line">        void ( ^ bk )(void);</span><br><span class="line">        bk &#x3D; ^()&#123;</span><br><span class="line">            __strong typeof(&amp;*self) sself &#x3D; wself;</span><br><span class="line">            if (sself) &#123;</span><br><span class="line">                if ([moduleInstance respondsToSelector:@selector(modInit:)]) &#123;</span><br><span class="line">                    [moduleInstance modInit:context];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        [[BHTimeProfiler sharedTimeProfiler] recordEventTime:[NSString stringWithFormat:@&quot;%@ --- modInit:&quot;, [moduleInstance class]]];</span><br><span class="line">        </span><br><span class="line">        if ([moduleInstance respondsToSelector:@selector(async)]) &#123;</span><br><span class="line">            BOOL async &#x3D; [moduleInstance async];</span><br><span class="line">            </span><br><span class="line">            if (async) &#123;</span><br><span class="line">                dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                    bk();</span><br><span class="line">                &#125;);</span><br><span class="line">                </span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                bk();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            bk();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体场景可分为：</p>
<ol>
<li><p>根据环境的不同初始化不同的方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (void)modInit:(BHContext *)context &#123;</span><br><span class="line">    switch (context.env) &#123;</span><br><span class="line">        case BHEnvironmentDev:</span><br><span class="line">            &#x2F;&#x2F;....初始化开发环境</span><br><span class="line">            break;</span><br><span class="line">        case BHEnvironmentProd:</span><br><span class="line">            &#x2F;&#x2F;....初始化生产环境</span><br><span class="line">        default:</span><br><span class="line">            break;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在初始化的时候注册一些协议</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (void)modInit:(BHContext *)context &#123;</span><br><span class="line">  [[BeeHive shareInstance] registerService:@protocol(UserTrackServiceProtocol) service:[BHUserTrackViewController class]];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h5 id="BHMTearDownEvent——拆除事件"><a href="#BHMTearDownEvent——拆除事件" class="headerlink" title="BHMTearDownEvent——拆除事件"></a>BHMTearDownEvent——拆除事件</h5><p>倒叙遍历当前Module中所有事件，调用modInit:事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (void)handleModulesTearDownEventForTarget:(id&lt;BHModuleProtocol&gt;)target</span><br><span class="line">                            withCustomParam:(NSDictionary *)customParam &#123;</span><br><span class="line">    BHContext *context &#x3D; [BHContext shareInstance].copy;</span><br><span class="line">    context.customParam &#x3D; customParam;</span><br><span class="line">    context.customEvent &#x3D; BHMTearDownEvent;</span><br><span class="line">    </span><br><span class="line">    NSArray&lt;id&lt;BHModuleProtocol&gt;&gt; *moduleInstances;</span><br><span class="line">    if (target) &#123;</span><br><span class="line">        moduleInstances &#x3D; @[target];</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        moduleInstances &#x3D; [self.BHModulesByEvent objectForKey:@(BHMTearDownEvent)];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F;Reverse Order to unload</span><br><span class="line">    for (int i &#x3D; (int)moduleInstances.count - 1; i &gt;&#x3D; 0; i--) &#123;</span><br><span class="line">        id&lt;BHModuleProtocol&gt; moduleInstance &#x3D; [moduleInstances objectAtIndex:i];</span><br><span class="line">        if (moduleInstance &amp;&amp; [moduleInstance respondsToSelector:@selector(modTearDown:)]) &#123;</span><br><span class="line">            [moduleInstance modTearDown:context];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="模块注册"><a href="#模块注册" class="headerlink" title="模块注册"></a>模块注册</h3><h4 id="静态注册"><a href="#静态注册" class="headerlink" title="静态注册"></a>静态注册</h4><h5 id="通过配置BHContext指定本地moduleConfigName配置文件"><a href="#通过配置BHContext指定本地moduleConfigName配置文件" class="headerlink" title="通过配置BHContext指定本地moduleConfigName配置文件"></a>通过配置BHContext指定本地moduleConfigName配置文件</h5><ol>
<li><p>指定文件读取路径</p>
<p>[BHContext shareInstance].moduleConfigName = @“BeeHive.bundle/BeeHive.plist”</p>
</li>
<li><p>配置文件格式</p>
<p><img src="http://q6luryr3j.bkt.clouddn.com/image-20200227230948167.png" alt="img"></p>
</li>
<li><p>读取文件内容，将其读取存入内存字段BHModuleInfos中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">- (void)loadLocalModules &#123;</span><br><span class="line">    </span><br><span class="line">    NSString *plistPath &#x3D; [[NSBundle mainBundle] pathForResource:[BHContext shareInstance].moduleConfigName ofType:@&quot;plist&quot;];</span><br><span class="line">    if (![[NSFileManager defaultManager] fileExistsAtPath:plistPath]) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    NSDictionary *moduleList &#x3D; [[NSDictionary alloc] initWithContentsOfFile:plistPath];</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 加载模块文件</span><br><span class="line">    NSArray&lt;NSDictionary *&gt; *modulesArray &#x3D; [moduleList objectForKey:kModuleArrayKey];</span><br><span class="line">    NSMutableDictionary&lt;NSString *, NSNumber *&gt; *moduleInfoByClass &#x3D; @&#123;&#125;.mutableCopy;</span><br><span class="line">    [self.BHModuleInfos enumerateObjectsUsingBlock:^(NSDictionary * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">        &#x2F;&#x2F; 标记当前模块已被加载</span><br><span class="line">        [moduleInfoByClass setObject:@1 forKey:[obj objectForKey:kModuleInfoNameKey]];</span><br><span class="line">    &#125;];</span><br><span class="line">    [modulesArray enumerateObjectsUsingBlock:^(NSDictionary * _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">        if (!moduleInfoByClass[[obj objectForKey:kModuleInfoNameKey]]) &#123;</span><br><span class="line">            [self.BHModuleInfos addObject:obj];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="API注册"><a href="#API注册" class="headerlink" title="API注册"></a>API注册</h5><p>将其添加到内存BHModuleInfos字段中，BHModuleInfos是一个NSMutableArray，里面存的都是一个个的字典，字典里面有两个Key，一个是@”moduleLevel”，另一个是@”moduleClass”。存储已经注册的Module的时候都要判断Level。还有一点需要说明的，所有需要注册的Module必须遵循BHModuleProtocol协议，否则不能被存储。</p>
<ol>
<li>遍历BHModules 判断当前object类 类型是否已存在BHModules中</li>
<li>校验当前Class是否实现BHModuleProtocol的协议方法</li>
<li>初始化moduleInfo将其添加到BHModuleInfos 中，实例化obj 将其添加到BHModules中，设置已添加标示</li>
<li>遍历BHModules中所有Module,将其中moduleInstance进行排序</li>
<li>根据shouldTriggerInitEvent判断是否需要立即触发初始化方法</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">- (void)addModuleFromObject:(id)object</span><br><span class="line">     shouldTriggerInitEvent:(BOOL)shouldTriggerInitEvent &#123;</span><br><span class="line">    Class class;</span><br><span class="line">    NSString *moduleName &#x3D; nil;</span><br><span class="line">    </span><br><span class="line">    if (object) &#123;</span><br><span class="line">        class &#x3D; object;</span><br><span class="line">        moduleName &#x3D; NSStringFromClass(class);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        return ;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 遍历BHModules 判断当前object类 类型是否已存在BHModules中</span><br><span class="line">    __block BOOL flag &#x3D; YES;</span><br><span class="line">    [self.BHModules enumerateObjectsUsingBlock:^(id  _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) &#123;</span><br><span class="line">        if ([obj isKindOfClass:class]) &#123;</span><br><span class="line">            flag &#x3D; NO;</span><br><span class="line">            *stop &#x3D; YES;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">    if (!flag) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    &#x2F;&#x2F; 校验当前Class是否遵循BHModuleProtocol的协议方法</span><br><span class="line">    if ([class conformsToProtocol:@protocol(BHModuleProtocol)]) &#123;</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 构建字典moduleInfo</span><br><span class="line">        NSMutableDictionary *moduleInfo &#x3D; [NSMutableDictionary dictionary];</span><br><span class="line">        BOOL responseBasicLevel &#x3D; [class instancesRespondToSelector:@selector(basicModuleLevel)];</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; 默认初始化level为1，判断是否需要更改</span><br><span class="line">        int levelInt &#x3D; 1;</span><br><span class="line">        if (responseBasicLevel) &#123;</span><br><span class="line">            levelInt &#x3D; 0;</span><br><span class="line">        &#125;</span><br><span class="line">        [moduleInfo setObject:@(levelInt) forKey:kModuleInfoLevelKey];</span><br><span class="line">        </span><br><span class="line">        if (moduleName) &#123;</span><br><span class="line">            [moduleInfo setObject:moduleName forKey:kModuleInfoNameKey];</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 将其添加到BHModuleInfos 中，</span><br><span class="line">        [self.BHModuleInfos addObject:moduleInfo];</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 实例化obj 将其添加到BHModules中，设置已初始化标示</span><br><span class="line">        id&lt;BHModuleProtocol&gt; moduleInstance &#x3D; [[class alloc] init];</span><br><span class="line">        [self.BHModules addObject:moduleInstance];</span><br><span class="line">        [moduleInfo setObject:@(YES) forKey:kModuleInfoHasInstantiatedKey];</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 遍历BHModules中所有Module,将其中moduleInstance根据basicModuleLevel（0 1）进行排序，相同情况下再根据modulePriority进行排序（1 0）</span><br><span class="line">        [self.BHModules sortUsingComparator:^NSComparisonResult(id&lt;BHModuleProtocol&gt; moduleInstance1, id&lt;BHModuleProtocol&gt; moduleInstance2) &#123;</span><br><span class="line">            NSNumber *module1Level &#x3D; @(BHModuleNormal);</span><br><span class="line">            NSNumber *module2Level &#x3D; @(BHModuleNormal);</span><br><span class="line">            if ([moduleInstance1 respondsToSelector:@selector(basicModuleLevel)]) &#123;</span><br><span class="line">                module1Level &#x3D; @(BHModuleBasic);</span><br><span class="line">            &#125;</span><br><span class="line">            if ([moduleInstance2 respondsToSelector:@selector(basicModuleLevel)]) &#123;</span><br><span class="line">                module2Level &#x3D; @(BHModuleBasic);</span><br><span class="line">            &#125;</span><br><span class="line">            if (module1Level.integerValue !&#x3D; module2Level.integerValue) &#123;</span><br><span class="line">                return module1Level.integerValue &gt; module2Level.integerValue;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                NSInteger module1Priority &#x3D; 0;</span><br><span class="line">                NSInteger module2Priority &#x3D; 0;</span><br><span class="line">                if ([moduleInstance1 respondsToSelector:@selector(modulePriority)]) &#123;</span><br><span class="line">                    module1Priority &#x3D; [moduleInstance1 modulePriority];</span><br><span class="line">                &#125;</span><br><span class="line">                if ([moduleInstance2 respondsToSelector:@selector(modulePriority)]) &#123;</span><br><span class="line">                    module2Priority &#x3D; [moduleInstance2 modulePriority];</span><br><span class="line">                &#125;</span><br><span class="line">                return module1Priority &lt; module2Priority;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;];</span><br><span class="line">        &#x2F;&#x2F; 注册模块，将module注册添加到BHModulesByEvent中</span><br><span class="line">        [self registerEventsByModuleInstance:moduleInstance];</span><br><span class="line">        </span><br><span class="line">        &#x2F;&#x2F; 是否需要立即触发BHMSetupEvent事件</span><br><span class="line">        if (shouldTriggerInitEvent) &#123;</span><br><span class="line">            [self handleModuleEvent:BHMSetupEvent forTarget:moduleInstance withSeletorStr:nil andCustomParam:nil];</span><br><span class="line">            [self handleModulesInitEventForTarget:moduleInstance withCustomParam:nil];</span><br><span class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</span><br><span class="line">                [self handleModuleEvent:BHMSplashEvent forTarget:moduleInstance withSeletorStr:nil andCustomParam:nil];</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Load方法注册，BH-EXPORT-MODULE宏定义"><a href="#Load方法注册，BH-EXPORT-MODULE宏定义" class="headerlink" title="Load方法注册，BH_EXPORT_MODULE宏定义"></a>Load方法注册，BH_EXPORT_MODULE宏定义</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#define BH_EXPORT_MODULE(isAsync) \</span><br><span class="line">+ (void)load &#123; [BeeHive registerDynamicModule:[self class]]; &#125; \</span><br><span class="line">-(BOOL)async &#123; return [[NSString stringWithUTF8String:#isAsync] boolValue];&#125;</span><br></pre></td></tr></table></figure>

<h4 id="动态注册"><a href="#动态注册" class="headerlink" title="动态注册"></a>动态注册</h4><h5 id="通过读取存储在数据段中的数据进行注册"><a href="#通过读取存储在数据段中的数据进行注册" class="headerlink" title="通过读取存储在数据段中的数据进行注册"></a>通过读取存储在数据段中的数据进行注册</h5><ol>
<li><h6 id="存储数据到数据段"><a href="#存储数据到数据段" class="headerlink" title="存储数据到数据段"></a>存储数据到数据段</h6><p>通过BeeHiveMod(DiaryModule)宏进行注册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#ifndef BeehiveModSectName</span><br><span class="line">#define BeehiveModSectName &quot;BeehiveMods&quot;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#define BeeHiveDATA(sectname) __attribute((used, section(&quot;__DATA,&quot;#sectname&quot; &quot;)))</span><br><span class="line"></span><br><span class="line">#define BeeHiveMod(name) \</span><br><span class="line">class BeeHive; char * k##name##_mod BeeHiveDATA(BeehiveMods) &#x3D; &quot;&quot;#name&quot;&quot;;</span><br></pre></td></tr></table></figure>

<p>BeeHiveDATA 宏定会将数据存储到__DATA数据段中中指定的sectname字段中</p>
<p>BeeHiveMod(MMDoubanModule)  在预编译完成后，会变为</p>
<p>class BeeHive; char * kMMDoubanModule_mod BeeHiveDATA(BeehiveMods) = “””MMDoubanModule”””</p>
<p>也就相当于</p>
<p>char * kMMDoubanModule_mod = “””MMDoubanModule”””;</p>
</li>
<li><h6 id="使用预编译指令进行简单验证"><a href="#使用预编译指令进行简单验证" class="headerlink" title="使用预编译指令进行简单验证"></a>使用预编译指令进行简单验证</h6><p>新建beeHive_macro.c文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BeeHiveDATA(sectname) __attribute((used, section(<span class="meta-string">"__DATA, "</span>#sectname<span class="meta-string">" "</span>)))</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> BeeHiveMod(name) \</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BeeHive</span>;</span> <span class="keyword">char</span> * k#<span class="meta">#name##_mod BeeHiveDATA(BeehiveMods) = <span class="meta-string">""</span>#name<span class="meta-string">""</span>;</span></span><br><span class="line"></span><br><span class="line">@BeeHiveMod(MMDoubanModule)</span><br></pre></td></tr></table></figure>

<p>执行预编译指令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -E beeHive_macro.c</span><br></pre></td></tr></table></figure>

<p>打印结果</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@class BeeHive; char * kMMDoubanModule_mod __attribute((used, section("__DATA, ""BeehiveMods"" "))) = """MMDoubanModule""";</span><br></pre></td></tr></table></figure>

<p>上述输出中，<code>__attribute((used, section(&quot;__DATA, &quot;&quot;BeehiveMods&quot;&quot; &quot;)))</code>表示在项目的mach-o文件的名字为<code>__DATA</code>的segment中添加一个名字为<code>BeehiveMods</code>的section，并将其值设置为字符串<code>&quot;MMDoubanModule&quot;</code>。</p>
</li>
</ol>
</li>
</ol>
<pre><code>实用otool命令验证，mach-o文件，输出mach-o文件的所有segment和section

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -l demo.o</span><br></pre></td></tr></table></figure>

输出内容，内容很多，只截取我们需要部分

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Section</span><br><span class="line">  sectname BeehiveMods</span><br><span class="line">   segname __DATA</span><br><span class="line">      addr 0x0000000100002018</span><br><span class="line">      size 0x0000000000000008</span><br><span class="line">    offset 8216</span><br><span class="line">     align 2^3 (8)</span><br><span class="line">    reloff 0</span><br><span class="line">    nreloc 0</span><br><span class="line">     flags 0x00000000</span><br><span class="line"> reserved1 0</span><br><span class="line"> reserved2 0</span><br></pre></td></tr></table></figure>

在mach-o文件中确实存在`BeehiveMods`这个section，接下来，继续验证这个section中的值是否是字符串`&quot;ModuleAModule&quot;`

查看section内容

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -s __DATA BeehiveMods demo.o</span><br></pre></td></tr></table></figure>

输出内容：

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Contents of (__DATA,BeehiveMods) section</span><br><span class="line">0000000100002018	92 0f 00 00 01 00 00 00</span><br></pre></td></tr></table></figure>

上述输出表示，section内部包含了地址92 0f 00 00 01 00 00 00， 地址指向的就是字符串`&quot;MMDoubanModule&quot;`



为了进一步验证，可以查看.o文件中segment为__TEXT section为 __cstring的内容

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">otool -V -s __TEXT __cstring</span><br></pre></td></tr></table></figure>

输出如下：

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Contents of (__TEXT,__cstring) section</span><br><span class="line">0000000100000f92  MMDoubanModule</span><br><span class="line">0000000100000fa1  Hello, World!</span><br></pre></td></tr></table></figure>

可以看出地址0000000100000f92 对应的字符串就是MMDoubanModule，可以验证MMDoubanModule确实被存储在了section中。</code></pre><ol start="3">
<li><h6 id="通过BHReadConfiguration读取-Data段中的字符串"><a href="#通过BHReadConfiguration读取-Data段中的字符串" class="headerlink" title="通过BHReadConfiguration读取__Data段中的字符串"></a>通过BHReadConfiguration读取__Data段中的字符串</h6><p>BeeHive在文件<code>BHAnnotation.m</code>中注册了一个函数<code>dyld_callback</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((constructor))</span><br><span class="line">void initProphet() &#123;</span><br><span class="line">    _dyld_register_func_for_add_image(dyld_callback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当一个函数被<code>__attribute__((constructor))</code>修饰时，表示这个函数是这个image的初始化函数，在image被加载时，首先会调用这个函数。（image指的是mach-o和动态共享库，在工程运行时，可以使用lldb命令<code>image list</code>查看这个工程中加载的所有image。）</p>
<p>上述代码表示<code>initProphet</code>函数被指定为mach-o的初始化函数，当dyld（动态链接器）加载mach-o时，执行<code>initProphet</code>函数，其执行时机在man函数和类的<code>load</code>方法之前。</p>
<p>当<code>_dyld_register_func_for_add_image(dyld_callback);</code>被执行时，如果已经加载了image，则每存在一个已经加载的image就执行一次<code>dyld_callback</code>函数，在此之后，每当有一个新的image被加载时，也会执行一次<code>dyld_callback</code>函数。</p>
<p>（<code>dyld_callback</code>函数在image的初始化函数之前被调用，mach-o是第一个被加载的image，调用顺序是：load mach-o -&gt; initProphet -&gt; dyld_callback -&gt; load other_image -&gt; dyld_callback -&gt; other_image_initializers -&gt; ……）</p>
<p>所以，当程序启动时，会多次调用<code>dyld_callback</code>函数。</p>
</li>
<li><h6 id="通过getsectiondata函数从数据段中取出数据"><a href="#通过getsectiondata函数从数据段中取出数据" class="headerlink" title="通过getsectiondata函数从数据段中取出数据"></a>通过getsectiondata函数从数据段中取出数据</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">extern uint8_t *getsectiondata(</span><br><span class="line">    const struct mach_header_64 *mhp,</span><br><span class="line">    const char *segname,</span><br><span class="line">    const char *sectname,</span><br><span class="line">    unsigned long *size);</span><br></pre></td></tr></table></figure>

<p>segname的值为<code>__DATA</code>，sectname的值为<code>BeehiveMods</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 从数据段__data__中取出数据</span><br><span class="line">NSArray&lt;NSString *&gt;* BHReadConfiguration(char *sectionName,const struct mach_header *mhp) &#123;</span><br><span class="line">    NSMutableArray *configs &#x3D; [NSMutableArray array];</span><br><span class="line">    unsigned long size &#x3D; 0;</span><br><span class="line">#ifndef __LP64__</span><br><span class="line">    uintptr_t *memory &#x3D; (uintptr_t*)getsectiondata(mhp, SEG_DATA, sectionName, &amp;size);</span><br><span class="line">#else</span><br><span class="line">    const struct mach_header_64 *mhp64 &#x3D; (const struct mach_header_64 *)mhp;</span><br><span class="line">    uintptr_t *memory &#x3D; (uintptr_t*)getsectiondata(mhp64, SEG_DATA, sectionName, &amp;size);</span><br><span class="line">#endif</span><br><span class="line">    </span><br><span class="line">    unsigned long counter &#x3D; size&#x2F;sizeof(void*);</span><br><span class="line">    for(int idx &#x3D; 0; idx &lt; counter; ++idx)&#123;</span><br><span class="line">        char *string &#x3D; (char*)memory[idx];</span><br><span class="line">        NSString *str &#x3D; [NSString stringWithUTF8String:string];</span><br><span class="line">        if(!str)continue;</span><br><span class="line">        </span><br><span class="line">        BHLog(@&quot;config &#x3D; %@&quot;, str);</span><br><span class="line">        if(str) [configs addObject:str];</span><br><span class="line">    &#125;</span><br><span class="line">    return configs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><h6 id="调用registerDynamicModule注册方法将其添加到BHModuleInfos数组中"><a href="#调用registerDynamicModule注册方法将其添加到BHModuleInfos数组中" class="headerlink" title="调用registerDynamicModule注册方法将其添加到BHModuleInfos数组中"></a>调用registerDynamicModule注册方法将其添加到BHModuleInfos数组中</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">static void dyld_callback(const struct mach_header *mhp, intptr_t vmaddr_slide) &#123;</span><br><span class="line">    NSArray *mods &#x3D; BHReadConfiguration(BeehiveModSectName, mhp);</span><br><span class="line">    for (NSString *modName in mods) &#123;</span><br><span class="line">        Class cls;</span><br><span class="line">        if (modName) &#123;</span><br><span class="line">            cls &#x3D; NSClassFromString(modName);</span><br><span class="line">            if (cls) &#123;</span><br><span class="line">                [[BHModuleManager sharedManager] registerDynamicModule:cls];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><h6 id="调用API进行注册到BHModuleInfos中"><a href="#调用API进行注册到BHModuleInfos中" class="headerlink" title="调用API进行注册到BHModuleInfos中"></a>调用API进行注册到BHModuleInfos中</h6></li>
</ol>
<h2 id="Service注册"><a href="#Service注册" class="headerlink" title="Service注册"></a>Service注册</h2><h3 id="静态注册-1"><a href="#静态注册-1" class="headerlink" title="静态注册"></a>静态注册</h3><h4 id="通过配置BHContext指定本地serviceConfigName"><a href="#通过配置BHContext指定本地serviceConfigName" class="headerlink" title="通过配置BHContext指定本地serviceConfigName"></a>通过配置BHContext指定本地serviceConfigName</h4><ol>
<li><p>指定文件读取路径</p>
<p>[BHContext shareInstance].serviceConfigName = @”BeeHive.bundle/BHService.plist”</p>
</li>
<li><p>配置文件格式</p>
<img src="http://q6luryr3j.bkt.clouddn.com/image-20200228173020182.png" alt="image-20200228173020182" style="zoom:80%;" />
</li>
<li><p>读取文件，形成protocolKey:protocolImplClass映射关系，将其Add到allServicesDict字典中</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- (void)registerLocalServices &#123;</span><br><span class="line">    </span><br><span class="line">    NSString *serviceConfigName &#x3D; [BHContext shareInstance].serviceConfigName;</span><br><span class="line">    NSString *plistPath &#x3D; [[NSBundle mainBundle] pathForResource:serviceConfigName ofType:@&quot;plist&quot;];</span><br><span class="line">    if (!plistPath) &#123;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    NSArray *serviceList &#x3D; [[NSArray alloc] initWithContentsOfFile:plistPath];</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 读取plist的文件</span><br><span class="line">    [self.lock lock];</span><br><span class="line">    for (NSDictionary *dict in serviceList) &#123;</span><br><span class="line">        NSString *protocolKey &#x3D; [dict objectForKey:@&quot;service&quot;];</span><br><span class="line">        NSString *protocolImplClass &#x3D; [dict objectForKey:@&quot;impl&quot;];</span><br><span class="line">        if (protocolKey.length &gt; 0 &amp;&amp; protocolImplClass.length &gt; 0) &#123;</span><br><span class="line">            [self.allServicesDict addEntriesFromDictionary:@&#123;protocolKey:protocolImplClass&#125;];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    [self.lock unlock];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="API注册-1"><a href="#API注册-1" class="headerlink" title="API注册"></a>API注册</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 注册protocol与目标句柄</span><br><span class="line">- (void)registerService:(Protocol *)service implClass:(Class)implClass &#123;</span><br><span class="line">    </span><br><span class="line">    NSParameterAssert(service !&#x3D; nil);</span><br><span class="line">    NSParameterAssert(implClass !&#x3D; nil);</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 校验当前目标句柄是否遵守协议</span><br><span class="line">    if (![implClass conformsToProtocol:service]) &#123;</span><br><span class="line">        if (self.enableException) &#123;</span><br><span class="line">            @throw [NSException exceptionWithName:NSInternalInconsistencyException reason:[NSString stringWithFormat:@&quot;%@ module does not comply with %@ protocol&quot;, NSStringFromClass(implClass), NSStringFromProtocol(service)] userInfo:nil];</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    &#x2F;&#x2F; 检测当前service是否已经注册</span><br><span class="line">    if ([self checkValidService:service]) &#123;</span><br><span class="line">        if (self.enableException) &#123;</span><br><span class="line">            @throw [NSException exceptionWithName:NSInternalInconsistencyException reason:[NSString stringWithFormat:@&quot;%@ protocol has been registed&quot;, NSStringFromProtocol(service)] userInfo:nil];</span><br><span class="line">        &#125;</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    NSString *key &#x3D; NSStringFromProtocol(service);</span><br><span class="line">    NSString *value &#x3D; NSStringFromClass(implClass);</span><br><span class="line">    if (key.length &gt; 0 &amp;&amp; value.length &gt; 0) &#123;</span><br><span class="line">        [self.lock lock];</span><br><span class="line">        [self.allServicesDict addEntriesFromDictionary:@&#123;key:value&#125;];</span><br><span class="line">        [self.lock unlock];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="动态注册-1"><a href="#动态注册-1" class="headerlink" title="动态注册"></a>动态注册</h3><h4 id="BeeHiveService宏注册"><a href="#BeeHiveService宏注册" class="headerlink" title="BeeHiveService宏注册"></a>BeeHiveService宏注册</h4><ol>
<li><p>BeeHiveService宏定义</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define BeeHiveDATA(sectname) __attribute((used, section(&quot;__DATA,&quot;#sectname&quot; &quot;)))</span><br><span class="line"></span><br><span class="line">#define BeeHiveService(servicename,impl) \</span><br><span class="line">class BeeHive; char * k##servicename##_service BeeHiveDATA(BeehiveServices) &#x3D; &quot;&#123; \&quot;&quot;#servicename&quot;\&quot; : \&quot;&quot;#impl&quot;\&quot;&#125;&quot;;</span><br></pre></td></tr></table></figure>

<p>BeeHiveDATA 宏定会将数据存储到__DATA数据段中中指定的sectname字段中</p>
<p>BeeHiveService(MMDouBanProtocol,MMDouBanModule)最终宏在预编译完成后会变为</p>
<p>char * kMMDouBanProtocol_service <strong>attribute((used, section(“</strong>DATA,””MMDouBanProtocol”” “))) = “{ &quot;“MMDouBanProtocol”&quot; : &quot;“MMDouBanModule”&quot;}”;</p>
</li>
</ol>
</li>
</ol>
<pre><code>__attribute第一个参数used很有用。这个关键字是用来修饰函数的。被used修饰以后，意味着即使函数没有被引用，在Release下也不会被优化。如果不加这个修饰，那么Release环境链接器下会去掉没有被引用的段。具体的描述可以看这个[gun的官方文档](https://gcc.gnu.org/onlinedocs/gcc-3.2/gcc/Function-Attributes.html#Function Attributes)。

Static静态变量会按照他们申明的顺序，放到一个单独的段中。我们通过使用__attribute__((section(&quot;name&quot;)))来指明哪个段。数据则用__attribute__((used))来标记，防止链接器会优化删除未被使用的段。</code></pre><ol start="2">
<li><p>通过BHReadConfiguration读取__Data段中的字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; 从数据段__data__中取出数据</span><br><span class="line">NSArray&lt;NSString *&gt;* BHReadConfiguration(char *sectionName,const struct mach_header *mhp) &#123;</span><br><span class="line">    NSMutableArray *configs &#x3D; [NSMutableArray array];</span><br><span class="line">    unsigned long size &#x3D; 0;</span><br><span class="line">#ifndef __LP64__</span><br><span class="line">    uintptr_t *memory &#x3D; (uintptr_t*)getsectiondata(mhp, SEG_DATA, sectionName, &amp;size);</span><br><span class="line">#else</span><br><span class="line">    const struct mach_header_64 *mhp64 &#x3D; (const struct mach_header_64 *)mhp;</span><br><span class="line">    uintptr_t *memory &#x3D; (uintptr_t*)getsectiondata(mhp64, SEG_DATA, sectionName, &amp;size);</span><br><span class="line">#endif</span><br><span class="line">    </span><br><span class="line">    unsigned long counter &#x3D; size&#x2F;sizeof(void*);</span><br><span class="line">    for(int idx &#x3D; 0; idx &lt; counter; ++idx)&#123;</span><br><span class="line">        char *string &#x3D; (char*)memory[idx];</span><br><span class="line">        NSString *str &#x3D; [NSString stringWithUTF8String:string];</span><br><span class="line">        if(!str)continue;</span><br><span class="line">        </span><br><span class="line">        BHLog(@&quot;config &#x3D; %@&quot;, str);</span><br><span class="line">        if(str) [configs addObject:str];</span><br><span class="line">    &#125;</span><br><span class="line">    return configs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用API进行注册</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">static void dyld_callback(const struct mach_header *mhp, intptr_t vmaddr_slide) &#123;</span><br><span class="line">    &#x2F;&#x2F;register services</span><br><span class="line">    NSArray&lt;NSString *&gt; *services &#x3D; BHReadConfiguration(BeehiveServiceSectName,mhp);</span><br><span class="line">    for (NSString *map in services) &#123;</span><br><span class="line">        NSData *jsonData &#x3D;  [map dataUsingEncoding:NSUTF8StringEncoding];</span><br><span class="line">        NSError *error &#x3D; nil;</span><br><span class="line">        id json &#x3D; [NSJSONSerialization JSONObjectWithData:jsonData options:0 error:&amp;error];</span><br><span class="line">        if (!error) &#123;</span><br><span class="line">            if ([json isKindOfClass:[NSDictionary class]] &amp;&amp; [json allKeys].count) &#123;</span><br><span class="line">                </span><br><span class="line">                NSString *protocol &#x3D; [json allKeys][0];</span><br><span class="line">                NSString *clsName  &#x3D; [json allValues][0];</span><br><span class="line">                </span><br><span class="line">                if (protocol &amp;&amp; clsName) &#123;</span><br><span class="line">                    [[BHServiceManager sharedManager] registerService:NSProtocolFromString(protocol) implClass:NSClassFromString(clsName)];</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="应用实例"><a href="#应用实例" class="headerlink" title="应用实例"></a>应用实例</h2><h5 id="浏览日记本详情页——-gt-关注日记作者——-gt-校验当前用户登录状态——-gt-执行关注"><a href="#浏览日记本详情页——-gt-关注日记作者——-gt-校验当前用户登录状态——-gt-执行关注" class="headerlink" title="浏览日记本详情页——&gt;关注日记作者——&gt;校验当前用户登录状态——&gt;执行关注"></a>浏览日记本详情页——&gt;关注日记作者——&gt;校验当前用户登录状态——&gt;执行关注</h5><p>日记模块、关注模块、登录模块，互相之间调用互不依赖</p>
<p>使用接口或者抽象类制定好规范和契约，而不去涉及任何具体的操作，把展现细节的任务交给它们的实现类去完成</p>
<ol>
<li><p>浏览日记本详情页</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;MMDiaryProtocol.h&quot;</span><br><span class="line"></span><br><span class="line">- (void)demo1 &#123;</span><br><span class="line">    &#x2F;&#x2F; 浏览日记本详情页</span><br><span class="line">    id&lt;MMDiaryProtocol&gt; diary &#x3D; [[BeeHive shareInstance] createService:@protocol(MMDiaryProtocol)];</span><br><span class="line">    [diary jumpToDiaryDetail:@&#123;@&quot;diary_id&quot;:@&quot;1234&quot;&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>关注日记作者</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;MMFollowProtocol.h&quot;</span><br><span class="line"></span><br><span class="line">- (void)demo0 &#123;</span><br><span class="line">    &#x2F;&#x2F; 关注日记作者</span><br><span class="line">    id&lt;MMFollowProtocol&gt; follow &#x3D; [[BeeHive shareInstance] createService:@protocol(MMFollowProtocol)];</span><br><span class="line">    [follow follow:@&#123;@&quot;follow_id&quot;: @&quot;123&quot;&#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>校验登录状态</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#import &quot;MMLoginProtocol.h&quot;</span><br><span class="line">@BeeHiveService(MMFollowProtocol, MMFollowModule)</span><br><span class="line"></span><br><span class="line">@implementation MMFollowModule</span><br><span class="line">- (void)follow:(NSDictionary *)follow &#123;</span><br><span class="line">    NSLog(@&quot;%@&quot;,follow[@&quot;follow_id&quot;]);</span><br><span class="line">    id&lt;MMLoginProtocol&gt; login &#x3D; [[BeeHive shareInstance] createService:@protocol(MMLoginProtocol)];</span><br><span class="line">    [login loginIfNeedWithCompleteBlock:^(BOOL success) &#123;</span><br><span class="line">        NSLog(@&quot;%d&quot;,success);</span><br><span class="line">        if (success) &#123;</span><br><span class="line">            &#x2F;&#x2F; 调用关注接口</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="https://github.com/alibaba/BeeHive/blob/master/README-CN.md" target="_blank" rel="noopener">GitHub地址</a></p>
<p><a href="https://tech.meituan.com/2018/06/29/ios-multiterminal-reuse.html" target="_blank" rel="noopener">美团技术博客</a></p>
<p><a href="https://www.jianshu.com/p/4d770ec3cf7d" target="_blank" rel="noopener">组件化工具：BeeHive事件分发</a></p>
<p><a href="https://halfrost.com/beehive/" target="_blank" rel="noopener">BeeHive：一个优雅但还在完善中的解耦工具</a></p>
</li>
</ol>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item"></div>
      <div class="post-nav-item">
    <a href="/2020/02/27/iOS%E5%BC%80%E5%8F%91-%E5%9F%BA%E7%B1%BB%E8%AE%BE%E8%AE%A1%EF%BC%9A%E6%9E%B6%E6%9E%84%E6%A8%A1%E5%BC%8F%E4%B9%8BMVC%E3%80%81MVP%E3%80%81MVVM%E6%9E%B6%E6%9E%84/" rel="next" title="iOS开发-基类设计：架构模式之MVC、MVP、MVVM架构">
      iOS开发-基类设计：架构模式之MVC、MVP、MVVM架构 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#概述"><span class="nav-number">1.</span> <span class="nav-text">概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#官方架构图"><span class="nav-number">1.1.</span> <span class="nav-text">官方架构图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#基本架构"><span class="nav-number">1.2.</span> <span class="nav-text">基本架构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#组件通讯"><span class="nav-number">2.</span> <span class="nav-text">组件通讯</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#调用标示与组件一一对应"><span class="nav-number">2.1.</span> <span class="nav-text">调用标示与组件一一对应</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Module模块"><span class="nav-number">3.</span> <span class="nav-text">Module模块</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#模块事件"><span class="nav-number">3.1.</span> <span class="nav-text">模块事件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#系统事件"><span class="nav-number">3.1.1.</span> <span class="nav-text">系统事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通用事件"><span class="nav-number">3.1.2.</span> <span class="nav-text">通用事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#业务自定义事件"><span class="nav-number">3.1.3.</span> <span class="nav-text">业务自定义事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BeeHive事件-BHModuleEventType"><span class="nav-number">3.1.4.</span> <span class="nav-text">BeeHive事件(BHModuleEventType)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#处理系统事件"><span class="nav-number">3.1.5.</span> <span class="nav-text">处理系统事件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#特殊事件"><span class="nav-number">3.1.6.</span> <span class="nav-text">特殊事件</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#BHMInitEvent——初始化Module模块调用modInit-事件"><span class="nav-number">3.1.6.1.</span> <span class="nav-text">BHMInitEvent——初始化Module模块调用modInit:事件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#BHMTearDownEvent——拆除事件"><span class="nav-number">3.1.6.2.</span> <span class="nav-text">BHMTearDownEvent——拆除事件</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#模块注册"><span class="nav-number">3.2.</span> <span class="nav-text">模块注册</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#静态注册"><span class="nav-number">3.2.1.</span> <span class="nav-text">静态注册</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#通过配置BHContext指定本地moduleConfigName配置文件"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">通过配置BHContext指定本地moduleConfigName配置文件</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#API注册"><span class="nav-number">3.2.1.2.</span> <span class="nav-text">API注册</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Load方法注册，BH-EXPORT-MODULE宏定义"><span class="nav-number">3.2.1.3.</span> <span class="nav-text">Load方法注册，BH_EXPORT_MODULE宏定义</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动态注册"><span class="nav-number">3.2.2.</span> <span class="nav-text">动态注册</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#通过读取存储在数据段中的数据进行注册"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">通过读取存储在数据段中的数据进行注册</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#存储数据到数据段"><span class="nav-number">3.2.2.1.1.</span> <span class="nav-text">存储数据到数据段</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#使用预编译指令进行简单验证"><span class="nav-number">3.2.2.1.2.</span> <span class="nav-text">使用预编译指令进行简单验证</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#通过BHReadConfiguration读取-Data段中的字符串"><span class="nav-number">3.2.2.1.3.</span> <span class="nav-text">通过BHReadConfiguration读取__Data段中的字符串</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#通过getsectiondata函数从数据段中取出数据"><span class="nav-number">3.2.2.1.4.</span> <span class="nav-text">通过getsectiondata函数从数据段中取出数据</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#调用registerDynamicModule注册方法将其添加到BHModuleInfos数组中"><span class="nav-number">3.2.2.1.5.</span> <span class="nav-text">调用registerDynamicModule注册方法将其添加到BHModuleInfos数组中</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#调用API进行注册到BHModuleInfos中"><span class="nav-number">3.2.2.1.6.</span> <span class="nav-text">调用API进行注册到BHModuleInfos中</span></a></li></ol></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Service注册"><span class="nav-number">4.</span> <span class="nav-text">Service注册</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#静态注册-1"><span class="nav-number">4.1.</span> <span class="nav-text">静态注册</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通过配置BHContext指定本地serviceConfigName"><span class="nav-number">4.1.1.</span> <span class="nav-text">通过配置BHContext指定本地serviceConfigName</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#API注册-1"><span class="nav-number">4.2.</span> <span class="nav-text">API注册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#动态注册-1"><span class="nav-number">4.3.</span> <span class="nav-text">动态注册</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#BeeHiveService宏注册"><span class="nav-number">4.3.1.</span> <span class="nav-text">BeeHiveService宏注册</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#应用实例"><span class="nav-number">5.</span> <span class="nav-text">应用实例</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#浏览日记本详情页——-gt-关注日记作者——-gt-校验当前用户登录状态——-gt-执行关注"><span class="nav-number">5.0.0.1.</span> <span class="nav-text">浏览日记本详情页——&gt;关注日记作者——&gt;校验当前用户登录状态——&gt;执行关注</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考链接"><span class="nav-number">6.</span> <span class="nav-text">参考链接</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Doris AI</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Doris AI</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
