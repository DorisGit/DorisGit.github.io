<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('https://dorisgit.github.io').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.7.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    comments: {"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}
  };
</script>

  <meta property="og:type" content="website">
<meta property="og:title" content="æ³¡æ³¡èŒ¶å£¶">
<meta property="og:url" content="https://dorisgit.github.io/index.html">
<meta property="og:site_name" content="æ³¡æ³¡èŒ¶å£¶">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Doris AI">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://dorisgit.github.io/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false
  };
</script>

  <title>æ³¡æ³¡èŒ¶å£¶</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">æ³¡æ³¡èŒ¶å£¶</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/12/21/%E4%B8%80%E6%AC%A1Crash%E8%B7%9F%E8%B8%AA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/21/%E4%B8%80%E6%AC%A1Crash%E8%B7%9F%E8%B8%AA/" class="post-title-link" itemprop="url">ä¸€æ¬¡Crashè·Ÿè¸ª</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-21 16:43:40 / Modified: 19:51:10" itemprop="dateCreated datePublished" datetime="2020-12-21T16:43:40+08:00">2020-12-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ä¸€æ¬¡å¶ç„¶çš„æœºä¼šï¼Œçº¿ä¸Šåé¦ˆç”¨æˆ·æ‰‹æœºå‡ºç°äº†æ‰“å¼€Appå³Crashçš„æƒ…å†µï¼Œæ ¹æ®ç”¨æˆ·æä¾›æ—¶é—´ç‚¹ä»¥åŠè§†é¢‘ä¿¡æ¯ï¼Œæˆ‘ä»¬æŸ¥çœ‹äº†buglyå’Œå°è¯•æœ¬åœ°å¤ç°ï¼Œå¾ˆé—æ†¾ï¼Œéƒ½æ²¡æœ‰ç›¸å…³æœ‰ç”¨ä¿¡æ¯ã€‚</p>
<p>è¿™æ—¶æƒ³åˆ°äº†ï¼Œç”¨æˆ·åˆ†ææœ¬æœºä¸­å¯èƒ½å­˜åœ¨logä¿¡æ¯ã€‚</p>
<h4 id="è·å–Crashæ–‡ä»¶"><a href="#è·å–Crashæ–‡ä»¶" class="headerlink" title="è·å–Crashæ–‡ä»¶"></a>è·å–Crashæ–‡ä»¶</h4><p>è®¾ç½®-&gt;åˆ†æä¸æ”¹è¿›-&gt;åˆ†ææ•°æ®ï¼Œæ‰¾åˆ°å½“å¤©å¯¹åº”çš„Crashæ–‡ä»¶ï¼Œåˆ†äº«åˆ°ç”µè„‘ä¸Šã€‚</p>
<h4 id="è·å–-ipaåŒ…çš„UUID"><a href="#è·å–-ipaåŒ…çš„UUID" class="headerlink" title="è·å–.ipaåŒ…çš„UUID"></a>è·å–.ipaåŒ…çš„UUID</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xcrun dwarfdump --uuid xxx.app/xxx</span><br></pre></td></tr></table></figure>

<p>æ‰“å°ç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UUID: 464A42BE-DB0F-3DF5-ABA7-F3CC4C4944CF (armv7) xxx.app/xxx</span><br><span class="line">UUID: F89C620B-0D6F-3422-A9BE-1C84FC827111 (arm64) xxx.app/xxx</span><br></pre></td></tr></table></figure>

<h4 id="æŸ¥çœ‹Crashæ–‡ä»¶çš„UUID"><a href="#æŸ¥çœ‹Crashæ–‡ä»¶çš„UUID" class="headerlink" title="æŸ¥çœ‹Crashæ–‡ä»¶çš„UUID"></a>æŸ¥çœ‹Crashæ–‡ä»¶çš„UUID</h4><p>æ‰“å¼€Crashæ—¥å¿—ï¼Œç›´æ¥æœç´¢<code>Binary Images</code>ï¼Œå¯¹åº”çš„å°±æ˜¯uuid</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Binary Images:</span><br><span class="line">0x100110000 - 0x10283ffff xxx arm64  &lt;f89c620b0d6f3422a9be1c84fc827111&gt; /var/containers/Bundle/Application/66BFB77D-3B41-42F2-A283-3F96EB4AD716/xxx.app/xxx</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°crashæ—¥å¿—ä¸­çš„uuidä¸ipaåŒ…ä¸­çš„uuidå¯¹åº”ä¸Šäº†</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f89c620b0d6f3422a9be1c84fc827111</span><br></pre></td></tr></table></figure>

<h4 id="æŸ¥çœ‹-dSYMæ–‡ä»¶çš„UUID"><a href="#æŸ¥çœ‹-dSYMæ–‡ä»¶çš„UUID" class="headerlink" title="æŸ¥çœ‹.dSYMæ–‡ä»¶çš„UUID"></a>æŸ¥çœ‹.dSYMæ–‡ä»¶çš„UUID</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dwarfdump --uuid xxx.app.dSYM</span><br></pre></td></tr></table></figure>

<p>æ‰“å°ç»“æœï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UUID: 464A42BE-DB0F-3DF5-ABA7-F3CC4C4944CF (armv7) xxx.app.dSYM/Contents/Resources/DWARF/xxx</span><br><span class="line">UUID: F89C620B-0D6F-3422-A9BE-1C84FC827111 (arm64) xxx.app.dSYM/Contents/Resources/DWARF/xxx</span><br></pre></td></tr></table></figure>

<h4 id="symbolicatecrash"><a href="#symbolicatecrash" class="headerlink" title="symbolicatecrash"></a>symbolicatecrash</h4><h5 id="è·å–è§£æå·¥å…·symbolicatecrashæ‰€åœ¨ä½ç½®"><a href="#è·å–è§£æå·¥å…·symbolicatecrashæ‰€åœ¨ä½ç½®" class="headerlink" title="è·å–è§£æå·¥å…·symbolicatecrashæ‰€åœ¨ä½ç½®"></a>è·å–è§£æå·¥å…·symbolicatecrashæ‰€åœ¨ä½ç½®</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;Applications&#x2F;Xcode.app&#x2F;Contents&#x2F;SharedFrameworks&#x2F;DVTFoundation.framework&#x2F;Versions&#x2F;A&#x2F;Resources&#x2F;symbolicatecrash</span><br></pre></td></tr></table></figure>

<p>æŒ‰ç…§æ ¼å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">symbolicatecrash .crashæ–‡ä»¶ .dSYMæ–‡ä»¶ &gt;result.log</span><br></pre></td></tr></table></figure>

<p>æ‹¼è£…å‘½ä»¤ï¼Œæ‰§è¡Œå³å¯è·å¾—è§£æç»“æœresult.log</p>
<h5 id="æ‰§è¡Œå‘½ä»¤"><a href="#æ‰§è¡Œå‘½ä»¤" class="headerlink" title="æ‰§è¡Œå‘½ä»¤"></a>æ‰§è¡Œå‘½ä»¤</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Applications/Xcode.app/Contents/SharedFrameworks/DVTFoundation.framework/Versions/A/Resources/symbolicatecrash /Users/mikasa/Documents/Crash/xxx-2020-12-20-212420.ips xxx.app.dSYM &gt;result.log</span><br></pre></td></tr></table></figure>

<p>ç»ˆç«¯å¯èƒ½ä¼šå‡ºç°</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: "DEVELOPER_DIR" is not defined at /Applications/Xcode.app/Contents/SharedFrameworks/DVTFoundation.framework/Versions/A/Resources/symbolicatecrash line 69.</span><br></pre></td></tr></table></figure>

<h5 id="æ‰§è¡Œç»“æœ"><a href="#æ‰§è¡Œç»“æœ" class="headerlink" title="æ‰§è¡Œç»“æœ"></a>æ‰§è¡Œç»“æœ</h5><p>å†æ‰§è¡Œå‘½ä»¤ï¼Œåœ¨ç»ˆç«¯å®Œæˆä»¥åï¼Œåœ¨Crashæ–‡ä»¶å¤¹ä¸­å°±ä¼šå¤šå‡ºä¸€ä¸ªresult.logæ–‡ä»¶ï¼Œå¯ä»¥æŸ¥çœ‹bugçš„å´©æºƒä¿¡æ¯ã€‚</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201221184525739.png" alt="image-20201221184525739"></p>
<h4 id="å¦‚ä½•æ‰¾å›å·²å‘å¸ƒåˆ°App-Storeçš„Appå¯¹åº”çš„dSYMæ–‡ä»¶ï¼Ÿ"><a href="#å¦‚ä½•æ‰¾å›å·²å‘å¸ƒåˆ°App-Storeçš„Appå¯¹åº”çš„dSYMæ–‡ä»¶ï¼Ÿ" class="headerlink" title="å¦‚ä½•æ‰¾å›å·²å‘å¸ƒåˆ°App Storeçš„Appå¯¹åº”çš„dSYMæ–‡ä»¶ï¼Ÿ"></a>å¦‚ä½•æ‰¾å›å·²å‘å¸ƒåˆ°App Storeçš„Appå¯¹åº”çš„dSYMæ–‡ä»¶ï¼Ÿ</h4><h5 id="é€šè¿‡Xcodeæ‰¾å›"><a href="#é€šè¿‡Xcodeæ‰¾å›" class="headerlink" title="é€šè¿‡Xcodeæ‰¾å›"></a>é€šè¿‡Xcodeæ‰¾å›</h5><ul>
<li>æ‰“å¼€ Xcode é¡¶éƒ¨èœå•æ  -&gt; Window -&gt; Organizer çª—å£</li>
<li>æ‰“å¼€ Xcode é¡¶éƒ¨èœå•æ ï¼Œé€‰æ‹© Archive æ ‡ç­¾</li>
<li>æ‰¾åˆ°å‘å¸ƒçš„å½’æ¡£åŒ…ï¼Œå³é”®ç‚¹å‡»å¯¹åº”å½’æ¡£åŒ…ï¼Œé€‰æ‹©Show in Finderæ“ä½œ</li>
<li>å³é”®é€‰æ‹©å®šä½åˆ°çš„å½’æ¡£æ–‡ä»¶ï¼Œé€‰æ‹©æ˜¾ç¤ºåŒ…å†…å®¹æ“ä½œ</li>
<li>é€‰æ‹©dSYMsç›®å½•ï¼Œç›®å½•å†…å³ä¸ºä¸‹è½½åˆ°çš„ dSYM æ–‡ä»¶</li>
</ul>
<h5 id="é€šè¿‡iTunes-Connectæ‰¾å›"><a href="#é€šè¿‡iTunes-Connectæ‰¾å›" class="headerlink" title="é€šè¿‡iTunes Connectæ‰¾å›"></a>é€šè¿‡iTunes Connectæ‰¾å›</h5><ul>
<li>ç™»å½•<a href="https://itunesconnect.apple.com/" target="_blank" rel="noopener">iTunes Connect</a></li>
<li>è¿›å…¥â€œæˆ‘çš„Appï¼ˆMy Appsï¼‰â€çš„â€œæ´»åŠ¨ï¼ˆActivityï¼‰â€é¡µé¢</li>
<li>åœ¨â€œæ‰€æœ‰æ„ä»¶ç‰ˆæœ¬ï¼ˆAll Buildsï¼‰â€ä¸­é€‰æ‹©æŸä¸€ä¸ªç‰ˆæœ¬ï¼Œç‚¹â€œä¸‹è½½dSYMï¼ˆDownload dSYMï¼‰â€ä¸‹è½½dSYMæ–‡ä»¶</li>
</ul>
<h5 id="é€šè¿‡mdfindå·¥å…·æ‰¾å›"><a href="#é€šè¿‡mdfindå·¥å…·æ‰¾å›" class="headerlink" title="é€šè¿‡mdfindå·¥å…·æ‰¾å›"></a>é€šè¿‡mdfindå·¥å…·æ‰¾å›</h5><ul>
<li><p>æŸ¥è¯¢åˆ°crashå¯¹åº”çš„UUID</p>
</li>
<li><p>ç„¶ååœ¨Macçš„Shellä¸­ï¼Œç”¨mdfindå‘½ä»¤å®šä½dSYMæ–‡ä»¶</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdfind "com_apple_xcode_dsym_uuids == &lt;UUID&gt;"</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼Œä½¿ç”¨mdfindæ—¶ï¼ŒUUIDéœ€è¦æ ¼å¼è½¬æ¢ï¼ˆå¢åŠ â€œ-â€ï¼‰ï¼š 12345678-1234-1234-1234-xxxxxxxxxxxx</p>
</blockquote>
</li>
</ul>
<p>ä¾‹å¦‚ï¼Œè¦å®šä½çš„dSYMçš„UUIDä¸ºï¼šf89c620b0d6f3422a9be1c84fc827111 åˆ™å®šä½dSYMæ–‡ä»¶çš„å‘½ä»¤å¦‚ä¸‹:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mdfind "com_apple_xcode_dsym_uuids == F89C620B-0D6F-3422-A9BE-1C84FC827111"</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/12/21/%E6%B5%85%E8%B0%88iOS%E5%9B%BE%E7%89%87%E8%A7%A3%E5%8E%8B%E7%BC%A9%E4%BB%8E%E6%96%87%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%88%B0%E5%B1%8F%E5%B9%95%E7%9A%84%E8%BF%87%E7%A8%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/21/%E6%B5%85%E8%B0%88iOS%E5%9B%BE%E7%89%87%E8%A7%A3%E5%8E%8B%E7%BC%A9%E4%BB%8E%E6%96%87%E4%BB%B6%E6%B8%B2%E6%9F%93%E5%88%B0%E5%B1%8F%E5%B9%95%E7%9A%84%E8%BF%87%E7%A8%8B/" class="post-title-link" itemprop="url">æµ…è°ˆiOSå›¾ç‰‡è§£å‹ç¼©ä»æ–‡ä»¶æ¸²æŸ“åˆ°å±å¹•çš„è¿‡ç¨‹</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-21 14:28:48 / Modified: 14:35:21" itemprop="dateCreated datePublished" datetime="2020-12-21T14:28:48+08:00">2020-12-21</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ¦‚è¿°</p>
<p>å°†ä¸€å¼ å›¾ç‰‡ä»ç£ç›˜ä¸­åŠ è½½å‡ºæ¥ï¼Œå¹¶æœ€ç»ˆæ˜¾ç¤ºåˆ°å±å¹•ä¸Šï¼Œä¸­é—´å…¶å®ç»è¿‡äº†ä¸€ç³»åˆ—å¤æ‚çš„å¤„ç†è¿‡ç¨‹ï¼Œä»æ–‡ä»¶åˆ°å±å¹•ï¼Œå…¶ä¸­åŒ…æ‹¬äº†å¯¹å›¾ç‰‡çš„è§£å‹ç¼©æ“ä½œã€‚</p>
<p><strong>æ¸²æŸ“å›¾ç‰‡åˆ°å±å¹•çš„è¿‡ç¨‹</strong></p>
<p><img src="/Users/mikasa/Desktop/image_mark/16cfbeb484307840.png" alt="16cfbeb484307840"></p>
<p>å¦‚ä¸Šæ‰€ç¤ºï¼Œå›¾ç‰‡æ¸²æŸ“åˆ°å±å¹•ä¸Šï¼Œæ˜¯CPUå’ŒGPUåä½œå®Œæˆçš„ã€‚</p>
<p>CPU/GPUç­‰è¿™æ ·ä¸€æ¬¡æ¸²æŸ“è¿‡ç¨‹ä¸­çš„å…·ä½“åˆ†å·¥ï¼š</p>
<ul>
<li>CPUï¼šè®¡ç®—è§†å›¾frameã€å›¾ç‰‡è§£ç ã€éœ€è¦ç»˜åˆ¶çº¹ç†å›¾ç‰‡é€šè¿‡æ•°æ®æ€»çº¿äº¤ç»™GPU</li>
<li>GPUï¼šçº¹ç†æ··åˆã€é¡¶ç‚¹å˜æ¢ä¸è®¡ç®—</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/12/17/%E7%9F%A5%E8%AF%86%E5%B0%8F%E9%9B%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/17/%E7%9F%A5%E8%AF%86%E5%B0%8F%E9%9B%86/" class="post-title-link" itemprop="url">çŸ¥è¯†å°é›†</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-17 14:01:13" itemprop="dateCreated datePublished" datetime="2020-12-17T14:01:13+08:00">2020-12-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-21 14:27:38" itemprop="dateModified" datetime="2020-12-21T14:27:38+08:00">2020-12-21</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="UIKit"><a href="#UIKit" class="headerlink" title="UIKit"></a>UIKit</h3><h4 id="UIView-å’Œ-CALayerçš„åŒºåˆ«ï¼Ÿ"><a href="#UIView-å’Œ-CALayerçš„åŒºåˆ«ï¼Ÿ" class="headerlink" title="UIView å’Œ CALayerçš„åŒºåˆ«ï¼Ÿ"></a>UIView å’Œ CALayerçš„åŒºåˆ«ï¼Ÿ</h4><ul>
<li>UIViewç»§æ‰¿è‡³UIRespondï¼Œå¯ä»¥å¤„ç†æ‰‹åŠ¿å“åº”äº‹ä»¶ï¼›CALayerç»§æ‰¿è‡³NSObjectï¼Œä¸å¯ä»¥å¤„ç†å¤„ç†å“åº”äº‹ä»¶</li>
<li>UIViewç€é‡äºå†…å®¹ç®¡ç†ï¼ŒCALayerç€é‡äºå†…å®¹ç»˜åˆ¶</li>
<li>UIViewä¸CALayerä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼ŒUIViewçš„æ˜¾ç¤ºä¾èµ–äºCALayerçš„å†…å®¹ï¼ŒCALayerä¾èµ–UIViewçš„å®¹å™¨æ¥ç»˜åˆ¶æ˜¾ç¤ºçš„å†…å®¹</li>
<li>UIViewæ¥è‡ªCALayerï¼Œé«˜äºCALayerï¼Œæ˜¯CALayerçš„é«˜å±‚å±•ç¤ºä¸å°è£…ï¼ŒUIViewçš„ç‰¹æ€§å‡æ¥æ¥è‡ªäºCALayer</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/12/14/%E6%9B%B4%E6%94%B9AppStore%E5%85%AC%E5%8F%B8%E4%BF%A1%E6%81%AF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/14/%E6%9B%B4%E6%94%B9AppStore%E5%85%AC%E5%8F%B8%E4%BF%A1%E6%81%AF/" class="post-title-link" itemprop="url">æ›´æ”¹AppStoreå…¬å¸ä¿¡æ¯</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2020-12-14 15:36:27 / Modified: 16:48:13" itemprop="dateCreated datePublished" datetime="2020-12-14T15:36:27+08:00">2020-12-14</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h4><p>å…¬å¸æ›´æ”¹çš„ä¼ä¸šåç§°ï¼ŒApp Storeä¸­çš„éœ€è¦åŒæ­¥æ›´æ”¹ã€‚</p>
<h4 id="è´¦å·æŒæœ‰è€…"><a href="#è´¦å·æŒæœ‰è€…" class="headerlink" title="è´¦å·æŒæœ‰è€…"></a>è´¦å·æŒæœ‰è€…</h4><p><a href="https://developer.apple.com/account/#/membership" target="_blank" rel="noopener">æŸ¥çœ‹è´¦æˆ·æŒæœ‰è€…</a>ï¼Œåªæœ‰æ˜¯è‹¹æœå¼€å‘è€…è´¦æˆ·æŒæœ‰è€…ï¼Œæ‰ä¼šç»™ä½ ä¿®æ”¹ã€‚</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214154119454.png" alt="image-20201214154119454"></p>
<h4 id="æ›´æ”¹åç§°"><a href="#æ›´æ”¹åç§°" class="headerlink" title="æ›´æ”¹åç§°"></a>æ›´æ”¹åç§°</h4><h5 id="è”ç³»è‹¹æœå®¢æœ"><a href="#è”ç³»è‹¹æœå®¢æœ" class="headerlink" title="è”ç³»è‹¹æœå®¢æœ"></a>è”ç³»è‹¹æœå®¢æœ</h5><p>æ‹¨æ‰“è‹¹æœå¼€å‘è€…(ä¸­å›½)ç”µè¯ 400-670-1855 å‘Šè¯‰å®¢æœä½ è¦æ›´æ”¹å…¬å¸åç§°ï¼Œå¿…é¡»è¦è¯´ä½ æ˜¯ä»£ç†äººã€‚æˆ–è€…ç”¨ä»£ç†äººçš„é‚®ç®±ç›´æ¥å†™é‚®ä»¶ï¼šâ€œæˆ‘éœ€è¦æ›´æ”¹å…¬å¸åç§°â€å‘é€åˆ° <a href="mailto:chinadev@asia.apple.com">chinadev@asia.apple.com</a>ã€‚</p>
<h5 id="æä¾›å…¬å¸ä¿¡æ¯"><a href="#æä¾›å…¬å¸ä¿¡æ¯" class="headerlink" title="æä¾›å…¬å¸ä¿¡æ¯"></a>æä¾›å…¬å¸ä¿¡æ¯</h5><p>ç„¶åå®¢æœä¼šç»™ä½ å‘ä¸€å°é‚®ä»¶ï¼Œé‚®ä»¶ä¸­åŒ…æ‹¬éœ€è¦ä½ æä¾›çš„ä¿¡æ¯å’Œé‚“ç™½æ°çš„è”ç³»æ–¹å¼ã€‚</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214163025028.png" alt="image-20201214163025028"></p>
<p>æä¾›é‚®ä»¶ä¿¡æ¯è¿›è¡Œå›å¤åï¼Œè‹¹æœæ¥ç€ä¼šå›å¤é‚®ä»¶ï¼ˆåŸºæœ¬1ä¸ªå°æ—¶å·¦å³ä¼šæ”¶åˆ°å›å¤ï¼‰</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214163248859.png" alt="image-20201214163248859"></p>
<h5 id="è”ç³»é‚“ç™½æ°"><a href="#è”ç³»é‚“ç™½æ°" class="headerlink" title="è”ç³»é‚“ç™½æ°"></a>è”ç³»é‚“ç™½æ°</h5><p>å› ä¸ºæˆ‘ä»¬éœ€è¦åŒæ—¶å˜æ›´è‹±æ–‡åç§°ï¼Œè‹¹æœè®©æˆ‘ä»¬æ˜¾è”ç³»é‚“ç™½æ°ï¼Œå› ä¸ºä¸€ä¸ªå…¬å¸åªæœ‰ä¸€ä¸ªé‚“ç™½æ°ç¼–ç ï¼Œä¸ºäº†ä¿è¯ï¼Œä½ ç°åœ¨çš„æ–°åç§°å…¬å¸å°†æ²¿ç”¨ä¹‹å‰çš„é‚“ç™½æ°ç ã€‚</p>
<p>ç‚¹å‡»é‚®ä»¶ä¸­é“¾æ¥ï¼Œä¼šç›´æ¥æ¥åˆ°<a href="https://support.dnb.com/?CUST=APPLEDEV" target="_blank" rel="noopener">D-U-N-S</a>ç½‘ç«™ï¼Œå¡«å†™é‚®ç®±ä¿¡æ¯</p>
<blockquote>
<p>æ³¨æ„ï¼šé‚®ç®±åªèƒ½ä½¿ç”¨ä¼ä¸šé‚®ç®±ï¼Œä¸ªäººé‚®ç®±ä¼šç›´æ¥ä¸äºˆé€šè¿‡</p>
</blockquote>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214163825700.png" alt="image-20201214163825700"></p>
<h5 id="è·å–D-U-N-S"><a href="#è·å–D-U-N-S" class="headerlink" title="è·å–D-U-N-S"></a>è·å–D-U-N-S</h5><p><a href="https://developer.apple.com/cn/support/D-U-N-S/" target="_blank" rel="noopener">ç›¸å…³ä¿¡æ¯æŸ¥è¯¢ç½‘ç«™</a></p>
<p><a href="https://developer.apple.com/enroll/duns-lookup/#!/select/complete" target="_blank" rel="noopener">è·å–D-U-N-Sç¼–å·</a></p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214164756200.png" alt="image-20201214164756200"></p>
<blockquote>
<p>æ³¨æ„ï¼šåœ¨è·å–DUNSä¿¡æ¯æ—¶ï¼Œå¡«å†™çš„æ³•äººä»£è¡¨ä¸å¼€å‘è€…è´¦æˆ·ä¸­çš„â€œTeam Nameâ€ä¸€è‡´</p>
</blockquote>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214164225552.png" alt="image-20201214164225552"></p>
<p>æ¥ç€ä¼šæ”¶åˆ°D-U-N-S ç¼–å·é‚®ä»¶</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214164410118.png" alt="image-20201214164410118"></p>
<p>æ ¹æ®D-U-N-S ç¼–å·ï¼Œç»§ç»­å»å¡«å†™Request</p>
<h5 id="å¡«å†™æ›´æ–°ä¿¡æ¯"><a href="#å¡«å†™æ›´æ–°ä¿¡æ¯" class="headerlink" title="å¡«å†™æ›´æ–°ä¿¡æ¯"></a>å¡«å†™æ›´æ–°ä¿¡æ¯</h5><p>é€‰æ‹©æäº¤ç”³è¯·</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214160714384.png" alt="image-20201214160714384"></p>
<p>å¡«å†™å®Œæ¯•</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214161118176.png" alt="image-20201214161118176"></p>
<p>é‚®ç®±ä¼šæ”¶åˆ°é‚®ä»¶</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201214161223146.png" alt="image-20201214161223146"></p>
<p>æ¥ç€å°±æ˜¯ç­‰å¾…é‚“ç™½æ°é‚£è¾¹æ›´æ–°äº†ï¼Œæ›´æ–°å®Œæ¯•åå†è”ç³»è‹¹æœå¼€å‘è€…ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/12/08/iOS%E2%80%94%E2%80%94KVO%E7%9B%B8%E5%85%B3%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/12/08/iOS%E2%80%94%E2%80%94KVO%E7%9B%B8%E5%85%B3%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">iOSâ€”â€”KVOç›¸å…³æ€»ç»“</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-12-08 20:26:57" itemprop="dateCreated datePublished" datetime="2020-12-08T20:26:57+08:00">2020-12-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-11 17:50:28" itemprop="dateModified" datetime="2020-12-11T17:50:28+08:00">2020-12-11</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="KVOæ¦‚è¿°"><a href="#KVOæ¦‚è¿°" class="headerlink" title="KVOæ¦‚è¿°"></a>KVOæ¦‚è¿°</h3><ul>
<li>KVOå…¨ç§°æ˜¯key value observingï¼Œä¿—ç§°â€œé”®å€¼ç›‘å¬/è§‚å¯Ÿâ€ï¼Œæ˜¯è‹¹æœæä¾›çš„ä¸€å¥—äº‹ä»¶é€šçŸ¥æœºåˆ¶ï¼Œå…è®¸ä¸€ä¸ªå¯¹è±¡è§‚å¯Ÿ/ç›‘å¬å¦ä¸€ä¸ªå¯¹è±¡æŒ‡å®šå±æ€§å€¼çš„å˜åŒ–ï¼Œå½“è¢«è§‚å¯Ÿå¯¹è±¡å±æ€§å€¼å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè§¦å‘KVOçš„ç›‘å¬æ–¹æ³•æ¥é€šçŸ¥è§‚å¯Ÿè€…ï¼ŒKVOæ—¶MVCåº”ç”¨ç¨‹åºä¸­çš„å„å±‚ä¹‹å‰è¿›è¡Œé€šä¿¡çš„éå¸¸æœ‰ç”¨çš„æŠ€æœ¯ã€‚</li>
<li>KVO å’Œ NSNotificationéƒ½æ˜¯iosä¸­è§‚å¯Ÿè€…æ¨¡å¼çš„ä¸€ç§å®ç°</li>
<li>KVOå¯ä»¥ç›‘å¬å•ä¸ªå±æ€§çš„å˜åŒ–ï¼Œä¹Ÿå¯ä»¥ç›‘å¬é›†åˆå¯¹è±¡çš„å˜åŒ–ï¼Œç›‘å¬é›†åˆå¯¹è±¡å˜åŒ–æ—¶ï¼Œéœ€è¦é€šè¿‡KVCçš„mutableValueForKey:ç­‰å¯å˜ä»£ç†æ–¹æ³•è·å¾—é›†åˆä»£ç†å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ä»£ç†å¯¹è±¡è¿›è¡Œæ“ä½œï¼Œå½“ä»£ç†å¯¹è±¡çš„å†…éƒ¨å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè§¦å‘KVOçš„ç›‘å¬æ–¹æ³•ã€‚é›†åˆå¯¹è±¡åŒ…å«NSArray å’Œ NSSetã€‚</li>
</ul>
<h3 id="KVOçš„åŸºæœ¬ä½¿ç”¨"><a href="#KVOçš„åŸºæœ¬ä½¿ç”¨" class="headerlink" title="KVOçš„åŸºæœ¬ä½¿ç”¨"></a>KVOçš„åŸºæœ¬ä½¿ç”¨</h3><p>KVOä½¿ç”¨æ­¥éª¤ï¼šæ·»åŠ /æ³¨å†ŒKVOç›‘å¬ã€å®ç°ç›‘å¬æ–¹æ³•ä»¥æ¥å—å±æ€§å˜åŒ–é€šçŸ¥ã€ç§»é™¤KVOç›‘å¬</p>
<ol>
<li><p>è°ƒç”¨æ–¹æ³•ç»™è¢«è§‚å¯Ÿå¯¹è±¡æ·»åŠ è§‚å¯Ÿè€…</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSArray æ·»åŠ </span></span><br><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer toObjectsAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes forKeyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure>
</li>
<li><p>åœ¨è§‚å¯Ÿè€…ç±»ä¸­å®ç°æ–¹æ³•ä»¥æ¥å—å±æ€§å˜åŒ–çš„é€šçŸ¥æ¶ˆæ¯</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="keyword">nullable</span> <span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">nullable</span> <span class="keyword">id</span>)object change:(<span class="keyword">nullable</span> <span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>, <span class="keyword">id</span>&gt; *)change context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å½“è§‚å¯Ÿè€…ä¸éœ€è¦å†ç›‘å¬æ—¶ï¼Œè°ƒç”¨æ–¹æ³•å°†è§‚å¯Ÿè€…ç§»é™¤ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè‡³å°‘åœ¨è§‚å¯Ÿè€…é”€æ¯ä¹‹å‰ï¼Œè¿›è¡Œç§»é™¤ï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´Crash</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>));</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NSArray ç§»é™¤</span></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer fromObjectsAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>));</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer fromObjectsAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="æ³¨å†Œæ–¹æ³•"><a href="#æ³¨å†Œæ–¹æ³•" class="headerlink" title="æ³¨å†Œæ–¹æ³•"></a>æ³¨å†Œæ–¹æ³•</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// æ³¨å†Œè§‚å¯Ÿè€…</span></span><br><span class="line"><span class="comment">/// @param observer è§‚å¯Ÿè€…å¯¹è±¡</span></span><br><span class="line"><span class="comment">/// @param keyPath è§‚å¯Ÿå¯¹è±¡å±æ€§è·¯å¾„</span></span><br><span class="line"><span class="comment">/// @param options</span></span><br><span class="line"><span class="comment">///     NSKeyValueObservingOptionNew è§‚å¯Ÿæ–°å€¼</span></span><br><span class="line"><span class="comment">///     NSKeyValueObservingOptionOld è§‚å¯Ÿæ—§å€¼</span></span><br><span class="line"><span class="comment">///     NSKeyValueObservingOptionInitial è§‚å¯Ÿåˆå§‹å€¼ï¼ˆå¦‚æœæƒ³åœ¨æ³¨å†Œè§‚å¯Ÿè€…åç«‹å³æ”¶åˆ°ä¸€æ¬¡é€šçŸ¥ï¼Œå¯ä»¥åŠ å…¥æ­¤å€¼ï¼‰</span></span><br><span class="line"><span class="comment">///     NSKeyValueObservingOptionPrior åˆ†åˆ«åœ¨å€¼æ”¹å˜å‰åè§¦å‘æ–¹æ³•ï¼ˆå³ä¸€æ¬¡ä¿®æ”¹æœ‰ä¸¤æ¬¡è§¦å‘ï¼‰</span></span><br><span class="line"><span class="comment">/// @param context  å¯ä»¥ä¼ å…¥ä»»æ„æ•°æ®ï¼ˆä»»æ„ç±»å‹çš„å¯¹è±¡æˆ–è€…CæŒ‡é’ˆï¼‰ï¼Œåœ¨ç›‘å¬æ–¹æ³•ä¸­å¯ä»¥æ¥æ”¶åˆ°è¿™ä¸ªæ•°æ®ï¼Œæ˜¯KVOä¸­çš„ä¸€ç§ä¼ å€¼æ–¹å¼ï¼Œ</span></span><br><span class="line"><span class="comment">///                 å¦‚æœä¼ çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»åœ¨ç§»é™¤è§‚å¯Ÿä¹‹å‰æŒæœ‰å®ƒçš„å¼ºå¼•ç”¨ï¼Œå¦åˆ™åœ¨ç›‘å¬æ–¹æ³•ä¸­è®¿é—®contextå°±å¯èƒ½å¯¼è‡´Crash</span></span><br><span class="line">- (<span class="keyword">void</span>)addObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="keyword">nullable</span> <span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure>

<h4 id="ç›‘å¬æ–¹æ³•"><a href="#ç›‘å¬æ–¹æ³•" class="headerlink" title="ç›‘å¬æ–¹æ³•"></a>ç›‘å¬æ–¹æ³•</h4><p>å¦‚æœå¯¹è±¡è¢«æ³¨å†Œæˆä¸ºè§‚å¯Ÿè€…ï¼Œåˆ™è¯¥å¯¹è±¡å¿…é¡»èƒ½å“åº”ä¸€ä¸‹ç›‘å¬æ–¹æ³•ï¼Œå³è¯¥å¯¹è±¡æ‰€å±ç±»ä¸­å¿…é¡»å®ç°ç›‘å¬æ–¹æ³•ã€‚å½“è¢«è§‚å¯Ÿå¯¹è±¡å±æ€§å‘ç”Ÿæ”¹å˜æ—¶ä¼šè°ƒç”¨ç›‘å¬æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰å®ç°åˆ™ä¼šCrashã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// ç›‘å¬æ–¹æ³•</span></span><br><span class="line"><span class="comment">/// @param keyPath è§‚å¯Ÿå¯¹è±¡å±æ€§è·¯å¾„</span></span><br><span class="line"><span class="comment">/// @param object è§‚å¯Ÿå¯¹è±¡</span></span><br><span class="line"><span class="comment">/// @param change</span></span><br><span class="line"><span class="comment">/// å­—å…¸ NSDictionary&lt;NSKeyValueChangeKey, id&gt;ï¼Œå±æ€§å€¼æ›´æ”¹çš„è¯¦ç»†ä¿¡æ¯ï¼Œæ ¹æ®æ³¨å†Œæ–¹æ³•ä¸­optionså‚æ•°ä¼ å…¥çš„æšä¸¾æ¥è¿”å›</span></span><br><span class="line"><span class="comment">/// keyä¸º NSKeyValueChangeKey æšä¸¾ç±»å‹</span></span><br><span class="line"><span class="comment">/// &#123;</span></span><br><span class="line"><span class="comment">/// 1.NSKeyValueChangeKindKeyï¼šå­˜å‚¨æœ¬æ¬¡æ”¹å˜çš„ä¿¡æ¯ï¼ˆchangeå­—å…¸ä¸­é»˜è®¤åŒ…å«è¿™ä¸ªkeyï¼‰</span></span><br><span class="line"><span class="comment">/// &#123;</span></span><br><span class="line"><span class="comment">/// å¯¹åº”æšä¸¾ç±»å‹ NSKeyValueChange</span></span><br><span class="line"><span class="comment">///     typedef NS_ENUM(NSUInteger, NSKeyValueChange) &#123;</span></span><br><span class="line"><span class="comment">///         NSKeyValueChangeSetting     = 1,</span></span><br><span class="line"><span class="comment">///         NSKeyValueChangeInsertion   = 2,</span></span><br><span class="line"><span class="comment">///         NSKeyValueChangeRemoval     = 3,</span></span><br><span class="line"><span class="comment">///         NSKeyValueChangeReplacement = 4</span></span><br><span class="line"><span class="comment">///&#125;;</span></span><br><span class="line"><span class="comment">/// å¦‚æœæ˜¯å¯¹è¢«è§‚å¯Ÿå¯¹è±¡å±æ€§ï¼ˆåŒ…æ‹¬é›†åˆï¼‰è¿›è¡Œèµ‹å€¼æ“ä½œï¼Œkind å­—æ®µçš„å€¼ä¸º NSKeyValueChangeSetting</span></span><br><span class="line"><span class="comment">/// å¦‚æœè¢«è§‚å¯Ÿçš„æ˜¯é›†åˆå¯¹è±¡ï¼Œä¸”è¿›è¡Œçš„æ˜¯ï¼ˆæ’å…¥ã€åˆ é™¤ã€æ›¿æ¢ï¼‰æ“ä½œï¼Œåˆ™ä¼šæ ¹æ®é›†åˆå¯¹è±¡çš„æ“ä½œæ–¹å¼æ¥è®¾ç½® kind å­—æ®µçš„å€¼</span></span><br><span class="line"><span class="comment">/// æ’å…¥ï¼šNSKeyValueChangeInsertion</span></span><br><span class="line"><span class="comment">/// åˆ é™¤ï¼šNSKeyValueChangeRemoval</span></span><br><span class="line"><span class="comment">/// æ›¿æ¢ï¼šNSKeyValueChangeReplacement</span></span><br><span class="line"></span><br><span class="line"><span class="comment">///&#125;</span></span><br><span class="line"><span class="comment">/// 2.NSKeyValueChangeNewKeyï¼šå­˜å‚¨æ–°å€¼ï¼ˆå¦‚æœoptionsä¸­ä¼ å…¥NSKeyValueObservingOptionNewï¼Œchangeå­—å…¸ä¸­å°±ä¼šåŒ…å«è¿™ä¸ªkeyï¼‰</span></span><br><span class="line"><span class="comment">/// 3.NSKeyValueChangeOldKeyï¼šå­˜å‚¨æ—§å€¼ï¼ˆå¦‚æœoptionsä¸­ä¼ å…¥NSKeyValueObservingOptionOldï¼Œchangeå­—å…¸ä¸­å°±ä¼šåŒ…å«è¿™ä¸ªkeyï¼‰</span></span><br><span class="line"><span class="comment">/// 4.NSKeyValueChangeIndexesKeyï¼šå¦‚æœè¢«è§‚å¯Ÿçš„æ˜¯é›†åˆå¯¹è±¡ï¼Œä¸”è¿›è¡Œçš„æ˜¯ï¼ˆæ’å…¥ã€åˆ é™¤ã€æ›¿æ¢ï¼‰æ“ä½œï¼Œåˆ™changeå­—å…¸ä¸­å°±ä¼šåŒ…å«è¿™ä¸ªkeyï¼Œ</span></span><br><span class="line"><span class="comment">/// è¿™ä¸ªkeyçš„valueæ˜¯ä¸€ä¸ªNSIndexSetå¯¹è±¡ï¼ŒåŒ…å«æ›´æ”¹å…³ç³»ä¸­çš„ç´¢å¼•</span></span><br><span class="line"><span class="comment">/// 5.NSKeyValueChangeNotificationIsPriorKeyï¼šå¦‚æœoptionsä¸­ä¼ å…¥NSKeyValueObservingOptionPriorï¼Œåˆ™åœ¨æ”¹å˜å‰é€šçŸ¥çš„changeå­—å…¸ä¸­ä¼šåŒ…å«è¿™ä¸ªkeyã€‚</span></span><br><span class="line"><span class="comment">/// è¿™ä¸ªkeyå¯¹åº”çš„valueæ˜¯NSNumberåŒ…è£…çš„YESï¼Œæˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥åˆ¤æ–­æ˜¯ä¸æ˜¯åœ¨æ”¹å˜å‰çš„é€šçŸ¥[change[NSKeyValueChangeNotificationIsPriorKey] boolValue] == YES]</span></span><br><span class="line"><span class="comment">/// @param context æ³¨å†Œæ–¹æ³•ä¸­ä¼ å…¥çš„context</span></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure>

<h4 id="ç§»é™¤æ–¹æ³•"><a href="#ç§»é™¤æ–¹æ³•" class="headerlink" title="ç§»é™¤æ–¹æ³•"></a>ç§»é™¤æ–¹æ³•</h4><p>åœ¨è°ƒç”¨æ³¨å†Œæ–¹æ³•åï¼ŒKVOä¸ä¼šå¯¹è§‚å¯Ÿè€…è¿›è¡Œå¼ºå¼•ç”¨ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„è§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸï¼Œè‡³å°‘éœ€è¦åœ¨è§‚å¯Ÿè€…é”€æ¯ä¹‹è°¦ï¼Œè°ƒç”¨ç§»é™¤ç›‘å¬æ–¹æ³•ï¼Œå¦åˆ™åœ¨è§‚å¯Ÿè€…è¢«é‡Šæ”¾åï¼Œå†æ¬¡è§¦å‘KVOç›‘å¬æ–¹æ³•å°±ä¼šCrashã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/// ç§»é™¤è§‚å¯Ÿè€…</span></span><br><span class="line"><span class="comment">/// @param observer è§‚å¯Ÿå¯¹è±¡</span></span><br><span class="line"><span class="comment">/// @param keyPath è§‚å¯Ÿå¯¹è±¡è·¯å¾„</span></span><br><span class="line"><span class="comment">/// @param context æ³¨å†Œä¼ å…¥çš„context</span></span><br><span class="line">- (<span class="keyword">void</span>)removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath context:(<span class="keyword">void</span> *)context;</span><br></pre></td></tr></table></figure>

<h4 id="ä¸¾ä¸ªğŸŒ°"><a href="#ä¸¾ä¸ªğŸŒ°" class="headerlink" title="ä¸¾ä¸ªğŸŒ°"></a>ä¸¾ä¸ªğŸŒ°</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)add_newKey_kvo &#123;</span><br><span class="line">    [<span class="keyword">self</span>.person addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"name"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionInitial</span> context:<span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context; &#123;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@--%@--%@--%@"</span>,keyPath,object,change,context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>======Log======</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">15</span>:<span class="number">57</span>:<span class="number">49</span>] -[MMKVO observeValueForKeyPath:ofObject:change:context:] [ç¬¬<span class="number">61</span>è¡Œ] ğŸ’• name--&lt;MMKVOPerson: <span class="number">0x600002a04100</span>&gt;--&#123;</span><br><span class="line">    kind = <span class="number">1</span>;</span><br><span class="line">    new = <span class="string">"&lt;null&gt;"</span>;</span><br><span class="line">&#125;--(null)</span><br><span class="line"></span><br><span class="line">[<span class="number">15</span>:<span class="number">57</span>:<span class="number">49</span>] -[MMKVO observeValueForKeyPath:ofObject:change:context:] [ç¬¬<span class="number">61</span>è¡Œ] ğŸ’• name--&lt;MMKVOPerson: <span class="number">0x600002a04100</span>&gt;--&#123;</span><br><span class="line">    kind = <span class="number">1</span>;</span><br><span class="line">    new = <span class="number">123</span>;</span><br><span class="line">&#125;--(null)</span><br></pre></td></tr></table></figure>

<h4 id="å®é™…åº”ç”¨"><a href="#å®é™…åº”ç”¨" class="headerlink" title="å®é™…åº”ç”¨"></a>å®é™…åº”ç”¨</h4><p>KVOä¸»è¦ç”¨æ¥åšé”®å€¼è§‚å¯Ÿæ“ä½œï¼Œæƒ³è¦ä¸€ä¸ªå€¼å‘ç”Ÿæ”¹å˜åé€šçŸ¥å¦ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™ç”¨KVOå®ç°æœ€ä¸ºåˆé€‚ã€‚</p>
<p>View-Model-Controllerä¹‹é—´æ•°æ®ä¼ é€’</p>
<h4 id="KVOè§¦å‘ç›‘å¬æ–¹æ³•çš„æ–¹å¼"><a href="#KVOè§¦å‘ç›‘å¬æ–¹æ³•çš„æ–¹å¼" class="headerlink" title="KVOè§¦å‘ç›‘å¬æ–¹æ³•çš„æ–¹å¼"></a>KVOè§¦å‘ç›‘å¬æ–¹æ³•çš„æ–¹å¼</h4><p>KVOè§¦å‘åˆ†ä¸ºæ‰‹åŠ¨è§¦å‘å’Œè‡ªåŠ¨è§¦å‘</p>
<h5 id="è‡ªåŠ¨è§¦å‘"><a href="#è‡ªåŠ¨è§¦å‘" class="headerlink" title="è‡ªåŠ¨è§¦å‘"></a>è‡ªåŠ¨è§¦å‘</h5><ul>
<li>å¦‚æœæ˜¯ç›‘å¬å¯¹è±¡ç‰¹å®šå±æ€§å€¼çš„æ”¹å˜ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼æ”¹å˜å±æ€§å€¼ä¼šè§¦å‘KVOï¼›<ol>
<li>ä½¿ç”¨ç‚¹è¯­æ³•</li>
<li>ä½¿ç”¨setteræ–¹æ³•</li>
<li>ä½¿ç”¨KVCçš„setValue:ForKey:æ–¹æ³•ï¼ˆkeyä¸º<code>&lt;key&gt;</code>ï¼Œ<code>_&lt;key&gt;</code>ä¸ä¼šè§¦å‘ï¼‰</li>
<li>ä½¿ç”¨KVCçš„setValue:ForKeyPath:æ–¹æ³•ï¼ˆkeyä¸º<code>&lt;key&gt;</code>ï¼Œ<code>_&lt;key&gt;</code>ä¸ä¼šè§¦å‘ï¼‰</li>
</ol>
</li>
<li>å¦‚æœæ˜¯ç›‘å¬é›†åˆå¯¹è±¡çš„æ”¹å˜ï¼Œéœ€è¦é€šè¿‡KVCçš„mutableArrayValueForKey:ç­‰æ–¹æ³•è·å–ä»£ç†å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ä»£ç†å¯¹è±¡è¿›è¡Œæ“ä½œï¼Œå½“ä»£ç†å¯¹è±¡çš„å†…éƒ¨å¯¹è±¡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¼šè§¦å‘KVOã€‚é›†åˆå¯¹è±¡åŒ…å«NSArray å’Œ NSSetã€‚</li>
</ul>
<h5 id="æ‰‹åŠ¨è§¦å‘"><a href="#æ‰‹åŠ¨è§¦å‘" class="headerlink" title="æ‰‹åŠ¨è§¦å‘"></a>æ‰‹åŠ¨è§¦å‘</h5><ul>
<li><p>æ™®é€šå¯¹è±¡å±æ€§æˆ–æ˜¯æˆå‘˜å˜é‡ä½¿ç”¨</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)willChangeValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)didChangeValueForKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>
</li>
<li><p>NSArrayã€NSSetå¯¹è±¡ä½¿ç”¨</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)willChange:(<span class="built_in">NSKeyValueChange</span>)changeKind valuesAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)didChange:(<span class="built_in">NSKeyValueChange</span>)changeKind valuesAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes forKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="KVOçš„è¿›é˜¶ä½¿ç”¨"><a href="#KVOçš„è¿›é˜¶ä½¿ç”¨" class="headerlink" title="KVOçš„è¿›é˜¶ä½¿ç”¨"></a>KVOçš„è¿›é˜¶ä½¿ç”¨</h3><h4 id="observationInfoå±æ€§"><a href="#observationInfoå±æ€§" class="headerlink" title="observationInfoå±æ€§"></a>observationInfoå±æ€§</h4><ul>
<li><code>observationInfo</code>å±æ€§æ˜¯<code>NSKeyValueObserving.h</code>æ–‡ä»¶ä¸­ç³»ç»Ÿé€šè¿‡åˆ†ç±»ç»™<code>NSObject</code>æ·»åŠ çš„å±æ€§ï¼Œæ‰€ä»¥æ‰€æœ‰ç»§æ‰¿äº<code>NSObject</code>çš„å¯¹è±¡éƒ½å«æœ‰è¯¥å±æ€§ï¼›</li>
<li>å¯ä»¥é€šè¿‡<code>observationInfo</code>å±æ€§æŸ¥çœ‹è¢«è§‚å¯Ÿå¯¹è±¡çš„å…¨éƒ¨è§‚å¯Ÿä¿¡æ¯ï¼ŒåŒ…æ‹¬<code>observer</code>ã€<code>keyPath</code>ã€<code>options</code>ã€<code>context</code>ç­‰ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@property (nullable) void *observationInfo NS_RETURNS_INNER_POINTER;</span><br></pre></td></tr></table></figure>

<h4 id="contextçš„ä½¿ç”¨"><a href="#contextçš„ä½¿ç”¨" class="headerlink" title="contextçš„ä½¿ç”¨"></a>contextçš„ä½¿ç”¨</h4><p>æ³¨å†Œæ–¹æ³•addObserver:forKey:options:context:ä¸­contextå¯ä»¥ä¼ å…¥ä»»æ„æ•°æ®ï¼Œå¹¶ä¸”å¯ä»¥åœ¨ç›‘å¬æ–¹æ³•ä¸­æ¥æ”¶åˆ°è¿™ä¸ªæ•°æ®ã€‚</p>
<ul>
<li><p>contextå·¦å³ï¼šæ ‡ç­¾ï¼Œå¯ä»¥æ›´ç²¾ç¡®çš„ç¡®å®šè¢«è§‚å¯Ÿå¯¹è±¡å±æ€§ï¼Œç”¨äºç»§æ‰¿ã€å¤šç›‘å¬ï¼›ä¹Ÿå¯ç”¨äºä¼ å€¼</p>
<p>KVOåªæœ‰ä¸€ä¸ªç›‘å¬å›è°ƒæ–¹æ³•<code>observeValueForKeyPath:ofObject:change:context:</code>ï¼Œæˆ‘ä»¬é€šå¸¸æƒ…å†µä¸‹å¯ä»¥åœ¨æ³¨å†Œæ–¹æ³•ä¸­æŒ‡å®šcontextä¸ºNULLï¼Œå¹¶åœ¨ç›‘å¬æ–¹æ³•ä¸­é€šè¿‡object å’Œ keyPathæ¥åˆ¤æ–­è§¦å‘KVOçš„æ¥æº</p>
<p>ä½†æ˜¯å¦‚æœå­˜åœ¨ç»§æ‰¿çš„æƒ…å†µï¼Œå­ç±»å’Œçˆ¶ç±»éƒ½å¯¹åŒä¸€ä¸ªå±æ€§è¿›è¡Œäº†è§‚å¯Ÿï¼Œå½“å±æ€§å˜åŒ–æ—¶å€™ç”±è°æ¥è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡contextå°±èƒ½å¾ˆå¥½çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåœ¨æ³¨å†Œæ–¹æ³•ä¸­ä¸ºcontextè®¾ç½®ä¸€ä¸ªç‹¬ç«‹æ— äºŒçš„å€¼ï¼Œç„¶ååœ¨ç›‘å¬æ–¹æ³•ä¸­å¯¹contextè¿›è¡Œæ ¡éªŒå³å¯</p>
</li>
<li><p>è‹¹æœæ¨èç”¨æ³•ï¼šç”¨contextæ¥å‡†ç¡®çš„ç¼ºç‚¹è¢«è§‚å¯Ÿå¯¹è±¡å±æ€§ï¼Œä½¿ç”¨å”¯ä¸€å‘½åçš„é™æ€å˜é‡åœ°å€ä½œä¸ºcontextçš„å€¼ã€‚å¯ä»¥ä¸ºæ•´ä¸ªç±»è®¾ç½®ä¸€ä¸ªcontextï¼Œç„¶ååœ¨ç›‘å¬æ–¹æ³•ä¸­é€šè¿‡object å’Œ keypathæ¥ç¡®å®šè¢«è§‚å¯Ÿå±æ€§ï¼Œè¿™æ ·å­˜åœ¨ç»§æ‰¿çš„æƒ…å†µå°±å¯ä»¥é€šè¿‡contextæ¥åˆ¤æ–­ï¼Œä¹Ÿå¯ä»¥ä¸ºæ¯ä¸ªè¢«è§‚å¯Ÿå¯¹è±¡æ•°é‡è®¾ç½®ä¸åŒçš„contextï¼Œè¿™æ ·ä½¿ç”¨contextå°±èƒ½ç²¾ç¡®çš„ç¡®å®šè¢«è§‚å¯Ÿå¯¹è±¡å±æ€§ã€‚</p>
</li>
</ul>
<p>ä»¥SDWebImageæºç ä¸ºä¾‹ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> * SDMemoryCacheContext = &amp;SDMemoryCacheContext;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨å†Œç›‘å¬</span></span><br><span class="line">[config addObserver:<span class="keyword">self</span> forKeyPath:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(maxMemoryCost)) options:<span class="number">0</span> context:SDMemoryCacheContext];</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSKeyValueChangeKey</span>,<span class="keyword">id</span>&gt; *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="keyword">if</span> (context == SDMemoryCacheContext) &#123;</span><br><span class="line">        <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(maxMemoryCost))]) &#123;</span><br><span class="line">            <span class="keyword">self</span>.totalCostLimit = <span class="keyword">self</span>.config.maxMemoryCost;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> ([keyPath isEqualToString:<span class="built_in">NSStringFromSelector</span>(<span class="keyword">@selector</span>(maxMemoryCount))]) &#123;</span><br><span class="line">            <span class="keyword">self</span>.countLimit = <span class="keyword">self</span>.config.maxMemoryCount;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> observeValueForKeyPath:keyPath ofObject:object change:change context:context];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>contextä¼˜ç‚¹ï¼šåµŒå¥—å°‘ï¼Œæ€§èƒ½é«˜ï¼Œæ›´å®‰å…¨ã€æ‰©å±•æ€§å¼º</li>
<li>contextæ³¨æ„ç‚¹ï¼š<ol>
<li>å¦‚æœä¼ çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»åœ¨ç§»é™¤è§‚å¯Ÿä¹‹å‰æŒæœ‰å®ƒçš„å¼ºå¼•ç”¨ï¼Œå¦åˆ™åœ¨ç›‘å¬æ–¹æ³•ä¸­è®¿é—®<code>context</code>å°±å¯èƒ½Crash</li>
<li>ç©ºä¼ NULL è€Œä¸åº”è¯¥ä¼ nil</li>
</ol>
</li>
</ul>
<p>ç›´æ¥å‡ºç°Crash</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MMKVOPerson *person = [MMKVOPerson new];</span><br><span class="line">person.name = <span class="string">@"person"</span>;</span><br><span class="line">[<span class="keyword">self</span>.person addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"name"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> | <span class="built_in">NSKeyValueObservingOptionInitial</span> context:(__bridge <span class="keyword">void</span> * _Nullable)(person)];</span><br><span class="line"></span><br><span class="line">Thread <span class="number">1</span>: EXC_BAD_ACCESS (code=<span class="number">1</span>, address=<span class="number">0x64b6f2e7498c</span>)</span><br></pre></td></tr></table></figure>

<h4 id="KVOçš„è‡ªåŠ¨è§¦å‘æ§åˆ¶"><a href="#KVOçš„è‡ªåŠ¨è§¦å‘æ§åˆ¶" class="headerlink" title="KVOçš„è‡ªåŠ¨è§¦å‘æ§åˆ¶"></a>KVOçš„è‡ªåŠ¨è§¦å‘æ§åˆ¶</h4><p>é€šè¿‡åœ¨è¢«è§‚å¯Ÿå¯¹è±¡çš„ç±»ä¸­é‡å†™<code>automaticallyNotifiesObserversForKey:</code>æ–¹æ³•æ¥æ§åˆ¶<code>KVO</code>çš„è‡ªåŠ¨è§¦å‘ï¼Œé€šè¿‡æ§åˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åªè®©å¤–ç•Œè§‚å¯Ÿç±»ä¸­çš„æŸäº›å±æ€§çš„å˜åŒ–</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key &#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"name"</span>]) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[<span class="number">20</span>:<span class="number">03</span>:<span class="number">19</span>] -[MMKVO observeValueForKeyPath:ofObject:change:context:] [ç¬¬<span class="number">108</span>è¡Œ] ğŸ’• name--&lt;MMKVOPerson: <span class="number">0x600000e28dd0</span>&gt;--&#123;</span><br><span class="line">    kind = <span class="number">1</span>;</span><br><span class="line">    new = <span class="string">"&lt;null&gt;"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä½†æ˜¯å¯¹äºæ³¨å†Œç›‘å¬<code>option</code>åŒ…å«çš„<code>NSKeyValueObservingOptionInitial</code>çš„è§‚å¯Ÿå¯¹è±¡ï¼Œä¼šåœ¨æ³¨å†Œè§‚å¯Ÿè€…åç«‹å³æ”¶åˆ°ä¸€æ¬¡é€šçŸ¥ã€‚</p>
<p>ä¹Ÿå¯ä»¥å®ç°éµå¾ªå‘½åè§„åˆ™ä¸º<code>+ (BOOL)automaticallyNotifiesObserversOf&lt;Key&gt;</code>çš„æ–¹æ³•æ¥å•ä¸€æ§åˆ¶å±æ€§çš„KVOè‡ªåŠ¨è§¦å‘ï¼Œ<code>&lt;key&gt;</code>ä¸ºå±æ€§åï¼ˆé¦–å­—æ¯å¤§å†™ï¼‰ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversOfName;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>ç¬¬ä¸€ä¸ªæ–¹æ³•çš„ä¼˜å…ˆçº§é«˜äºç¬¬äºŒä¸ªæ–¹æ³•ã€‚å¦‚æœå®ç°äº†<code>automaticallyNotifiesObserversForKey:</code>æ–¹æ³•ï¼Œå¹¶å¯¹<code>&lt;key&gt;</code>åšäº†å¤„ç†ï¼Œåˆ™ç³»ç»Ÿä¸ä¼šå†è°ƒç”¨ <code>&lt;key&gt;</code>çš„<code>automaticallyNotifiesObserversOf&lt;Key&gt;</code></li>
<li>optionsæŒ‡å®šçš„<code>NSKeyValueObservingOptionInitial</code>è§¦å‘çš„<code>KVO</code>é€šçŸ¥ï¼Œæ˜¯æ— æ³•è¢«<code>automaticallyNotifiesObserversForKey:</code>é˜»æ­¢</li>
</ul>
</blockquote>
<h4 id="KVOçš„æ‰‹åŠ¨è§¦å‘"><a href="#KVOçš„æ‰‹åŠ¨è§¦å‘" class="headerlink" title="KVOçš„æ‰‹åŠ¨è§¦å‘"></a>KVOçš„æ‰‹åŠ¨è§¦å‘</h4><h5 id="ä½¿ç”¨åœºæ™¯"><a href="#ä½¿ç”¨åœºæ™¯" class="headerlink" title="ä½¿ç”¨åœºæ™¯"></a>ä½¿ç”¨åœºæ™¯</h5><ul>
<li>ä½¿ç”¨KVOç›‘å¬æˆå‘˜å˜é‡å€¼çš„æ”¹å˜ï¼›</li>
<li>åœ¨æŸäº›éœ€è¦æ§åˆ¶ç›‘å¬è¿‡ç¨‹çš„åœºæ™¯ä¸‹ï¼š<ol>
<li>ä¸ºäº†å°½é‡å‡å°‘ä¸å¿…è¦çš„è§¦å‘é€šçŸ¥æ“ä½œ</li>
<li>å½“å¤šä¸ªæ›´æ”¹åŒæ—¶å…·å¤‡çš„æ—¶å€™æ‰è°ƒç”¨å±æ€§æ”¹å˜çš„ç›‘å¬æ–¹æ³•</li>
</ol>
</li>
</ul>
<h5 id="è§¦å‘æ–¹å¼"><a href="#è§¦å‘æ–¹å¼" class="headerlink" title="è§¦å‘æ–¹å¼"></a>è§¦å‘æ–¹å¼</h5><ul>
<li>ç”±äºKVOçš„æœ¬è´¨ï¼Œé‡å†™setteræ–¹æ³•æ¥è¾¾åˆ°å¯ä»¥é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡çš„ç›®çš„ï¼Œæ‰€ä»¥åªæœ‰é€šè¿‡setteræ–¹æ³•æˆ–è€…KVCæ–¹æ³•å»ä¿®æ”¹å±æ€§å˜é‡å€¼çš„æ—¶å€™ï¼Œæ‰ä¼šè§¦å‘KVOï¼Œç›´æ¥ä¿®æ”¹æˆå‘˜å˜é‡æ˜¯ä¸ä¼šè§¦å‘KVOã€‚</li>
<li>å½“æˆ‘ä»¬è¦ä½¿ç”¨KVOç›‘å¬æˆå‘˜å˜é‡å€¼æ”¹å˜çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡åœ¨ä¸ºæˆå‘˜å˜é‡èµ‹å€¼çš„å‰åæ‰‹åŠ¨è°ƒç”¨willChangeValueForKey: å’Œ didChangeValueForKey:ä¸¤ä¸ªæ–¹æ³•æ¥æ‰‹åŠ¨è§¦å‘KVOã€‚</li>
<li>NSKeyValueObservingOptionPriorï¼ˆåˆ†åˆ«åœ¨å€¼æ”¹å˜å‰åè§¦å‘æ–¹æ³•ï¼Œå³ä¸€æ¬¡ä¿®æ”¹æœ‰ä¸¤æ¬¡è§¦å‘ï¼‰ï¼Œä¸¤æ¬¡è§¦å‘åˆ†åˆ«åœ¨willChangeValueForKey: å’Œ didChangeValueForKey:çš„æ—¶å€™è¿›è¡Œã€‚</li>
<li>å¦‚æœæ³¨å†Œæ–¹æ³•ä¸­optionsä¼ å…¥NSKeyValueObservingOptionPriorï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡å€¼è°ƒç”¨willChangeValueForKey:æ¥è§¦å‘æ”¹å˜å‰çš„é‚£æ¬¡KVOï¼Œå¯ä»¥ç”¨äºåœ¨å±æ€§å³å°†æ”¹å˜æ—¶åšä¸€äº›æ“ä½œã€‚</li>
</ul>
<h4 id="KVOæ–°æ—§å€¼ç›¸ç­‰æ—¶ä¸è§¦å‘"><a href="#KVOæ–°æ—§å€¼ç›¸ç­‰æ—¶ä¸è§¦å‘" class="headerlink" title="KVOæ–°æ—§å€¼ç›¸ç­‰æ—¶ä¸è§¦å‘"></a>KVOæ–°æ—§å€¼ç›¸ç­‰æ—¶ä¸è§¦å‘</h4><p>æ§åˆ¶KVOç›‘å¬çš„å±æ€§å€¼ä¿®æ”¹å‰åç›¸ç­‰æ—¶ï¼Œä¸è§¦å‘KVOçš„ç›‘å¬æ–¹æ³•ï¼Œå¯ä»¥ç»“åˆè‡ªåŠ¨è§¦å‘å’Œæ‰‹åŠ¨è§¦å‘æ¥å®ç°ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">BOOL</span>)automaticallyNotifiesObserversForKey:(<span class="built_in">NSString</span> *)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">BOOL</span> automatic = <span class="literal">YES</span>;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"name"</span>]) &#123;</span><br><span class="line">        automatic = <span class="literal">NO</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        automatic = [<span class="keyword">super</span> automaticallyNotifiesObserversForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> automatic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)setName:(<span class="built_in">NSString</span> *)name</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (![_name isEqualToString:name]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"name"</span>];</span><br><span class="line">        _name = name;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"name"</span>];</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ‰‹åŠ¨è§‚å¯Ÿé›†åˆå±æ€§"><a href="#æ‰‹åŠ¨è§‚å¯Ÿé›†åˆå±æ€§" class="headerlink" title="æ‰‹åŠ¨è§‚å¯Ÿé›†åˆå±æ€§"></a>æ‰‹åŠ¨è§‚å¯Ÿé›†åˆå±æ€§</h4><p>æ‰‹åŠ¨è§¦å‘ç›‘å¬æ–¹æ³•APIï¼ˆæ•°ç»„ï¼‰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)willChange:(<span class="built_in">NSKeyValueChange</span>)changeKind valuesAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line">- (<span class="keyword">void</span>)didChange:(<span class="built_in">NSKeyValueChange</span>)changeKind valuesAtIndexes:(<span class="built_in">NSIndexSet</span> *)indexes forKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>

<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ ¹æ®<code>KVC</code>çš„<code>NSMutableArray</code>æœç´¢æ¨¡å¼ï¼š</p>
<ul>
<li>è‡³å°‘è¦å®ç°ä¸€ä¸ªæ’å…¥å’Œä¸€ä¸ªåˆ é™¤æ–¹æ³•ï¼Œéƒ½åœ¨ä¸ä¼šè§¦å‘<code>KVO</code><ol>
<li>æ’å…¥æ–¹æ³•ï¼š<code>insertObject:in&lt;Key&gt;AtIndex:</code>æˆ–<code>insert&lt;Key&gt;:atIndexes:</code> </li>
<li>åˆ é™¤æ–¹æ³•ï¼š<code>removeObjectFrom&lt;Key&gt;AtIndex:</code>æˆ–<code>remove&lt;Key&gt;AtIndexes:</code></li>
</ol>
</li>
<li>å¯ä»¥ä¸å®ç°æ›¿æ¢æ–¹æ³•ï¼Œä½†æ˜¯å¦‚æœä¸å®ç°æ›¿æ¢æ–¹æ³•ï¼Œæ‰§è¡Œæ›¿æ¢æ“ä½œæ—¶ï¼ŒKVOä¼šæŠŠå®ƒå½“æˆå…ˆåˆ é™¤åæ·»åŠ ï¼Œå³ä¼šè§¦å‘ä¸¤æ¬¡<code>KVO</code>ã€‚ç¬¬ä¸€æ¬¡è§¦å‘<code>KVO</code>ä¸­<code>change</code>å­—å…¸çš„<code>old</code>é”®çš„å€¼ä¸ºæ›¿æ¢å‰çš„å…ƒç´ ï¼Œç¬¬äºŒæ¬¡è§¦å‘çš„<code>KVO</code>ä¸­<code>change</code>å­—å…¸çš„<code>new</code>é”®çš„å€¼ä¸ºæ›¿æ¢åçš„å…ƒç´ ï¼Œå‰ææ¡ä»¶æ˜¯æ³¨å†Œæ–¹æ³•ä¸­çš„<code>options</code>ä¼ å…¥å¯¹äºçš„æšä¸¾å€¼ã€‚</li>
<li>å¦‚æœå®ç°æ›¿æ¢æ–¹æ³•ï¼Œåˆ™æ‰§è¡Œæ›¿æ¢æ“ä½œåªä¼šè§¦å‘ä¸€æ¬¡<code>KVO</code>ï¼Œå¹¶ä¸”<code>change</code>å­—å…¸ä¼šåŒæ—¶åŒ…å«<code>new</code>å’Œ<code>old</code>ï¼Œå‰ææ¡ä»¶æ˜¯æ³¨å†Œæ–¹æ³•ä¸­çš„<code>options</code>ä¸­ä¼ å…¥äº†å¯¹äºçš„æšä¸¾å€¼ã€‚<ol>
<li>æ›¿æ¢æ–¹æ³•ï¼š<code>replaceObjectIn&lt;Key&gt;AtIndex:withObject:</code>æˆ–<code>replace&lt;Key&gt;AtIndexes:with&lt;Key&gt;:</code></li>
</ol>
</li>
<li>å»ºè®®å®ç°æ›¿æ¢æ–¹æ³•ä»¥æé«˜æ€§èƒ½</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">+ (BOOL)automaticallyNotifiesObserversForKey:(NSString *)key</span><br><span class="line">&#123;</span><br><span class="line">    BOOL automatic &#x3D; NO;</span><br><span class="line">    if ([key isEqualToString:@&quot;mArray&quot;]) &#123;</span><br><span class="line">        automatic &#x3D; NO;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        automatic &#x3D; [super automaticallyNotifiesObserversForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">    return automatic;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)insertMArray:(NSArray *)array atIndexes:(NSIndexSet *)indexes</span><br><span class="line">&#123;</span><br><span class="line">    [self willChange:NSKeyValueChangeInsertion valuesAtIndexes:indexes forKey:@&quot;mArray&quot;];</span><br><span class="line">    [self.mArray insertObjects:array atIndexes:indexes];</span><br><span class="line">    [self didChange:NSKeyValueChangeInsertion valuesAtIndexes:indexes forKey:@&quot;mArray&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)removeMArrayAtIndexes:(NSIndexSet *)indexes</span><br><span class="line">&#123;</span><br><span class="line">    [self willChange:NSKeyValueChangeRemoval valuesAtIndexes:indexes forKey:@&quot;mArray&quot;];</span><br><span class="line">    [self.mArray removeObjectsAtIndexes:indexes];</span><br><span class="line">    [self didChange:NSKeyValueChangeRemoval valuesAtIndexes:indexes forKey:@&quot;mArray&quot;];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (void)replaceMArrayAtIndexes:(NSIndexSet *)indexes withMArray:(NSArray *)array</span><br><span class="line">&#123;</span><br><span class="line">    [self willChange:NSKeyValueChangeReplacement valuesAtIndexes:indexes forKey:@&quot;mArray&quot;];</span><br><span class="line">    [self.mArray replaceObjectsAtIndexes:indexes withObjects:array];</span><br><span class="line">    [self didChange:NSKeyValueChangeReplacement valuesAtIndexes:indexes forKey:@&quot;mArray&quot;];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="KVOçš„ä¾èµ–è§‚å¯Ÿ"><a href="#KVOçš„ä¾èµ–è§‚å¯Ÿ" class="headerlink" title="KVOçš„ä¾èµ–è§‚å¯Ÿ"></a>KVOçš„ä¾èµ–è§‚å¯Ÿ</h4><h5 id="ä¸€å¯¹ä¸€å…³ç³»"><a href="#ä¸€å¯¹ä¸€å…³ç³»" class="headerlink" title="ä¸€å¯¹ä¸€å…³ç³»"></a>ä¸€å¯¹ä¸€å…³ç³»</h5><p>æœ‰äº›æƒ…å†µä¸‹ï¼Œä¸€ä¸ªå±æ€§çš„æ”¹å˜ä¾èµ–äºèƒŒçš„ä¸€ä¸ªæˆ–å¤šä¸ªå±æ€§çš„æ”¹å˜ï¼Œä¹Ÿå°±æ˜¯è¯´å½“åˆ«çš„å±æ€§éäº†ï¼Œè¿™ä¸ªå±æ€§ä¹Ÿä¼šè·Ÿç€æ”¹å˜ã€‚</p>
<p>æ¯”å¦‚æˆ‘ä»¬å¯¹<code>Download</code>ç±»ä¸­çš„<code>downloadProgress</code>å±æ€§è¿›è¡Œ<code>KVO</code>ç›‘å¬ï¼Œæ”¹å±æ€§çš„æ”¹å˜ä¾èµ–äº<code>writtenData</code> å’Œ <code>totalData</code>å±æ€§çš„æ”¹å˜ã€‚è§‚å¯Ÿè€…ç›‘å¬äº†<code>downloadProgress</code>ï¼Œå½“<code>writtenData</code> å’Œ <code>totalData</code>å±æ€§å€¼å‘ç”Ÿæ”¹å˜æ—¶ï¼Œè§‚å¯Ÿè€…ä¹Ÿåº”è¯¥è¢«é€šçŸ¥ã€‚</p>
<ol>
<li><p>é‡å†™<code>keyPathsForValuesAffectingValueForKey:</code>æ–¹æ³•æŒ‡æ˜å±æ€§ä¾èµ–äº <code>writtenData</code> å’Œ <code>totalData</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSSet</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPathsForValuesAffectingValueForKey:(<span class="built_in">NSString</span> *)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSSet</span> *keyPaths = [<span class="keyword">super</span> keyPathsForValuesAffectingValueForKey:key];</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"downloadProgress"</span>]) &#123;</span><br><span class="line">        <span class="built_in">NSArray</span> *affectingKeys = @[<span class="string">@"writtenData"</span>,<span class="string">@"totalData"</span>];</span><br><span class="line">        keyPaths = [keyPaths setByAddingObjectsFromArray:affectingKeys];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> keyPaths;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å®ç°ä¸€ä¸ªéµå¾ªå‘½åè§„åˆ™ä¸º<code>keyPathsForValuesAffecting&lt;Key&gt;</code>çš„ç±»æ–¹æ³•ï¼Œ<code>&lt;key&gt;</code>æ˜¯ä¾èµ–äºå…¶ä»–å€¼çš„å±æ€§åï¼ˆé¦–å­—æ¯å¤§å°ï¼‰</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="built_in">NSSet</span>&lt;<span class="built_in">NSString</span> *&gt; *)keyPathsForValuesAffectingDownloadProgress</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> [<span class="built_in">NSSet</span> setWithObjects:<span class="string">@"writtenData"</span>,<span class="string">@"totalData"</span>, <span class="literal">nil</span>];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<blockquote>
<p>æ³¨æ„ï¼šä»¥ä¸Šä¸¤ä¸ªæ–¹æ³•å¯ä»¥åŒæ—¶å­˜åœ¨ï¼Œä¸”éƒ½ä¼šè°ƒç”¨ï¼Œä½†æ˜¯æœ€ç»ˆç»“æœä¼šä»¥<code>keyPathsForValuesAffectingValueForKey:</code>ä¸ºå‡†ã€‚</p>
</blockquote>
<h5 id="ä¸€å¯¹å¤šå…³ç³»"><a href="#ä¸€å¯¹å¤šå…³ç³»" class="headerlink" title="ä¸€å¯¹å¤šå…³ç³»"></a>ä¸€å¯¹å¤šå…³ç³»</h5><p>ä»¥ä¸Šæ–¹æ³•åœ¨è§‚å¯Ÿé›†åˆå±æ€§æ—¶å°±ä¸ç®¡ç”¨äº†ã€‚ä¾‹å¦‚ï¼Œå‡å¦‚ä½ æœ‰ä¸€ä¸ª Department ç±»ï¼Œå®ƒæœ‰ä¸€ä¸ªè£…æœ‰ Employee ç±»çš„å®ä¾‹å¯¹è±¡çš„æ•°ç»„ï¼ŒEmployee ç±»æœ‰ salary å±æ€§ã€‚ä½ å¸Œæœ› Department ç±»æœ‰ä¸€ä¸ª totalSalary å±æ€§æ¥è®¡ç®—æ‰€æœ‰å‘˜å·¥çš„è–ªæ°´ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿™ä¸ªå…³ç³»ä¸­ Department çš„ totalSalary ä¾èµ–äºæ‰€æœ‰ Employee å®ä¾‹å¯¹è±¡çš„ salary å±æ€§ã€‚ä»¥ä¸‹æœ‰ä¸¤ç§æ–¹æ³•å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<ol>
<li><p>ä½ å¯ä»¥ç”¨<code>KVO</code>å°† parentï¼ˆæ¯”å¦‚ Department ï¼‰ä½œä¸ºæ‰€æœ‰ childrenï¼ˆæ¯”å¦‚ Employee ï¼‰ç›¸å…³å±æ€§çš„è§‚å¯Ÿè€…ã€‚ä½ å¿…é¡»åœ¨æŠŠ child æ·»åŠ æˆ–åˆ é™¤åˆ° parent æ—¶æŠŠ parent ä½œä¸º child çš„è§‚å¯Ÿè€…æ·»åŠ æˆ–åˆ é™¤ã€‚åœ¨<code>observeValueForKeyPath:ofObject:change:context:</code>æ–¹æ³•ä¸­æˆ‘ä»¬å¯ä»¥é’ˆå¯¹è¢«ä¾èµ–é¡¹çš„å˜æ›´æ¥æ›´æ–°ä¾èµ–é¡¹çš„å€¼ï¼š</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#import <span class="meta-string">"Department.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> *totalSalaryContext = &amp;totalSalaryContext;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">Department</span> ()</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSArray</span>&lt;Employee *&gt; *employees;</span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>,<span class="keyword">strong</span>)<span class="built_in">NSNumber</span> *totalSalary;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">Department</span></span></span><br><span class="line"></span><br><span class="line">- (<span class="keyword">instancetype</span>)initWithEmployees:(<span class="built_in">NSArray</span> *)employees</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">self</span> = [<span class="keyword">super</span> init];</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">self</span>) &#123;</span><br><span class="line">        <span class="keyword">self</span>.employees = [employees <span class="keyword">copy</span>];</span><br><span class="line">        <span class="keyword">for</span> (Employee *em <span class="keyword">in</span> <span class="keyword">self</span>.employees) &#123;</span><br><span class="line">            [em addObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"salary"</span> options:<span class="built_in">NSKeyValueObservingOptionNew</span> context:totalSalaryContext];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">self</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)observeValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath ofObject:(<span class="keyword">id</span>)object change:(<span class="built_in">NSDictionary</span> *)change context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (context == totalSalaryContext) &#123;</span><br><span class="line">        [<span class="keyword">self</span> setTotalSalary:[<span class="keyword">self</span> valueForKeyPath:<span class="string">@"employees.@sum.salary"</span>]];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> observeValueForKeyPath:keyPath ofObject:object change:change context:context];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">- (<span class="keyword">void</span>)setTotalSalary:(<span class="built_in">NSNumber</span> *)totalSalary</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (_totalSalary != totalSalary) &#123;</span><br><span class="line">        [<span class="keyword">self</span> willChangeValueForKey:<span class="string">@"totalSalary"</span>];</span><br><span class="line">        _totalSalary = totalSalary;</span><br><span class="line">        [<span class="keyword">self</span> didChangeValueForKey:<span class="string">@"totalSalary"</span>];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)dealloc</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">for</span> (Employee *em <span class="keyword">in</span> <span class="keyword">self</span>.employees) &#123;</span><br><span class="line">        [em removeObserver:<span class="keyword">self</span> forKeyPath:<span class="string">@"salary"</span> context:totalSalaryContext];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>ä½¿ç”¨iOSä¸­è§‚å¯Ÿè€…æ¨¡å¼çš„å¦å¤–ä¸€ç§å®ç°æ–¹å¼ï¼šé€šçŸ¥ï¼ˆNSNotificationï¼‰</p>
</li>
</ol>
<h3 id="KVOçš„ä½¿ç”¨æ³¨æ„"><a href="#KVOçš„ä½¿ç”¨æ³¨æ„" class="headerlink" title="KVOçš„ä½¿ç”¨æ³¨æ„"></a>KVOçš„ä½¿ç”¨æ³¨æ„</h3><h4 id="ç§»é™¤è§‚å¯Ÿè€…çš„æ³¨æ„ç‚¹"><a href="#ç§»é™¤è§‚å¯Ÿè€…çš„æ³¨æ„ç‚¹" class="headerlink" title="ç§»é™¤è§‚å¯Ÿè€…çš„æ³¨æ„ç‚¹"></a>ç§»é™¤è§‚å¯Ÿè€…çš„æ³¨æ„ç‚¹</h4><ul>
<li>åœ¨è°ƒç”¨KVOæ³¨å†Œæ–¹æ³•åï¼ŒKVOå¹¶ä¸ä¼šå¯¹è§‚å¯Ÿè€…è¿›è¡Œå¼ºå¼•ç”¨ï¼Œæ‰€ä»¥éœ€è¦æ³¨æ„è§‚å¯Ÿè€…çš„ç”Ÿå‘½å‘¨æœŸã€‚è‡³å°‘éœ€è¦åœ¨è§‚å¯Ÿè€…é”€æ¯ä¹‹å‰ï¼Œè°ƒç”¨KVOç§»é™¤æ–¹æ³•ç§»é™¤è§‚å¯Ÿè€…ï¼Œå¦åˆ™å¦‚æœè§‚å¯Ÿè€…è¢«é‡Šæ”¾åï¼Œå†æ¬¡è§¦å‘KVOç›‘å¬æ–¹æ³•å°±ä¼šCrashã€‚</li>
<li>KVOçš„æ³¨å†Œæ–¹æ³•å’Œç§»é™¤æ–¹æ³•åº”è¯¥æ˜¯æˆå¯¹çš„ï¼Œå¦‚æœé‡å¤è°ƒç”¨ç§»é™¤æ–¹æ³•ï¼Œå°±ä¼šæŠ›å‡ºNSRangeExceptionå¹¶å¯¼è‡´Crashã€‚</li>
<li>è‹¹æœæ¨èçš„æ–¹å¼æ˜¯ï¼Œåœ¨è§‚å¯Ÿè€…åˆå§‹åŒ–æœŸé—´ï¼ˆinit æˆ– viewDidLoadçš„æ—¶å€™ï¼‰æ³¨å†Œä¸ºè§‚å¯Ÿè€…ï¼Œåœ¨é‡Šæ”¾ï¼ˆdeallocï¼‰æ—¶è°ƒç”¨ç§»é™¤æ–¹æ³•ï¼Œè¿™æ ·å¯ä»¥ä¿è¯ä»–ä»¬æ˜¯æˆå¯¹å‡ºç°çš„ï¼Œæ˜¯ä¸€ç§æ¯”è¾ƒç†æƒ³çš„æ–¹å¼ã€‚</li>
</ul>
<h4 id="é˜²æ­¢å¤šæ¬¡æ³¨å†Œ-å’Œ-ç§»é™¤ç›¸åŒçš„KVO"><a href="#é˜²æ­¢å¤šæ¬¡æ³¨å†Œ-å’Œ-ç§»é™¤ç›¸åŒçš„KVO" class="headerlink" title="é˜²æ­¢å¤šæ¬¡æ³¨å†Œ å’Œ ç§»é™¤ç›¸åŒçš„KVO"></a>é˜²æ­¢å¤šæ¬¡æ³¨å†Œ å’Œ ç§»é™¤ç›¸åŒçš„KVO</h4><p>æœ‰æ—¶å€™æˆ‘ä»¬éš¾ä»¥é¿å…å¤šæ¬¡æ³¨å†Œ å’Œ ç§»é™¤KVOï¼Œæˆ–è€…ç§»é™¤äº†ä¸€ä¸ªæœªæ³¨å†Œçš„è§‚å¯Ÿè€…ï¼Œä»è€Œäº§ç”Ÿå¯èƒ½ä¼šå¯¼è‡´Crashçš„é£é™©ã€‚</p>
<h5 id="é»‘ç§‘æŠ€é˜²æ­¢å¤šæ¬¡æ·»åŠ åˆ é™¤KVOå‡ºç°çš„é—®é¢˜"><a href="#é»‘ç§‘æŠ€é˜²æ­¢å¤šæ¬¡æ·»åŠ åˆ é™¤KVOå‡ºç°çš„é—®é¢˜" class="headerlink" title="é»‘ç§‘æŠ€é˜²æ­¢å¤šæ¬¡æ·»åŠ åˆ é™¤KVOå‡ºç°çš„é—®é¢˜"></a>é»‘ç§‘æŠ€é˜²æ­¢å¤šæ¬¡æ·»åŠ åˆ é™¤KVOå‡ºç°çš„é—®é¢˜</h5><p>æ ¸å¿ƒï¼šåˆ©ç”¨runtimeå®ç°æ–¹æ³•äº¤æ¢ï¼Œè¿›è¡Œæ‹¦æˆª<code>add</code>  å’Œ <code>remove</code> è¿›è¡Œæ“ä½œã€‚</p>
<h6 id="æ–¹æ¡ˆä¸€ï¼šåˆ©ç”¨-try-catch"><a href="#æ–¹æ¡ˆä¸€ï¼šåˆ©ç”¨-try-catch" class="headerlink" title="æ–¹æ¡ˆä¸€ï¼šåˆ©ç”¨@try @catch"></a>æ–¹æ¡ˆä¸€ï¼šåˆ©ç”¨@try @catch</h6><p>åˆ©ç”¨@try @catchæ•è·å¼‚å¸¸ï¼Œä¸è®©ç¨‹åºCrashï¼Œä½†æ˜¯åªèƒ½é’ˆå¯¹å¤šæ¬¡åˆ é™¤<code>KVO</code>çš„å¤„ç†</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">kvoRemove</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    [<span class="keyword">self</span> swizzleInstanceMethod:<span class="keyword">@selector</span>(removeObserver:forKeyPath:) withSelector:<span class="keyword">@selector</span>(swizzle_removeObserver:forKeyPath:)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)swizzle_removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    <span class="keyword">@try</span> &#123;</span><br><span class="line">        [<span class="keyword">self</span> swizzle_removeObserver:observer forKeyPath:keyPath];</span><br><span class="line">    &#125; <span class="keyword">@catch</span> (<span class="built_in">NSException</span> *exception) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h6 id="æ–¹æ¡ˆäºŒï¼šåˆ©ç”¨æ¨¡å‹æ•°ç»„è¿›è¡Œå­˜å‚¨æ•°æ®"><a href="#æ–¹æ¡ˆäºŒï¼šåˆ©ç”¨æ¨¡å‹æ•°ç»„è¿›è¡Œå­˜å‚¨æ•°æ®" class="headerlink" title="æ–¹æ¡ˆäºŒï¼šåˆ©ç”¨æ¨¡å‹æ•°ç»„è¿›è¡Œå­˜å‚¨æ•°æ®"></a>æ–¹æ¡ˆäºŒï¼šåˆ©ç”¨æ¨¡å‹æ•°ç»„è¿›è¡Œå­˜å‚¨æ•°æ®</h6><p>åˆ©ç”¨æ¨¡å‹æ•°æ®è¿›è¡Œå­˜å‚¨è®°å½•</p>
<ul>
<li>åˆ©ç”¨<code>runtime</code>ï¼Œæ‹¦æˆªç›‘å¬å¯¹è±¡ å’Œ <code>keyPath</code></li>
<li>åˆ©ç”¨æ¨¡å‹å­˜å‚¨æ‰§è¡Œ<code>addObserver</code>å¯¹è±¡ å’Œ ç›‘å¬çš„<code>KeyPath</code></li>
<li>è¿›è¡Œå­˜å‚¨æ ¡éªŒï¼Œä¸å­˜åœ¨äºæ¨¡å‹ä¸­çš„<code>addObserver</code>å¯¹è±¡ å’Œ ç›‘å¬çš„<code>KeyPath</code>ï¼Œæ‰è¿›è¡Œ<code>addObserver</code></li>
<li><code>remove</code>çš„æ—¶å€™åŒæ ·è¿›è¡Œæ ¡éªŒä¸€ä¸‹</li>
</ul>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">@interface</span> <span class="title">NSKVOCache</span> : <span class="title">NSObject</span></span></span><br><span class="line"><span class="comment">/// arrayM</span></span><br><span class="line"><span class="keyword">@property</span> (<span class="keyword">nonatomic</span>, <span class="keyword">strong</span>) <span class="built_in">NSMutableDictionary</span>&lt;<span class="built_in">NSString</span> *,<span class="built_in">NSMutableArray</span> *&gt; *dictM;</span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSKVOCache</span></span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">instancetype</span>)shareInshance &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">dispatch_once_t</span> onceToken;</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">NSKVOCache</span> *_instance;</span><br><span class="line">    <span class="built_in">dispatch_once</span>(&amp;onceToken, ^&#123;</span><br><span class="line">        _instance = [<span class="built_in">NSKVOCache</span> new];</span><br><span class="line">        _instance.dictM = [<span class="built_in">NSMutableDictionary</span> dictionary];</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">return</span> _instance;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">@implementation</span> <span class="title">NSObject</span> (<span class="title">kvoRemove</span>)</span></span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">void</span>)load &#123;</span><br><span class="line">    [<span class="keyword">self</span> swizzleInstanceMethod:<span class="keyword">@selector</span>(removeObserver:forKeyPath:)</span><br><span class="line">                   withSelector:<span class="keyword">@selector</span>(swizzle_removeObserver:forKeyPath:)];</span><br><span class="line">    </span><br><span class="line">    [<span class="keyword">self</span> swizzleInstanceMethod:<span class="keyword">@selector</span>(addObserver:forKeyPath:options:context:)</span><br><span class="line">                   withSelector:<span class="keyword">@selector</span>(swizzle_addObserver:forKeyPath:options:context:)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)swizzle_removeObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">NSKVOCache</span> *kvo = [<span class="built_in">NSKVOCache</span> shareInshance];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *arrayM = kvo.dictM[keyPath];</span><br><span class="line">    <span class="keyword">if</span> (arrayM &amp;&amp; [arrayM containsObject:observer]) &#123;</span><br><span class="line">        [arrayM removeObject:observer];</span><br><span class="line">        [<span class="keyword">self</span> swizzle_removeObserver:observer forKeyPath:keyPath];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (<span class="keyword">void</span>)swizzle_addObserver:(<span class="built_in">NSObject</span> *)observer forKeyPath:(<span class="built_in">NSString</span> *)keyPath options:(<span class="built_in">NSKeyValueObservingOptions</span>)options context:(<span class="keyword">void</span> *)context &#123;</span><br><span class="line">    <span class="built_in">NSKVOCache</span> *kvo = [<span class="built_in">NSKVOCache</span> shareInshance];</span><br><span class="line">    <span class="built_in">NSMutableArray</span> *arrayM = kvo.dictM[keyPath];</span><br><span class="line">    <span class="keyword">if</span> (!arrayM) &#123;</span><br><span class="line">        arrayM = [<span class="built_in">NSMutableArray</span> array];</span><br><span class="line">        [kvo.dictM setObject:arrayM forKey:keyPath];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (![arrayM containsObject:observer]) &#123;</span><br><span class="line">        [arrayM addObject:observer];</span><br><span class="line">        [<span class="keyword">self</span> swizzle_addObserver:observer forKeyPath:keyPath options:options context:context];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@end</span></span><br></pre></td></tr></table></figure>

<h6 id="æ–¹æ¡ˆä¸‰ï¼šåˆ©ç”¨obserationInfoé‡Œç§æœ‰å±æ€§"><a href="#æ–¹æ¡ˆä¸‰ï¼šåˆ©ç”¨obserationInfoé‡Œç§æœ‰å±æ€§" class="headerlink" title="æ–¹æ¡ˆä¸‰ï¼šåˆ©ç”¨obserationInfoé‡Œç§æœ‰å±æ€§"></a>æ–¹æ¡ˆä¸‰ï¼šåˆ©ç”¨<code>obserationInfo</code>é‡Œç§æœ‰å±æ€§</h6><p><code>obserationInfo</code>å±æ€§åŒ…å«å±æ€§çš„ç›‘å¬è€…ï¼Œé€šçŸ¥è€…ï¼Œä»¥åŠç›‘å¬çš„<code>keyPath</code>ï¼Œé€šè¿‡ç§æœ‰å±æ€§ç›´æ¥æ‹¿åˆ°å½“å‰å¯¹è±¡æ‰€ç›‘å¬çš„<code>keyPath</code>ï¼Œå’Œ<code>observer</code></p>
<p>å®ç°ä¸Šå’Œæ–¹æ¡ˆäºŒåŸºæœ¬ä¸€ç›´ï¼Œåªä¸è¿‡å¯ä»¥é€šè¿‡<code>obserationInfo</code>å……å½“æˆ‘ä»¬å‰é¢çš„<code>NSKVOCache</code>çš„åŠŸèƒ½ï¼Œè¿›è¡Œæ ¡éªŒ</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿›è¡Œæ£€ç´¢è·å–Key</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)observerKeyPath:(<span class="built_in">NSString</span> *)key observer:(<span class="keyword">id</span> )observer</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> info = <span class="keyword">self</span>.observationInfo;</span><br><span class="line">    <span class="built_in">NSArray</span> *array = [info valueForKey:<span class="string">@"_observances"</span>];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">id</span> objc <span class="keyword">in</span> array) &#123;</span><br><span class="line">        <span class="keyword">id</span> Properties = [objc valueForKeyPath:<span class="string">@"_property"</span>];</span><br><span class="line">        <span class="keyword">id</span> newObserver = [objc valueForKeyPath:<span class="string">@"_observer"</span>];</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">NSString</span> *keyPath = [Properties valueForKeyPath:<span class="string">@"_keyPath"</span>];</span><br><span class="line">        <span class="keyword">if</span> ([key isEqualToString:keyPath] &amp;&amp; [newObserver isEqual:observer]) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">YES</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NO</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="å…¶ä»–æ³¨æ„ç‚¹"><a href="#å…¶ä»–æ³¨æ„ç‚¹" class="headerlink" title="å…¶ä»–æ³¨æ„ç‚¹"></a>å…¶ä»–æ³¨æ„ç‚¹</h4><ul>
<li>å¦‚æœå¯¹è±¡è¢«æ³¨å†Œæˆä¸ºè§‚å¯Ÿè€…ï¼Œåˆ™è¯¥å¯¹è±¡å¿…é¡»å®ç°èƒ½å“åº”çš„ç›‘å¬æ–¹æ³•ï¼Œå½“å¯¹è±¡çš„å±æ€§å‘ç”Ÿæ”¹å˜æ—¶å°±ä¼šè°ƒç”¨ç›‘å¬æ–¹æ³•ã€‚å¦‚æœæ²¡æœ‰å®ç°ï¼Œä¼šç›´æ¥Crashã€‚</li>
<li><code>keyPath</code>ä¼ å…¥çš„æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸ºé¿å…å†™é”™ï¼Œå¯ä»¥ä½¿ç”¨<code>NSStringFromSelector(@selector(propertyName))</code>ï¼Œå°†å±æ€§çš„getteræ–¹æ³•SELè½¬æ¢æˆå­—ç¬¦ä¸²ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µå¯¹keyPathè¿›è¡Œæ ¡éªŒ</li>
<li>å¦‚æœæ³¨å†Œæ–¹æ³•ä¸­<code>context</code>ä¼ çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»åœ¨ç§»é™¤è§‚å¯Ÿä¹‹å‰æŒæœ‰å®ƒçš„å¼ºå¼•ç”¨ï¼Œå¦åˆ™ç›‘å¬æ–¹æ³•ä¸­è®¿é—®<code>context</code>å°±å¯èƒ½å¯¼è‡´Crashã€‚</li>
<li>å¦‚æœç›‘å¬é›†åˆå¯¹è±¡çš„æ”¹å˜ï¼Œéœ€è¦é€šè¿‡<code>KVC</code>çš„<code>mutableArrayValueForKey:</code>ç­‰æ–¹æ³•è·å¾—ä»£ç†å¯¹è±¡ï¼Œå¹¶ä½¿ç”¨ä»£ç†å¯¹è±¡è¿›è¡Œæ“ä½œï¼Œå½“ä»£ç†å¯¹è±¡çš„å†…éƒ¨å¯¹è±¡å‘ç”Ÿæ”¹å˜æ—¶ï¼Œä¼šè§¦å‘<code>KVO</code>ã€‚å¦‚æœç›´æ¥å¯¹é›†åˆå¯¹è±¡è¿›è¡Œæ“ä½œæ”¹å˜ï¼Œä¸ä¼šè§¦å‘<code>KVO</code>ã€‚</li>
<li>åœ¨è§‚å¯Ÿè€…ç±»çš„ç›‘å¬æ–¹æ³•ä¸­ï¼Œåº”è¯¥ä¸ºæ— æ³•è¯†åˆ«çš„<code>context</code> æˆ–è€… <code>object</code>ã€keyPathè°ƒç”¨çˆ¶ç±»çš„<code>[super observeValueForKeyPath:keyPath ofObject:object change:change context:context];</code></li>
</ul>
<h3 id="KVOå®ç°åŸç†"><a href="#KVOå®ç°åŸç†" class="headerlink" title="KVOå®ç°åŸç†"></a>KVOå®ç°åŸç†</h3><h4 id="isa-swizzling"><a href="#isa-swizzling" class="headerlink" title="isa-swizzling"></a>isa-swizzling</h4><p>è‹¹æœä½¿ç”¨äº†isaæ··å†™æŠ€æœ¯ï¼ˆisa-swizzlingï¼‰æ¥å®ç°KVOï¼Œå½“æˆ‘ä»¬è°ƒç”¨addObserver:forKeyPath:options:context:æ–¹æ³•ä¸ºinstanceæ·»åŠ KVOç›‘å¬åï¼Œç³»ç»Ÿä¼šåœ¨è¿è¡Œæ—¶åˆ©äºRuntime APIåŠ¨æ€åˆ›å»ºinstanceå¯¹è±¡æ‰€å±ç±»çš„å­ç±»NSKVONotifying_Aï¼Œå¹¶ä¸”è®©instanceå¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘è¿™ä¸ªå…¨æ–°çš„å­ç±»ï¼Œå¹¶é‡å†™åŸç±»çš„è¢«è§‚å¯Ÿå±æ€§çš„setteræ–¹æ³•æ¥è¾¾åˆ°å¯ä»¥é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡çš„ç›®çš„ã€‚</p>
<ul>
<li>è¿™ä¸ªå­ç±»æŒ‡å‘å®ƒè‡ªå·±çš„meta-classå¯¹è±¡ï¼Œè€Œä¸æ˜¯åŸç±»çš„meta-classå¯¹è±¡</li>
<li>é‡å†™çš„setteræ–¹æ³•çš„SELå¯¹è±¡çš„IMPä¸ºFoundationä¸­çš„<code>_NSSetXXXValueAndNotify</code>å‡½æ•°ï¼ˆXXXä¸ºkeyçš„æ•°æ®ç±»å‹ï¼‰ï¼Œå½“è¢«è§‚å¯Ÿçš„å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè°ƒç”¨_NSSetXXXValueAndNotifyå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¸­è°ƒç”¨ï¼š<ol>
<li>willChangeValueForKey:æ–¹æ³•</li>
<li>çˆ¶ç±»åŸæ¥çš„setteræ–¹æ³•</li>
<li>didChangeValueForKey:æ–¹æ³•ï¼ˆå†…éƒ¨è§¦å‘observerç›‘å¬æ–¹æ³•observeValueForKeyPath:ofObject:change:context:ï¼‰</li>
</ol>
</li>
<li>åœ¨ç§»é™¤KVOç›‘å¬åï¼Œè¢«è§‚å¯Ÿå¯¹è±¡çš„isaä¼šæŒ‡å›åŸç±»Aï¼Œä½†æ˜¯NSKVONotifying_Aç±»å¹¶æ²¡æœ‰é”€æ¯ï¼Œè¿˜æ˜¯ä¿å­˜åœ¨å†…å­˜ä¸­</li>
</ul>
<h4 id="KVOåŠ¨æ€ç”Ÿæˆçš„å­ç±»éƒ½æœ‰å“ªäº›æ–¹æ³•"><a href="#KVOåŠ¨æ€ç”Ÿæˆçš„å­ç±»éƒ½æœ‰å“ªäº›æ–¹æ³•" class="headerlink" title="KVOåŠ¨æ€ç”Ÿæˆçš„å­ç±»éƒ½æœ‰å“ªäº›æ–¹æ³•"></a>KVOåŠ¨æ€ç”Ÿæˆçš„å­ç±»éƒ½æœ‰å“ªäº›æ–¹æ³•</h4><p>NSKVONotifying_Aé™¤äº†é‡å†™setteræ–¹æ³•ï¼Œè¿˜æ˜¯é‡å†™äº†classã€deallocã€_isKVOè¿™ä¸‰ä¸ªæ–¹æ³•ï¼ˆå¯ä»¥ä½¿ç”¨runtimeçš„class_copyMethodListå‡½æ•°æ‰“å°æ–¹æ³•åˆ—è¡¨è·å–ï¼‰ï¼Œå…¶ä¸­ï¼š</p>
<ul>
<li>Class:class æ–¹æ³•è¿”å›çš„æ˜¯çˆ¶ç±»çš„classå¯¹è±¡ï¼Œç›®çš„æ˜¯ä¸ºäº†ä¸è®©å¤–ç•ŒçŸ¥é“KVOåŠ¨æ€ç”Ÿæˆç±»çš„å­˜åœ¨ï¼›</li>
<li>Dealloc:é‡Šæ”¾KVOä½¿ç”¨è¿‡ç¨‹äº§ç”Ÿçš„ä¸œè¥¿</li>
<li>_isKVO:ç”¨æ¥æ ‡ç¤ºå®ƒæ˜¯ä¸€ä¸ªKVOçš„ç±»</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/11/17/iOS%E2%80%94%E2%80%94KVC%E7%9B%B8%E5%85%B3%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/11/17/iOS%E2%80%94%E2%80%94KVC%E7%9B%B8%E5%85%B3%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">iOSâ€”â€”KVCç›¸å…³æ€»ç»“</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-11-17 16:02:22" itemprop="dateCreated datePublished" datetime="2020-11-17T16:02:22+08:00">2020-11-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-12-08 20:26:04" itemprop="dateModified" datetime="2020-12-08T20:26:04+08:00">2020-12-08</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="KVC"><a href="#KVC" class="headerlink" title="KVC"></a>KVC</h3><ul>
<li>KVC å…¨ç§°æ˜¯ï¼ˆKey-Value Codingï¼‰é”®å€¼ç¼–ç ï¼Œæ˜¯æœ‰<code>NSKeyValueCoding</code>éæ­£å¼åè®®å¯ç”¨çš„ä¸€ç§æœºåˆ¶ï¼Œå¯¹è±¡é‡‡ç”¨è¿™ç§æœºåˆ¶æ¥æä¾›å¯¹å…¶å±æ€§çš„é—´æ¥è®¿é—®ï¼Œå¯ä»¥é€šè¿‡å­—ç¬¦ä¸²æ¥è®¿é—®ä¸€ä¸ªå¯¹è±¡çš„æˆå‘˜å˜é‡æˆ–å…¶å…³è”çš„å­˜å–æ–¹æ³•ï¼ˆ<code>setter</code> or <code>getter</code>ï¼‰ã€‚</li>
<li>é€šå¸¸ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡å­˜å‚¨æ–¹æ³•æˆ–å˜é‡åæ¥è®¿é—®å¯¹è±¡çš„å±æ€§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡<code>KVC</code>é—´æ¥è®¿é—®å¯¹è±¡çš„å±æ€§ï¼Œå¹¶ä¸”<code>KVC</code>è¿˜å¯ä»¥è®¿é—®ç§æœ‰å˜é‡ã€‚æŸäº›æƒ…å†µä¸‹ï¼Œ<code>KVC</code>è¿˜å¯ä»¥å¸®åŠ©ç®€åŒ–ä»£ç </li>
<li><code>KVC</code>æ˜¯è®¸å¤šå…¶ä»–CocoaæŠ€æœ¯çš„åŸºç¡€ï¼Œæ¯”å¦‚<code>KVO</code>ã€<code>Cocoa bingdings</code>ï¼Œ<code>Core Data</code>ï¼Œ<code>AppleScript-ability</code>ç­‰ã€‚</li>
</ul>
<p>è®¿é—®å¯¹è±¡å±æ€§</p>
<h4 id="å¸¸ç”¨API"><a href="#å¸¸ç”¨API" class="headerlink" title="å¸¸ç”¨API"></a>å¸¸ç”¨API</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Return an array containing the results of invoking -valueForKey: on each of the receiver's elements. The returned array will contain NSNull elements for each instance of -valueForKey: returning nil.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">id</span>)valueForKey:(<span class="built_in">NSString</span> *)key;<span class="comment">// é€šè¿‡keyæ¥å–å€¼</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Invoke -setValue:forKey: on each of the receiver's elements.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Key-path-taking variants of like-named methods. The default implementation of each parses the key path enough to determine whether or not it has more than one component (key path components are separated by periods). If so, -valueForKey: is invoked with the first key path component as the argument, and the method being invoked is invoked recursively on the result, with the remainder of the key path passed as an argument. If not, the like-named non-key-path-taking method is invoked.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForKeyPath:(<span class="built_in">NSString</span> *)keyPath; <span class="comment">// é€šè¿‡keyPathæ¥å–å€¼</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given an array of keys, return a dictionary containing the keyed attribute values, to-one-related objects, and/or collections of to-many-related objects. Entries for which -valueForKey: returns nil have NSNull as their value in the returned dictionary.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)dictionaryWithValuesForKeys:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keys;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given a dictionary containing keyed attribute values, to-one-related objects, and/or collections of to-many-related objects, set the keyed values. Dictionary entries whose values are NSNull result in -setValue:nil forKey:key messages being sent to the receiver.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)setValuesForKeysWithDictionary:(<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)keyedValues;</span><br></pre></td></tr></table></figure>

<h5 id="setValue-forKey"><a href="#setValue-forKey" class="headerlink" title="setValue:forKey"></a>setValue:forKey</h5><p>é€šè¿‡<code>KVC</code>é—´æ¥ä¸ºå±æ€§èµ‹å€¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[myAccount setValue:@(100.0) forKey:@&quot;currentBalance&quot;];</span><br></pre></td></tr></table></figure>

<h5 id="valueForKey"><a href="#valueForKey" class="headerlink" title="valueForKey"></a>valueForKey</h5><p>é€šè¿‡<code>KVC</code>é—´æ¥å–å€¼ï¼Œé€šè¿‡å…¶<code>key</code>è·å–å€¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[myAccount valueForKey:@&quot;currentBalance&quot;];</span><br></pre></td></tr></table></figure>

<h5 id="setValue-forKeyPath"><a href="#setValue-forKeyPath" class="headerlink" title="setValue:forKeyPath"></a>setValue:forKeyPath</h5><p>KVC<code>è¿˜æ”¯æŒå¤šçº§è®¿é—®</code>ï¼ŒKeyPathç”¨æ³•å’Œç‚¹è¯­æ³•ç›¸åŒã€‚ä¾‹å¦‚ï¼šæˆ‘ä»¬æƒ³å¯¹<code>myAccount</code>çš„<code>owner</code>å±æ€§çš„<code>address</code>å±æ€§çš„<code>street</code>å±æ€§èµ‹å€¼ï¼Œå…¶<code>keyPath</code>ä¸º<code>myAccount.owner.address.</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[myAccount setValue:<span class="string">@"åœ°å€"</span> forKeyPath:<span class="string">@"owner.address.street"</span>];</span><br></pre></td></tr></table></figure>

<h4 id="å¤šå€¼æ“ä½œ"><a href="#å¤šå€¼æ“ä½œ" class="headerlink" title="å¤šå€¼æ“ä½œ"></a>å¤šå€¼æ“ä½œ</h4><p>ç»™å®šä¸€ç»„<code>Key</code>ï¼Œè·å¾—ä¸€ç»„<code>Value</code>ï¼Œä»¥å­—å…¸çš„å½¢å¼è¿”å›ã€‚è¯¥æ–¹æ³•ä¸ºæ•°ç»„ä¸­çš„æ¯ä¸ª<code>key</code>è°ƒç”¨<code>valueForKey</code>æ–¹æ³•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSDictionary</span>&lt;<span class="built_in">NSString</span> *, <span class="keyword">id</span>&gt; *)dictionaryWithValuesForKeys:(<span class="built_in">NSArray</span>&lt;<span class="built_in">NSString</span> *&gt; *)keys;</span><br></pre></td></tr></table></figure>

<p>å°†æŒ‡å®šå­—å…¸ä¸­çš„å€¼è®¾ç½®åˆ°æ¶ˆæ¯æ¥å—è€…çš„å±æ€§ä¸­ï¼Œä½¿ç”¨å­—å…¸çš„keyæ ‡ç¤ºå±æ€§ã€‚é»˜è®¤å®ç°å¸‚å§”æ¯ä¸ªé”®å€¼è°ƒç”¨setValue:forKey:æ–¹æ³•ï¼Œä¼šæ ¹æ®éœ€è¦ç”¨nilæ›¿æ¢NSNullå¯¹è±¡ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">- (void)setValuesForKeysWithDictionary:(NSDictionary&lt;NSString *, id&gt; *)keyedValues;</span><br></pre></td></tr></table></figure>

<h4 id="è®¿é—®é›†åˆå±æ€§"><a href="#è®¿é—®é›†åˆå±æ€§" class="headerlink" title="è®¿é—®é›†åˆå±æ€§"></a>è®¿é—®é›†åˆå±æ€§</h4><p>æˆ‘ä»¬å¯ä»¥åƒè®¿é—®å…¶ä»–å¯¹è±¡ä¸€æ ·ä½¿ç”¨<code>valueForKey:</code>æˆ–<code>setValue:forKey:</code>æ–¹æ³•è·å–æˆ–è®¾ç½®é›†åˆå¯¹è±¡ï¼ˆä¸»è¦åŒ…æ‹¬<code>NSArray</code>æˆ–<code>NSSet</code>ï¼‰ã€‚ä½†æ˜¯ï¼Œå½“æˆ‘ä»¬è¦æ“ä½œé›†åˆå¯¹è±¡çš„å†…å®¹ï¼Œæ¯”å¦‚æ·»åŠ æˆ–è€…åˆ é™¤å…ƒç´ æ—¶ï¼Œé€šè¿‡KVCçš„å¯å˜ä»£ç†æ–¹æ³•è·å–é›†åˆä»£ç†å¯¹è±¡æ˜¯æœ‰æ•ˆçš„ã€‚</p>
<p>æ ¹æ®<code>KVO</code>çš„å®ç°åŸç†ï¼Œæ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆå­ç±»å¹¶é‡å†™<code>setter</code>æ–¹æ³•æ¥è¾¾åˆ°å¯ä»¥é€šçŸ¥æ‰€æœ‰è§‚å¯Ÿè€…å¯¹è±¡çš„ç›®çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯¹é›†åˆå¯¹è±¡è¿›è¡Œæ“ä½œæ˜¯ä¸ä¼šè§¦å‘<code>KVO</code>çš„ã€‚å½“æˆ‘ä»¬è¦ä½¿ç”¨<code>KVO</code>ç›‘å¬é›†åˆå¯¹è±¡å˜åŒ–æ—¶ï¼Œéœ€è¦é€šè¿‡<code>KVC</code>çš„å¯å˜ä»£ç†æ–¹æ³•è·å–é›†åˆä»£ç†å¯¹è±¡ï¼Œç„¶åå¯¹ä»£ç†å¯¹è±¡è¿›è¡Œæ“ä½œï¼Œå½“ä»£ç†å¯¹è±¡å†…éƒ¨å¯¹è±¡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè§¦å‘<code>KVO</code>çš„ç›‘å¬æ–¹æ³•ã€‚</p>
<p><code>KVC</code>æä¾›äº†ä¸‰ç§ä¸åŒçš„ä»£ç†å¯¹è±¡è®¿é—®çš„ä»£ç†æ–¹æ³•ï¼Œæ¯ç§éƒ½æœ‰<code>key</code> å’Œ <code>keyPath</code>ä¸¤ç§æ–¹æ³•ã€‚</p>
<ul>
<li><p>è¿”å›NSMutableArrayå¯¹è±¡çš„ä»£ç†å¯¹è±¡</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSMutableArray</span> *)mutableArrayValueForKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableArray</span> *)mutableArrayValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è¿”å›NSMutableSetå¯¹è±¡çš„ä»£ç†å¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (NSMutableSet *)mutableSetValueForKey:(NSString *)key;</span><br><span class="line"></span><br><span class="line">- (NSMutableSet *)mutableSetValueForKeyPath:(NSString *)keyPath;</span><br></pre></td></tr></table></figure>
</li>
<li><p>è¿”å›NSMutableOrderedSetå¯¹è±¡çš„ä»£ç†å¯¹è±¡</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">NSMutableOrderedSet</span> *)mutableOrderedSetValueForKey:(<span class="built_in">NSString</span> *)key API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>));</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">NSMutableOrderedSet</span> *)mutableOrderedSetValueForKeyPath:(<span class="built_in">NSString</span> *)keyPath API_AVAILABLE(macos(<span class="number">10.7</span>), ios(<span class="number">5.0</span>), watchos(<span class="number">2.0</span>), tvos(<span class="number">9.0</span>));</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="ä½¿ç”¨é›†åˆè¿ç®—ç¬¦"><a href="#ä½¿ç”¨é›†åˆè¿ç®—ç¬¦" class="headerlink" title="ä½¿ç”¨é›†åˆè¿ç®—ç¬¦"></a>ä½¿ç”¨é›†åˆè¿ç®—ç¬¦</h4><p>KVCçš„valueForKeyPath:æ–¹æ³•é™¤äº†å¯ä»¥å–å‡ºå±æ€§å€¼ä»¥å¤–ï¼Œè¿˜å¯ä»¥åœ¨keyPathä¸­åµŒå¥—é›†åˆè¿ç®—ç¬¦ï¼Œæ¥å¯¹é›†åˆå¯¹è±¡è¿›è¡Œæ“ä½œã€‚</p>
<p>KeyPath åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œleft key pathï¼ˆå·¦é”®è·¯å¾„ï¼‰ã€Collection operationï¼ˆé›†åˆè¿ç®—ç¬¦ï¼‰ã€right key pathï¼ˆå³é”®è·¯å¾„ï¼Œè¦è¿›è¡Œè¿ç®—çš„é›†åˆä¸­çš„å±æ€§ï¼‰</p>
<p>é›†åˆè¿ç®—ç¬¦åˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li>èšåˆè¿ç®—ç¬¦ï¼šä»¥æŸç§æ–¹å¼åˆå¹¶é›†åˆä¸­çš„å¯¹è±¡ï¼Œå¹¶è¿”å›å³é”®è·¯å¾„ä¸­æŒ‡å®šçš„å±æ€§çš„æ•°æ®ç±»å‹åŒ¹é…çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä¸€èˆ¬è¿”å›NSNumberå¯¹è±¡</li>
<li>æ•°ç»„è¿ç®—ç¬¦ï¼šæ ¹æ®è¿ç®—ç¬¦çš„æ¡ä»¶ï¼Œå°†ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡ä»¥ä¸€ä¸ªNSArrayå¯¹è±¡è¿”å›</li>
<li>åµŒå¥—è¿ç®—ç¬¦ï¼šå¤„ç†é›†åˆå¯¹è±¡ä¸­åµŒå¥—å…¶ä»–é›†åˆå¯¹è±¡çš„æƒ…å†µï¼Œå¹¶æ ¹æ®è¿ç®—ç¬¦è¿”å›ä¸€ä¸ªNSArray æˆ– NSSetå¯¹è±¡</li>
</ul>
<h5 id="èšåˆè¿ç®—ç¬¦"><a href="#èšåˆè¿ç®—ç¬¦" class="headerlink" title="èšåˆè¿ç®—ç¬¦"></a>èšåˆè¿ç®—ç¬¦</h5><p>ä»¥æŸç§æ–¹å¼åˆå¹¶é›†åˆä¸­çš„å¯¹è±¡ï¼Œå¹¶è¿”å›å³é”®è·¯å¾„ä¸­æŒ‡å®šçš„å±æ€§çš„æ•°æ®ç±»å‹åŒ¹é…çš„ä¸€ä¸ªå¯¹è±¡ï¼Œä¸€èˆ¬è¿”å›NSNumberå¯¹è±¡</p>
<h6 id="avg"><a href="#avg" class="headerlink" title="@avg"></a>@avg</h6><p>è¯»å–é›†åˆä¸­æ¯ä¸ªå…ƒç´ çš„å³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§ï¼Œå°†å…¶è½¬æ¢ä¸ºdoubleç±»å‹ï¼ˆnil ç”¨ 0ä»£æ›¿ï¼‰ï¼Œå¹¶è®¡ç®—è¿™äº›å€¼çš„ç®—æœ¯å¹³å‡å€¼ï¼Œç„¶åå°†ç»“æœä»¥NSNumberå¯¹è±¡è¿”å›ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®—é›†åˆä¸­amountå±æ€§çš„å¹³å‡å€¼</span></span><br><span class="line"><span class="built_in">NSNumber</span> *transactionAverage = [<span class="keyword">self</span>.transactions valueForKeyPath:<span class="string">@"@avg.amount"</span>];</span><br></pre></td></tr></table></figure>

<h6 id="count"><a href="#count" class="headerlink" title="@count"></a>@count</h6><p>è®¡ç®—é›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°ï¼Œä»¥NSNumberå®ä¾‹è¿”å›</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®¡ç®— transactions é›†åˆä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚</span></span><br><span class="line"><span class="built_in">NSNumber</span> *numberOfTransactions = [<span class="keyword">self</span>.transactions valueForKeyPath:<span class="string">@"@count"</span>];</span><br><span class="line"><span class="comment">// numberOfTransactions çš„å€¼ä¸º 13ã€‚</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¤‡æ³¨ï¼š@countè¿ç®—ç¬¦æ¯”è¾ƒç‰¹åˆ«ï¼Œå®ƒä¸éœ€è¦å†™å³é”®è·¯å¾„ï¼Œå³ä½¿å†™äº†ä¹Ÿä¼šè¢«å¿½ç•¥</p>
</blockquote>
<h6 id="sum"><a href="#sum" class="headerlink" title="@sum"></a>@sum</h6><p>è¯»å–é›†åˆä¸­æ¯ä¸ªå…ƒç´ çš„å³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§ï¼Œå°†å…¶è½¬æ¢ä¸ºdoubleç±»å‹(nil ç”¨ 0ä»£æ›¿)ï¼Œå¹¶è®¡ç®—è¿™äº›å€¼çš„æ€»å’Œï¼Œç„¶åå°†ç»“æœä»¥NSNumberå®ä¾‹è¿”å›</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è®¡ç®—amount çš„æ€»å’Œ</span><br><span class="line">NSNumber *amountSum &#x3D; [self.transactions valueForKeyPath:@&quot;@sum.amount&quot;];</span><br></pre></td></tr></table></figure>

<h6 id="max"><a href="#max" class="headerlink" title="@max"></a>@max</h6><p>è¿”å›é›†åˆå³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§çš„æœ€å¤§å€¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è·å–æ—¥æœŸçš„æœ€å¤§å€¼</span><br><span class="line">NSDate *latestDate &#x3D; [self.transactions valueForKeyPath:@&quot;@max.date&quot;];</span><br></pre></td></tr></table></figure>

<p>@min</p>
<p>è¿”å›é›†åˆå³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§çš„æœ€å°å€¼</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–æ—¥æœŸçš„æœ€å°å€¼</span></span><br><span class="line"><span class="built_in">NSDate</span> *earliestDate = [<span class="keyword">self</span>.transactions valueForKeyPath:<span class="string">@"@min.date"</span>];</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¤‡æ³¨ï¼š@max å’Œ @minæ ¹æ®å³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§åœ¨é›†åˆä¸­æœç´¢ï¼Œæœç´¢ä½¿ç”¨compare:æ–¹æ³•è¿›è¡Œã€‚å› æ­¤ï¼Œå³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§å¿…é¡»èƒ½å“åº”compare:æ¶ˆæ¯ã€‚æœç´¢å¿½ç•¥å€¼ä¸ºnilçš„é›†åˆé¡¹ï¼Œä¹Ÿå¯é€šè¿‡é‡å†™compare:æ–¹æ³•å¯¹æœç´¢ç»“æœè¿›è¡Œæ§åˆ¶ã€‚</p>
</blockquote>
<h5 id="æ•°ç»„è¿ç®—ç¬¦"><a href="#æ•°ç»„è¿ç®—ç¬¦" class="headerlink" title="æ•°ç»„è¿ç®—ç¬¦"></a>æ•°ç»„è¿ç®—ç¬¦</h5><p>æ ¹æ®è¿ç®—ç¬¦çš„æ¡ä»¶ï¼Œå°†ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡ä»¥ä¸€ä¸ªNSArrayå®ä¾‹è¿”å›ã€‚</p>
<h6 id="unionOfObjects"><a href="#unionOfObjects" class="headerlink" title="@unionOfObjects"></a>@unionOfObjects</h6><p>è¯»å–æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„å³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§ï¼Œæ”¾åœ¨ä¸€ä¸ªNSArrayå®ä¾‹ä¸­è¿”å›</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è·å–é›†åˆä¸­çš„æ‰€æœ‰payeeå¯¹è±¡</span><br><span class="line">NSArray *payees &#x3D; [self.transactions valueForKeyPath:@&quot;@unionOfObjects.payee&quot;];</span><br><span class="line">&#x2F;&#x2F; payees æ•°ç»„ä¸­åŒ…å«æ‰€æœ‰payeeå…ƒç´ çš„å­—ç¬¦ä¸²</span><br></pre></td></tr></table></figure>

<h6 id="distinctUnionOfObjects"><a href="#distinctUnionOfObjects" class="headerlink" title="@distinctUnionOfObjects"></a>@distinctUnionOfObjects</h6><p>è¯»å–æ•°ç»„ä¸­æ¯ä¸ªå…ƒç´ çš„å³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§ï¼Œæ”¾åœ¨ä¸€ä¸ªNSArrayå®ä¾‹ä¸­ï¼Œå°†æ•°ç»„è¿›è¡Œå»é‡åè¿”å›ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; è·å–é›†åˆä¸­çš„æ‰€æœ‰ä¸åŒçš„ payee å¯¹è±¡ã€‚</span><br><span class="line">NSArray *distinctPayees &#x3D; [self.transactions valueForKeyPath:@&quot;@distinctUnionOfObjects.payee&quot;];</span><br><span class="line">&#x2F;&#x2F; distinctPayees æ•°ç»„åŒ…å«ä»¥ä¸‹å­—ç¬¦ä¸²ï¼šCar Loan, General Cable, Animal Hospital, Green Power, Mortgage</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šåœ¨ä½¿ç”¨æ•°ç»„è¿ç®—ç¬¦æ—¶ï¼Œå¦‚æœæœ‰ä»»ä½•æ“ä½œçš„å¯¹è±¡ä¸ºnilï¼Œåˆ™valueForKeyPath:æ–¹æ³•å°†å¼•å‘å¼‚å¸¸</p>
</blockquote>
<h5 id="åµŒå¥—è¿ç®—ç¬¦"><a href="#åµŒå¥—è¿ç®—ç¬¦" class="headerlink" title="åµŒå¥—è¿ç®—ç¬¦"></a>åµŒå¥—è¿ç®—ç¬¦</h5><p>å¤„ç†é›†åˆå¯¹è±¡ä¸­åµŒå¥—å…¶ä»–é›†åˆå¯¹è±¡çš„æƒ…å†µï¼Œå¹¶æ ¹æ®è¿ç®—ç¬¦è¿”å›ä¸€ä¸ªNSArray å’Œ NSSetå®ä¾‹ã€‚</p>
<p>å¦‚ä¸‹ï¼Œä¸€ä¸ªæ•°ç»„ä¸­æ”¾ç€å¦å¤–ä¸¤ä¸ªæ•°ç»„</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSArray</span>* moreTransactions = @[&lt;<span class="meta"># transaction data #&gt;];</span></span><br><span class="line"><span class="built_in">NSArray</span>* arrayOfArrays = @[<span class="keyword">self</span>.transactions, moreTransactions];</span><br></pre></td></tr></table></figure>

<h6 id="unionOfArrays"><a href="#unionOfArrays" class="headerlink" title="@unionOfArrays"></a>@unionOfArrays</h6><p>è¯»å–é›†åˆä¸­æ¯ä¸ªé›†åˆä¸­æ¯ä¸ªå…ƒç´ çš„å³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§ï¼Œæ”¾åœ¨ä¸€ä¸ªNSArrayå®ä¾‹ä¸­è¿”å›ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– arrayOfArrays é›†åˆä¸­çš„æ¯ä¸ªé›†åˆä¸­çš„æ‰€æœ‰ payee å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="built_in">NSArray</span> *collectedPayees = [arrayOfArrays valueForKeyPath:<span class="string">@"@unionOfArrays.payee"</span>];</span><br></pre></td></tr></table></figure>

<h6 id="distinctUnionOfArrays"><a href="#distinctUnionOfArrays" class="headerlink" title="@distinctUnionOfArrays"></a>@distinctUnionOfArrays</h6><p>è¯»å–é›†åˆä¸­æ¯ä¸ªé›†åˆæ¯ä¸ªå…ƒç´ çš„å³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§ï¼Œæ”¾åœ¨ä¸€ä¸ªNSArrayå®ä¾‹ä¸­ï¼Œå°†æ•°ç»„è¿›è¡Œå»é‡åè¿”å›ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å– arrayOfArrays é›†åˆä¸­çš„æ¯ä¸ªé›†åˆä¸­çš„æ‰€æœ‰ä¸åŒçš„ payee å¯¹è±¡ã€‚</span></span><br><span class="line"><span class="built_in">NSArray</span> *collectedDistinctPayees = [arrayOfArrays valueForKeyPath:<span class="string">@"@distinctUnionOfArrays.payee"</span>];</span><br></pre></td></tr></table></figure>

<h6 id="distinctUnionOfSets"><a href="#distinctUnionOfSets" class="headerlink" title="@distinctUnionOfSets"></a>@distinctUnionOfSets</h6><p>è¯»å–é›†åˆä¸­æ¯ä¸ªé›†åˆæ¯ä¸ªå…ƒç´ çš„å³é”®è·¯å¾„æŒ‡å®šçš„å±æ€§ï¼Œæ”¾åœ¨ä¸€ä¸ªNSSetå®ä¾‹ä¸­ï¼Œå»é‡åè¿”å›ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NSSet</span> *collectedDistinctPayees = [setOfSets valueForKeyPath:<span class="string">@"@distinctUnionOfSets.payee"</span>];</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>æ³¨æ„ï¼š</strong></p>
<ul>
<li>åœ¨ä½¿ç”¨åµŒå¥—è¿ç®—ç¬¦æ—¶ï¼ŒvalueForKeyPath:å†…éƒ¨ä¼šæ ¹æ®è¿ç®—ç¬¦åˆ›å»ºä¸€ä¸ªNSMuatbleArray æˆ– NSMuatbleSetå¯¹è±¡ï¼Œå°†é›†åˆä¸­çš„array å’Œ setæ·»åŠ è¿›å»åœ¨è¿›è¡Œæ“ä½œã€‚å¦‚æœé›†åˆä¸­æœ‰éé›†åˆå…ƒç´ ï¼Œä¼šå¯¼è‡´Crash</li>
<li>ä½¿ç”¨unionArrays æˆ– distionctUnionOfArraysè¿ç®—ç¬¦ï¼Œæ¶ˆæ¯æ¥æ”¶è€…åº”è¯¥æ˜¯arrayOfArraysç±»å‹ï¼Œå³<code>NSArray&lt;NASrray *&gt; *arrayOfArrays;</code>ï¼›ä½¿ç”¨distinctUnionOfSetsè¿ç®—ç¬¦ï¼Œæ¶ˆæ¯æ¥æ”¶è€…çš„ç±»å‹åº”è¯¥æ˜¯setOfSetsæˆ–è€…arrayOfSetsç±»å‹ï¼Œå¦åˆ™ä¼šå‘ç”Ÿå¼‚å¸¸ã€‚</li>
<li>åœ¨ä½¿ç”¨åµŒå¥—è¿ç®—ç¬¦æ—¶ï¼Œå¦‚æœæœ‰ä»»ä½•æ“ä½œå¯¹è±¡ä¸ºnilï¼Œåˆ™valueForKeyPath:æ–¹æ³•å°†å¼•å‘å¼‚å¸¸</li>
</ul>
</blockquote>
<h5 id="æ‰©å±•"><a href="#æ‰©å±•" class="headerlink" title="æ‰©å±•"></a>æ‰©å±•</h5><p>å¦‚æœé›†åˆå¯¹è±¡éƒ½æ˜¯NSNumberï¼Œå³é”®è·¯å¾„å¯ä»¥ç”¨self</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NSArray *array &#x3D; @[@1, @2, @3, @4, @5];</span><br><span class="line">NSNumber *sum &#x3D; [array valueForKeyPath:@&quot;@sum.self&quot;];</span><br><span class="line">NSLog(@&quot;%d&quot;,[sum intValue]);</span><br></pre></td></tr></table></figure>

<h4 id="è‡ªå®šä¹‰é›†åˆè¿ç®—ç¬¦"><a href="#è‡ªå®šä¹‰é›†åˆè¿ç®—ç¬¦" class="headerlink" title="è‡ªå®šä¹‰é›†åˆè¿ç®—ç¬¦"></a>è‡ªå®šä¹‰é›†åˆè¿ç®—ç¬¦</h4><p>æ ¹æ®<code>Runtime</code>è·å–<code>NSArray</code>ç±»çš„æ–¹æ³•åˆ—è¡¨</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)print_arrayMethodList &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> count;</span><br><span class="line">    Method *methods = class_copyMethodList([<span class="built_in">NSArray</span> <span class="keyword">class</span>], &amp;count);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; count; i++) &#123;</span><br><span class="line">        Method method = methods[i];</span><br><span class="line">        SEL sel = method_getName(method);</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,<span class="built_in">NSStringFromSelector</span>(sel));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¾“å‡ºç»“æœ(æœªå®Œå…¨æˆªå›¾)ï¼š</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201208151209139.png" alt="image-20201208151209139"></p>
<p>æ–¹æ³•å¾ˆå¤šï¼Œæœç´¢å…³é”®å­—<code>avg</code>ã€<code>count</code>ã€<code>sum</code>ç­‰<code>KVC</code>ä¸ºæˆ‘ä»¬æä¾›çš„é›†åˆè¿ç®—ç¬¦ï¼Œå‘ç°éƒ½æœ‰å¯¹è±¡çš„æ–¹æ³•<code>_&lt;operatorKey&gt;ForKeyPath:</code></p>
<blockquote>
<p>æ³¨æ„ï¼šå†æ¥çœ‹ä¸€ä¸‹<code>NSSet</code>ç±»æ”¯æŒçš„é›†åˆè¿ç®—ç¬¦ï¼š</p>
<p>å¯è§<code>NSSet</code>ç±»ä¸æ”¯æŒ<code>@unionOfObjects</code> å’Œ <code>@unionOfArrays</code>è¿ç®—ç¬¦ï¼Œå¦‚æœä½¿ç”¨äº†å°±ä¼šæŠ›å‡º<code>NSInvalidArgumentException</code>å¼‚å¸¸å¹¶å´©æºƒï¼Œreasonï¼š<code>[&lt;__NSSetI 0x6000017a12f0&gt; valueForKeyPath:]: this class does not implement the unionOfArrays operation.</code>ä¸æ”¯æŒè¯¥è¿ç®—ç¬¦ã€‚</p>
<p>è€Œ<code>NSArray</code>ç±»è™½ç„¶æ”¯æŒ<code>@distinctUnionOfSets</code>è¿ç®—ç¬¦ï¼Œä½†æ˜¯å¿…é¡»æ˜¯<code>arrayOfSets</code>ç±»å‹ï¼Œå³<code>NSArray&lt; NSSet* &gt;* arrayOfSets;</code>ï¼Œå› ä¸º<code>_distinctUnionOfSetsForKeyPath</code>æ–¹æ³•ä¸­ä¼šåˆ›å»ºä¸€ä¸ª<code>NSMutableSet</code>å®ä¾‹ï¼Œå¹¶è°ƒç”¨<code>unionSet:</code>æ–¹æ³•å°†é›†åˆä¸­çš„setå…ƒç´ æ·»åŠ è¿›å»å†è¿›è¡Œæ“ä½œï¼Œå¦‚æœæ˜¯<code>arrayOfArrays</code>ç±»å‹å°±ä¼šæŠ›å‡º<code>NSInvalidArgumentException</code>å¹¶å¯¼è‡´ç¨‹åºå´©æºƒï¼Œreason: <code>&#39;*** -[NSMutableSet unionSet:]: set argument is not an NSSet&#39;</code>å³é›†åˆä¸­æœ‰é<code>NSSet</code>å…ƒç´ ã€‚</p>
</blockquote>
<p>æˆ‘ä»¬å°è¯•ä¸ºNSArrayæ·»åŠ ä¸€ä¸ªåˆ†ç±»ï¼Œå¹¶å®šä¹‰ä¸€ä¸ª_medianForKeyPath:æ–¹æ³•ï¼Œç”¨æ¥è·å–NSArrayä¸­çš„ä¸­ä½æ•°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">@interface NSArray (kvc)</span><br><span class="line">@end</span><br><span class="line"></span><br><span class="line">@implementation NSArray (kvc)</span><br><span class="line">- (NSNumber *)_medianForKeyPath:(NSString *)keyPath &#123;</span><br><span class="line">    &#x2F;&#x2F;æ’åº</span><br><span class="line">    NSArray *sortedArray &#x3D; [self sortedArrayUsingSelector:@selector(compare:)];</span><br><span class="line">    double median;</span><br><span class="line">    if (self.count % 2 &#x3D;&#x3D; 0) &#123;</span><br><span class="line">        NSInteger index1 &#x3D; sortedArray.count * 0.5;</span><br><span class="line">        NSInteger index2 &#x3D; sortedArray.count * 0.5 - 1;</span><br><span class="line">        median &#x3D; ([[sortedArray objectAtIndex:index1] doubleValue] + [[sortedArray objectAtIndex:index2] doubleValue]) * 0.5;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        NSInteger index &#x3D; (sortedArray.count-1) * 0.5;</span><br><span class="line">        median &#x3D; [[sortedArray objectAtIndex:index] doubleValue];</span><br><span class="line">    &#125;</span><br><span class="line">    return [NSNumber numberWithDouble:median];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@end</span><br></pre></td></tr></table></figure>

<p>æµ‹è¯•</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">+ (<span class="keyword">void</span>)medianObject_kvc &#123;</span><br><span class="line">    <span class="built_in">NSArray</span> *arr = @[@<span class="number">3</span>,@<span class="number">4</span>,@<span class="number">8</span>,@<span class="number">1</span>];</span><br><span class="line">    <span class="built_in">NSNumber</span> *num = [arr valueForKeyPath:<span class="string">@"@median.self"</span>];</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%@"</span>,num);</span><br><span class="line">&#125;</span><br><span class="line">[<span class="number">15</span>:<span class="number">55</span>:<span class="number">06</span>] +[MMKVC medianObject_kvc] [ç¬¬<span class="number">67</span>è¡Œ] ğŸ’• <span class="number">3.5</span></span><br></pre></td></tr></table></figure>

<h4 id="éå¯¹è±¡å€¼å¤„ç†"><a href="#éå¯¹è±¡å€¼å¤„ç†" class="headerlink" title="éå¯¹è±¡å€¼å¤„ç†"></a>éå¯¹è±¡å€¼å¤„ç†</h4><p><code>KVC</code>æ”¯æŒåŸºç¡€æ•°æ®ç±»å‹å’Œç»“æ„ä½“ï¼Œåœ¨ä½¿ç”¨<code>KVC</code>èµ‹å€¼æˆ–å–å€¼çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åœ¨éå¯¹è±¡å€¼å’Œå¯¹è±¡å€¼ä¹‹é—´è½¬æ¢</p>
<ul>
<li>å½“è¿›è¡Œå–å€¼å¦‚<code>valueForKey:</code>æ—¶ï¼Œå¦‚æœè¿”å›å€¼éå¯¹è±¡ï¼Œä¼šä½¿ç”¨è¯¥å€¼åˆå§‹åŒ–ä¸€ä¸ª<code>NSNumber</code>æˆ– <code>NSValue</code>å®ä¾‹ï¼Œç„¶åè¿”å›è¯¥å®ä¾‹ã€‚</li>
<li>å½“è¿›è¡Œèµ‹å€¼å¦‚<code>setValue:forKey:</code>æ—¶ï¼Œå¦‚æœkeyçš„æ•°æ®ç±»å‹éå¯¹è±¡ï¼Œåˆ™ä¼šå‘é€ä¸€æ¡<code>&lt;type&gt;Value</code>æ¶ˆæ¯ç»™valueå¯¹è±¡ä»¥æå–åŸºç¡€æ•°æ®ï¼Œç„¶åå¤åˆ¶ç»™<code>key</code></li>
</ul>
<blockquote>
<p>æ³¨æ„ï¼š</p>
<ul>
<li>å› ä¸ºswiftä¸­çš„æ‰€æœ‰å±æ€§éƒ½æ˜¯å¯¹è±¡ï¼Œæ‰€ä»¥è¿™é‡Œä»…é€‚ç”¨äºObjective-Cå±æ€§ã€‚å½“è¿›è¡Œèµ‹å€¼å¦‚setValue:forKeyæ—¶ï¼Œå¦‚æœkey çš„æ•°æ®ç±»æ˜¯éå¯¹è±¡ç±»å‹ï¼Œåˆ™valueå°±ç¦æ­¢ä¼ nilã€‚å¦åˆ™è°ƒç”¨setNilValueForKey:æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„é»˜è®¤å®ç°æŠ›å‡ºå¼‚å¸¸NSInvalidArgumentExceptionï¼Œå¹¶å¯¼è‡´Crash</li>
</ul>
</blockquote>
<h4 id="å±æ€§éªŒè¯"><a href="#å±æ€§éªŒè¯" class="headerlink" title="å±æ€§éªŒè¯"></a>å±æ€§éªŒè¯</h4><p><code>KVC</code>æä¾›äº†å±æ€§éªŒè¯çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä½¿ç”¨<code>KVC</code>èµ‹å€¼å‰éªŒè¯èƒ½å¦ä¸ºè¿™ä¸ª<code>key</code>èµ‹å€¼æŒ‡å®šçš„<code>value</code>ã€‚</p>
<p><code>validateValue</code>æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æŸ¥çœ‹æ¶ˆæ¯æ¥æ”¶è€…ç±»ä¸­æ˜¯å¦å®ç°äº†éµå¾ªå‘½åè§„åˆ™ä¸º<code>validate&lt;key&gt;:error:</code>çš„æ–¹æ³•ï¼Œå¦‚æœæœ‰å°±è¿”å›è°ƒç”¨è¯¥æ–¹æ³•çš„ç»“æœï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±é»˜è®¤éªŒè¯æˆåŠŸå¹¶è¿”å›YESï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¶ˆæ¯æ¥æ”¶è€…ç±»ä¸­å®ç°<code>validate&lt;key&gt;:error:</code>æ–¹æ³•æ¥å®šä¹‰é€»è¾‘è¿”å›YES æˆ– NO</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="built_in">BOOL</span>)validateValue:(<span class="keyword">inout</span> <span class="keyword">id</span> _Nullable * _Nonnull)ioValue forKeyPath:(<span class="built_in">NSString</span> *)inKeyPath error:(<span class="keyword">out</span> <span class="built_in">NSError</span> **)outError;</span><br><span class="line"></span><br><span class="line">- (<span class="built_in">BOOL</span>)validateValue:(<span class="keyword">inout</span> <span class="keyword">id</span> _Nullable * _Nonnull)ioValue forKey:(<span class="built_in">NSString</span> *)inKey error:(<span class="keyword">out</span> <span class="built_in">NSError</span> **)outError;</span><br></pre></td></tr></table></figure>

<p>ç¤ºä¾‹</p>
<p>åœ¨Personç±»ä¸­å®ç°äº†validateName:error:æ–¹æ³•ï¼ŒéªŒè¯ç»™nameèµ‹çš„å€¼æ˜¯ä¸æ˜¯Jackã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ViewController.m</span></span><br><span class="line">    Person *person = [[Person alloc] init];</span><br><span class="line">    <span class="built_in">NSString</span> *value = <span class="string">@"rose"</span>;</span><br><span class="line">    <span class="built_in">NSString</span> *key = <span class="string">@"name"</span>;</span><br><span class="line">    <span class="built_in">NSError</span>  *error;</span><br><span class="line">    <span class="built_in">BOOL</span> result = [person validateValue:&amp;value forKey:key error:&amp;error];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (error) &#123;</span><br><span class="line">        <span class="built_in">NSLog</span>(<span class="string">@"error = %@"</span>, error);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">NSLog</span>(<span class="string">@"%d"</span>,result);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Person.m</span></span><br><span class="line">- (<span class="built_in">BOOL</span>)validateName:(<span class="keyword">id</span> *)value error:(<span class="keyword">out</span> <span class="built_in">NSError</span> * _Nullable __autoreleasing *)outError</span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">NSString</span> *name = *value;</span><br><span class="line">    <span class="built_in">BOOL</span> result = <span class="literal">NO</span>;</span><br><span class="line">    <span class="keyword">if</span> ([name isEqualToString:<span class="string">@"jack"</span>]) &#123;</span><br><span class="line">        result = <span class="literal">YES</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ‰“å°ï¼š0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¤‡æ³¨ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼ŒKVCæ˜¯ä¸ä¼šè‡ªåŠ¨éªŒè¯å±æ€§çš„ã€‚</p>
</blockquote>
<h4 id="æœç´¢è§„åˆ™"><a href="#æœç´¢è§„åˆ™" class="headerlink" title="æœç´¢è§„åˆ™"></a>æœç´¢è§„åˆ™</h4><h5 id="åŸºæœ¬çš„getteræœç´¢æ¨¡å¼"><a href="#åŸºæœ¬çš„getteræœç´¢æ¨¡å¼" class="headerlink" title="åŸºæœ¬çš„getteræœç´¢æ¨¡å¼"></a>åŸºæœ¬çš„getteræœç´¢æ¨¡å¼</h5><p>ä»¥ä¸‹æ˜¯valueForKey:æ–¹æ³•çš„é»˜è®¤å®ç°ï¼Œç»™å®šä¸€ä¸ªkeyä½œä¸ºè¾“å…¥å‚æ•°ï¼Œåœ¨æ¶ˆæ¯æ¥æ”¶è€…ç±»ä¸­æ“ä½œï¼Œæ‰§è¡Œä»¥ä¸‹è¿‡ç¨‹ã€‚</p>
<ol>
<li>æŒ‰ç…§<code>get&lt;key&gt;</code>ã€<code>&lt;key&gt;</code>ã€<code>is&lt;key&gt;</code>ã€<code>_&lt;key&gt;</code>é¡ºåºæŸ¥æ‰¾ï¼Œå¦‚æœæ‰¾åˆ°å°±è°ƒç”¨å–å€¼ç›´æ¥æ‰§è¡Œ5ï¼Œå¦åˆ™æ‰§è¡Œ2</li>
<li>æŸ¥æ‰¾countOf<key>ã€objectIn<key>AtIndex:ã€<key>AtIndexes:å‘½åçš„æ–¹æ³•ã€‚å¦‚æœæ‰¾åˆ°ç¬¬ä¸€ä¸ªå’Œåé¢ä¸¤ä¸ªä¸­çš„è‡³å°‘ä¸€ä¸ªï¼Œåˆ™åˆ›å»ºä¸€ä¸ªèƒ½å¤Ÿå“åº”æ‰€æœ‰NSArrayçš„æ–¹æ³•çš„é›†åˆä»£ç†å¯¹è±¡ï¼ˆç±»å‹ä¸ºNSKeyValueArrayï¼Œç»§æ‰¿NSArrayï¼‰ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡ã€‚å¦åˆ™æ‰§è¡Œ3<ul>
<li>ä»£ç†å¯¹è±¡éšåå°†å°†å…¶æ¥æ”¶åˆ°çš„ä»»ä½•NSArrayæ¶ˆæ¯è½¬æ¢ä¸ºcountOf<key>ã€objetIn<key>AtIndex:ã€<key>AtIndexes:æ¶ˆæ¯çš„ç»„åˆï¼Œå¹¶å°†å…¶å‘é€ç»™KVCè°ƒç”¨æ–¹ã€‚å¦‚æœåŸå§‹å¯¹è±¡è¿˜å®ç°äº†ä¸€ä¸ªåä¸ºget<key>:range:çš„å¯é€‰æ–¹æ³•ï¼Œåˆ™ä»£ç†å¯¹è±¡ä¹Ÿä¼šåœ¨é€‚å½“æ—¶ä½¿ç”¨è¯¥æ–¹æ³•</li>
<li>å½“KVCè°ƒç”¨æ–¹ä¸ä»£ç†å¯¹è±¡ä¸€èµ·å·¥ä½œæ—¶ï¼Œå…è®¸åº•å±‚å±æ€§çš„è¡Œä¸ºå¦‚æœNSArrayä¸€æ ·ï¼Œå³ä½¿å®ƒä¸æ˜¯NSArray</li>
</ul>
</li>
<li>æŸ¥æ‰¾<code>countOf&lt;key&gt;</code>ã€<code>enumeratorOf&lt;key&gt;</code>ã€<code>memberOf&lt;key&gt;:</code>å‘½åçš„æ–¹æ³•ï¼Œå¦‚æœä¸‰ä¸ªæ–¹æ³•éƒ½æ‰¾åˆ°ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªèƒ½å¤Ÿå“åº”æ‰€æœ‰NSSetçš„æ–¹æ³•çš„é›†åˆä»£ç†å¯¹è±¡ï¼ˆç±»å‹ä¸ºNSKeyValueSetï¼Œç»§æ‰¿è‡ªNSSetï¼‰ï¼Œå¹¶è¿”å›è¯¥å¯¹è±¡ã€‚å¦åˆ™æ‰§è¡Œ4<ul>
<li>ä»£ç†å¯¹è±¡éšåå°†å…¶æ¥æ”¶åˆ°çš„ä»»ä½•NSSetæ¶ˆæ¯è½¬æ¢ä¸º<code>countOf&lt;key&gt;</code>ã€<code>enumeratorOf&lt;key&gt;</code>ã€<code>memberOf&lt;key&gt;:</code>æ¶ˆæ¯çš„ç»„åˆï¼Œå¹¶å°†å…¶å‘é€ç»™KVCçš„è°ƒç”¨æ–¹</li>
<li>å½“KVCè°ƒç”¨æ–¹ä¸ä»£ç†å¯¹è±¡ä¸€èµ·å·¥ä½œæ—¶ï¼Œå…è®¸åº•å±‚å±æ€§çš„è¡Œä¸ºå¦‚åŒNSSetä¸€æ ·ï¼Œå³ä½¿ä»–ä¸æ˜¯NSSetã€‚</li>
</ul>
</li>
<li>æŸ¥çœ‹æ¶ˆæ¯æ¥æ”¶è€…ç±»çš„<code>+accessInstanceVariableDirectly</code>æ–¹æ³•çš„è¿”å›å€¼ï¼ˆé»˜è®¤è¿”å›YESï¼‰ï¼Œå¦‚æœè¿”å›YESï¼Œå°±æŒ‰ç…§<code>_&lt;key&gt;</code>ã€<code>_is&lt;key&gt;</code>ã€<code>&lt;key&gt;</code>ã€<code>is&lt;key&gt;</code>é¡ºåºæŸ¥æ‰¾æˆå‘˜å˜é‡ã€‚å¦‚æœæ‰¾åˆ°å°±ç›´æ¥å–å€¼æ‰§è¡Œ5ï¼Œå¦åˆ™æ‰§è¡Œ6ã€‚å¦‚æœ<code>+accessInstanceVariableDirectly</code>æ–¹æ³•è¿”å›NOï¼Œ ä¹Ÿä¼šæ‰§è¡Œ6</li>
<li>å¦‚æœå–åˆ°å€¼æ˜¯ä¸€ä¸ªå¯¹è±¡æŒ‡é’ˆï¼Œå³è·å–çš„æ˜¯å¯¹è±¡ï¼Œåˆ™ç›´æ¥å°†å¯¹è±¡è¿”å›ã€‚å¦‚æœå–å¾—å€¼æ˜¯ä¸€ä¸ªNSNumberæ”¯æŒçš„æ•°æ®ç±»å‹ï¼Œåˆ™è½¬æ¢ä¸ºNSValueå¯¹è±¡ï¼Œç„¶åè¿”å›ã€‚</li>
<li>è°ƒç”¨valueForUndefinedKey:æ–¹æ³•ï¼Œè¯¥æ–¹æ³•æŠ›å‡ºå¼‚å¸¸NSUnknownKeyExceptionï¼Œå¹¶å¯¼è‡´ç¨‹åºCrashï¼Œè¿™æ˜¯é»˜è®¤å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™è¯¥æ–¹æ³•æ ¹æ®ç‰¹ç‚¹çš„keyåšä¸€äº›ç‰¹æ®Šå¤„ç†ã€‚</li>
</ol>
<h5 id="åŸºæœ¬çš„Setteræœç´¢æ¨¡å¼"><a href="#åŸºæœ¬çš„Setteræœç´¢æ¨¡å¼" class="headerlink" title="åŸºæœ¬çš„Setteræœç´¢æ¨¡å¼"></a>åŸºæœ¬çš„Setteræœç´¢æ¨¡å¼</h5><p>ä»¥ä¸‹æ˜¯setValue:forKeyæ–¹æ³•çš„é»˜è®¤å®ç°ï¼Œç»™å®šä¸€ä¸ªkeyä½œä¸ºè¾“å…¥å‚æ•°ï¼Œè¿”å›å±æ€§åä¸ºkeyçš„é›†åˆçš„ä»£ç†å¯¹è±¡ï¼ˆè¿™é‡ŒæŒ‡çš„æ˜¯NSMutableArrayå¯¹è±¡ï¼‰ï¼Œåœ¨æ¶ˆæ¯æ¥æ”¶è€…ç±»ä¸­æ“ä½œï¼Œæ‰§è¡Œä»¥ä¸‹è¿‡ç¨‹ã€‚</p>
<ol>
<li><p>æŸ¥æ‰¾â€”å¯¹æ–¹æ³•<code>insert&lt;Key&gt;:atIndexes:</code>å’Œ<code>remove&lt;Key&gt;AtIndexes:</code><br>ï¼ˆç›¸å½“äº<code>NSMutableArray</code>çš„åŸå§‹æ–¹æ³•<code>insertObjects:atIndexes:</code>å’Œ<code>removeObjectsAtIndexes:</code>ï¼‰ã€‚</p>
<ul>
<li><p>å¦‚æœæˆ‘ä»¬è‡³å°‘å®ç°äº†ä¸€ä¸ª<code>insertion</code>æ–¹æ³•å’Œä¸€ä¸ª<code>removal</code>æ–¹æ³•ï¼Œåˆ™è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œæ¥å“åº”å‘é€ç»™<code>NSMutableArray</code>çš„æ¶ˆæ¯ï¼Œé€šè¿‡å‘é€<code>insertObject:in&lt;Key&gt;AtIndex:</code>ã€<code>removeObjectFrom&lt;Key&gt;AtIndex:</code>ã€<code>insert&lt;Key&gt;:atIndexes:</code>ã€<code>remove&lt;Key&gt;AtIndexes:</code>ç»„åˆæ¶ˆæ¯ç»™<code>KVC</code>è°ƒç”¨æ–¹ã€‚å¦åˆ™æ‰§è¡Œâ‘¡ã€‚</p>
<blockquote>
<p>è¯¥ä»£ç†å¯¹è±¡ç±»å‹ä¸º<code>NSKeyValueFastMutableArray2</code>ï¼Œç»§æ‰¿é“¾ä¸º<code>NSKeyValueFastMutableArray2</code>-&gt;<code>NSKeyValueFastMutableArray</code>-&gt;<code>NSKeyValueMutableArray</code>-&gt;<code>NSMutableArray</code>ã€‚</p>
</blockquote>
</li>
<li><p>å¦‚æœæˆ‘ä»¬ä¹Ÿå®ç°äº†ä¸€ä¸ªå¯é€‰çš„<code>replace object</code>æ–¹æ³•ï¼Œå¦‚<code>replaceObjectIn&lt;Key&gt;AtIndex:withObject:</code>æˆ–<code>replace&lt;Key&gt;AtIndexes:with&lt;Key&gt;:</code>ï¼Œä»£ç†å¯¹è±¡åœ¨é€‚å½“çš„æƒ…å†µä¸‹ä¹Ÿä¼šä½¿ç”¨å®ƒä»¬ï¼Œä»¥è·å¾—æœ€ä½³æ€§èƒ½ã€‚</p>
</li>
</ul>
</li>
<li><p>æŸ¥æ‰¾<code>set&lt;Key&gt;:</code>æ–¹æ³•ã€‚å¦‚æœæ‰¾åˆ°ï¼Œå°±ä¼šå‘<code>KVC</code>è°ƒç”¨æ–¹å‘é€ä¸€ä¸ª<code>set&lt;Key&gt;:</code></p>
<p>æ¶ˆæ¯ï¼Œæ¥è¿”å›ä¸€ä¸ªå“åº”<code>NSMutableArray</code>æ¶ˆæ¯çš„ä»£ç†å¯¹è±¡ã€‚å¦åˆ™æ‰§è¡Œâ‘¢ã€‚</p>
<blockquote>
<p>è¯¥ä»£ç†å¯¹è±¡ç±»å‹ä¸º<code>NSKeyValueSlowMutableArray</code>ï¼Œç»§æ‰¿é“¾ä¸º<code>NSKeyValueSlowMutableArray</code>-&gt;<code>NSKeyValueMutableArray</code>-&gt;<code>NSMutableArray</code>ã€‚</p>
</blockquote>
<blockquote>
<p>æ³¨æ„ï¼š** æ­¤æ­¥éª¤ä¸­æè¿°çš„æœºåˆ¶æ¯”ä¸Šä¸€æ­¥çš„æ•ˆç‡ä½å¾—å¤šï¼Œå› ä¸ºå®ƒå¯èƒ½é‡å¤åˆ›å»ºæ–°çš„é›†åˆå¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¿®æ”¹ç°æœ‰çš„é›†åˆå¯¹è±¡ã€‚å› æ­¤ï¼Œåœ¨è®¾è®¡è‡ªå·±çš„é”®å€¼ç¼–ç å…¼å®¹å¯¹è±¡æ—¶ï¼Œé€šå¸¸åº”è¯¥é¿å…ä½¿ç”¨å®ƒã€‚</p>
<p>ç»™ä»£ç†å¯¹è±¡å‘é€<code>NSMutableArray</code>æ¶ˆæ¯éƒ½ä¼šè°ƒç”¨<code>set&lt;Key&gt;:</code>æ–¹æ³•ã€‚å³ï¼Œå¯¹ä»£ç†å¯¹è±¡è¿›è¡Œä¿®æ”¹ï¼Œéƒ½æ˜¯è°ƒç”¨<code>set&lt;Key&gt;:</code>æ¥é‡æ–°èµ‹å€¼ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šä½å¾ˆå¤šã€‚</p>
</blockquote>
</li>
<li><p>æŸ¥çœ‹æ¶ˆæ¯æ¥æ”¶è€…ç±»çš„<code>+accessInstanceVariablesDirectly</code>æ–¹æ³•çš„è¿”å›å€¼ï¼ˆé»˜è®¤è¿”å›<code>YES</code>ï¼‰ã€‚å¦‚æœè¿”å›<code>YES</code>ï¼Œå°±æŒ‰ç…§<code>_&lt;key&gt;</code>ã€<code>&lt;key&gt;</code>é¡ºåºæŸ¥æ‰¾æˆå‘˜å˜é‡ã€‚å¦‚æœæ‰¾åˆ°å°±è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¯¥ä»£ç†å¯¹è±¡å°†æ¥æ”¶æ‰€æœ‰<code>NSMutableArray</code>æ¶ˆæ¯ï¼Œé€šå¸¸æ˜¯<code>NSMutableArray</code>æˆ–å…¶å­ç±»ã€‚å¦åˆ™æ‰§è¡Œâ‘£ã€‚å¦‚æœ<code>+accessInstanceVariablesDirectly</code>æ–¹æ³•è¿”å›<code>NO</code>ä¹Ÿæ‰§è¡Œâ‘£ã€‚</p>
</li>
<li><p>è¿”å›ä¸€ä¸ªå¯å˜çš„é›†åˆä»£ç†å¯¹è±¡ã€‚å½“å®ƒæ¥æ”¶åˆ°<code>NSMutableArray</code>æ¶ˆæ¯æ—¶ï¼Œå‘é€ä¸€ä¸ª<code>valueForUndefinedKey:</code>æ¶ˆæ¯ç»™<code>KVC</code>è°ƒç”¨æ–¹ï¼Œè¯¥æ–¹æ³•æŠ›å‡ºå¼‚å¸¸<code>NSUnknownKeyException</code>ï¼Œå¹¶å¯¼è‡´ç¨‹åº<code>Crash</code>ã€‚è¿™æ˜¯é»˜è®¤å®ç°ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™è¯¥æ–¹æ³•æ ¹æ®ç‰¹å®š<code>key</code>åšä¸€äº›ç‰¹æ®Šå¤„ç†ã€‚</p>
</li>
</ol>
<h5 id="å…¶ä»–æœç´¢æ¨¡å¼"><a href="#å…¶ä»–æœç´¢æ¨¡å¼" class="headerlink" title="å…¶ä»–æœç´¢æ¨¡å¼"></a>å…¶ä»–æœç´¢æ¨¡å¼</h5><p>é™¤äº†ä»¥ä¸Šä¸‰ç§ï¼Œ<code>KVC</code>è¿˜æœ‰<code>NSMutableSet</code>å’Œ<code>NSMutableOrderedSet</code>ä¸¤ç§æœç´¢æ¨¡å¼ï¼Œå®ƒä»¬çš„æœç´¢è§„åˆ™å’Œ<code>NSMutableArray</code>ç›¸åŒï¼Œåªæ˜¯æœç´¢å’Œè°ƒç”¨çš„æ–¹æ³•ä¸åŒã€‚å…·ä½“å¯ä»¥æŸ¥çœ‹<code>KVC</code>å®˜æ–¹æ–‡æ¡£ <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/KeyValueCoding/SearchImplementation.html#//apple_ref/doc/uid/20000955-CJBBBFFA" target="_blank" rel="noopener">KVC - Accessor Search Patterns</a></p>
<h4 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h4><ul>
<li><p>æ ¹æ®KVCæœç´¢è§„åˆ™ï¼Œå½“æ²¡æœ‰æœç´¢åˆ°å¯¹åº”çš„key æˆ–è€… keyPathç›¸å…³æ–¹æ³•æˆ–è€…å˜é‡æ—¶ï¼Œä¼šè°ƒç”¨å¯¹åº”çš„å¼‚å¸¸æ–¹æ³•valueForUndefinedKey: æˆ– setValue:forUndefinedKey:ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æŠ›å‡ºå¼‚å¸¸NSUnKnownKeyExceptionï¼Œå¹¶å¯¼è‡´ç¨‹åºCrashã€‚æˆ‘ä»¬å¯ä»¥é‡å†™è¿™ä¸¤ä¸ªæ–¹æ³•æ¥å¤„ç†å¼‚å¸¸</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Given that an invocation of -valueForKey: would be unable to get a keyed value using its default access mechanism, return the keyed value using some other mechanism. The default implementation of this method raises an NSUndefinedKeyException. You can override it to handle properties that are dynamically defined at run-time.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">nullable</span> <span class="keyword">id</span>)valueForUndefinedKey:(<span class="built_in">NSString</span> *)key;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Given that an invocation of -setValue:forKey: would be unable to set the keyed value using its default mechanism, set the keyed value using some other mechanism. The default implementation of this method raises an NSUndefinedKeyException. You can override it to handle properties that are dynamically defined at run-time.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">- (<span class="keyword">void</span>)setValue:(<span class="keyword">nullable</span> <span class="keyword">id</span>)value forUndefinedKey:(<span class="built_in">NSString</span> *)key;</span><br></pre></td></tr></table></figure>
</li>
<li><p>å½“è¿›è¡Œèµ‹å€¼å¦‚setValue:forKey:æ—¶ï¼Œå¦‚æœkeyçš„æ•°æ®ç±»å‹æ˜¯éå¯¹è±¡ç±»å‹ï¼Œåˆ™valueå°±ç¦æ­¢ä¼ nilã€‚å¦åˆ™è°ƒç”¨setNilValueForKey:æ–¹æ³•ï¼Œè¯¥æ–¹æ³•çš„é»˜è®¤å®ç°æ˜¯æŠ›å‡ºå¼‚å¸¸NSInvalidArgumentExceptionï¼Œå¹¶å¯¼è‡´ç¨‹åºCrashã€‚æˆ‘ä»¬å¯ä»¥é‡å†™è¿™ä¸ªæ–¹æ³•æ¥å¤„ç†å¼‚å¸¸ã€‚</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)setNilValueForKey:(<span class="built_in">NSString</span> *)key</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> ([key isEqualToString:<span class="string">@"hidden"</span>]) &#123;</span><br><span class="line">        [<span class="keyword">self</span> setValue:@(<span class="literal">NO</span>) forKey:@â€hiddenâ€];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        [<span class="keyword">super</span> setNilValueForKey:key];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/10/30/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-alloc%E3%80%81retainCount%E3%80%81retain%E3%80%81release%E3%80%81dealloc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/30/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-alloc%E3%80%81retainCount%E3%80%81retain%E3%80%81release%E3%80%81dealloc/" class="post-title-link" itemprop="url">å†…å­˜ç®¡ç†-allocã€retainCountã€retainã€releaseã€dealloc</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-30 10:32:42" itemprop="dateCreated datePublished" datetime="2020-10-30T10:32:42+08:00">2020-10-30</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-11-17 15:58:41" itemprop="dateModified" datetime="2020-11-17T15:58:41+08:00">2020-11-17</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æ¥ä¸‹æ¥ç»§ç»­ä»æºç è§’åº¦ï¼Œåˆ†æ<code>alloc</code>ã€<code>retainCount</code>ã€<code>retain</code>ã€<code>release</code>ã€<code>dealloc</code>ç­‰æ–¹æ³•çš„å®ç°ã€‚</p>
<p>æºç åœ°å€ï¼š<a href="https://opensource.apple.com/tarballs/objc4/" target="_blank" rel="noopener">https://opensource.apple.com/tarballs/objc4/</a></p>
<h3 id="slowpath-amp-fastpath"><a href="#slowpath-amp-fastpath" class="headerlink" title="slowpath &amp; fastpath"></a>slowpath &amp; fastpath</h3><blockquote>
<p>å®å®šä¹‰å¦‚ä¸‹ï¼š</p>
<p>#define fastpath(x) (__builtin_expect(bool(x), 1))</p>
<p>#define slowpath(x) (__builtin_expect(bool(x), 0))</p>
</blockquote>
<p>ä»–ä»¬éƒ½æ˜¯ç”¨äº†__builtin_expectå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> __builtin_expect(<span class="keyword">long</span> <span class="built_in">exp</span>, <span class="keyword">long</span> c);</span><br></pre></td></tr></table></figure>

<p><code>__builtin_expect()</code>å‡½æ•°æ˜¯GCCæä¾›ç»™ç¨‹åºå‘˜æ˜¯ç”¨çš„ï¼Œç”±äºå¤§éƒ¨åˆ†ç¨‹åºå‘˜åœ¨åˆ†æ”¯é¢„æµ‹ä¸Šéƒ½éå¸¸ç³Ÿç³•ï¼Œæ‰€ä»¥GCCæä¾›è¿™ä¸ªå†…å»ºå‡½æ•°æ¥å¸®åŠ©ç¨‹åºå‘˜å¤„ç†åˆ†æ”¯é¢„æµ‹ï¼Œç›®çš„æ˜¯å°†â€œåˆ†æ”¯è½¬ç§»â€çš„ä¿¡æ¯æä¾›ç»™ç¼–è¯‘å™¨ï¼Œè¿™æ ·ç¼–è¯‘å™¨å¯ä»¥å¯¹ä»£ç è¿›è¡Œä¼˜åŒ–ï¼Œä»¥å‡å°‘æŒ‡ä»¤è·³è½¬å¸¦æ¥çš„æ€§èƒ½ä¸‹é™ã€‚å®ƒçš„æ„æ€æ˜¯: <code>exp == c</code>çš„æ¦‚ç‡å¾ˆå¤§ã€‚</p>
<p><code>fastpath(x)</code> è¡¨ç¤º  <code>x</code> æ˜¯1çš„æ¦‚ç‡å¾ˆå¤§ï¼Œ<code>slowpath(x)</code>è¡¨ç¤º <code>x</code> æ˜¯0çš„æ¦‚ç‡å¾ˆå¤§ã€‚å®ƒå’Œifä¸€èµ·ä½¿ç”¨ï¼Œ<code>if (fastpath(x))</code>è¡¨ç¤ºæ‰§è¡Œ<code>if</code>è¯­å¥çš„å¯èƒ½æ€§å¤§ï¼Œ<code>if (slowpath(x))</code>è¡¨ç¤ºæ‰§è¡Œ<code>if</code>è¯­å¥çš„å¯èƒ½æ€§å°ã€‚</p>
<h3 id="alloc"><a href="#alloc" class="headerlink" title="alloc"></a>alloc</h3><p>allocæ–¹æ³•çš„å‡½æ•°è°ƒç”¨æ ˆ</p>
<h4 id="callAlloc"><a href="#callAlloc" class="headerlink" title="callAlloc"></a>callAlloc</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Call [cls alloc] or [cls allocWithZone:nil], with appropriate </span></span><br><span class="line"><span class="comment">// shortcutting optimizations.</span></span><br><span class="line"><span class="comment">// è°ƒç”¨[cls alloc] or [cls allocWithZone:nil]å‡½æ•°çš„æ—¶å€™ä¼šæ¥åˆ°è¿™é‡Œï¼Œä½¿ç”¨é€‚å½“çš„å¿«æ·æ–¹å¼ä¼˜åŒ–</span></span><br><span class="line"><span class="comment">// Call [cls alloc] or [cls allocWithZone:nil], with appropriate </span></span><br><span class="line"><span class="comment">// shortcutting optimizations.</span></span><br><span class="line"><span class="keyword">static</span> ALWAYS_INLINE <span class="keyword">id</span></span><br><span class="line">callAlloc(Class cls, <span class="keyword">bool</span> checkNil, <span class="keyword">bool</span> allocWithZone=<span class="literal">false</span>)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">  	<span class="comment">// æ ¡éªŒï¼ˆcheckNil &amp; !clsï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (slowpath(checkNil &amp;&amp; !cls)) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">  	<span class="comment">// å¦‚æœclsæ²¡æœ‰å®ç°é»˜è®¤çš„allocWithZoneï¼Œè°ƒç”¨_objc_rootAllocWithZone</span></span><br><span class="line">    <span class="keyword">if</span> (fastpath(!cls-&gt;ISA()-&gt;hasCustomAWZ())) &#123;</span><br><span class="line">        <span class="keyword">return</span> _objc_rootAllocWithZone(cls, <span class="literal">nil</span>);</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// No shortcuts available.</span></span><br><span class="line">  	<span class="comment">// ç»™cls å‘é€ allocWithZone:æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">if</span> (allocWithZone) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL, <span class="keyword">struct</span> _NSZone *))objc_msgSend)(cls, <span class="keyword">@selector</span>(allocWithZone:), <span class="literal">nil</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// å¦åˆ™å‘é€allocæ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL))objc_msgSend)(cls, <span class="keyword">@selector</span>(alloc));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>callAlloc()</code>å‡½æ•°ä¸»è¦æ‰§è¡Œäº†ä¸€ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>åˆ¤æ–­ç±»æœ‰æ²¡æœ‰å®ç°è‡ªå®šä¹‰çš„<code>allocWithZone</code>æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ï¼Œå°±è°ƒç”¨<code>_objc_rootAllocWithZone</code>å‡½æ•°ï¼ˆå¿«æ·æ–¹å¼ï¼‰</li>
<li>å¦‚æœæ²¡æœ‰å¿«æ·æ–¹å¼ï¼Œæ ¹æ®<code>allocWithZone</code>çš„å€¼ï¼Œtrue ç»™<code>cls</code>ç±»å‘é€<code>allocWithZone</code>æ¶ˆæ¯ï¼Œfalseåˆ™ç»™<code>cls</code>ç±»å‘é€<code>alloc</code>æ¶ˆæ¯</li>
</ul>
<h4 id="allocWithZone"><a href="#allocWithZone" class="headerlink" title="allocWithZone"></a>allocWithZone</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Replaced by ObjectAlloc</span><br><span class="line">+ (id)allocWithZone:(struct _NSZone *)zone &#123;</span><br><span class="line">    return _objc_rootAllocWithZone(self, (malloc_zone_t *)zone);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°<code>allocWithZone</code>å…¶å®ç°ä¹Ÿæ˜¯è°ƒç”¨<code>_objc_rootAllocWithZone</code>å‡½æ•°</p>
<h4 id="alloc-1"><a href="#alloc-1" class="headerlink" title="alloc"></a>alloc</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">+ (id)alloc &#123;</span><br><span class="line">    return _objc_rootAlloc(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-rootAlloc"><a href="#objc-rootAlloc" class="headerlink" title="_objc_rootAlloc"></a>_objc_rootAlloc</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_objc_rootAlloc(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    return callAlloc(cls, false&#x2F;*checkNil*&#x2F;, true&#x2F;*allocWithZone*&#x2F;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>alloc</code>å‡½æ•°ä¼šè°ƒç”¨<code>_objc_rootAlloc</code>å‡½æ•°ï¼Œæœ€ç»ˆä¼šå†æ¬¡æ¥åˆ°<code>callAlloc</code>å‡½æ•°ï¼Œä¼ å‚ä¸å†è¿›è¡Œnilæ£€æŸ¥</p>
<h4 id="objc-rootAllocWithZone"><a href="#objc-rootAllocWithZone" class="headerlink" title="_objc_rootAllocWithZone"></a>_objc_rootAllocWithZone</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NEVER_INLINE</span><br><span class="line">id</span><br><span class="line">_objc_rootAllocWithZone(Class cls, <span class="keyword">malloc_zone_t</span> *zone __unused)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// allocWithZone under __OBJC2__ ignores the zone parameter</span></span><br><span class="line">    <span class="keyword">return</span> _class_createInstanceFromZone(cls, <span class="number">0</span>, nil,</span><br><span class="line">                                         OBJECT_CONSTRUCT_CALL_BADALLOC);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨<code>_class_createInstanceFromZone</code>å‡½æ•°ï¼Œå‚æ•°<code>zone</code>å·²ç»è¢«å¿½ç•¥ç›´æ¥ä¼ nil</p>
<h4 id="class-createInstanceFromZone"><a href="#class-createInstanceFromZone" class="headerlink" title="_class_createInstanceFromZone"></a>_class_createInstanceFromZone</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> ALWAYS_INLINE id</span><br><span class="line">_class_createInstanceFromZone(Class cls, <span class="keyword">size_t</span> extraBytes, <span class="keyword">void</span> *zone,</span><br><span class="line">                              <span class="keyword">int</span> construct_flags = OBJECT_CONSTRUCT_NONE,</span><br><span class="line">                              <span class="keyword">bool</span> cxxConstruct = <span class="literal">true</span>,</span><br><span class="line">                              <span class="keyword">size_t</span> *outAllocatedSize = nil)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(cls-&gt;isRealized());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read class's info bits all at once for performance</span></span><br><span class="line">    <span class="keyword">bool</span> hasCxxCtor = cxxConstruct &amp;&amp; cls-&gt;hasCxxCtor();<span class="comment">// è·å–clsæ˜¯å¦æœ‰æ„é€ å‡½æ•°</span></span><br><span class="line">    <span class="keyword">bool</span> hasCxxDtor = cls-&gt;hasCxxDtor();<span class="comment">// è·å–clsæ˜¯å¦æœ‰ææ„å‡½æ•°</span></span><br><span class="line">    <span class="keyword">bool</span> fast = cls-&gt;canAllocNonpointer();<span class="comment">// è·å–clsæ˜¯å¦è¿›è¡Œäº†isaæŒ‡é’ˆä¼˜åŒ–</span></span><br><span class="line">    <span class="keyword">size_t</span> <span class="built_in">size</span>;</span><br><span class="line">		<span class="comment">// è·å–éœ€è¦ç”³è¯·çš„ç©ºé—´å¤§å°</span></span><br><span class="line">    <span class="built_in">size</span> = cls-&gt;instanceSize(extraBytes);</span><br><span class="line">    <span class="keyword">if</span> (outAllocatedSize) *outAllocatedSize = <span class="built_in">size</span>;</span><br><span class="line">		</span><br><span class="line">  	<span class="comment">// å¦‚æœzoneä¸ºnilï¼Œè°ƒç”¨malloc_zone_callocç”³è¯·å†…å­˜ç©ºé—´</span></span><br><span class="line">    id obj;</span><br><span class="line">    <span class="keyword">if</span> (zone) &#123;</span><br><span class="line">        obj = (id)malloc_zone_calloc((<span class="keyword">malloc_zone_t</span> *)zone, <span class="number">1</span>, <span class="built_in">size</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        obj = (id)<span class="built_in">calloc</span>(<span class="number">1</span>, <span class="built_in">size</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// å¦‚æœå†…å­˜ç©ºé—´ç”³è¯·å¤±è´¥ï¼Œè°ƒç”¨_objc_callBadAllocHandler</span></span><br><span class="line">    <span class="keyword">if</span> (slowpath(!obj)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (construct_flags &amp; OBJECT_CONSTRUCT_CALL_BADALLOC) &#123;</span><br><span class="line">            <span class="keyword">return</span> _objc_callBadAllocHandler(cls);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nil;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  	<span class="comment">// åˆå§‹åŒ– isa å¦‚æœ zone == nil &amp;&amp; isaè¿›è¡Œäº†æŒ‡é’ˆä¼˜åŒ–ï¼Œè°ƒç”¨initInstanceIsa</span></span><br><span class="line">    <span class="keyword">if</span> (!zone &amp;&amp; fast) &#123;</span><br><span class="line">        obj-&gt;initInstanceIsa(cls, hasCxxDtor);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Use raw pointer isa on the assumption that they might be</span></span><br><span class="line">        <span class="comment">// doing something weird with the zone or RR.</span></span><br><span class="line">      	<span class="comment">// å¦åˆ™ä½¿ç”¨initIsaè¿›è¡Œåˆå§‹åŒ–isaæŒ‡é’ˆ</span></span><br><span class="line">        obj-&gt;initIsa(cls);</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// å¦‚æœæ²¡æœ‰æ„é€ å‡½æ•°ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (fastpath(!hasCxxCtor)) &#123;</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// è¿›è¡Œæ„é€ å‡½æ•°å¤„ç†ï¼Œåœ¨è¿”å›</span></span><br><span class="line">    construct_flags |= OBJECT_CONSTRUCT_FREE_ONFAILURE;</span><br><span class="line">    <span class="keyword">return</span> object_cxxConstructFromClass(obj, cls, construct_flags);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨å‡½æ•°_class_createInstanceFromZoneä¸­ï¼Œé€šè¿‡Cå‡½æ•°callocç”³è¯·å†…å­˜ç©ºé—´ï¼Œå¹¶åˆå§‹åŒ–å¯¹è±¡çš„isa</p>
<h4 id="initInstanceIsa"><a href="#initInstanceIsa" class="headerlink" title="initInstanceIsa"></a>initInstanceIsa</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">inline void </span><br><span class="line">objc_object::initInstanceIsa(Class cls, bool hasCxxDtor)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(!cls-&gt;instancesRequireRawIsa());</span><br><span class="line">    ASSERT(hasCxxDtor &#x3D;&#x3D; cls-&gt;hasCxxDtor());</span><br><span class="line"></span><br><span class="line">    initIsa(cls, true, hasCxxDtor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="initIsa"><a href="#initIsa" class="headerlink" title="initIsa"></a>initIsa</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">inline void </span><br><span class="line">objc_object::initIsa(Class cls, bool nonpointer, bool hasCxxDtor) </span><br><span class="line">&#123; </span><br><span class="line">    ASSERT(!isTaggedPointer()); </span><br><span class="line">    </span><br><span class="line">  	&#x2F;&#x2F; æœªå¼€å¯isaæŒ‡é’ˆä¼˜åŒ–ï¼Œç›´æ¥å°†isaæŒ‡é’ˆæŒ‡å‘clsç±»å¯¹è±¡</span><br><span class="line">    if (!nonpointer) &#123;</span><br><span class="line">        isa &#x3D; isa_t((uintptr_t)cls);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        ASSERT(!DisableNonpointerIsa);</span><br><span class="line">        ASSERT(!cls-&gt;instancesRequireRawIsa());</span><br><span class="line"></span><br><span class="line">        isa_t newisa(0);</span><br><span class="line"></span><br><span class="line">#if SUPPORT_INDEXED_ISA		&#x2F;&#x2F; å¯¹äº64ä½ç³»ç»Ÿï¼Œè¯¥å€¼ä¸º0</span><br><span class="line">        ASSERT(cls-&gt;classArrayIndex() &gt; 0);</span><br><span class="line">        newisa.bits &#x3D; ISA_INDEX_MAGIC_VALUE;</span><br><span class="line">        &#x2F;&#x2F; isa.magic is part of ISA_MAGIC_VALUE</span><br><span class="line">        &#x2F;&#x2F; isa.nonpointer is part of ISA_MAGIC_VALUE</span><br><span class="line">        newisa.has_cxx_dtor &#x3D; hasCxxDtor;</span><br><span class="line">        newisa.indexcls &#x3D; (uintptr_t)cls-&gt;classArrayIndex();</span><br><span class="line">#else</span><br><span class="line">      	&#x2F;&#x2F; è®¾ç½®nonpointer å’Œ magicå€¼ä½1 å’Œ 1101</span><br><span class="line">        newisa.bits &#x3D; ISA_MAGIC_VALUE;</span><br><span class="line">        &#x2F;&#x2F; isa.magic is part of ISA_MAGIC_VALUE</span><br><span class="line">        &#x2F;&#x2F; isa.nonpointer is part of ISA_MAGIC_VALUE</span><br><span class="line">      	&#x2F;&#x2F; è®¾ç½®æ˜¯å¦æœ‰ææ„å‡½æ•°</span><br><span class="line">        newisa.has_cxx_dtor &#x3D; hasCxxDtor;</span><br><span class="line">      	&#x2F;&#x2F; è®¾ç½®class&#x2F;meta-classå¯¹è±¡</span><br><span class="line">        newisa.shiftcls &#x3D; (uintptr_t)cls &gt;&gt; 3;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">        &#x2F;&#x2F; This write must be performed in a single store in some cases</span><br><span class="line">        &#x2F;&#x2F; (for example when realizing a class because other threads</span><br><span class="line">        &#x2F;&#x2F; may simultaneously try to use the class).</span><br><span class="line">        &#x2F;&#x2F; fixme use atomics here to guarantee single-store and to</span><br><span class="line">        &#x2F;&#x2F; guarantee memory order w.r.t. the class index table</span><br><span class="line">        &#x2F;&#x2F; ...but not too atomic because we don&#39;t want to hurt instantiation</span><br><span class="line">        isa &#x3D; newisa;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³äºISAæŒ‡é’ˆï¼Œå…·ä½“å¯è§å†…å­˜ç®¡ç†â€”ISAæŒ‡é’ˆ</p>
<h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Calls [[cls alloc] init].</span><br><span class="line">id</span><br><span class="line">objc_alloc_init(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    return [callAlloc(cls, true&#x2F;*checkNil*&#x2F;, false&#x2F;*allocWithZone*&#x2F;) init];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- (id)init &#123;</span><br><span class="line">    return _objc_rootInit(self);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">id</span><br><span class="line">_objc_rootInit(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    &#x2F;&#x2F; In practice, it will be hard to rely on this function.</span><br><span class="line">    &#x2F;&#x2F; Many classes do not properly chain -init calls.</span><br><span class="line">    return obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åŸºç±»çš„initæ–¹æ³•ä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼Œåªæ˜¯å°†allocåˆ›å»ºçš„å¯¹è±¡è¿”å›ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥é‡å†™initæ–¹æ³•åšä¸€äº›åˆå§‹åŒ–æ“ä½œã€‚</p>
<h3 id="new"><a href="#new" class="headerlink" title="new"></a>new</h3><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Calls [cls new]</span></span><br><span class="line"><span class="keyword">id</span></span><br><span class="line">objc_opt_new(Class cls)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">    <span class="keyword">if</span> (fastpath(cls &amp;&amp; !cls-&gt;ISA()-&gt;hasCustomCore())) &#123;</span><br><span class="line">        <span class="keyword">return</span> [callAlloc(cls, <span class="literal">false</span><span class="comment">/*checkNil*/</span>, <span class="literal">true</span><span class="comment">/*allocWithZone*/</span>) init];</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">id</span>(*)(<span class="keyword">id</span>, SEL))objc_msgSend)(cls, <span class="keyword">@selector</span>(new));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">+ (<span class="keyword">id</span>)new &#123;</span><br><span class="line">    <span class="keyword">return</span> [callAlloc(<span class="keyword">self</span>, <span class="literal">false</span><span class="comment">/*checkNil*/</span>) init];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>newæ–¹æ³•æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯åµŒå¥—äº†allocå’Œinit</p>
<h3 id="copy-amp-mutableCopy"><a href="#copy-amp-mutableCopy" class="headerlink" title="copy &amp; mutableCopy"></a>copy &amp; mutableCopy</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">- (id)copy &#123;</span><br><span class="line">    return [(id)self copyWithZone:nil];</span><br><span class="line">&#125;</span><br><span class="line">+ (id)copyWithZone:(struct _NSZone *)zone &#123;</span><br><span class="line">    return (id)self;</span><br><span class="line">&#125;</span><br><span class="line">- (id)mutableCopy &#123;</span><br><span class="line">    return [(id)self mutableCopyWithZone:nil];</span><br><span class="line">&#125;</span><br><span class="line">+ (id)mutableCopyWithZone:(struct _NSZone *)zone &#123;</span><br><span class="line">    return (id)self;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>copyå’ŒmutableCopyä¹Ÿå¾ˆç®€å•ï¼Œåªæ˜¯è°ƒç”¨äº†copyWithZoneå’ŒmutableCopyWithZoneæ–¹æ³•ã€‚</p>
<h3 id="retainCount"><a href="#retainCount" class="headerlink" title="retainCount"></a>retainCount</h3><p>è·å–å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨</p>
<h4 id="retainCount-1"><a href="#retainCount-1" class="headerlink" title="retainCount"></a>retainCount</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (NSUInteger)retainCount &#123;</span><br><span class="line">    return _objc_rootRetainCount(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-rootRetainCount"><a href="#objc-rootRetainCount" class="headerlink" title="_objc_rootRetainCount"></a>_objc_rootRetainCount</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">uintptr_t</span><br><span class="line">_objc_rootRetainCount(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(obj);</span><br><span class="line"></span><br><span class="line">    return obj-&gt;rootRetainCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="rootRetainCount"><a href="#rootRetainCount" class="headerlink" title="rootRetainCount"></a>rootRetainCount</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> uintptr_t </span><br><span class="line">objc_object::rootRetainCount()</span><br><span class="line">&#123;</span><br><span class="line">  	<span class="comment">// å¦‚æœæ˜¯taggedpointer ç›´æ¥è¿”å›this</span></span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> (uintptr_t)<span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    sidetable_lock();</span><br><span class="line">  	<span class="comment">// è·å–isaæŒ‡é’ˆ</span></span><br><span class="line">    isa_t bits = LoadExclusive(&amp;isa.bits);</span><br><span class="line">    ClearExclusive(&amp;isa.bits);</span><br><span class="line">  	<span class="comment">// åˆ¤æ–­isaæŒ‡é’ˆæ˜¯å¦å¼€å§‹ä¼˜åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (bits.nonpointer) &#123;</span><br><span class="line">      	<span class="comment">// ä»extra_rcè¯»å–å¼•ç”¨è®¡æ•°å™¨ å† +1</span></span><br><span class="line">        uintptr_t rc = <span class="number">1</span> + bits.extra_rc;</span><br><span class="line">      	<span class="comment">// åˆ¤æ–­æ˜¯å¦ä½¿ç”¨sidetableé¢å¤–å­˜å‚¨å¼•ç”¨è®¡æ•°å™¨</span></span><br><span class="line">        <span class="keyword">if</span> (bits.has_sidetable_rc) &#123;</span><br><span class="line">            rc += sidetable_getExtraRC_nolock();</span><br><span class="line">        &#125;</span><br><span class="line">        sidetable_unlock();</span><br><span class="line">        <span class="keyword">return</span> rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sidetable_unlock();</span><br><span class="line">  	<span class="comment">// isaæŒ‡é’ˆä¸æ˜¯nonpointer, è¿”å›sidetable_retainCountå‡½æ•°è·å–åˆ°çš„å€¼</span></span><br><span class="line">    <span class="keyword">return</span> sidetable_retainCount();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sidetable-getExtraRC-nolock"><a href="#sidetable-getExtraRC-nolock" class="headerlink" title="sidetable_getExtraRC_nolock"></a>sidetable_getExtraRC_nolock</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">size_t </span><br><span class="line">objc_object::sidetable_getExtraRC_nolock()</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(isa.nonpointer);</span><br><span class="line">    SideTable&amp; table &#x3D; SideTables()[this];</span><br><span class="line">    RefcountMap::iterator it &#x3D; table.refcnts.find(this);</span><br><span class="line">    if (it &#x3D;&#x3D; table.refcnts.end()) return 0;</span><br><span class="line">    else return it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="sidetable-retainCount"><a href="#sidetable-retainCount" class="headerlink" title="sidetable_retainCount"></a>sidetable_retainCount</h5><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">uintptr_t</span><br><span class="line">objc_object::sidetable_retainCount()</span><br><span class="line">&#123;</span><br><span class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</span><br><span class="line"></span><br><span class="line">    size_t refcnt_result = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    table.lock();</span><br><span class="line">    RefcountMap::iterator it = table.refcnts.find(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (it != table.refcnts.end()) &#123;</span><br><span class="line">        <span class="comment">// this is valid for SIDE_TABLE_RC_PINNED too</span></span><br><span class="line">        refcnt_result += it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">    <span class="keyword">return</span> refcnt_result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡½æ•°sidetable_getExtraRC_nolockå’Œå‡½æ•°sidetable_retainCountï¼Œå‡æ˜¯é€šè¿‡å“ˆå¸ŒæŸ¥æ‰¾è·å–ä»–ä»¬çš„å¼•ç”¨è®¡æ•°å™¨è¡¨ã€‚</p>
<p>ä¸åŒçš„æ˜¯ï¼š</p>
<ul>
<li>isa æ˜¯ nonpointerä¼šè°ƒç”¨sidetable_getExtraRC_nolockå‡½æ•°ï¼Œå®ƒçš„å¼•ç”¨è®¡æ•°å™¨ä¼šå­˜åœ¨ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†åœ¨isa_tçš„extra_rcï¼Œå¦ä¸€éƒ¨åˆ†å­˜åœ¨äºSideTableä¸­ï¼Œä¸è¿›è¡ŒåŠ é”</li>
<li>isaä¸æ˜¯nonpointerä¼šè°ƒç”¨sidetable_retainCountå‡½æ•°ï¼Œä»–çš„å¼•ç”¨è®¡æ•°å™¨ä¹‹å­˜åœ¨äºSideTableä¸­ï¼Œéœ€è¦åŠ é”æŸ¥æ‰¾</li>
</ul>
<p>SideTableæŸ¥æ‰¾æ­¥éª¤ï¼š</p>
<ul>
<li>å…ˆæ ¹æ®å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œç»è¿‡å“ˆå¸ŒæŸ¥æ‰¾åä»SideTablesä¸­è·å–åˆ°å®ƒæ‰€åœ¨çš„SideTable</li>
<li>å†æ ¹æ®å½“å‰å¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œç»è¿‡å“ˆå¸ŒæŸ¥æ‰¾ä»SideTableè¡¨ä¸­çš„refcntsä¸­å–å‡ºå®ƒçš„å¼•ç”¨è®¡æ•°å™¨è¡¨</li>
</ul>
<blockquote>
<p>å°ç»“ï¼šrootRetainCountå‡½æ•°</p>
<ul>
<li>åœ¨arm64ä¹‹å‰ï¼Œisa ä¸æ˜¯ nonpointer å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨å­˜å‚¨åœ¨SideTableä¸­ï¼ŒrootRetainCountè·å–åˆ°çš„å°±æ˜¯1 + SideTableä¸­å­˜å‚¨çš„å€¼</li>
<li>arm64ä¹‹åï¼Œisaå¦‚æœæ˜¯nonpointer å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨å…ˆå­˜å‚¨åœ¨extra_rcä¸­ï¼Œå¦‚æœ19ä½extra_rcä¸å¤Ÿå­˜å‚¨ï¼Œä½ ä»¬æº¢å‡ºçš„éƒ¨åˆ†åœ¨å­˜å‚¨åœ¨SideTableä¸­ï¼ŒrootRetainCountè·å–åˆ°çš„å°±æ˜¯1+ extra_rcçš„å€¼+SideTableçš„å€¼</li>
<li>åˆå§‹åŒ–æƒ…å†µä¸‹ï¼Œé€šè¿‡rootRetainCountè·å–åˆ°çš„1ï¼Œè¿™æ˜¯rootRetainCountçš„åŠŸåŠ³ï¼Œallocå¹¶æ²¡æœ‰è®¾ç½®å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨</li>
</ul>
</blockquote>
<p><strong>Qï¼šallocæ–¹æ³•æ²¡æœ‰è®¾ç½®å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ä¸º1ï¼Œè€Œä¸”å†…éƒ¨ä¹Ÿæ²¡æœ‰è°ƒç”¨<code>retainCount</code>æ–¹æ³•ï¼Œé‚£<code>alloc</code>åˆ›å»ºçš„å¯¹è±¡ä¸ä¼šå› å¼•ç”¨è®¡æ•°å™¨ä¸º0ï¼Œè€Œç›´æ¥è¢«<code>dealloc</code>å—ï¼Ÿ</strong></p>
<p>Aï¼šdeallocæ–¹æ³•æ˜¯åœ¨releaseæ–¹æ³•å†…éƒ¨è°ƒç”¨çš„ï¼Œåªæœ‰ä½ ç›´æ¥è°ƒç”¨äº†<code>dealloc</code>ï¼Œæˆ–è€…è°ƒç”¨äº†<code>release</code>æ–¹æ³•ä¸”åœ¨releaseä¸­åˆ¤æ–­å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨æ˜¯å¦ä¸º0ï¼Œæ‰ä¼šè°ƒç”¨dealloc</p>
<h3 id="retain"><a href="#retain" class="headerlink" title="retain"></a>retain</h3><p>ä¹‹å‰å·²ç»è¯´è¿‡ï¼ŒæŒæœ‰å¯¹è±¡çš„æ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯<code>alloc/new/copy/mutableCopy</code>ï¼Œä¸€ç§æ˜¯<code>retain</code>ï¼Œ<code>retain</code>ä¼šå°†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°+1</p>
<h4 id="objc-retain"><a href="#objc-retain" class="headerlink" title="objc_retain"></a>objc_retain</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#if __OBJC2__</span><br><span class="line">__attribute__((aligned(16), flatten, noinline))</span><br><span class="line">id </span><br><span class="line">objc_retain(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    if (!obj) return obj;</span><br><span class="line">    if (obj-&gt;isTaggedPointer()) return obj;</span><br><span class="line">    return obj-&gt;retain();</span><br><span class="line">&#125;</span><br><span class="line">#else</span><br><span class="line">id objc_retain(id obj) &#123; return [obj retain]; &#125;</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯<code>__OBJC2__</code>ï¼Œåˆ™è°ƒç”¨<code>objc_retain</code>ï¼Œå¦åˆ™è°ƒç”¨<code>retain</code></p>
<h4 id="retain-1"><a href="#retain-1" class="headerlink" title="retain"></a>retain</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">-(id) retain</span><br><span class="line">&#123;</span><br><span class="line">    return _objc_rootRetain(self);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-rootRetain"><a href="#objc-rootRetain" class="headerlink" title="_objc_rootRetain"></a>_objc_rootRetain</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NEVER_INLINE <span class="keyword">id</span></span><br><span class="line">_objc_rootRetain(<span class="keyword">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(obj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj-&gt;rootRetain();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-rootRetain"><a href="#objc-object-rootRetain" class="headerlink" title="objc_object::rootRetain()"></a>objc_object::rootRetain()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Base retain implementation, ignoring overrides.</span><br><span class="line">&#x2F;&#x2F; This does not check isa.fast_rr; if there is an RR override then </span><br><span class="line">&#x2F;&#x2F; it was already called and it chose to call [super retain].</span><br><span class="line">&#x2F;&#x2F;</span><br><span class="line">&#x2F;&#x2F; tryRetain&#x3D;true is the -_tryRetain path.</span><br><span class="line">&#x2F;&#x2F; handleOverflow&#x3D;false is the frameless fast path.</span><br><span class="line">&#x2F;&#x2F; handleOverflow&#x3D;true is the framed slow path including overflow to side table</span><br><span class="line">&#x2F;&#x2F; The code is structured this way to prevent duplication.</span><br><span class="line"></span><br><span class="line">ALWAYS_INLINE id </span><br><span class="line">objc_object::rootRetain()</span><br><span class="line">&#123;</span><br><span class="line">    return rootRetain(false, false);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-rootRetain-bool-tryRetain-bool-handleOverflow"><a href="#objc-object-rootRetain-bool-tryRetain-bool-handleOverflow" class="headerlink" title="objc_object::rootRetain(bool tryRetain, bool handleOverflow)"></a>objc_object::rootRetain(bool tryRetain, bool handleOverflow)</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">ALWAYS_INLINE <span class="keyword">id</span> </span><br><span class="line">objc_object::rootRetain(<span class="keyword">bool</span> tryRetain, <span class="keyword">bool</span> handleOverflow)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> (<span class="keyword">id</span>)<span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> sideTableLocked = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">bool</span> transcribeToSideTable = <span class="literal">false</span>;<span class="comment">// æ˜¯å¦è¦å°†å¼•ç”¨è®¡æ•°å™¨å­˜å‚¨åœ¨SideTableä¸­</span></span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        transcribeToSideTable = <span class="literal">false</span>;</span><br><span class="line">        oldisa = LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa = oldisa;</span><br><span class="line">        <span class="keyword">if</span> (slowpath(!newisa.nonpointer)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            <span class="keyword">if</span> (rawISA()-&gt;isMetaClass()) <span class="keyword">return</span> (<span class="keyword">id</span>)<span class="keyword">this</span>;</span><br><span class="line">            <span class="keyword">if</span> (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();</span><br><span class="line">            <span class="keyword">if</span> (tryRetain) <span class="keyword">return</span> sidetable_tryRetain() ? (<span class="keyword">id</span>)<span class="keyword">this</span> : <span class="literal">nil</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">return</span> sidetable_retain();</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// ä¸å»æ£€æŸ¥isaæŒ‡é’ˆæ˜¯å¦fast_rrï¼Œå› ä¸ºæˆ‘ä»¬å¯èƒ½ä¼šè°ƒç”¨é‡è½½æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// don't check newisa.fast_rr; we already called any RR overrides</span></span><br><span class="line">        <span class="keyword">if</span> (slowpath(tryRetain &amp;&amp; newisa.deallocating)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            <span class="keyword">if</span> (!tryRetain &amp;&amp; sideTableLocked) sidetable_unlock();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        uintptr_t carry;</span><br><span class="line">      	<span class="comment">// #   define RC_ONE   (1ULL&lt;&lt;45)</span></span><br><span class="line">      	<span class="comment">// å°†å¼•ç”¨è®¡æ•°å™¨+1</span></span><br><span class="line">        newisa.bits = addc(newisa.bits, RC_ONE, <span class="number">0</span>, &amp;carry);  <span class="comment">// extra_rc++</span></span><br><span class="line">				</span><br><span class="line">        <span class="keyword">if</span> (slowpath(carry)) &#123;</span><br><span class="line">            <span class="comment">// newisa.extra_rc++ overflowed</span></span><br><span class="line">          	<span class="comment">// å¦‚æœextra_rcä¸Šæº¢</span></span><br><span class="line">            <span class="keyword">if</span> (!handleOverflow) &#123;</span><br><span class="line">                ClearExclusive(&amp;isa.bits);</span><br><span class="line">                <span class="keyword">return</span> rootRetain_overflow(tryRetain);</span><br><span class="line">            &#125;</span><br><span class="line">          	<span class="comment">// è®¾ç½®extra_rcä¸ºRC_HALFï¼ŒåŒæ—¶æ ‡è®°has_sidetable_rc</span></span><br><span class="line">            <span class="comment">// Leave half of the retain counts inline and </span></span><br><span class="line">            <span class="comment">// prepare to copy the other half to the side table.</span></span><br><span class="line">            <span class="keyword">if</span> (!tryRetain &amp;&amp; !sideTableLocked) sidetable_lock();</span><br><span class="line">            sideTableLocked = <span class="literal">true</span>;</span><br><span class="line">            transcribeToSideTable = <span class="literal">true</span>;</span><br><span class="line">            newisa.extra_rc = RC_HALF;<span class="comment">// #   define RC_HALF  (1ULL&lt;&lt;18)</span></span><br><span class="line">            newisa.has_sidetable_rc = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (slowpath(!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)));</span><br><span class="line">		</span><br><span class="line">  	<span class="comment">// å¦‚æœéœ€è¦ å°†æº¢å‡ºçš„å¼•ç”¨è®¡æ•°å™¨å­˜å‚¨åˆ°sidetableä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (slowpath(transcribeToSideTable)) &#123;</span><br><span class="line">        <span class="comment">// Copy the other half of the retain counts to the side table.</span></span><br><span class="line">        sidetable_addExtraRC_nolock(RC_HALF);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(!tryRetain &amp;&amp; sideTableLocked)) sidetable_unlock();</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">id</span>)<span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-sidetable-retain"><a href="#objc-object-sidetable-retain" class="headerlink" title="objc_object::sidetable_retain()"></a>objc_object::sidetable_retain()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">id</span><br><span class="line">objc_object::sidetable_retain()</span><br><span class="line">&#123;</span><br><span class="line">#if SUPPORT_NONPOINTER_ISA</span><br><span class="line">    ASSERT(!isa.nonpointer);</span><br><span class="line">#endif</span><br><span class="line">    SideTable&amp; table &#x3D; SideTables()[this];</span><br><span class="line">    </span><br><span class="line">    table.lock();</span><br><span class="line">    size_t&amp; refcntStorage &#x3D; table.refcnts[this];&#x2F;&#x2F; è·å–å½“å‰å¼•ç”¨è®¡æ•°</span><br><span class="line">    if (! (refcntStorage &amp; SIDE_TABLE_RC_PINNED)) &#123; &#x2F;&#x2F; è·å–åˆ°äº† &amp; æœªæº¢å‡º</span><br><span class="line">        refcntStorage +&#x3D; SIDE_TABLE_RC_ONE;&#x2F;&#x2F; å°†å¼•ç”¨è®¡æ•°+1</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line"></span><br><span class="line">    return (id)this;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å®å®šä¹‰ä¿¡æ¯</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; The order of these bits is important.</span><br><span class="line">#define SIDE_TABLE_WEAKLY_REFERENCED (1UL&lt;&lt;0)		&#x2F;&#x2F; æ ‡è®°å¯¹è±¡æ˜¯å¦æœ‰å¼±å¼•ç”¨</span><br><span class="line">#define SIDE_TABLE_DEALLOCATING      (1UL&lt;&lt;1)  	&#x2F;&#x2F; æ ‡è®°å¯¹è±¡æ˜¯å¦æ­£åœ¨deallocating</span><br><span class="line">#define SIDE_TABLE_RC_ONE            (1UL&lt;&lt;2)  	&#x2F;&#x2F; å¯¹è±¡å¼•ç”¨è®¡æ•°å­˜å‚¨çš„å¼€å§‹ä½ï¼Œå¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨2ï½63ä½</span><br><span class="line">#define SIDE_TABLE_RC_PINNED         (1UL&lt;&lt;(WORD_BITS-1)) &#x2F;&#x2F; å¼•ç”¨è®¡æ•° </span><br><span class="line"></span><br><span class="line">#define SIDE_TABLE_RC_SHIFT 2</span><br><span class="line">#define SIDE_TABLE_FLAG_MASK (SIDE_TABLE_RC_ONE-1)</span><br></pre></td></tr></table></figure>

<p>å¯¹è±¡å¼•ç”¨è®¡æ•°è¡¨<code>refcnts</code></p>
<p><img src="/Users/mikasa/Desktop/image_mark/202011032030.png" alt="img"></p>
<h4 id="rootRetain-overflow"><a href="#rootRetain-overflow" class="headerlink" title="rootRetain_overflow"></a>rootRetain_overflow</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NEVER_INLINE id </span><br><span class="line">objc_object::rootRetain_overflow(bool tryRetain)</span><br><span class="line">&#123;</span><br><span class="line">    return rootRetain(tryRetain, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœextra_rcå­˜å‚¨æ»¡äº†ï¼Œå°±ä¼šè°ƒç”¨rootRetain_overflowï¼Œè¯¥å‡½æ•°è°ƒç”¨äº†rootRetainï¼Œä½†å‚æ•°handleOverflowä¼ true</p>
<h4 id="sidetable-addExtraRC-nolock"><a href="#sidetable-addExtraRC-nolock" class="headerlink" title="sidetable_addExtraRC_nolock"></a>sidetable_addExtraRC_nolock</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Move some retain counts to the side table from the isa field.</span></span><br><span class="line"><span class="comment">// Returns true if the object is now pinned.</span></span><br><span class="line"><span class="comment">// å°†ä¸€äº›å¼•ç”¨è®¡æ•°å­˜å‚¨åœ¨sideTableè¡¨ä¸­</span></span><br><span class="line"><span class="keyword">bool</span> </span><br><span class="line">objc_object::sidetable_addExtraRC_nolock(size_t delta_rc)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(isa.nonpointer);</span><br><span class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</span><br><span class="line"></span><br><span class="line">    size_t&amp; refcntStorage = table.refcnts[<span class="keyword">this</span>];</span><br><span class="line">    size_t oldRefcnt = refcntStorage;</span><br><span class="line">    <span class="comment">// isa-side bits should not be set here</span></span><br><span class="line">    ASSERT((oldRefcnt &amp; SIDE_TABLE_DEALLOCATING) == <span class="number">0</span>);</span><br><span class="line">    ASSERT((oldRefcnt &amp; SIDE_TABLE_WEAKLY_REFERENCED) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oldRefcnt &amp; SIDE_TABLE_RC_PINNED) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">    uintptr_t carry;</span><br><span class="line">    size_t newRefcnt = </span><br><span class="line">        addc(oldRefcnt, delta_rc &lt;&lt; SIDE_TABLE_RC_SHIFT, <span class="number">0</span>, &amp;carry);</span><br><span class="line">    <span class="keyword">if</span> (carry) &#123;</span><br><span class="line">        refcntStorage =</span><br><span class="line">            SIDE_TABLE_RC_PINNED | (oldRefcnt &amp; SIDE_TABLE_FLAG_MASK);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        refcntStorage = newRefcnt;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>extra_rc</code>å­˜å‚¨æ»¡äº†ï¼Œå°±ä¼šè°ƒç”¨<code>sidetable_addExtraRC_nolock</code>å°†<code>extra_rc</code>ä¸­çš„<code>RC_HALF(extra_rcæ»¡</code>å€¼çš„ä¸€åŠ)ä¸ªå¼•ç”¨è®¡æ•°è½¬ç§»åˆ°<code>sidetable</code>ä¸­å­˜å‚¨ï¼Œä¹Ÿæ˜¯è°ƒç”¨<code>addc</code>å¯¹<code>refcnt</code>å¼•ç”¨è®¡æ•°è¡¨è¿›è¡Œè®¡æ•°å¢åŠ æ“ä½œã€‚</p>
<blockquote>
<p>å°ç»“ï¼š<code>retain</code>æ–¹æ³•ï¼š</p>
<ul>
<li>å¦‚æœ<code>isa</code>ä¸æ˜¯<code>nonpointer</code>ï¼Œé‚£ä¹ˆå°±å¯¹<code>Sidetable</code>ä¸­çš„å¼•ç”¨è®¡æ•°+1</li>
<li>å¦‚æœisaæ˜¯nonpointerï¼Œå°±å¯¹isaä¸­çš„<code>extra_rc</code>å­˜å‚¨çš„å¼•ç”¨è®¡æ•°è¿›è¡Œ+1ï¼Œå¦‚æœæº¢å‡ºï¼Œå°±å°†extra_rcä¸­<code>RC_HALF</code>(<code>extra_rc</code>æ»¡å€¼çš„ä¸€åŠ)ä¸ªå¼•ç”¨è®¡æ•°è½¬ç§»åˆ°<code>sidetable</code>ä¸­å­˜å‚¨ï¼Œä»<code>rootRetain</code>å‡½æ•°ä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœ<code>extra_rc</code>æº¢å‡ºï¼Œè®¾ç½®å®ƒçš„å€¼ä¸ºRC_HALFï¼Œè¿™æ—¶å€™åˆå¯¹<code>sidetable</code>ä¸­çš„<code>refcnt</code>å¢åŠ å¼•ç”¨è®¡æ•°ã€‚<code>extra_rc</code>æ˜¯<code>19</code>ä½ï¼Œè€Œ<code>RC_HALF</code>å®æ˜¯<code>(1ULL&lt;&lt;18)</code>ï¼Œå®é™…ä¸Šç›¸ç­‰äºè¿›è¡Œäº† +1 æ“ä½œ</li>
</ul>
</blockquote>
<h3 id="release"><a href="#release" class="headerlink" title="release"></a>release</h3><p>å½“æˆ‘ä»¬åœ¨ä¸éœ€è¦æŒæœ‰å¯¹è±¡çš„æ—¶å€™ï¼Œéœ€è¦è°ƒç”¨<code>release</code>æ–¹æ³•è¿›è¡Œé‡Šæ”¾ï¼Œ<code>release</code>ä¼šå°†å¯¹è±¡çš„å¼•ç”¨è®¡æ•°-1</p>
<h4 id="objc-release"><a href="#objc-release" class="headerlink" title="objc_release"></a>objc_release</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">__attribute__((aligned(<span class="number">16</span>), flatten, noinline))</span><br><span class="line"><span class="keyword">void</span> </span><br><span class="line">objc_release(<span class="keyword">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;isTaggedPointer()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">return</span> obj-&gt;release();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">void</span> objc_release(<span class="keyword">id</span> obj) &#123; [obj release]; &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h4 id="objc-object-release"><a href="#objc-object-release" class="headerlink" title="objc_object::release"></a>objc_object::release</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Equivalent to calling [this release], with shortcuts if there is no override</span></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span></span><br><span class="line">objc_object::release()</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(!isTaggedPointer());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fastpath(!ISA()-&gt;hasCustomRR())) &#123;</span><br><span class="line">        rootRelease();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ((<span class="keyword">void</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, <span class="keyword">@selector</span>(release));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ–¹æ³•æ²¡æœ‰è¢«é‡å†™ï¼Œç›´æ¥è°ƒç”¨<code>rootRelease()</code>;ï¼Œè¿™æ˜¯å¿«æ·æ–¹å¼ï¼Œå¦åˆ™è°ƒç”¨<code>release</code></p>
<h4 id="release-1"><a href="#release-1" class="headerlink" title="release"></a>release</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)release</span><br><span class="line">&#123;</span><br><span class="line">    _objc_rootRelease(<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-rootRelease"><a href="#objc-rootRelease" class="headerlink" title="_objc_rootRelease"></a>_objc_rootRelease</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">_objc_rootRelease(<span class="keyword">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(obj);</span><br><span class="line"></span><br><span class="line">    obj-&gt;rootRelease();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-rootRelease"><a href="#objc-object-rootRelease" class="headerlink" title="objc_object::rootRelease"></a>objc_object::rootRelease</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Base release implementation, ignoring overrides.</span></span><br><span class="line"><span class="comment">// Does not call -dealloc.</span></span><br><span class="line"><span class="comment">// Returns true if the object should now be deallocated.</span></span><br><span class="line"><span class="comment">// This does not check isa.fast_rr; if there is an RR override then </span></span><br><span class="line"><span class="comment">// it was already called and it chose to call [super release].</span></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// handleUnderflow=false is the frameless fast path.</span></span><br><span class="line"><span class="comment">// handleUnderflow=true is the framed slow path including side table borrow</span></span><br><span class="line"><span class="comment">// The code is structured this way to prevent duplication.</span></span><br><span class="line"></span><br><span class="line">ALWAYS_INLINE <span class="keyword">bool</span> </span><br><span class="line">objc_object::rootRelease()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> rootRelease(<span class="literal">true</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALWAYS_INLINE <span class="keyword">bool</span> </span><br><span class="line">objc_object::rootReleaseShouldDealloc()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> rootRelease(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ALWAYS_INLINE <span class="keyword">bool</span> </span><br><span class="line">objc_object::rootRelease(<span class="keyword">bool</span> performDealloc, <span class="keyword">bool</span> handleUnderflow)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">bool</span> sideTableLocked = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    isa_t oldisa;</span><br><span class="line">    isa_t newisa;</span><br><span class="line"></span><br><span class="line"> retry:</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        oldisa = LoadExclusive(&amp;isa.bits);</span><br><span class="line">        newisa = oldisa;</span><br><span class="line">      	<span class="comment">// ä¸æ˜¯nonpointer</span></span><br><span class="line">        <span class="keyword">if</span> (slowpath(!newisa.nonpointer)) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">          	<span class="comment">// å¦‚æœæ˜¯meta-classç›´æ¥return</span></span><br><span class="line">            <span class="keyword">if</span> (rawISA()-&gt;isMetaClass()) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (sideTableLocked) sidetable_unlock();</span><br><span class="line">          	<span class="comment">// è°ƒç”¨sidetable_releaseå‡½æ•°</span></span><br><span class="line">            <span class="keyword">return</span> sidetable_release(performDealloc);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// don't check newisa.fast_rr; we already called any RR overrides</span></span><br><span class="line">        uintptr_t carry;</span><br><span class="line">      	<span class="comment">// subcå‡½æ•°å¯¹extra_rc--</span></span><br><span class="line">        newisa.bits = subc(newisa.bits, RC_ONE, <span class="number">0</span>, &amp;carry);  <span class="comment">// extra_rc--</span></span><br><span class="line">      	<span class="comment">// å¦‚æœextra_rcå·²ç»æº¢å‡ºäº†</span></span><br><span class="line">        <span class="keyword">if</span> (slowpath(carry)) &#123;</span><br><span class="line">            <span class="comment">// don't ClearExclusive()</span></span><br><span class="line">          	<span class="comment">// æ‰§è¡Œunderflowå¤„ç†ä¸‹æº¢</span></span><br><span class="line">            <span class="keyword">goto</span> underflow;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (slowpath(!StoreReleaseExclusive(&amp;isa.bits, </span><br><span class="line">                                             oldisa.bits, newisa.bits)));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (slowpath(sideTableLocked)) sidetable_unlock();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	</span><br><span class="line"> <span class="comment">// å¤„ç†ä¸‹æº¢</span></span><br><span class="line"> underflow:</span><br><span class="line">    <span class="comment">// newisa.extra_rc-- underflowed: borrow from side table or deallocate</span></span><br><span class="line">		<span class="comment">// å‡ºç°extra_rc-- ä¸‹æº¢ï¼Œsidetableç§»é™¤æˆ–è€…deallocå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// abandon newisa to undo the decrement</span></span><br><span class="line">    newisa = oldisa;</span><br><span class="line">		<span class="comment">// å¦‚æœhas_sidetable_rc ä¸ºtrue</span></span><br><span class="line">    <span class="keyword">if</span> (slowpath(newisa.has_sidetable_rc)) &#123;</span><br><span class="line">      	<span class="comment">// æ²¡æœ‰å‡ºç°ä¸‹æº¢</span></span><br><span class="line">        <span class="keyword">if</span> (!handleUnderflow) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">          	<span class="comment">// æ‰§è¡ŒrootRelease_underflowå‡½æ•°</span></span><br><span class="line">            <span class="keyword">return</span> rootRelease_underflow(performDealloc);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Transfer retain count from side table to inline storage.</span></span><br><span class="line">				<span class="comment">// å¼•ç”¨è®¡æ•°ä»sidetableè½¬ç§»åˆ°extra_rcä¸­å­˜å‚¨</span></span><br><span class="line">        <span class="keyword">if</span> (!sideTableLocked) &#123;</span><br><span class="line">            ClearExclusive(&amp;isa.bits);</span><br><span class="line">            sidetable_lock();</span><br><span class="line">            sideTableLocked = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// Need to start over to avoid a race against </span></span><br><span class="line">            <span class="comment">// the nonpointer -&gt; raw pointer transition.</span></span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// å°è¯•ä»sidetableä¸­åˆ é™¤ä¸€äº›å¼•ç”¨è®¡æ•°ï¼Œä¼ å…¥RC_HALFï¼Œborrowedä¸ºå®é™…åˆ é™¤çš„å¼•ç”¨è®¡æ•°</span></span><br><span class="line">        <span class="comment">// Try to remove some retain counts from the side table.        </span></span><br><span class="line">        size_t borrowed = sidetable_subExtraRC_nolock(RC_HALF);</span><br><span class="line">      </span><br><span class="line">				<span class="comment">// ä¸ºäº†é¿å…ç«äº‰ï¼Œhas_sidetable_rcå¿…é¡»è®¾ç½®ï¼Œå³ä½¿ç°åœ¨sidetableä¸­çš„å¼•ç”¨è®¡æ•°å·²ç»æ˜¯0äº†</span></span><br><span class="line">        <span class="comment">// To avoid races, has_sidetable_rc must remain set </span></span><br><span class="line">        <span class="comment">// even if the side table count is now zero.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (borrowed &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// Side table retain count decreased.</span></span><br><span class="line">            <span class="comment">// Try to add them to the inline count.</span></span><br><span class="line">            newisa.extra_rc = borrowed - <span class="number">1</span>;  <span class="comment">// redo the original decrement too</span></span><br><span class="line">            <span class="keyword">bool</span> stored = StoreReleaseExclusive(&amp;isa.bits, </span><br><span class="line">                                                oldisa.bits, newisa.bits);</span><br><span class="line">          	<span class="comment">// å­˜å‚¨å¤±è´¥ï¼Œå†è¯•ä¸€æ¬¡</span></span><br><span class="line">            <span class="keyword">if</span> (!stored) &#123;</span><br><span class="line">                <span class="comment">// Inline update failed. </span></span><br><span class="line">                <span class="comment">// Try it again right now. This prevents livelock on LL/SC </span></span><br><span class="line">                <span class="comment">// architectures where the side table access itself may have </span></span><br><span class="line">                <span class="comment">// dropped the reservation.</span></span><br><span class="line">                isa_t oldisa2 = LoadExclusive(&amp;isa.bits);</span><br><span class="line">                isa_t newisa2 = oldisa2;</span><br><span class="line">                <span class="keyword">if</span> (newisa2.nonpointer) &#123;</span><br><span class="line">                    uintptr_t overflow;</span><br><span class="line">                    newisa2.bits = </span><br><span class="line">                        addc(newisa2.bits, RC_ONE * (borrowed<span class="number">-1</span>), <span class="number">0</span>, &amp;overflow);</span><br><span class="line">                    <span class="keyword">if</span> (!overflow) &#123;</span><br><span class="line">                        stored = StoreReleaseExclusive(&amp;isa.bits, oldisa2.bits, </span><br><span class="line">                                                       newisa2.bits);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">						<span class="comment">// å¦‚æœè¿˜æ˜¯å¤±è´¥ï¼Œå°±å°†å¼•ç”¨è®¡æ•°é‡æ–°ä¿å­˜åœ¨sidetableä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (!stored) &#123;</span><br><span class="line">                <span class="comment">// Inline update failed.</span></span><br><span class="line">                <span class="comment">// Put the retains back in the side table.</span></span><br><span class="line">                sidetable_addExtraRC_nolock(borrowed);</span><br><span class="line">                <span class="keyword">goto</span> retry;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Decrement successful after borrowing from side table.</span></span><br><span class="line">            <span class="comment">// This decrement cannot be the deallocating decrement - the side </span></span><br><span class="line">            <span class="comment">// table lock and has_sidetable_rc bit ensure that if everyone </span></span><br><span class="line">            <span class="comment">// else tried to -release while we worked, the last one would block.</span></span><br><span class="line">            sidetable_unlock();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Side table is empty after all. Fall-through to the dealloc path.</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// å¦‚æœå¼•ç”¨è®¡æ•°å™¨ä¸º0 deallocå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// Really deallocate.</span></span><br><span class="line">		<span class="comment">// å¦‚æœå½“å‰å¯¹è±¡å¤„äºdeallocatingï¼Œä¿è¯å¯¹è±¡åªä¼šdeallocatingä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">if</span> (slowpath(newisa.deallocating)) &#123;</span><br><span class="line">        ClearExclusive(&amp;isa.bits);</span><br><span class="line">        <span class="keyword">if</span> (sideTableLocked) sidetable_unlock();</span><br><span class="line">        <span class="keyword">return</span> overrelease_error();</span><br><span class="line">        <span class="comment">// does not actually return</span></span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// è®¾ç½®isaå¤„äºdeallocatingçŠ¶æ€</span></span><br><span class="line">    newisa.deallocating = <span class="literal">true</span>;</span><br><span class="line">  	<span class="comment">// å¦‚æœå­˜å‚¨å¤±è´¥ ç»§ç»­é‡è¯•</span></span><br><span class="line">    <span class="keyword">if</span> (!StoreExclusive(&amp;isa.bits, oldisa.bits, newisa.bits)) <span class="keyword">goto</span> retry;</span><br><span class="line">		</span><br><span class="line">    <span class="keyword">if</span> (slowpath(sideTableLocked)) sidetable_unlock();</span><br><span class="line"></span><br><span class="line">    __c11_atomic_thread_fence(__ATOMIC_ACQUIRE);</span><br><span class="line">		<span class="comment">// å¦‚æœperformDealloc==true,ç»™å¯¹è±¡å‘é€ä¸€æ¡deallocæ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">if</span> (performDealloc) &#123;</span><br><span class="line">        ((<span class="keyword">void</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, <span class="keyword">@selector</span>(dealloc));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-sidetable-release"><a href="#objc-object-sidetable-release" class="headerlink" title="objc_object::sidetable_release"></a>objc_object::sidetable_release</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rdar://20206767</span></span><br><span class="line"><span class="comment">// return uintptr_t instead of bool so that the various raw-isa </span></span><br><span class="line"><span class="comment">// -release paths all return zero in eax</span></span><br><span class="line">uintptr_t</span><br><span class="line">objc_object::sidetable_release(<span class="keyword">bool</span> performDealloc)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> SUPPORT_NONPOINTER_ISA</span></span><br><span class="line">    ASSERT(!isa.nonpointer);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</span><br><span class="line">		<span class="comment">// è®¾ç½®æ˜¯å¦éœ€è¦æ‰§è¡Œdo_deallocæ ‡è®°ï¼Œé»˜è®¤ä¸éœ€è¦</span></span><br><span class="line">    <span class="keyword">bool</span> do_dealloc = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    table.lock();</span><br><span class="line">  	<span class="comment">// è·å–å½“å‰å¯¹è±¡æ˜¯å¦æ­£åœ¨æ‰§è¡Œdeallocating</span></span><br><span class="line">    auto it = table.refcnts.try_emplace(<span class="keyword">this</span>, SIDE_TABLE_DEALLOCATING);</span><br><span class="line">  	<span class="comment">// è·å–refcnt</span></span><br><span class="line">    auto &amp;refcnt = it.first-&gt;second;</span><br><span class="line">    <span class="keyword">if</span> (it.second) &#123;</span><br><span class="line">        do_dealloc = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refcnt &lt; SIDE_TABLE_DEALLOCATING) &#123;</span><br><span class="line">      	<span class="comment">// å¦‚æœå¯¹è±¡å¤„äºdeallocatingçŠ¶æ€</span></span><br><span class="line">        <span class="comment">// SIDE_TABLE_WEAKLY_REFERENCED may be set. Don't change it.</span></span><br><span class="line">        do_dealloc = <span class="literal">true</span>;</span><br><span class="line">        refcnt |= SIDE_TABLE_DEALLOCATING;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (! (refcnt &amp; SIDE_TABLE_RC_PINNED)) &#123;<span class="comment">// å¦‚æœå¼•ç”¨è®¡æ•°å™¨è¿˜æœ‰å€¼ï¼Œä½œè®¡æ•°å™¨-1</span></span><br><span class="line">        refcnt -= SIDE_TABLE_RC_ONE;</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">  	<span class="comment">// å¦‚æœå¯¹è±¡æ­£åœ¨ä½œdealloc å’Œ performDeallocï¼Œå¯¹å½“å‰å¯¹è±¡å‘é€deallocæ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">if</span> (do_dealloc  &amp;&amp;  performDealloc) &#123;</span><br><span class="line">        ((<span class="keyword">void</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, <span class="keyword">@selector</span>(dealloc));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> do_dealloc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>isa</code>ä¸æ˜¯<code>nonpointer</code>ï¼Œé‚£ä¹ˆå°±å¯¹<code>SideTable</code>ä¸­å¼•ç”¨è®¡æ•°-1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°ä¸º0ï¼Œå‘é€<code>dealloc</code>æ¶ˆæ¯</p>
<h4 id="subc"><a href="#subc" class="headerlink" title="subc"></a>subc</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">static ALWAYS_INLINE uintptr_t </span><br><span class="line">subc(uintptr_t lhs, uintptr_t rhs, uintptr_t carryin, uintptr_t *carryout)</span><br><span class="line">&#123;</span><br><span class="line">    return __builtin_subcl(lhs, rhs, carryin, carryout);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>subc</code> å°±æ˜¯ <code>addc</code>åå‘æ“ä½œï¼Œç”¨æ¥å‡å°‘å¼•ç”¨è®¡æ•°</p>
<h4 id="objc-object-rootRelease-underflow"><a href="#objc-object-rootRelease-underflow" class="headerlink" title="objc_object::rootRelease_underflow"></a>objc_object::rootRelease_underflow</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NEVER_INLINE uintptr_t</span><br><span class="line">objc_object::rootRelease_underflow(bool performDealloc)</span><br><span class="line">&#123;</span><br><span class="line">    return rootRelease(performDealloc, true);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœ<code>extra_rc</code>ä¸‹æº¢ï¼Œå°±ä¼šè°ƒç”¨<code>rootRelease_underflow</code>ï¼Œè¯¥å‡½æ•°ä¼šå†æ¬¡è°ƒç”¨<code>rootRelease</code>ï¼Œä½†æ˜¯å‚æ•°<code>handleUnderflow</code>ä¼ true</p>
<h4 id="objc-object-sidetable-subExtraRC-nolock"><a href="#objc-object-sidetable-subExtraRC-nolock" class="headerlink" title="objc_object::sidetable_subExtraRC_nolock"></a>objc_object::sidetable_subExtraRC_nolock</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Move some retain counts from the side table to the isa field.</span></span><br><span class="line"><span class="comment">// Returns the actual count subtracted, which may be less than the request.</span></span><br><span class="line"><span class="comment">// å°è¯•ä»sidetableä¸­ç§»åŠ¨ä¸€äº›å¼•ç”¨è®¡æ•°åˆ°isaä¸­ï¼Œè¿”å›çœŸå®ç§»åŠ¨çš„æ•°é‡ï¼Œæœ‰å¯èƒ½æ¯”è¯·æ±‚ç§»åŠ¨çš„è¦å°‘</span></span><br><span class="line">size_t </span><br><span class="line">objc_object::sidetable_subExtraRC_nolock(size_t delta_rc)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(isa.nonpointer);</span><br><span class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</span><br><span class="line">		<span class="comment">// è·å–refcnts</span></span><br><span class="line">    RefcountMap::iterator it = table.refcnts.find(<span class="keyword">this</span>);</span><br><span class="line">  	<span class="comment">// å¦‚æœå½“å‰refcntsä¸ºç©ºï¼Œç›´æ¥return</span></span><br><span class="line">    <span class="keyword">if</span> (it == table.refcnts.end()  ||  it-&gt;second == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// Side table retain count is zero. Can't borrow.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    size_t oldRefcnt = it-&gt;second;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// isa-side bits should not be set here</span></span><br><span class="line">    ASSERT((oldRefcnt &amp; SIDE_TABLE_DEALLOCATING) == <span class="number">0</span>);</span><br><span class="line">    ASSERT((oldRefcnt &amp; SIDE_TABLE_WEAKLY_REFERENCED) == <span class="number">0</span>);</span><br><span class="line">		</span><br><span class="line">  	<span class="comment">// å‡å°‘å¼•ç”¨è®¡æ•°å™¨</span></span><br><span class="line">    size_t newRefcnt = oldRefcnt - (delta_rc &lt;&lt; SIDE_TABLE_RC_SHIFT);</span><br><span class="line">    ASSERT(oldRefcnt &gt; newRefcnt);  <span class="comment">// shouldn't underflow</span></span><br><span class="line">    it-&gt;second = newRefcnt;</span><br><span class="line">    <span class="keyword">return</span> delta_rc;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>sidetable_subExtraRC_nolock</code>å‡½æ•°å°†å¼•ç”¨è®¡æ•°å™¨è½¬ç§»åˆ°<code>isa</code>æŒ‡é’ˆçš„<code>extra_rc</code>ä¸­ï¼Œæœ‰å¯èƒ½æ¯”è¯·æ±‚è¦ç§»åŠ¨çš„å°‘ã€‚</p>
<h4 id="objc-object-overrelease-error"><a href="#objc-object-overrelease-error" class="headerlink" title="objc_object::overrelease_error"></a>objc_object::overrelease_error</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">NEVER_INLINE uintptr_t</span><br><span class="line">objc_object::overrelease_error()</span><br><span class="line">&#123;</span><br><span class="line">    _objc_inform_now_and_on_crash(<span class="string">"%s object %p overreleased while already deallocating; break on objc_overrelease_during_dealloc_error to debug"</span>, object_getClassName((<span class="keyword">id</span>)<span class="keyword">this</span>), <span class="keyword">this</span>);</span><br><span class="line">    objc_overrelease_during_dealloc_error();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// allow rootRelease() to tail-call this</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœå½“å‰å¯¹è±¡æ­£å¤„äºdeallocçŠ¶æ€ï¼Œå†æ¬¡releaseæœºä¼šæ‰§è¡Œoverrelease_errorï¼Œè¯¥å‡½æ•°ç”¨äºå¤„ç†è¿‡åº¦è°ƒç”¨releaseçš„æ—¶å€™ä½¿ç”¨ã€‚</p>
<blockquote>
<p><strong>å°ç»“ï¼šreleaseæ–¹æ³•</strong></p>
<p>å¦‚æœisaä¸æ˜¯nonpointer,é‚£ä¹ˆç›´æ¥å¯¹sidetableä¸­çš„å¼•ç”¨è®¡æ•°-1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•°==0ï¼Œè°ƒç”¨dealloc</p>
<p>å¦‚æœisaæ˜¯nonpointerï¼Œå°±å°†å½“å‰extra_rcå­˜å‚¨çš„å¼•ç”¨è®¡æ•°å™¨-1ï¼Œå¦‚æœä¸‹æº¢ï¼Œå³extra_rcä¸­çš„å¼•ç”¨è®¡æ•°å™¨ä¸º0äº†ï¼Œåˆ¤æ–­has_sidetable_rcæ˜¯å¦ä¸ºtrueï¼Œå³æ˜¯å¦ä½¿ç”¨çš„sidetableè¿›è¡Œå¼•ç”¨è®¡æ•°å­˜å‚¨ï¼Œå¦‚æœæœ‰çš„è¯å°±ç”³è¯·ä»Sidetableä¸­ç”³è¯·RC_HALFä¸ªå¼•ç”¨è®¡æ•°è½¬ç§»åˆ°extra_rcä¸­å­˜å‚¨ï¼Œå¦‚æœä¸è¶³RC_HALFå°±æœ‰å¤šå°‘è½¬ç§»å¤šå°‘ï¼Œç„¶åå°†Sitetableä¸­çš„å¼•ç”¨è®¡æ•°å‡å»RC_HALFï¼ˆæˆ–è€…å®é™…è½¬ç§»æ•°é‡ï¼‰å°†å®é™…ç”³è¯·çš„å¼•ç”¨è®¡æ•°å™¨-1åå­˜å‚¨åœ¨extra_rcä¸­ï¼Œå¦‚æœextra_rcä¸­å¼•ç”¨è®¡æ•°å™¨ä¸º0äº†è€Œä¸”has_sidetable_rc ä¸ºfalseæˆ–è€…sitetableä¸­çš„å¼•ç”¨è®¡æ•°å™¨ä¹Ÿä¸º0äº†ï¼Œä½ ä»¬å°±å‘é€deallocæ¶ˆæ¯</p>
</blockquote>
<h3 id="autorelease"><a href="#autorelease" class="headerlink" title="autorelease"></a>autorelease</h3><h4 id="objc-autorelease"><a href="#objc-autorelease" class="headerlink" title="objc_autorelease"></a>objc_autorelease</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __OBJC2__</span></span><br><span class="line">__attribute__((aligned(<span class="number">16</span>), flatten, noinline))</span><br><span class="line"><span class="keyword">id</span></span><br><span class="line">objc_autorelease(<span class="keyword">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> obj;</span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;isTaggedPointer()) <span class="keyword">return</span> obj;</span><br><span class="line">    <span class="keyword">return</span> obj-&gt;autorelease();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">id</span> objc_autorelease(<span class="keyword">id</span> obj) &#123; <span class="keyword">return</span> [obj autorelease]; &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>å¦‚æœæ˜¯<code>__OBJC2__</code>ï¼Œåˆ™è°ƒç”¨autoreleaseå‡½æ•°ï¼Œå¦åˆ™è°ƒç”¨autoreleaseæ–¹æ³•</p>
<h4 id="objc-object-autorelease"><a href="#objc-object-autorelease" class="headerlink" title="objc_object::autorelease"></a>objc_object::autorelease</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">id</span> </span><br><span class="line">objc_object::autorelease()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> (<span class="keyword">id</span>)<span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (fastpath(!ISA()-&gt;hasCustomRR())) <span class="keyword">return</span> rootAutorelease();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">id</span>(*)(objc_object *, SEL))objc_msgSend)(<span class="keyword">this</span>, <span class="keyword">@selector</span>(autorelease));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¯¥æ–¹æ³•æ²¡æœ‰è¢«é‡å†™ï¼Œç›´æ¥è°ƒç”¨objc_object::rootAutoreleaseï¼Œè¿™æ˜¯å¿«æ·æ–¹å¼ï¼›å¦åˆ™è°ƒç”¨autoreleaseæ–¹æ³•ã€‚</p>
<h4 id="objc-object-autorelease-1"><a href="#objc-object-autorelease-1" class="headerlink" title="objc_object::autorelease"></a>objc_object::autorelease</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">id</span> </span><br><span class="line">objc_object::rootAutorelease()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span> (<span class="keyword">id</span>)<span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> (prepareOptimizedReturn(ReturnAtPlus1)) <span class="keyword">return</span> (<span class="keyword">id</span>)<span class="keyword">this</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rootAutorelease2();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-rootAutorelease2"><a href="#objc-object-rootAutorelease2" class="headerlink" title="objc_object::rootAutorelease2"></a>objc_object::rootAutorelease2</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">__attribute__((noinline,used))</span><br><span class="line"><span class="keyword">id</span> </span><br><span class="line">objc_object::rootAutorelease2()</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(!isTaggedPointer());</span><br><span class="line">    <span class="keyword">return</span> AutoreleasePoolPage::autorelease((<span class="keyword">id</span>)<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ä¸­è°ƒç”¨äº†<code>AutoreleasePoolPage</code>ä¸­<code>autorelease</code>æ–¹æ³•</p>
<h3 id="dealloc"><a href="#dealloc" class="headerlink" title="dealloc"></a>dealloc</h3><h4 id="dealloc-1"><a href="#dealloc-1" class="headerlink" title="dealloc"></a>dealloc</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)dealloc &#123;</span><br><span class="line">    _objc_rootDealloc(<span class="keyword">self</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-rootDealloc"><a href="#objc-rootDealloc" class="headerlink" title="_objc_rootDealloc"></a>_objc_rootDealloc</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span></span><br><span class="line">_objc_rootDealloc(<span class="keyword">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(obj);</span><br><span class="line"></span><br><span class="line">    obj-&gt;rootDealloc();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-rootDealloc"><a href="#objc-object-rootDealloc" class="headerlink" title="objc_object::rootDealloc"></a>objc_object::rootDealloc</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span></span><br><span class="line">objc_object::rootDealloc()</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (isTaggedPointer()) <span class="keyword">return</span>;  <span class="comment">// fixme necessary?</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (fastpath(isa.nonpointer  &amp;&amp;  </span><br><span class="line">                 !isa.weakly_referenced  &amp;&amp;  <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰å¼±å¼•ç”¨</span></span><br><span class="line">                 !isa.has_assoc  &amp;&amp;  				 <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰å…³è”å¯¹è±¡</span></span><br><span class="line">                 !isa.has_cxx_dtor  &amp;&amp;  		 <span class="comment">// æ²¡æœ‰c++ææ„å‡½æ•°</span></span><br><span class="line">                 !isa.has_sidetable_rc))		 <span class="comment">// æ²¡æœ‰ä½¿ç”¨sidetableè¿›è¡Œå¼•ç”¨è®¡æ•°å­˜å‚¨</span></span><br><span class="line">    &#123;</span><br><span class="line">        assert(!sidetable_present());</span><br><span class="line">      	<span class="comment">// ç›´æ¥ä½¿ç”¨freeé”€æ¯å¯¹è±¡</span></span><br><span class="line">        free(<span class="keyword">this</span>);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      	<span class="comment">// è°ƒç”¨object_disposeå‡½æ•°</span></span><br><span class="line">        object_dispose((<span class="keyword">id</span>)<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="object-dispose"><a href="#object-dispose" class="headerlink" title="object_dispose"></a>object_dispose</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">id</span> </span><br><span class="line">object_dispose(<span class="keyword">id</span> obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line"></span><br><span class="line">    objc_destructInstance(obj);   <span class="comment">// è°ƒç”¨ objc_destructInstance å‡½æ•°</span></span><br><span class="line">    free(obj);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-destructInstance"><a href="#objc-destructInstance" class="headerlink" title="objc_destructInstance"></a>objc_destructInstance</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/***********************************************************************</span></span><br><span class="line"><span class="comment">* objc_destructInstance</span></span><br><span class="line"><span class="comment">* Destroys an instance without freeing memory. </span></span><br><span class="line"><span class="comment">* Calls C++ destructors.</span></span><br><span class="line"><span class="comment">* Calls ARC ivar cleanup.</span></span><br><span class="line"><span class="comment">* Removes associative references.</span></span><br><span class="line"><span class="comment">* Returns `obj`. Does nothing if `obj` is nil.</span></span><br><span class="line"><span class="comment">**********************************************************************/</span></span><br><span class="line"><span class="keyword">void</span> *objc_destructInstance(<span class="keyword">id</span> obj) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (obj) &#123;</span><br><span class="line">        <span class="comment">// Read all of the flags at once for performance.</span></span><br><span class="line">        <span class="keyword">bool</span> cxx = obj-&gt;hasCxxDtor();</span><br><span class="line">        <span class="keyword">bool</span> assoc = obj-&gt;hasAssociatedObjects();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// This order is important.</span></span><br><span class="line">        <span class="keyword">if</span> (cxx) object_cxxDestruct(obj);<span class="comment">// å¦‚æœæœ‰c++ææ„å‡½æ•°ï¼Œè°ƒç”¨object_cxxDestruct</span></span><br><span class="line">        <span class="keyword">if</span> (assoc) _object_remove_assocations(obj);<span class="comment">// å¦‚æœæœ‰å…³è”å¯¹è±¡ï¼Œç§»é™¤å…³è”å¯¹è±¡</span></span><br><span class="line">        obj-&gt;clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-clearDeallocating"><a href="#objc-object-clearDeallocating" class="headerlink" title="objc_object::clearDeallocating"></a>objc_object::clearDeallocating</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span> </span><br><span class="line">objc_object::clearDeallocating()</span><br><span class="line">&#123;</span><br><span class="line">  	<span class="comment">// å¦‚æœ isa ä¸æ˜¯ nonpointer</span></span><br><span class="line">    <span class="keyword">if</span> (slowpath(!isa.nonpointer)) &#123;</span><br><span class="line">        <span class="comment">// Slow path for raw pointer isa.</span></span><br><span class="line">        sidetable_clearDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// å¦‚æœ isa æ˜¯ nonpointer æˆ–è€… isa.has_sidetable_rc == true</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (slowpath(isa.weakly_referenced  ||  isa.has_sidetable_rc)) &#123;</span><br><span class="line">        <span class="comment">// Slow path for non-pointer isa with weak refs and/or side table data.</span></span><br><span class="line">        clearDeallocating_slow();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    assert(!sidetable_present());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-sidetable-clearDeallocating"><a href="#objc-object-sidetable-clearDeallocating" class="headerlink" title="objc_object::sidetable_clearDeallocating"></a>objc_object::sidetable_clearDeallocating</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> </span><br><span class="line">objc_object::sidetable_clearDeallocating()</span><br><span class="line">&#123;</span><br><span class="line">  	<span class="comment">// è·å–SideTable</span></span><br><span class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clear any weak table items</span></span><br><span class="line">    <span class="comment">// clear extra retain count and deallocating bit</span></span><br><span class="line">    <span class="comment">// (fixme warn or abort if extra retain count == 0 ?)</span></span><br><span class="line">    table.lock();</span><br><span class="line">  	<span class="comment">// è·å–å¼±å¼•ç”¨æ•£åˆ—è¡¨</span></span><br><span class="line">    RefcountMap::iterator it = table.refcnts.find(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (it != table.refcnts.end()) &#123;</span><br><span class="line">      	<span class="comment">// å½“å‰å¯¹è±¡æ˜¯å¦æœ‰å¼±å¼•ç”¨</span></span><br><span class="line">        <span class="keyword">if</span> (it-&gt;second &amp; SIDE_TABLE_WEAKLY_REFERENCED) &#123;</span><br><span class="line">            weak_clear_no_lock(&amp;table.weak_table, (<span class="keyword">id</span>)<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// è°ƒç”¨table.refcnts.eraseä»å¼•ç”¨è®¡æ•°å™¨ä¸­</span></span><br><span class="line">        table.refcnts.erase(it);</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-object-clearDeallocating-slow"><a href="#objc-object-clearDeallocating-slow" class="headerlink" title="objc_object::clearDeallocating_slow"></a>objc_object::clearDeallocating_slow</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Slow path of clearDeallocating() </span></span><br><span class="line"><span class="comment">// for objects with nonpointer isa</span></span><br><span class="line"><span class="comment">// that were ever weakly referenced </span></span><br><span class="line"><span class="comment">// or whose retain count ever overflowed to the side table.</span></span><br><span class="line">NEVER_INLINE <span class="keyword">void</span></span><br><span class="line">objc_object::clearDeallocating_slow()</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(isa.nonpointer  &amp;&amp;  (isa.weakly_referenced || isa.has_sidetable_rc));</span><br><span class="line"></span><br><span class="line">    SideTable&amp; table = SideTables()[<span class="keyword">this</span>];</span><br><span class="line">    table.lock();</span><br><span class="line">  	<span class="comment">// æ˜¯å¦æœ‰å¼±å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (isa.weakly_referenced) &#123;</span><br><span class="line">      	<span class="comment">// æ¸…ç†å¼±å¼•ç”¨æŒ‡é’ˆ</span></span><br><span class="line">        weak_clear_no_lock(&amp;table.weak_table, (<span class="keyword">id</span>)<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  	<span class="comment">// å¦‚æœæœ‰has_sidetable_rc</span></span><br><span class="line">    <span class="keyword">if</span> (isa.has_sidetable_rc) &#123;</span><br><span class="line">      	<span class="comment">// è°ƒç”¨table.refcnts.eraseä»å¼•ç”¨è®¡æ•°å™¨ä¸­</span></span><br><span class="line">        table.refcnts.erase(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    table.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>å°ç»“ï¼šdeallocæ–¹æ³•</strong></p>
<ul>
<li><p>åˆ¤æ–­æ¡ä»¶ï¼ˆ1ã€isa ä¸ºnonpointer; 2ã€æ²¡æœ‰å¼±å¼•ç”¨ï¼›3ã€æ²¡æœ‰å…³è”å¯¹è±¡ï¼›4ã€æ²¡æœ‰c++ææ„å‡½æ•°ï¼›5ã€æ²¡æœ‰é¢å¤–ä½¿ç”¨sidetableè¿›è¡Œå¼•ç”¨è®¡æ•°å™¨å­˜å‚¨ï¼‰æ˜¯å¦æˆç«‹ï¼Œå‡æˆç«‹çš„è¯ï¼Œä½¿ç”¨freeå‡½æ•°ç›´æ¥é”€æ¯å¯¹è±¡ï¼Œå¦åˆ™è°ƒç”¨object_disposeåšä¸€äº›é‡Šæ”¾å¯¹è±¡å‰çš„å¤„ç†</p>
</li>
<li><p>å¦‚æœæœ‰C++ææ„å‡½æ•°ï¼Œè°ƒç”¨<code>object_cxxDestruct</code>;</p>
</li>
<li><p>å¦‚æœæœ‰å…³è”å¯¹è±¡ï¼Œ<code>_object_remove_assocations</code>ç§»é™¤å…³è”å¯¹è±¡</p>
</li>
<li><p>å¦‚æœæœ‰å¼±å¼•ç”¨ï¼Œè°ƒç”¨<code>weak_clear_no_lock</code>å°†æŒ‡å‘è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨æŒ‡é’ˆç½®ä¸ºnil</p>
</li>
<li><p>å¦‚æœæœ‰ä½¿ç”¨sidetableè¿›è¡Œå¼•ç”¨è®¡æ•°å™¨å­˜å‚¨ï¼Œè°ƒç”¨<code>table.refcnts.erase</code>ä»å¼•ç”¨è®¡æ•°è¡¨ä¸­æ“¦é™¤è¯¥å¯¹äºçš„å¼•ç”¨è®¡æ•°</p>
</li>
<li><p>è°ƒç”¨<code>free</code>å‡½æ•°é”€æ¯å¯¹è±¡</p>
<p>æ ¹æ®deallocè¿‡ç¨‹ï¼Œ<code>__weak</code>ä¿®é¥°ç¬¦çš„å˜é‡åœ¨å¯¹è±¡è¢«<code>dealloc</code>æ—¶ï¼Œä¼šå°†è¯¥<code>weak</code>ç½®ä¸ºnilã€‚å¯è§ï¼Œå¦‚æœå¤§é‡ä½¿ç”¨<code>weak</code>å˜é‡çš„è¯ï¼Œæ˜¯ä¼šæ¶ˆè€—CPUçš„èµ„æºï¼Œæ‰€ä»¥å»ºè®®åªåœ¨éœ€è¦é¿å…å¾ªç¯å¼•ç”¨çš„æ—¶å€™ä½¿ç”¨<code>weak</code>ä¿®é¥°ç¬¦ã€‚</p>
</li>
</ul>
</blockquote>
<h3 id="weak"><a href="#weak" class="headerlink" title="weak"></a>weak</h3><h4 id="æ¸…é™¤weak"><a href="#æ¸…é™¤weak" class="headerlink" title="æ¸…é™¤weak"></a>æ¸…é™¤weak</h4><p>ä»¥ä¸Šä»deallocæ–¹æ³•å®ç°æˆ‘ä»¬çŸ¥é“äº†å¯¹è±¡åœ¨deallocçš„æ—¶å€™ï¼Œä¼šè°ƒç”¨weak_clear_no_lockå‡½æ•°å°†æŒ‡å‘è¯¥å¯¹è±¡çš„å¼±å¼•ç”¨æŒ‡é’ˆç½®ä¸ºnil</p>
<h4 id="weak-clear-no-lock"><a href="#weak-clear-no-lock" class="headerlink" title="weak_clear_no_lock"></a>weak_clear_no_lock</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Called by dealloc; nils out all weak pointers that point to the </span></span><br><span class="line"><span class="comment"> * provided object so that they can no longer be used.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param weak_table </span></span><br><span class="line"><span class="comment"> * @param referent The object being deallocated. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> </span><br><span class="line">weak_clear_no_lock(weak_table_t *weak_table, <span class="keyword">id</span> referent_id) </span><br><span class="line">&#123;</span><br><span class="line">  	<span class="comment">// è·å–weakæŒ‡å‘çš„åœ°å€ï¼Œå³å½“æå¯¹è±¡çš„åœ°å€</span></span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line">		<span class="comment">// æ‰¾åˆ°ç®¡ç†weak_entry_tçš„å®¹å™¨</span></span><br><span class="line">    weak_entry_t *entry = weak_entry_for_referent(weak_table, referent);</span><br><span class="line">    <span class="keyword">if</span> (entry == <span class="literal">nil</span>) &#123;</span><br><span class="line">        <span class="comment">/// XXX shouldn't happen, but does with mismatched CF/objc</span></span><br><span class="line">        <span class="comment">//printf("XXX no entry for clear deallocating %p\n", referent);</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// zero out references</span></span><br><span class="line">    weak_referrer_t *referrers;</span><br><span class="line">    size_t count;</span><br><span class="line">    </span><br><span class="line">  	<span class="comment">// åˆ¤æ–­å¼±å¼•ç”¨æ˜¯å¦è¶…å‡ºå®šé•¿</span></span><br><span class="line">    <span class="keyword">if</span> (entry-&gt;out_of_line()) &#123;</span><br><span class="line">      	<span class="comment">// è·å–entryä¸­çš„referrersï¼Œreferrersæ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå­˜å‚¨æ‰€æœ‰æŒ‡å‘referent_idçš„æŒ‡é’ˆ</span></span><br><span class="line">        referrers = entry-&gt;referrers;</span><br><span class="line">      	<span class="comment">// å¼±å¼•ç”¨æ•°ç»„é•¿åº¦</span></span><br><span class="line">        count = TABLE_SIZE(entry);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      	<span class="comment">// å¦‚æœæ˜¯ä½¿ç”¨çš„å®šé•¿å­˜å‚¨</span></span><br><span class="line">        referrers = entry-&gt;inline_referrers;</span><br><span class="line">        count = WEAK_INLINE_COUNT;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// éå†å¼±å¼•ç”¨æ•°ç»„ï¼Œå°†æ‰€æœ‰æŒ‡å‘referent_idçš„æŒ‡é’ˆç½®ä¸ºnil</span></span><br><span class="line">    <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; count; ++i) &#123;</span><br><span class="line">        objc_object **referrer = referrers[i];</span><br><span class="line">        <span class="keyword">if</span> (referrer) &#123;</span><br><span class="line">            <span class="keyword">if</span> (*referrer == referent) &#123;</span><br><span class="line">                *referrer = <span class="literal">nil</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (*referrer) &#123;</span><br><span class="line">                _objc_inform(<span class="string">"__weak variable at %p holds %p instead of %p. "</span></span><br><span class="line">                             <span class="string">"This is probably incorrect use of "</span></span><br><span class="line">                             <span class="string">"objc_storeWeak() and objc_loadWeak(). "</span></span><br><span class="line">                             <span class="string">"Break on objc_weak_error to debug.\n"</span>, </span><br><span class="line">                             referrer, (<span class="keyword">void</span>*)*referrer, (<span class="keyword">void</span>*)referent);</span><br><span class="line">                objc_weak_error();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†entryä»å¼±å¼•ç”¨è¡¨ä¸­ç§»é™¤</span></span><br><span class="line">    weak_entry_remove(weak_table, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>å°ç»“ï¼šæ¸…é™¤weak</strong></p>
<p>å½“ä¸€ä¸ªå¯¹è±¡é”€æ¯æ˜¯ï¼Œåœ¨<code>dealloc</code>æ–¹æ³•å†…éƒ¨ç»è¿‡ä¸€ç³»åˆ—çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œé€šè¿‡äºŒæ¬¡å“ˆå¸ŒæŸ¥æ‰¾ï¼Œç¬¬ä¸€æ¬¡æ ¹æ®å¯¹è±¡çš„åœ°å€æ‰¾åˆ°å®ƒæ‰€åœ¨çš„<code>sidetable</code>ï¼Œç¬¬äºŒæ¬¡æ ¹æ®å¯¹è±¡çš„åœ°å€åœ¨Sidetableçš„<code>weak_table</code>ä¸­æ‰¾æ‰“å®ƒçš„å¼±å¼•ç”¨è¡¨ã€‚å¼±å¼•ç”¨è¡¨ä¸­å­˜å‚¨çš„æ˜¯å¯¹è±¡çš„åœ°å€ï¼ˆä½œä¸º<code>key</code>ï¼‰å’ŒweakæŒ‡é’ˆåœ°å€çš„æ•°ç»„ï¼ˆä½œä¸º<code>value</code>ï¼‰çš„æ˜ å°„ã€‚<code>weak_clear_no_lock</code>å‡½æ•°ä¸­éå†å¼±å¼•ç”¨æ•°ç»„ï¼Œå°†æŒ‡å‘è¯¥å¯¹è±¡çš„åœ°å€çš„<code>weak</code>å˜é‡å…¨éƒ¨ç½®ä¸ºnil</p>
</blockquote>
<h3 id="æ·»åŠ weak"><a href="#æ·»åŠ weak" class="headerlink" title="æ·»åŠ weak"></a>æ·»åŠ weak</h3><p>ä¸€ä¸ªè¢«å£°æ˜æœª__weakçš„æŒ‡é’ˆï¼Œåœ¨ç»è¿‡ç¼–è¯‘ä¹‹åï¼Œé€šè¿‡<code>objc_initWeak</code>å‡½æ•°åˆå§‹åŒ–é™„æœ‰<code>weak</code>ä¿®é¥°ç¬¦çš„å˜é‡ï¼Œåœ¨å˜é‡ä½œç”¨åŸŸç»“æŸæ—¶ï¼Œé€šè¿‡<code>objc_destroyWeak</code>å‡½æ•°é”€æ¯è¯¥å˜é‡ã€‚</p>
<h4 id="objc-moveWeak"><a href="#objc-moveWeak" class="headerlink" title="objc_moveWeak"></a>objc_moveWeak</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Move a weak pointer from one location to another.</span></span><br><span class="line"><span class="comment"> * Before the move, the destination must be uninitialized.</span></span><br><span class="line"><span class="comment"> * After the move, the source is nil.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function IS NOT thread-safe with respect to concurrent </span></span><br><span class="line"><span class="comment"> * modifications to either weak variable. (Concurrent weak clear is safe.)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">objc_moveWeak(<span class="keyword">id</span> *dst, <span class="keyword">id</span> *src)</span><br><span class="line">&#123;</span><br><span class="line">    objc_copyWeak(dst, src);</span><br><span class="line">    objc_destroyWeak(src);</span><br><span class="line">    *src = <span class="literal">nil</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-copyWeak"><a href="#objc-copyWeak" class="headerlink" title="objc_copyWeak"></a>objc_copyWeak</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * This function copies a weak pointer from one location to another,</span></span><br><span class="line"><span class="comment"> * when the destination doesn't already contain a weak pointer. It</span></span><br><span class="line"><span class="comment"> * would be used for code like:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *  __weak id src = ...;</span></span><br><span class="line"><span class="comment"> *  __weak id dst = src;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This function IS NOT thread-safe with respect to concurrent </span></span><br><span class="line"><span class="comment"> * modifications to the destination variable. (Concurrent weak clear is safe.)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param dst The destination variable.</span></span><br><span class="line"><span class="comment"> * @param src The source variable.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">objc_copyWeak(<span class="keyword">id</span> *dst, <span class="keyword">id</span> *src)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">id</span> obj = objc_loadWeakRetained(src);</span><br><span class="line">    objc_initWeak(dst, obj);</span><br><span class="line">    objc_release(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-initWeak"><a href="#objc-initWeak" class="headerlink" title="objc_initWeak"></a>objc_initWeak</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Initialize a fresh weak pointer to some object location. </span></span><br><span class="line"><span class="comment"> * It would be used for code like: </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * (The nil case) </span></span><br><span class="line"><span class="comment"> * __weak id weakPtr;</span></span><br><span class="line"><span class="comment"> * (The non-nil case) </span></span><br><span class="line"><span class="comment"> * NSObject *o = ...;</span></span><br><span class="line"><span class="comment"> * __weak id weakPtr = o;</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * This function IS NOT thread-safe with respect to concurrent </span></span><br><span class="line"><span class="comment"> * modifications to the weak variable. (Concurrent weak clear is safe.)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param location Address of __weak ptr. </span></span><br><span class="line"><span class="comment"> * @param newObj Object ptr. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">id</span></span><br><span class="line">objc_initWeak(<span class="keyword">id</span> *location, <span class="keyword">id</span> newObj)<span class="comment">// locationä¸º__weakæŒ‡é’ˆåœ°å€ï¼ŒnewObjä¸ºå¯¹è±¡åœ°å€</span></span><br><span class="line">&#123;</span><br><span class="line">  	<span class="comment">// å¦‚æœå¯¹è±¡ä¸ºnilï¼Œé‚£å°±å°†__weakæŒ‡é’ˆç½®ä¸ºnil</span></span><br><span class="line">    <span class="keyword">if</span> (!newObj) &#123;</span><br><span class="line">        *location = <span class="literal">nil</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> storeWeak&lt;DontHaveOld, DoHaveNew, DoCrashIfDeallocating&gt;</span><br><span class="line">        (location, (objc_object*)newObj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="storeWeak"><a href="#storeWeak" class="headerlink" title="storeWeak"></a>storeWeak</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Update a weak variable.</span></span><br><span class="line"><span class="comment">// If HaveOld is true, the variable has an existing value </span></span><br><span class="line"><span class="comment">//   that needs to be cleaned up. This value might be nil.</span></span><br><span class="line"><span class="comment">// If HaveNew is true, there is a new value that needs to be </span></span><br><span class="line"><span class="comment">//   assigned into the variable. This value might be nil.</span></span><br><span class="line"><span class="comment">// If CrashIfDeallocating is true, the process is halted if newObj is </span></span><br><span class="line"><span class="comment">//   deallocating or newObj's class does not support weak references. </span></span><br><span class="line"><span class="comment">//   If CrashIfDeallocating is false, nil is stored instead.</span></span><br><span class="line"><span class="comment">// æ›´æ–°weakå˜é‡</span></span><br><span class="line"><span class="comment">// å¦‚æœ HaveOld == trueï¼Œè¡¨ç¤ºå˜é‡æœ‰æ—§å€¼ï¼Œè¿™ä¸ªå€¼å¯èƒ½ä¸ºnil</span></span><br><span class="line"><span class="comment">// å¦‚æœ HaveNew == trueï¼Œè¡¨ç¤ºä¸€ä¸ªæ–°å€¼éœ€è¦èµ‹å€¼ç»™å˜é‡ï¼Œè¿™ä¸ªæ–°å€¼å¯èƒ½æ˜¯nil</span></span><br><span class="line"><span class="comment">// å¦‚æœ CrashIfDeallocating == trueï¼Œè¡¨ç¤ºå¯¹è±¡æ­£åœ¨é”€æ¯ æˆ–è€… å¯¹è±¡ä¸æ”¯æŒå¼±å¼•ç”¨ï¼Œåˆ™åœæ­¢æ›´æ–°</span></span><br><span class="line"><span class="comment">// å¦‚æœ CrashIfDeallocating == falseï¼Œåˆ™å­˜å‚¨nil</span></span><br><span class="line"><span class="keyword">enum</span> CrashIfDeallocating &#123;</span><br><span class="line">    DontCrashIfDeallocating = <span class="literal">false</span>, DoCrashIfDeallocating = <span class="literal">true</span></span><br><span class="line">&#125;;</span><br><span class="line">template &lt;HaveOld haveOld, HaveNew haveNew,</span><br><span class="line">          CrashIfDeallocating crashIfDeallocating&gt;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">id</span> </span><br><span class="line">storeWeak(<span class="keyword">id</span> *location, objc_object *newObj)</span><br><span class="line">&#123;</span><br><span class="line">    ASSERT(haveOld  ||  haveNew);</span><br><span class="line">    <span class="keyword">if</span> (!haveNew) ASSERT(newObj == <span class="literal">nil</span>);</span><br><span class="line"></span><br><span class="line">    Class previouslyInitializedClass = <span class="literal">nil</span>;</span><br><span class="line">    <span class="keyword">id</span> oldObj;</span><br><span class="line">    SideTable *oldTable;<span class="comment">// æ—§è¡¨ï¼Œç”¨æ¥å­˜æ”¾å·²æœ‰çš„weakå˜é‡</span></span><br><span class="line">    SideTable *newTable;<span class="comment">// æ–°è¡¨ï¼Œç”¨æ¥å­˜æ”¾æ–°çš„weakå˜é‡</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Acquire locks for old and new values.</span></span><br><span class="line">    <span class="comment">// Order by lock address to prevent lock ordering problems. </span></span><br><span class="line">    <span class="comment">// Retry if the old value changes underneath us.</span></span><br><span class="line"> retry:</span><br><span class="line">    <span class="comment">// å­˜åœ¨æ—§å€¼ï¼Œè·å–æ—§å€¼å¯¹è±¡ å’Œæ—§å€¼æ‰€åœ¨çš„å¼±å¼•ç”¨è¡¨</span></span><br><span class="line">    <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">        oldObj = *location;</span><br><span class="line">        oldTable = &amp;SideTables()[oldObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        oldTable = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å­˜åœ¨æ–°å€¼ï¼Œåˆ›å»ºæ–°è¡¨</span></span><br><span class="line">    <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">        newTable = &amp;SideTables()[newObj];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        newTable = <span class="literal">nil</span>;</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// å¯¹æ—§å€¼ æ–°å€¼ åˆ†åˆ«åŠ é”</span></span><br><span class="line">    SideTable::lockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">		<span class="comment">// åˆ¤æ–­æ—§å€¼ å’Œ locationæŒ‡å‘çš„å€¼æ˜¯å¦ç›¸ç­‰ï¼Œå³æ˜¯å¦åŒä¸€å¯¹è±¡ï¼Œå¦‚æœä¸æ˜¯å°±é‡æ–°è·å–æ—§å€¼ç›¸å…³è”çš„å¯¹è±¡å’Œè¡¨</span></span><br><span class="line">    <span class="keyword">if</span> (haveOld  &amp;&amp;  *location != oldObj) &#123;</span><br><span class="line">        SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">        <span class="keyword">goto</span> retry;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Prevent a deadlock between the weak reference machinery</span></span><br><span class="line">    <span class="comment">// and the +initialize machinery by ensuring that no </span></span><br><span class="line">    <span class="comment">// weakly-referenced object has an un-+initialized isa.</span></span><br><span class="line">    <span class="comment">// å­˜åœ¨æ–°å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (haveNew  &amp;&amp;  newObj) &#123;</span><br><span class="line">        Class cls = newObj-&gt;getIsa();</span><br><span class="line">      	<span class="comment">// åˆ¤æ–­æ–°å€¼æ‰€å±çš„ç±»æ˜¯å¦å·²ç»åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (cls != previouslyInitializedClass  &amp;&amp;  </span><br><span class="line">            !((objc_class *)cls)-&gt;isInitialized()) </span><br><span class="line">        &#123;</span><br><span class="line">            SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">          	<span class="comment">// æœªåˆå§‹åŒ–ï¼Œå…ˆè¿›è¡Œåˆå§‹åŒ–ï¼Œé˜²æ­¢ +initialize å†…éƒ¨è°ƒç”¨ storeWeak äº§ç”Ÿæ­»é”</span></span><br><span class="line">            class_initialize(cls, (<span class="keyword">id</span>)newObj);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// If this class is finished with +initialize then we're good.</span></span><br><span class="line">            <span class="comment">// If this class is still running +initialize on this thread </span></span><br><span class="line">            <span class="comment">// (i.e. +initialize called storeWeak on an instance of itself)</span></span><br><span class="line">            <span class="comment">// then we may proceed but it will appear initializing and </span></span><br><span class="line">            <span class="comment">// not yet initialized to the check above.</span></span><br><span class="line">            <span class="comment">// Instead set previouslyInitializedClass to recognize it on retry.</span></span><br><span class="line">            <span class="comment">// æ ‡è®°ç±»å·²ç»è¿›è¡Œåˆå§‹åŒ–æ£€æŸ¥</span></span><br><span class="line">            previouslyInitializedClass = cls;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">goto</span> retry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clean up old value, if any.</span></span><br><span class="line">    <span class="comment">// å¦‚æœå­˜åœ¨æ—§å€¼ï¼Œè°ƒç”¨weak_unregister_no_lockè¿›è¡Œæ¸…ç†</span></span><br><span class="line">    <span class="keyword">if</span> (haveOld) &#123;</span><br><span class="line">        weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Assign new value, if any.</span></span><br><span class="line">    <span class="comment">// å­˜åœ¨æ–°å€¼ï¼Œè°ƒç”¨weak_register_no_lockæ–¹æ³•ï¼Œå°†æ‰€æœ‰weakæŒ‡é’ˆé‡æ–°æŒ‡å‘æ–°çš„å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">        newObj = (objc_object *)</span><br><span class="line">            weak_register_no_lock(&amp;newTable-&gt;weak_table, (<span class="keyword">id</span>)newObj, location, </span><br><span class="line">                                  crashIfDeallocating);</span><br><span class="line">        <span class="comment">// weak_register_no_lock returns nil if weak store should be rejected</span></span><br><span class="line">				<span class="comment">// å¦‚æœå­˜å‚¨æˆåŠŸ</span></span><br><span class="line">      	<span class="comment">// å¦‚æœå¯¹è±¡æ˜¯ taggedPointerï¼Œä¸åšæ“ä½œ</span></span><br><span class="line">      	<span class="comment">// å¦‚æœisa ä¸æ˜¯ nonpointer,è®¾ç½®Sidetableä¸­å¼±å¼•ç”¨æ ‡å¿—ä½</span></span><br><span class="line">      	<span class="comment">// å¦‚æœisa æ˜¯ nonpointerï¼Œè®¾ç½®isa çš„ weakly_referencedå¼±å¼•ç”¨æ ‡å¿—ä½</span></span><br><span class="line">        <span class="comment">// Set is-weakly-referenced bit in refcount table.</span></span><br><span class="line">        <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</span><br><span class="line">            newObj-&gt;setWeaklyReferenced_nolock();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do not set *location anywhere else. That would introduce a race.</span></span><br><span class="line">      	<span class="comment">// å°†locationæŒ‡å‘æ–°çš„å¯¹è±¡</span></span><br><span class="line">        *location = (<span class="keyword">id</span>)newObj;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// No new value. The storage is not changed.</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">id</span>)newObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>æ€»ç»“ï¼š<code>storeWeak</code>å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ï¼š</strong></p>
<ul>
<li>åˆ†åˆ«è·å–æ–°æ—§å€¼ç›¸å…³è”çš„å¼±å¼•ç”¨è¡¨ï¼›</li>
<li>å¦‚æœæœ‰æ—§å€¼ï¼Œå°±è°ƒç”¨<code>weak_unregister_no_lock</code>è¿›è¡Œæ¸…ç†</li>
<li>å¦‚æœæœ‰æ–°å€¼ï¼Œå°±è°ƒç”¨<code>weak_register_no_lock</code>å‡½æ•°åˆ†é…æ–°å€¼ï¼Œå°†æ‰€æœ‰<code>weak</code>æŒ‡é’ˆé‡æ–°æŒ‡å‘æ–°çš„å¯¹è±¡ï¼›</li>
<li>åˆ¤æ–­<code>isa</code>æ˜¯å¦ä¸º<code>nonpointer</code> æ¥è®¾ç½®å¼±å¼•ç”¨æ ‡å¿—ä½ï¼Œå¦‚æœä¸æ˜¯<code>nonponinter</code>ï¼Œè®¾ç½®<code>SideTable</code>ä¸­çš„å¼±å¼•ç”¨æ ‡å¿—ä½ï¼Œå¦åˆ™è®¾ç½®<code>isa</code>çš„<code>weakly_referenced</code>å¼±å¼•ç”¨æ ‡å¿—ä½ã€‚</li>
</ul>
</blockquote>
<h4 id="weak-unregister-no-lock"><a href="#weak-unregister-no-lock" class="headerlink" title="weak_unregister_no_lock"></a>weak_unregister_no_lock</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Registers a new (object, weak pointer) pair. Creates a new weak</span></span><br><span class="line"><span class="comment"> * object entry if it does not exist.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param weak_table The global weak table.</span></span><br><span class="line"><span class="comment"> * @param referent The object pointed to by the weak reference.</span></span><br><span class="line"><span class="comment"> * @param referrer The weak pointer address.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">id</span> </span><br><span class="line">weak_register_no_lock(weak_table_t *weak_table, <span class="keyword">id</span> referent_id, </span><br><span class="line">                      <span class="keyword">id</span> *referrer_id, <span class="keyword">bool</span> crashIfDeallocating)</span><br><span class="line">&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;<span class="comment">// å¯¹è±¡</span></span><br><span class="line">    objc_object **referrer = (objc_object **)referrer_id;<span class="comment">// å¼±å¼•ç”¨æŒ‡é’ˆ</span></span><br><span class="line">  </span><br><span class="line">		<span class="comment">// åˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºnil &amp;&amp; æ˜¯å¦æ˜¯taggedPointeræŒ‡é’ˆï¼Œå¦‚æœæ˜¯ ç›´æ¥è¿”å›å½“å‰å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">if</span> (!referent  ||  referent-&gt;isTaggedPointer()) <span class="keyword">return</span> referent_id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ensure that the referenced object is viable</span></span><br><span class="line">  	<span class="comment">// ç¡®ä¿å¯¹è±¡æ˜¯å¯ç”¨çš„</span></span><br><span class="line">    <span class="keyword">bool</span> deallocating;</span><br><span class="line">  	<span class="comment">// åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯å¦æ­£åœ¨deallocating</span></span><br><span class="line">    <span class="keyword">if</span> (!referent-&gt;ISA()-&gt;hasCustomRR()) &#123;</span><br><span class="line">        deallocating = referent-&gt;rootIsDeallocating();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      	<span class="comment">// å½“å‰å¯¹è±¡æ˜¯å¦æ”¯æŒå¼±å¼•ç”¨</span></span><br><span class="line">        <span class="built_in">BOOL</span> (*allowsWeakReference)(objc_object *, SEL) = </span><br><span class="line">            (<span class="built_in">BOOL</span>(*)(objc_object *, SEL))</span><br><span class="line">            object_getMethodImplementation((<span class="keyword">id</span>)referent, </span><br><span class="line">                                           <span class="keyword">@selector</span>(allowsWeakReference));</span><br><span class="line">        <span class="keyword">if</span> ((IMP)allowsWeakReference == _objc_msgForward) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      	<span class="comment">// allowsWeakReference å‡½æ•°è·å–çš„å…¶å®å°±æ˜¯å½“å‰å¯¹è±¡! [self _isDeallocating]; </span></span><br><span class="line">        deallocating =</span><br><span class="line">            ! (*allowsWeakReference)(referent, <span class="keyword">@selector</span>(allowsWeakReference));</span><br><span class="line">    &#125;</span><br><span class="line">		<span class="comment">// æ­£åœ¨æ‰§è¡Œdeallocating ä¸å¯ä½¿ç”¨weakæŒ‡é’ˆ</span></span><br><span class="line">    <span class="keyword">if</span> (deallocating) &#123;</span><br><span class="line">        <span class="keyword">if</span> (crashIfDeallocating) &#123;</span><br><span class="line">            _objc_fatal(<span class="string">"Cannot form weak reference to instance (%p) of "</span></span><br><span class="line">                        <span class="string">"class %s. It is possible that this object was "</span></span><br><span class="line">                        <span class="string">"over-released, or is in the process of deallocation."</span>,</span><br><span class="line">                        (<span class="keyword">void</span>*)referent, object_getClassName((<span class="keyword">id</span>)referent));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// now remember it and where it is being stored</span></span><br><span class="line">  	<span class="comment">// è·å–å¼±å¼•ç”¨entry</span></span><br><span class="line">    weak_entry_t *entry;</span><br><span class="line">  	<span class="comment">// å¦‚æœå½“å‰entryå­˜åœ¨ï¼ŒæŒ‡å‘å°†weakæŒ‡é’ˆè¿½åŠ è¿›å»</span></span><br><span class="line">    <span class="keyword">if</span> ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</span><br><span class="line">        append_referrer(entry, referrer);</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      	<span class="comment">// å¦‚æœå½“å‰entryä¸å­˜åœ¨ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªæ–°çš„entryï¼Œå°†æ–°çš„entryå­˜å‚¨åˆ°weak_tableä¸­</span></span><br><span class="line">        weak_entry_t new_entry(referent, referrer);</span><br><span class="line">        weak_grow_maybe(weak_table);</span><br><span class="line">        weak_entry_insert(weak_table, &amp;new_entry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not set *referrer. objc_storeWeak() requires that the </span></span><br><span class="line">    <span class="comment">// value not change.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> referent_id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>æ€»ç»“ï¼šweak_register_no_lockç”¨äºä¿å­˜å¼±å¼•ç”¨ä¿¡æ¯ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</strong></p>
<ul>
<li>åˆ¤æ–­å¯¹è±¡æ˜¯å¦æ­£åœ¨é‡Šæ”¾ï¼Œæ˜¯å¦æ”¯æŒå¼±å¼•ç”¨ï¼Œå¦‚æœå®ä¾‹å¯¹è±¡<code>allowsWeakReference</code>è¿”å›NOï¼Œè¡¨æ˜å¯¹è±¡æ­£åœ¨æ‰§è¡Œ<code>deallocating</code> ä¸å¯ä½¿ç”¨weakæŒ‡é’ˆ</li>
<li>æŸ¥è¯¢<code>weak_table</code>è¡¨ï¼Œåˆ¤æ–­å¼•ç”¨è¡¨ä¸­æ˜¯å¦å·²ç»ä¿å­˜ä¸å¯¹è±¡ç›¸å…³è”çš„å¼±å¼•ç”¨ä¿¡æ¯ï¼›</li>
<li>å¦‚æœå·²ç»æœ‰ç›¸å…³å¼±å¼•ç”¨ä¿¡æ¯ï¼Œåˆ™è°ƒç”¨<code>append_referrer</code>å‡½æ•°å°†å¼±å¼•ç”¨ä¿¡æ¯æ·»åŠ è¿›ç°æœ‰çš„entryå®¹å™¨ä¸­ï¼›å¦‚æœæ²¡æœ‰ç›¸å…³è”ä¿¡æ¯ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª<code>entry</code>ï¼Œåˆ¤æ–­<code>weak_table</code>æ˜¯å¦éœ€è¦æ‰©å®¹ï¼ˆå¤§å°è¶…è¿‡<code>3/4ï¼Œè¿›è¡Œ2å€æ‰©</code>å®¹ï¼‰ï¼Œå°†<code>entry</code>æ’å…¥åˆ°å¼±å¼•ç”¨è¡¨ä¸­ã€‚</li>
</ul>
</blockquote>
<h4 id="weak-unregister-no-lock-1"><a href="#weak-unregister-no-lock-1" class="headerlink" title="weak_unregister_no_lock"></a>weak_unregister_no_lock</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Unregister an already-registered weak reference.</span></span><br><span class="line"><span class="comment"> * This is used when referrer's storage is about to go away, but referent</span></span><br><span class="line"><span class="comment"> * isn't dead yet. (Otherwise, zeroing referrer later would be a</span></span><br><span class="line"><span class="comment"> * bad memory access.)</span></span><br><span class="line"><span class="comment"> * Does nothing if referent/referrer is not a currently active weak reference.</span></span><br><span class="line"><span class="comment"> * Does not zero referrer.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * FIXME currently requires old referent value to be passed in (lame)</span></span><br><span class="line"><span class="comment"> * FIXME unregistration should be automatic if referrer is collected</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param weak_table The global weak table.</span></span><br><span class="line"><span class="comment"> * @param referent The object.</span></span><br><span class="line"><span class="comment"> * @param referrer The weak reference.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">weak_unregister_no_lock(weak_table_t *weak_table, <span class="keyword">id</span> referent_id, </span><br><span class="line">                        <span class="keyword">id</span> *referrer_id)</span><br><span class="line">&#123;</span><br><span class="line">    objc_object *referent = (objc_object *)referent_id;</span><br><span class="line">    objc_object **referrer = (objc_object **)referrer_id;</span><br><span class="line"></span><br><span class="line">    weak_entry_t *entry;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!referent) <span class="keyword">return</span>;</span><br><span class="line">		<span class="comment">// æ˜¯å¦å­˜åœ¨ä¸å½“å‰å¯¹è±¡ç›¸å…³è”çš„å¼±å¼•ç”¨è¡¨</span></span><br><span class="line">    <span class="keyword">if</span> ((entry = weak_entry_for_referent(weak_table, referent))) &#123;</span><br><span class="line">      	<span class="comment">// ä»entryä¸­ç§»é™¤å¼±å¼•ç”¨æŒ‡é’ˆreferrer</span></span><br><span class="line">        remove_referrer(entry, referrer);</span><br><span class="line">        <span class="keyword">bool</span> empty = <span class="literal">true</span>;</span><br><span class="line">      	<span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…å‡ºå®šé•¿ï¼ˆ4ï¼‰ï¼Œout_of_line_nessä¸º2æ ‡è®°è¿˜æ˜¯é€šè¿‡inline_referrerså­˜å‚¨</span></span><br><span class="line">        <span class="keyword">if</span> (entry-&gt;out_of_line()  &amp;&amp;  entry-&gt;num_refs != <span class="number">0</span>) &#123;</span><br><span class="line">            empty = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          	<span class="comment">// åˆ¤æ–­inline_referrersä¸­æ˜¯å¦å­˜åœ¨weakä¿¡æ¯</span></span><br><span class="line">            <span class="keyword">for</span> (size_t i = <span class="number">0</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (entry-&gt;inline_referrers[i]) &#123;</span><br><span class="line">                    empty = <span class="literal">false</span>; </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">// å¦‚æœä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">            weak_entry_remove(weak_table, entry);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not set *referrer = nil. objc_storeWeak() requires that the </span></span><br><span class="line">    <span class="comment">// value not change.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ€»ç»“ï¼š<code>weak_unregister_no_lock</code>å‡½æ•°ç”¨æ¥ç§»é™¤å¼±å¼•ç”¨ä¿¡æ¯ï¼Œå…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<ul>
<li>æŸ¥è¯¢<code>weak_table</code>è¡¨ï¼Œè·å–ä¸å½“å‰å¯¹è±¡ç›¸å…³è”çš„å¼±å¼•ç”¨ä¿¡æ¯ï¼›</li>
<li>å¦‚æœæœ‰ï¼Œè°ƒç”¨<code>remove_referrer</code>ç§»é™¤ç›¸å…³å¼±å¼•ç”¨ä¿¡æ¯ï¼›æ¥ç€åˆ¤æ–­æ•°ç»„æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœä¸ºç©ºï¼Œè°ƒç”¨<code>weak_entry_remove</code>ç§»é™¤<code>entry</code></li>
</ul>
</blockquote>
<h4 id="objc-destroyWeak"><a href="#objc-destroyWeak" class="headerlink" title="objc_destroyWeak"></a>objc_destroyWeak</h4><figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * Destroys the relationship between a weak pointer</span></span><br><span class="line"><span class="comment"> * and the object it is referencing in the internal weak</span></span><br><span class="line"><span class="comment"> * table. If the weak pointer is not referencing anything, </span></span><br><span class="line"><span class="comment"> * there is no need to edit the weak table. </span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This function IS NOT thread-safe with respect to concurrent </span></span><br><span class="line"><span class="comment"> * modifications to the weak variable. (Concurrent weak clear is safe.)</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * @param location The weak pointer address. </span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span></span><br><span class="line">objc_destroyWeak(<span class="keyword">id</span> *location)</span><br><span class="line">&#123;</span><br><span class="line">    (<span class="keyword">void</span>)storeWeak&lt;DoHaveOld, DontHaveNew, DontCrashIfDeallocating&gt;</span><br><span class="line">        (location, <span class="literal">nil</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>objc_initWeak</code> å’Œ objc_destroyWeak å‡½æ•°ä¸­éƒ½è°ƒç”¨äº†storeWeakï¼Œä½†æ˜¯ä¼ å…¥çš„å‚æ•°ä¸åŒ</p>
<ul>
<li><code>objc_initWeak</code>å°†å¯¹è±¡åœ°å€ä¼ å…¥ï¼Œä¸”DontHaveOldï¼ŒDoHaveNewï¼ŒDoCrashIfDeallocating</li>
<li>objc_destroyWeakå°†nilä¼ å…¥ï¼Œä¸”DontHaveOldï¼ŒDoHaveNewï¼ŒDoCrashIfDeallocating</li>
</ul>
<p>storeWeakå‡½æ•°å°†å‚æ•°äºŒçš„èµ‹å€¼çš„å¯¹è±¡åœ°å€ä½œä¸ºkeyï¼Œå°†å‚æ•°ä¸€çš„é™„æœ‰__weakä¿®é¥°ç¬¦çš„å˜é‡çš„åœ°å€æ³¨å†Œåˆ°weakè¡¨ä¸­ã€‚å¦‚æœå‚æ•°äºŒä¸ºnilï¼Œåˆ™å°†å˜é‡çš„åœ°å€ä»weakè¡¨ä¸­åˆ é™¤ã€‚</p>
<blockquote>
<p><strong>å°ç»“ï¼šæ·»åŠ `weak</strong>`</p>
<p>ä¸€ä¸ªè¢«æ ‡è®°ä¸º<code>weak</code>çš„æŒ‡é’ˆï¼Œåœ¨ç»è¿‡ç¼–è¯‘ä¹‹åä¼šè°ƒç”¨<code>objc_copyWeak</code>å‡½æ•°ï¼Œåœ¨<code>objc_copyWeak</code>å‡½æ•°ä¸­è°ƒç”¨<code>objc_initWeak</code>å‡½æ•°ï¼Œ<code>objc_initWeak</code>å‡½æ•°ä¸­åˆå§‹åŒ–weakå˜é‡åè°ƒç”¨<code>storeWeak</code>å‡½æ•°ã€‚æ·»åŠ weakçš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<ul>
<li>ç»è¿‡ä¸€ç³»åˆ—çš„è°ƒç”¨æ ˆï¼Œæœ€ç»ˆåœ¨<code>weak_register_no_lock</code>å‡½æ•°ä¸­ï¼Œè¿›è¡Œå¼±å¼•ç”¨å˜é‡çš„æ·»åŠ ï¼Œå…·ä½“æ·»åŠ çš„ä½ç½®æ˜¯é€šè¿‡å“ˆå¸Œç®—æ³•æ¥æŸ¥æ‰¾çš„ï¼Œå¦‚æœå¯¹åº”ä½ç½®å·²ç»å­˜åœ¨å½“å‰å¯¹è±¡çš„å¼±å¼•ç”¨è¡¨ï¼ˆæ•°ç»„ï¼‰ï¼Œç›´æ¥å°†å¼±å¼•ç”¨å˜é‡æ·»åŠ è¿›å…¥ï¼Œå¦‚æœä¸å­˜åœ¨å¼±å¼•ç”¨è¡¨ï¼Œå…ˆåˆ›å»ºå¼±å¼•ç”¨è¡¨ï¼Œå†åˆ¤æ–­æ˜¯å¦éœ€è¦å¯¹<code>weak_table</code>è¿›è¡Œæ‰©å®¹ï¼Œç„¶åå†å°†å¼±å¼•ç”¨å˜é‡æ·»åŠ è¿›å»ã€‚</li>
</ul>
</blockquote>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><table>
<thead>
<tr>
<th align="left">å†…å­˜ç®¡ç†æ–¹æ³•</th>
<th align="left">å…·ä½“å®ç°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">alloc</td>
<td align="left">ç»è¿‡ä¸€ç³»åˆ—çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œæœ€ç»ˆé€šè¿‡è°ƒç”¨ C å‡½æ•°<code>calloc</code>æ¥ç”³è¯·å†…å­˜ç©ºé—´ï¼Œå¹¶åˆå§‹åŒ–å¯¹è±¡çš„<code>isa</code>ï¼Œä½†å¹¶æ²¡æœ‰è®¾ç½®å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å€¼ä¸º 1ã€‚</td>
</tr>
<tr>
<td align="left">init</td>
<td align="left">åŸºç±»çš„<code>init</code>æ–¹æ³•å•¥éƒ½æ²¡å¹²ï¼Œåªæ˜¯å°†<code>alloc</code>åˆ›å»ºçš„å¯¹è±¡è¿”å›ã€‚æˆ‘ä»¬å¯ä»¥é‡å†™<code>init</code>æ–¹æ³•æ¥å¯¹<code>alloc</code>åˆ›å»ºçš„å®ä¾‹åšä¸€äº›åˆå§‹åŒ–æ“ä½œã€‚</td>
</tr>
<tr>
<td align="left">new</td>
<td align="left"><code>new</code>æ–¹æ³•å¾ˆç®€å•ï¼Œåªæ˜¯åµŒå¥—äº†<code>alloc</code>å’Œ<code>init</code>ã€‚</td>
</tr>
<tr>
<td align="left">copyã€mutableCopy</td>
<td align="left">è°ƒç”¨äº†<code>copyWithZone</code>å’Œ<code>mutableCopyWithZone</code>æ–¹æ³•ã€‚</td>
</tr>
<tr>
<td align="left">retainCount</td>
<td align="left">â‘  å¦‚æœ<code>isa</code>ä¸æ˜¯<code>nonpointer</code>ï¼Œå¼•ç”¨è®¡æ•°å€¼ = <code>SideTable</code>ä¸­çš„å¼•ç”¨è®¡æ•°è¡¨ä¸­å­˜å‚¨çš„å€¼ + 1ï¼› â‘¡ å¦‚æœ<code>isa</code>æ˜¯<code>nonpointer</code>ï¼Œå¼•ç”¨è®¡æ•°å€¼ = <code>isa</code>ä¸­çš„<code>extra_rc</code>å­˜å‚¨çš„å€¼ + 1 +<code>SideTable</code>ä¸­çš„å¼•ç”¨è®¡æ•°è¡¨ä¸­å­˜å‚¨çš„å€¼ã€‚</td>
</tr>
<tr>
<td align="left">retain</td>
<td align="left">â‘  å¦‚æœ<code>isa</code>ä¸æ˜¯<code>nonpointer</code>ï¼Œå°±å¯¹<code>Sidetable</code>ä¸­çš„å¼•ç”¨è®¡æ•°è¿›è¡Œ +1ï¼› â‘¡ å¦‚æœ<code>isa</code>æ˜¯<code>nonpointer</code>ï¼Œå°±å°†<code>isa</code>ä¸­çš„<code>extra_rc</code>å­˜å‚¨çš„å¼•ç”¨è®¡æ•°è¿›è¡Œ +1ï¼Œå¦‚æœæº¢å‡ºï¼Œå°±å°†<code>extra_rc</code>ä¸­<code>RC_HALF</code>ï¼ˆ<code>extra_rc</code>æ»¡å€¼çš„ä¸€åŠï¼‰ä¸ªå¼•ç”¨è®¡æ•°è½¬ç§»åˆ°<code>sidetable</code>ä¸­å­˜å‚¨ã€‚</td>
</tr>
<tr>
<td align="left">release</td>
<td align="left">â‘  å¦‚æœ<code>isa</code>ä¸æ˜¯<code>nonpointer</code>ï¼Œå°±å¯¹<code>Sidetable</code>ä¸­çš„å¼•ç”¨è®¡æ•°è¿›è¡Œ -1ï¼Œå¦‚æœå¼•ç”¨è®¡æ•° =0ï¼Œå°±<code>dealloc</code>å¯¹è±¡ï¼› â‘¡ å¦‚æœ<code>isa</code>æ˜¯<code>nonpointer</code>ï¼Œå°±å°†<code>isa</code>ä¸­çš„<code>extra_rc</code>å­˜å‚¨çš„å¼•ç”¨è®¡æ•°è¿›è¡Œ -1ã€‚å¦‚æœä¸‹æº¢ï¼Œå³<code>extra_rc</code>ä¸­çš„å¼•ç”¨è®¡æ•°å·²ç»ä¸º 0ï¼Œåˆ¤æ–­<code>has_sidetable_rc</code>æ˜¯å¦ä¸º<code>true</code>å³æ˜¯å¦æœ‰ä½¿ç”¨<code>Sidetable</code>å­˜å‚¨ã€‚å¦‚æœæœ‰çš„è¯å°±ç”³è¯·ä»<code>Sidetable</code>ä¸­ç”³è¯·<code>RC_HALF</code>ä¸ªå¼•ç”¨è®¡æ•°è½¬ç§»åˆ°<code>extra_rc</code>ä¸­å­˜å‚¨ï¼Œå¦‚æœä¸è¶³<code>RC_HALF</code>å°±æœ‰å¤šå°‘ç”³è¯·å¤šå°‘ï¼Œç„¶åå°†<code>Sidetable</code>ä¸­çš„å¼•ç”¨è®¡æ•°å€¼å‡å»<code>RC_HALF</code>ï¼ˆæˆ–æ˜¯å°äº<code>RC_HALF</code>çš„å®é™…å€¼ï¼‰ï¼Œå°†å®é™…ç”³è¯·åˆ°çš„å¼•ç”¨è®¡æ•°å€¼ -1 åå­˜å‚¨åˆ°<code>extra_rc</code>ä¸­ã€‚å¦‚æœ<code>extra_rc</code>ä¸­å¼•ç”¨è®¡æ•°ä¸º 0 ä¸”<code>has_sidetable_rc</code>ä¸º<code>false</code>æˆ–è€…<code>Sidetable</code>ä¸­çš„å¼•ç”¨è®¡æ•°ä¹Ÿä¸º 0 äº†ï¼Œé‚£å°±<code>dealloc</code>å¯¹è±¡ã€‚</td>
</tr>
<tr>
<td align="left">dealloc</td>
<td align="left">â‘  åˆ¤æ–­é”€æ¯å¯¹è±¡å‰æœ‰æ²¡æœ‰éœ€è¦å¤„ç†çš„ä¸œè¥¿ï¼ˆå¦‚å¼±å¼•ç”¨ã€å…³è”å¯¹è±¡ã€<code>C++</code>çš„ææ„å‡½æ•°ã€<code>SideTabel</code>çš„å¼•ç”¨è®¡æ•°è¡¨ç­‰ç­‰ï¼‰ï¼› â‘¡ å¦‚æœæ²¡æœ‰å°±ç›´æ¥è°ƒç”¨<code>free</code>å‡½æ•°é”€æ¯å¯¹è±¡ï¼› â‘¢ å¦‚æœæœ‰å°±å…ˆè°ƒç”¨<code>object_dispose</code>åšä¸€äº›é‡Šæ”¾å¯¹è±¡å‰çš„å¤„ç†ï¼ˆç½®å¼±å¼•ç”¨æŒ‡é’ˆç½®ä¸º<code>nil</code>ã€ç§»é™¤å…³è”å¯¹è±¡ã€<code>object_cxxDestruct</code>ã€åœ¨<code>SideTabel</code>çš„å¼•ç”¨è®¡æ•°è¡¨ä¸­æ“¦å‡ºå¼•ç”¨è®¡æ•°ç­‰ç­‰ï¼‰ï¼Œå†ç”¨<code>free</code>å‡½æ•°é”€æ¯å¯¹è±¡ã€‚</td>
</tr>
<tr>
<td align="left">æ¸…é™¤<code>weak</code>ï¼Œ<code>weak</code>æŒ‡é’ˆç½®ä¸º<code>nil</code>çš„è¿‡ç¨‹</td>
<td align="left">å½“ä¸€ä¸ªå¯¹è±¡è¢«é”€æ¯æ—¶ï¼Œåœ¨<code>dealloc</code>æ–¹æ³•å†…éƒ¨ç»è¿‡ä¸€ç³»åˆ—çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œé€šè¿‡ä¸¤æ¬¡å“ˆå¸ŒæŸ¥æ‰¾ï¼Œç¬¬ä¸€æ¬¡æ ¹æ®å¯¹è±¡çš„åœ°å€æ‰¾åˆ°å®ƒæ‰€åœ¨çš„<code>Sidetable</code>ï¼Œç¬¬äºŒæ¬¡æ ¹æ®å¯¹è±¡çš„åœ°å€åœ¨<code>Sidetable</code>çš„<code>weak_table</code>ä¸­æ‰¾åˆ°å®ƒçš„å¼±å¼•ç”¨è¡¨ã€‚éå†å¼±å¼•ç”¨æ•°ç»„ï¼Œå°†æŒ‡å‘å¯¹è±¡çš„åœ°å€çš„<code>weak</code>å˜é‡å…¨éƒ½ç½®ä¸º<code>nil</code>ã€‚</td>
</tr>
<tr>
<td align="left">æ·»åŠ <code>weak</code></td>
<td align="left">ç»è¿‡ä¸€ç³»åˆ—çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œæœ€ç»ˆåœ¨<code>weak_register_no_lock()</code>å‡½æ•°å½“ä¸­ï¼Œè¿›è¡Œå¼±å¼•ç”¨å˜é‡çš„æ·»åŠ ï¼Œå…·ä½“æ·»åŠ çš„ä½ç½®æ˜¯é€šè¿‡å“ˆå¸Œç®—æ³•æ¥æŸ¥æ‰¾çš„ã€‚å¦‚æœå¯¹åº”ä½ç½®å·²ç»å­˜åœ¨å½“å‰å¯¹è±¡çš„å¼±å¼•ç”¨è¡¨ï¼ˆæ•°ç»„ï¼‰ï¼Œé‚£å°±æŠŠå¼±å¼•ç”¨å˜é‡æ·»åŠ è¿›å»ï¼›å¦‚æœä¸å­˜åœ¨çš„è¯ï¼Œå°±åˆ›å»ºä¸€ä¸ªå¼±å¼•ç”¨è¡¨ï¼Œç„¶åå°†å¼±å¼•ç”¨å˜é‡æ·»åŠ è¿›å»ã€‚</td>
</tr>
</tbody></table>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/10/28/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-ISA/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/28/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-ISA/" class="post-title-link" itemprop="url">å†…å­˜ç®¡ç†-ISA & Weakåº•å±‚</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-28 17:33:31" itemprop="dateCreated datePublished" datetime="2020-10-28T17:33:31+08:00">2020-10-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-29 23:01:09" itemprop="dateModified" datetime="2020-10-29T23:01:09+08:00">2020-10-29</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="ISA"><a href="#ISA" class="headerlink" title="ISA"></a>ISA</h3><h4 id="ISAç»“æ„ä½“å®šä¹‰"><a href="#ISAç»“æ„ä½“å®šä¹‰" class="headerlink" title="ISAç»“æ„ä½“å®šä¹‰"></a>ISAç»“æ„ä½“å®šä¹‰</h4><p>ocå¯¹è±¡çš„æœ¬è´¨å…¶å®æ˜¯å°±æ˜¯ç»“æ„ä½“ï¼Œç±»ä¹Ÿæ˜¯å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰isaæŒ‡é’ˆï¼Œå¯¹è±¡çš„isaæŒ‡é’ˆæŒ‡å‘è¯¥å¯¹è±¡æ‰€å±çš„ç±»ï¼Œç±»å¯¹è±¡çš„<code>isa</code>æŒ‡é’ˆæŒ‡å‘çš„æ˜¯å½“å‰ç±»çš„å…ƒç±»å¯¹è±¡ã€‚</p>
<p>ARM64ä½æ¶æ„ä¹‹å‰ï¼Œ<code>isa</code>åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œ<code>arm64</code>ä¹‹åï¼Œ<code>isa</code>æ˜¯ä¸€ä¸ªè”åˆä½“/å…±ç”¨ä½“(union)ï¼Œè¿™æ˜¯è‹¹æœå¯¹äºisaçš„ä¼˜åŒ–ï¼Œç»“åˆä½åŸŸçš„æ¦‚å¿µä»¥åŠä½è¿ç®—çš„æ–¹å¼æ¥å­˜å‚¨æ›´å¤šç±»ç›¸å…³çš„ä¿¡æ¯ï¼Œç®€å•æ¥è¯´isaæŒ‡é’ˆé€šè¿‡ä¸€ä¸ªå«ISA_MASKçš„å€¼è¿›è¡ŒäºŒè¿›åˆ¶&amp;è¿ç®—ï¼Œå¾—åˆ°çœŸå®çš„<code>class/meta-class</code>å¯¹è±¡çš„åœ°å€ã€‚</p>
<p><code>arm64</code>æ¶æ„ä¹‹å‰ï¼ŒisaæŒ‡é’ˆç›´æ¥æŒ‡å‘å½“å‰ç±»<code>objc_class</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;&#x2F; An opaque type that represents an Objective-C class.</span><br><span class="line">typedef struct objc_class *Class;</span><br><span class="line">&#x2F;&#x2F;&#x2F; Represents an instance of a class.</span><br><span class="line">struct objc_object &#123;</span><br><span class="line">    Class _Nonnull isa  OBJC_ISA_AVAILABILITY;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>arm64</code>ä¹‹åï¼Œ<code>isa</code>ä¸å†æ˜¯ä¸€ä¸ªæ™®é€šçš„<code>isa</code>æŒ‡é’ˆï¼Œä¹Ÿæ˜¯<code>isa_t</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">struct objc_object &#123;</span><br><span class="line">private:</span><br><span class="line">    isa_t isa;</span><br><span class="line">    &#x2F;&#x2F; ISA() assumes this is NOT a tagged pointer object</span><br><span class="line">    Class ISA();</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; getIsa() allows this to be a tagged pointer object</span><br><span class="line">    Class getIsa();</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿›ä¸€æ­¥æ ¹æ®<code>isa_t</code></p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> isa_t &#123;</span><br><span class="line">    isa_t() &#123; &#125;</span><br><span class="line">    isa_t(uintptr_t value) : bits(value) &#123; &#125;</span><br><span class="line"></span><br><span class="line">    Class cls;</span><br><span class="line">    uintptr_t bits;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> defined(ISA_BITFIELD)</span></span><br><span class="line">    <span class="keyword">struct</span> &#123;</span><br><span class="line">        ISA_BITFIELD;  <span class="comment">// defined in isa.h</span></span><br><span class="line">      <span class="comment">// æˆªå–arm64æ¶æ„ä¸‹å®šä¹‰</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_MASK  0x000003f000000001ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_VALUE 0x000001a000000001ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_BITFIELD                                                      \</span></span><br><span class="line">      uintptr_t nonpointer        : <span class="number">1</span>;                                       \</span><br><span class="line">      uintptr_t has_assoc         : <span class="number">1</span>;                                       \</span><br><span class="line">      uintptr_t has_cxx_dtor      : <span class="number">1</span>;                                       \</span><br><span class="line">      uintptr_t shiftcls          : <span class="number">33</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> \</span><br><span class="line">      uintptr_t magic             : <span class="number">6</span>;                                       \</span><br><span class="line">      uintptr_t weakly_referenced : <span class="number">1</span>;                                       \</span><br><span class="line">      uintptr_t deallocating      : <span class="number">1</span>;                                       \</span><br><span class="line">      uintptr_t has_sidetable_rc  : <span class="number">1</span>;                                       \</span><br><span class="line">      uintptr_t extra_rc          : <span class="number">19</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_ONE   (1ULL&lt;&lt;45)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_HALF  (1ULL&lt;&lt;18)</span></span><br><span class="line">    &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>é€šè¿‡æºç å‘ç°isa_tæ˜¯ä¸€ä¸ªunionè”åˆä½“ï¼Œunionçœ‹ä¸Šå»è·Ÿstructå·®ä¸å¤šï¼Œåªæ˜¯å‘½åä¸åŒï¼Œä½†æ˜¯unionçš„å®šä¹‰æ˜¯å®ƒä½¿å¾—å‡ ä¸ªä¸åŒç±»å‹çš„å˜é‡å…±å ä¸€æ®µå†…å­˜ï¼ˆäº’ç›¸è¦†ç›–ï¼‰ï¼Œæ¯æ¬¡åªæœ‰ä¸€ä¸ªèƒ½ä½¿ç”¨ï¼Œè€Œstructçš„æˆå‘˜åˆ™å…·å¤‡ç‹¬ç«‹çš„å†…å­˜ç©ºé—´ï¼Œåœ¨ä½¿ç”¨æ—¶äº’ä¸å½±å“ã€‚</p>
<p>ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾Aç±»é‡Œé¢å£°æ˜ä¸€ä¸ªunion</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">union</span> x &#123;</span><br><span class="line">  <span class="keyword">char</span> *name;</span><br><span class="line">  <span class="keyword">int</span> age;</span><br><span class="line">  <span class="keyword">bool</span> isRich;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šå®šä¹‰åï¼Œç³»ç»Ÿä¼šä¸ºunion xåˆ†é…8ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œå› ä¸ºæŒ‡é’ˆå 8ä½ï¼Œintå 4ä½ï¼Œboolå 1ä½ï¼Œè¯¥unionçš„å†…å­˜å¤§å°ç”±å…¶å†…éƒ¨å æœ€å¤§è‡ªå·±çš„æˆå‘˜ç±»å‹å†³å®šï¼Œå› ä¸ºåç»­æ“ä½œæ˜¯éœ€è¦äº’ç›¸è¦†ç›–çš„ã€‚</p>
<p>åœ¨çœ‹Structçš„å®šä¹‰ï¼Œå‡è®¾Bç±»ä¸­å£°æ˜äº†ä¸€ä¸ªStruct</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">x</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> *name;</span><br><span class="line">  <span class="keyword">int</span> age;</span><br><span class="line">  <span class="keyword">bool</span> isRich;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚ä¸Šå®šä¹‰åï¼Œç³»ç»Ÿä¼šä¸ºè¿™ä¸ªstruct xåˆ†é…16ä¸ªå­—èŠ‚çš„å†…å­˜ç©ºé—´ï¼Œå„æˆå‘˜æ‰€å å†…å­˜è·Ÿä¸Šè¿°å¤§å°ä¸€è‡´ï¼Œå„è‡ªæœ‰ç‹¬ç«‹å¯¹åº”çš„å†…å­˜ç©ºé—´ï¼Œä¸è¿‡è¿™é‡Œç”±äºéœ€è¦å†…å­˜å¯¹é½ï¼Œå¯¼è‡´ç»“æ„ä½“çš„å†…å­˜å¤§å°ä¸å†æ˜¯8bit</p>
<p>æ¥ç€å›åˆ°ä¸Šè¿°ç»“æ„ä½“çš„å†…å®¹</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MASK        0x0000000ffffffff8ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_MASK  0x000003f000000001ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_MAGIC_VALUE 0x000001a000000001ULL</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> ISA_BITFIELD                                                      \</span></span><br><span class="line">      <span class="keyword">uintptr_t</span> nonpointer        : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> has_assoc         : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> has_cxx_dtor      : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> shiftcls          : <span class="number">33</span>; <span class="comment">/*MACH_VM_MAX_ADDRESS 0x1000000000*/</span> \</span><br><span class="line">      <span class="keyword">uintptr_t</span> magic             : <span class="number">6</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> weakly_referenced : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> deallocating      : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> has_sidetable_rc  : <span class="number">1</span>;                                       \</span><br><span class="line">      <span class="keyword">uintptr_t</span> extra_rc          : <span class="number">19</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_ONE   (1ULL&lt;&lt;45)</span></span><br><span class="line"><span class="meta">#   <span class="meta-keyword">define</span> RC_HALF  (1ULL&lt;&lt;18)</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ªæˆå‘˜åé¢éƒ½ä¼šæœ‰ä¸€ä¸ª:x ,å…¶å®è¿™ä¸ª:xå°±æ˜¯ä½åŸŸçš„åº”ç”¨ï¼Œç®€å•æ¥è¯´ï¼Œæœ‰çš„ä¿¡æ¯ä»–æ‰€éœ€è¦çš„å†…å­˜ä¸è¶³ä»¥å¡«æ»¡ä¸€ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œæ¯”å¦‚å¼€å…³çŠ¶æ€è¿™æ ·çš„ä¿¡æ¯ï¼Œå…¶å®åªéœ€è¦ä¸€ä¸ªäºŒè¿›åˆ¶ç©ºé—´å³å¯å­˜å‚¨ï¼Œè¿™æ ·å°±è¾¾åˆ°äº†èŠ‚çº¦å†…å­˜çš„ç›®çš„ã€‚ï¼ˆ<strong>ä½åŸŸæ¦‚å¿µæ˜¯Cè¯­è¨€é‡Œé¢çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå°†ä¸€ä¸ªå­—èŠ‚ä¸­çš„äºŒè¿›ä½åˆ’åˆ†ä¸ºå¤šä¸ªä¸åŒçš„åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸå…·å¤‡å‡ ä¸ªä½æ•°ï¼Œæ¯ä¸ªåŸŸç»™å®šä¸€ä¸ªåŸŸåï¼Œå…è®¸ç¨‹åºä¸­æŒ‰åŸŸåè¿›è¡Œæ“ä½œï¼Œè¿™æ ·å¯ä»¥æŠŠå‡ ä¸ªä¸åŒçš„å¯¹è±¡ç”¨ä¸€ä¸ªå­—èŠ‚çš„äºŒè¿›åˆ¶ä½åŸŸæ¥è¡¨ç¤º</strong>ï¼‰</p>
<ul>
<li>nonpointerâ€”â€”0:ä»£è¡¨æ™®é€šæŒ‡é’ˆï¼Œå­˜å‚¨class/meta-classå¯¹è±¡çš„å†…å­˜åœ°å€ï¼›1:ä»£è¡¨ä¼˜åŒ–è¿‡ï¼Œä½¿ç”¨ä½åŸŸå­˜å‚¨æ›´å¤šä¿¡æ¯</li>
<li>has_assocâ€”â€” æ˜¯å¦è®¾ç½®è¿‡å…³è”å¯¹è±¡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</li>
<li>has_cxx_dtorâ€”â€”æ˜¯å¦æœ‰c++çš„ææ„å‡½æ•°ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</li>
<li>shiftclsâ€”â€”è¿™ä¸ªéƒ¨åˆ†å­˜å‚¨çš„æ˜¯çœŸæ­£çš„class/meta-classå¯¹è±¡çš„å†…å­˜åœ°å€ï¼Œå› æ­¤è¦é€šè¿‡isa &amp; ISA_MASKæ‰èƒ½å–å‡ºè¿™é‡Œçš„33çš„å€¼ï¼Œå¾—åˆ°å¯¹è±¡çœŸæ­£çš„åœ°å€</li>
<li>magicâ€”â€”ç”¨äºåœ¨è°ƒè¯•çš„æ—¶å€™åˆ†è¾¨å¯¹è±¡æ˜¯å¦å®Œæˆäº†åˆå§‹åŒ–</li>
<li>weakly_referencedâ€”â€”æ˜¯å¦å€å¼±å¼•ç”¨çš„æŒ‡é’ˆæŒ‡å‘è¿‡ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‡Šæ”¾æ—¶ä¼šæ›´å¿«</li>
<li>deallocatingâ€”â€”æ˜¯å¦å¯¹è±¡æ­£åœ¨è¢«é‡Šæ”¾</li>
<li>has_sidetable_rcâ€”â€”å¼•ç”¨è®¡æ•°å™¨æ˜¯å¦è¿‡å¤§æ— æ³•å­˜å‚¨åœ¨isaä¸­ï¼Œå¦‚æœæ˜¯ï¼Œè¿™é‡Œå°±æ˜¯1ï¼Œå¼•ç”¨è®¡æ•°å°±ä¼šè¢«å­˜å‚¨åœ¨ä¸€ä¸ªå«SideTableçš„æ•£åˆ—è¡¨ä¸­</li>
<li>extra_rcâ€”â€”é‡Œé¢å­˜å‚¨çš„å€¼æ˜¯å¼•ç”¨è®¡æ•°çš„å€¼ï¼ˆretainCount-1ï¼‰ï¼Œå¦‚æœè¿™19ä½ä¸å¤Ÿå­˜å‚¨ï¼Œhas_sidetable_rcå°±ä¼šå˜ä¸º1</li>
</ul>
<p><img src="/Users/mikasa/Desktop/image_mark/23_8.png" alt="23_8"></p>
<h4 id="ISAåˆå§‹åŒ–"><a href="#ISAåˆå§‹åŒ–" class="headerlink" title="ISAåˆå§‹åŒ–"></a>ISAåˆå§‹åŒ–</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span> </span><br><span class="line">objc_object::initIsa(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    initIsa(cls, <span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span> </span><br><span class="line">objc_object::initClassIsa(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (DisableNonpointerIsa  ||  cls-&gt;instancesRequireRawIsa()) &#123;</span><br><span class="line">        initIsa(cls, <span class="literal">false</span><span class="comment">/*not nonpointer*/</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        initIsa(cls, <span class="literal">true</span><span class="comment">/*nonpointer*/</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span></span><br><span class="line">objc_object::initProtocolIsa(Class cls)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> initClassIsa(cls);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span> </span><br><span class="line">objc_object::initInstanceIsa(Class cls, <span class="keyword">bool</span> hasCxxDtor)</span><br><span class="line">&#123;</span><br><span class="line">    assert(!cls-&gt;instancesRequireRawIsa());</span><br><span class="line">    assert(hasCxxDtor == cls-&gt;hasCxxDtor());</span><br><span class="line"></span><br><span class="line">    initIsa(cls, <span class="literal">true</span>, hasCxxDtor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ä¸ç®¡æ˜¯ç±»å¯¹è±¡ã€å®ä¾‹å¯¹è±¡ã€åè®®å¯¹è±¡è¿˜æ˜¯å…¶ä»–å¯¹è±¡ï¼Œåˆå§‹åŒ–isaç»“æ„ä½“æœ€ç»ˆéƒ½è°ƒç”¨äº†initIsaå‡½æ•°ï¼Œåªæ˜¯æ‰€ä¼ å‚æ•°ä¸åŒè€Œå·²ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">inline</span> <span class="keyword">void</span> </span><br><span class="line">objc_object::initIsa(Class cls, <span class="keyword">bool</span> nonpointer, <span class="keyword">bool</span> hasCxxDtor) </span><br><span class="line">&#123; </span><br><span class="line">    assert(!isTaggedPointer()); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è¿›è¡Œisaä¼˜åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (!nonpointer) &#123;</span><br><span class="line">        isa.cls = cls;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        assert(!DisableNonpointerIsa);</span><br><span class="line">        assert(!cls-&gt;instancesRequireRawIsa());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–ä¸€ä¸ªæ–°çš„isa_tç»“æ„ä½“</span></span><br><span class="line">        <span class="keyword">isa_t</span> newisa(<span class="number">0</span>);</span><br><span class="line">        <span class="comment">// ISA_MAGIC_VALUEçš„å€¼æ˜¯ï¼Œ0x000001a000000001ULLï¼Œè½¬åŒ–ä¸ºäºŒè¿›åˆ¶æ˜¯64ä½ï¼Œå¯è§‚å¯Ÿåˆ°å®é™…åªèµ‹å€¼äº†nonpointer å’Œ magic</span></span><br><span class="line">        newisa.bits = ISA_MAGIC_VALUE;</span><br><span class="line">        <span class="comment">// isa.magic is part of ISA_MAGIC_VALUE</span></span><br><span class="line">        <span class="comment">// isa.nonpointer is part of ISA_MAGIC_VALUE</span></span><br><span class="line">        newisa.has_cxx_dtor = hasCxxDtor;</span><br><span class="line">        <span class="comment">// å°†å½“å‰å¯¹è±¡çš„ç±»æŒ‡é’ˆèµ‹å€¼åˆ°shiftcls</span></span><br><span class="line">        <span class="comment">// ç±»çš„æŒ‡é’ˆå¼æŒ‰ç…§ï¼ˆ8bitsï¼‰å¯¹é½çš„ï¼Œå…¶æŒ‡é’ˆåä¸‰ä½éƒ½æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤å¯ä»¥å³ç§»3ä½</span></span><br><span class="line">        newisa.shiftcls = (<span class="keyword">uintptr_t</span>)cls &gt;&gt; <span class="number">3</span>;</span><br><span class="line">        isa = newisa;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨Obj-Cä¸­ï¼Œç±»çš„æŒ‡é’ˆæ˜¯æŒ‰ç…§å­—èŠ‚ï¼ˆ8bitsï¼‰å¯¹é½çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç±»æŒ‡é’ˆåœ°å€è½¬åŒ–ä¸ºåè¿›åˆ¶åï¼Œéƒ½æ˜¯8çš„å€æ•°ï¼Œä¹Ÿå°±æ˜¯è¯´ç±»æŒ‡é’ˆåœ°å€è½¬åŒ–ä¸ºäºŒè¿›åˆ¶åï¼Œåä¸‰ä½éƒ½æ˜¯0ï¼Œæ—¢ç„¶0æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä½ ä»¬åœ¨å­˜å‚¨çš„æ—¶å€™å°±å¯ä»¥å¿½ç•¥ï¼Œç”¨èŠ‚çœä¸‹æ¥çš„ç©ºé—´å­˜å‚¨ä¸€ä¸‹å…¶ä»–ä¿¡æ¯ã€‚</p>
<p>å› æ­¤åœ¨èµ‹å€¼shiftclsçš„æ—¶å€™å³ç§»ä¸‰ä½æ˜¯å®‰å…¨çš„ï¼Œä¸ä¼šä¸¢å¤±ä»»ä½•æŒ‡é’ˆä¿¡æ¯ã€‚</p>
<h3 id="SideTables"><a href="#SideTables" class="headerlink" title="SideTables"></a>SideTables</h3><p><code>SideTables</code>æ˜¯ä¸€ç±»å‹æ˜¯<code>StripedMap&lt;SideTable&gt;</code>çš„é™æ€å…¨å±€å“ˆå¸Œè¡¨ï¼ŒiPhoneä¸‹å®ƒæ˜¯ä¸€ä¸ª8ä¸ªå…ƒç´ é•¿åº¦çš„<code>hash</code>æ•°ç»„ï¼Œåœ¨Macä¸‹å®ƒæ˜¯ä¸€ä¸ª64ä¸ªå…ƒç´ é•¿åº¦çš„hashæ•°ç»„ï¼Œé‡Œé¢å­˜å‚¨äº†<code>SideTable</code>ï¼Œ<code>SideTable</code>çš„hashé”®å€¼å°±æ˜¯ä¸€ä¸ªå¯¹è±¡objçš„addressã€‚</p>
<p>å› æ­¤å¯ä»¥è¯´ï¼Œä¸€ä¸ª<code>obj</code>å¯¹å‘€ä¸€ä¸ª<code>SideTable</code>ï¼Œä½†æ˜¯ä¸€ä¸ªSideTableä¼šå¯¹åº”å¤šä¸ª<code>objc</code>ã€‚å› ä¸º<code>SideTable</code>çš„æ•°é‡åªæœ‰8ä¸ªï¼Œæ‰€ä»¥ä¼šæœ‰å¾ˆå¤šobjcå…¬ç”¨åŒä¸€ä¸ª<code>SideTable</code>çš„æƒ…å†µã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alignas</span>(StripedMap&lt;SideTable&gt;) <span class="keyword">static</span> <span class="keyword">uint8_t</span> </span><br><span class="line">    SideTableBuf[<span class="keyword">sizeof</span>(StripedMap&lt;SideTable&gt;)];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SideTableInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">new</span> (SideTableBuf) StripedMap&lt;SideTable&gt;();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> StripedMap&lt;SideTable&gt;&amp; SideTables() &#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">reinterpret_cast</span>&lt;StripedMap&lt;SideTable&gt;*&gt;(SideTableBuf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å†æ¥çœ‹ä¸‹StripedMapçš„ç»“æ„ï¼ŒStripedMapæ˜¯ä¸€ä¸ªä»¥void *ä¸ºhash keyï¼ŒTä¸ºvalueçš„hashè¡¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> &#123; CacheLineSize = <span class="number">64</span> &#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StripedMap</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> TARGET_OS_IPHONE &amp;&amp; !TARGET_OS_SIMULATOR</span></span><br><span class="line">    <span class="keyword">enum</span> &#123; StripeCount = <span class="number">8</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">    <span class="keyword">enum</span> &#123; StripeCount = <span class="number">64</span> &#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">PaddedT</span> &#123;</span></span><br><span class="line">        <span class="function">T value <span class="title">alignas</span><span class="params">(CacheLineSize)</span></span>;<span class="comment">//T value 64å­—èŠ‚å¯¹é½</span></span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    PaddedT <span class="built_in">array</span>[StripeCount];<span class="comment">// æ‰€æœ‰PaddedT ç±»å‹æ•°æ®è¢«å­˜å‚¨åœ¨arrayä¸­</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯¥æ–¹æ³•ä»¥void *ä¸ºkey æ¥è·å–å¯¹åº”çš„T</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">indexForPointer</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *p)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">uintptr_t</span> addr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(p);</span><br><span class="line">        <span class="keyword">return</span> ((addr &gt;&gt; <span class="number">4</span>) ^ (addr &gt;&gt; <span class="number">9</span>)) % StripeCount;<span class="comment">// é˜²æ­¢indexè¶Šç•Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>hashç®—æ³•è®¡ç®—æ–¹å¼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> <span class="title">indexForPointer</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *p)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">uintptr_t</span> addr = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">uintptr_t</span>&gt;(p);</span><br><span class="line">    <span class="keyword">return</span> ((addr &gt;&gt; <span class="number">4</span>) ^ (addr &gt;&gt; <span class="number">9</span>)) % StripeCount;<span class="comment">// é˜²æ­¢indexè¶Šç•Œ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å°†åœ°å€æŒ‡é’ˆå³ç§»4ä½ å¼‚æˆ– æŒ‡é’ˆå³ç§»9ä½è®¡ç®—åï¼Œè¿›è¡Œå–ä½™ã€‚</p>
<h3 id="SideTable"><a href="#SideTable" class="headerlink" title="SideTable"></a>SideTable</h3><h4 id="SideTableå®šä¹‰"><a href="#SideTableå®šä¹‰" class="headerlink" title="SideTableå®šä¹‰"></a>SideTableå®šä¹‰</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">SideTable</span> &#123;</span></span><br><span class="line">    <span class="keyword">spinlock_t</span> slock;<span class="comment">// è‡ªæ—‹é”</span></span><br><span class="line">    RefcountMap refcnts;<span class="comment">// å¼•ç”¨è®¡æ•°å™¨è¡¨ï¼ˆæ•£åˆ—è¡¨ï¼‰</span></span><br><span class="line">    <span class="keyword">weak_table_t</span> weak_table; <span class="comment">// å¼±å¼•ç”¨è¡¨ï¼ˆæ•£åˆ—è¡¨ï¼‰</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>spinlock_tï¼šè‡ªæ—‹é”ï¼Œç”¨äºä¸Šé”/è§£é”<code>SideTable</code>ï¼Œä¿è¯æ“ä½œ<code>SideTable</code>æ—¶çš„çº¿ç¨‹å®‰å…¨</li>
<li>RefcountMap:ä»¥<code>DisguisedPtr&lt;objc_object&gt;</code>ä¸ºkeyçš„hashè¡¨ï¼Œç”¨æ¥å­˜å‚¨OCå¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨ï¼ˆä»…åœ¨æœªå¼€å¯isaæŒ‡é’ˆä¼˜åŒ–ï¼Œæˆ–isaå¼•ç”¨è®¡æ•°å™¨æº¢å‡ºçš„æƒ…å†µä¸‹æ‰ä¼šç”¨åˆ°ï¼‰</li>
<li>weak_table_tï¼šå­˜å‚¨å¯¹è±¡å¼±å¼•ç”¨æŒ‡é’ˆçš„hashè¡¨</li>
</ul>
<p><code>SideTable</code>è¡¨å­˜å‚¨åœ¨<code>SideTables()</code>ä¸­ï¼Œ<code>SideTables()</code>æœ¬è´¨ä¹Ÿæ˜¯æ•£åˆ—è¡¨ï¼Œå¯ä»¥é€šè¿‡å¯¹è±¡æŒ‡é’ˆæ¥è·å–ä»–å¯¹åº”çš„ï¼ˆå¼•ç”¨è®¡æ•°å™¨å’Œå¼±å¼•ç”¨è¡¨ï¼‰åœ¨å“ªä¸€ä¸ª<code>SideTable</code>ä¸­ã€‚åœ¨éåµŒå…¥å¼ç³»ç»Ÿä¸­ï¼Œ<code>SideTables()</code>æœ‰64çš„<code>SideTable</code></p>
<h4 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h4><p><strong>Qï¼šå¦‚ä½•æ‰¾åˆ°å¯¹è±¡æ‰€åœ¨çš„SideTableï¼Ÿ</strong></p>
<p>Aï¼šé€šè¿‡<code>indexForPointer</code>å‡½æ•°è®¡ç®—hashç®—æ³•ï¼Œæ‰¾åˆ°å¯¹è±¡åº”ç”¨çš„<code>SideTable</code></p>
<p><strong>Qï¼šä¸ºä»€ä¹ˆä¸æ˜¯ç”¨ä¸€ä¸ªSideTableï¼Œè€Œæ˜¯ç”¨SideTableså»ç®¡ç†å¤šä¸ªSideTableï¼Ÿ</strong></p>
<p>Aï¼šSideTableä¸­æœ‰ä¸€ä¸ªè‡ªæ—‹é”ï¼Œå¦‚æœæŠŠæ‰€æœ‰ç±»éƒ½æ”¾åœ¨åŒä¸€ä¸ª<code>SideTable</code>ï¼Œæœ‰ä»»ä½•ä¸€ä¸ªç±»æœ‰æ”¹åŠ¨éƒ½ä¼šå¯¹å½“å‰<code>SideTable</code>è¿›è¡ŒåŠ é”æ“ä½œï¼Œå…¶ä»–æ“ä½œå¤„äºç­‰å¾…çŠ¶æ€ï¼Œè¿™æ ·ä¼šå¯¼è‡´æ“ä½œæ•ˆç‡å’ŒæŸ¥è¯¢æ•ˆç‡å¾ˆä½ã€‚è€Œå¤šä¸ª<code>SideTable</code>çš„è¯ï¼Œæ“ä½œçš„éƒ½æ˜¯å•ä¸ªSideTableï¼Œå¹¶ä¸ä¼šå½±å“å…¶ä»–<code>SideTable</code>ï¼Œè¿™å°±æ˜¯åˆ†ç¦»é”ã€‚</p>
<p>â€‹    å…¨å±€çš„å¼•ç”¨è®¡æ•°å™¨ä¹‹æ‰€ä»¥ä¸å­˜åœ¨åŒä¸€ä¸ªè¡¨ä¸­ï¼Œæ˜¯ä¸ºäº†é¿å…èµ„æºç«äº‰ï¼Œè§£å†³æ•ˆç‡é—®é¢˜ã€‚å¼•ç”¨è®¡æ•°è¡¨ä¸­å¼•å…¥äº†åˆ†ç¦»é”çš„æ¦‚å¿µï¼Œå°†ä¸€ä¸ªè¡¨æ‹†åˆ†ä½å¤šä¸ªéƒ¨åˆ†ï¼Œå¯¹ä»–ä»¬åˆ†åˆ«åŠ é”ï¼Œå¯ä»¥å®ç°å¹¶å‘æ“ä½œï¼Œæå‡æ‰§è¡Œæ•ˆç‡ã€‚</p>
<p><strong>Qï¼šå¦‚ä½•æ‰¾åˆ°å¯¹è±¡çš„å¼•ç”¨è®¡æ•°å™¨ï¼Ÿ</strong></p>
<p>Aï¼šå…ˆæ‰¾åˆ°å¯¹è±¡æ‰€åœ¨<code>SideTable</code>ï¼Œç„¶åæ ¹æ®<code>refcnts</code>æŸ¥æ‰¾è·å–å¼•ç”¨è®¡æ•°å™¨å€¼ï¼Œ<code>refcnts</code>ä¹Ÿæ˜¯ä¸€ä¸ªæ•£åˆ—è¡¨ï¼Œä»¥å½“å‰å¯¹è±¡ä¸ºkeyï¼Œvalueä¸ºå¼•ç”¨è®¡æ•°å™¨çš„å€¼ï¼Œå¦‚æœæ˜¯<code>nonpointer</code>ä¸º1çš„<code>isa</code>æŒ‡é’ˆï¼Œè¿˜éœ€åŠ ä¸Š<code>extra_rc</code>çš„å€¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">inline uintptr_t </span><br><span class="line">objc_object::rootRetainCount()</span><br><span class="line">&#123;</span><br><span class="line">    if (isTaggedPointer()) return (uintptr_t)this;</span><br><span class="line"></span><br><span class="line">    sidetable_lock();</span><br><span class="line">    isa_t bits &#x3D; LoadExclusive(&amp;isa.bits);</span><br><span class="line">    ClearExclusive(&amp;isa.bits);</span><br><span class="line">    if (bits.nonpointer) &#123;</span><br><span class="line">        uintptr_t rc &#x3D; 1 + bits.extra_rc;</span><br><span class="line">        if (bits.has_sidetable_rc) &#123;</span><br><span class="line">            rc +&#x3D; sidetable_getExtraRC_nolock();</span><br><span class="line">        &#125;</span><br><span class="line">        sidetable_unlock();</span><br><span class="line">        return rc;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    sidetable_unlock();</span><br><span class="line">    return sidetable_retainCount();</span><br><span class="line">&#125;</span><br><span class="line">&#x2F;&#x2F; è·å–SideTableè¡¨ä¸­refcntsçš„å€¼</span><br><span class="line">size_t </span><br><span class="line">objc_object::sidetable_getExtraRC_nolock()</span><br><span class="line">&#123;</span><br><span class="line">    assert(isa.nonpointer);</span><br><span class="line">    SideTable&amp; table &#x3D; SideTables()[this];</span><br><span class="line">    RefcountMap::iterator it &#x3D; table.refcnts.find(this);</span><br><span class="line">    if (it &#x3D;&#x3D; table.refcnts.end()) return 0;</span><br><span class="line">    else return it-&gt;second &gt;&gt; SIDE_TABLE_RC_SHIFT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="weak-table-t"><a href="#weak-table-t" class="headerlink" title="weak_table_t"></a>weak_table_t</h3><p><code>weak_table_t</code>æ˜¯å…¨å±€ä¿å­˜çš„å¼±å¼•ç”¨çš„hashè¡¨ï¼Œä»¥<code>object</code> idsä¸ºkeysï¼Œä»¥<code>weak_entry_t</code>ä¸ºvalues</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * The global weak references table. Stores object ids as keys,</span><br><span class="line"> * and weak_entry_t structs as their values.</span><br><span class="line"> *&#x2F;</span><br><span class="line">struct weak_table_t &#123;</span><br><span class="line">  weak_entry_t *weak_entries;&#x2F;&#x2F; å­˜å‚¨weak_entry_tçš„å“ˆå¸Œæ•°ç»„</span><br><span class="line">  size_t    num_entries;&#x2F;&#x2F; å½“å‰weak_entriesä¿å­˜çš„weak_entry_tçš„æ•°é‡ï¼Œå“ˆå¸Œæ•°ç»„å†…ä¿å­˜çš„å…ƒç´ ä¸ªæ•°</span><br><span class="line">  uintptr_t mask;&#x2F;&#x2F; å“ˆå¸Œæ•°ç»„çš„æ€»é•¿åº¦-1ï¼Œä¼šå‚ä¸hashå‡½æ•°è®¡ç®—</span><br><span class="line"></span><br><span class="line">	&#x2F;&#x2F; è®°å½•æ‰€æœ‰é¡¹çš„æœ€å¤§åç§»é‡ï¼Œå³å‘ç”Ÿhashå†²çªçš„æœ€å¤§æ¬¡æ•°</span><br><span class="line">  &#x2F;&#x2F; ç”¨æˆ·åˆ¤æ–­æ˜¯å¦å‡ºç°äº†é€»è¾‘é”™è¯¯ï¼Œhashè¡¨ä¸­çš„å†²çªæ¬¡æ•°ç»å¯¹ä¸ä¼šè¶…è¿‡è¿™ä¸ªå€¼</span><br><span class="line">  &#x2F;&#x2F; å› ä¸ºä¼šæœ‰hashç¢°æ’çš„æƒ…å†µï¼Œè€Œweak_entry_té‡‡ç”¨äº†å¼€æ”¾åœ°å€å¯»å€æ³•æ¥è§£å†³</span><br><span class="line">  &#x2F;&#x2F; æ‰€ä»¥æŸä¸ªweak_entry_tæ—¶æœºå­˜å‚¨çš„ä½ç½®ä¸ä¸€å®šæ˜¯hashå‡½æ•°è®¡ç®—å‡ºæ¥çš„ç»“æœ</span><br><span class="line">  uintptr_t max_hash_displacement;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="weak-entry-t"><a href="#weak-entry-t" class="headerlink" title="weak_entry_t"></a>weak_entry_t</h4><p><code>weak_entry_t</code>çš„åŠŸèƒ½æ˜¯ä¿å­˜ä¸€ä¸ªå¯¹è±¡ï¼Œç„¶åä¿å­˜ä¸€ç»„å¯¹è±¡çš„å¼±å¼•ç”¨</p>
<p><code>weak_entry_t</code>çš„å“ˆå¸Œå­˜å‚¨çš„æ•°æ®æ˜¯<code>weak_referrer_t</code>ï¼Œå®è´¨ä¸Šæ˜¯å¼±å¼•ç”¨å˜é‡çš„åœ°å€ï¼Œå³objc_object **ï¼Œé€šè¿‡æ“ä½œæŒ‡é’ˆçš„æŒ‡é’ˆï¼Œå°±å¯ä»¥ä½¿å¾—å¼±å¼•ç”¨å˜é‡åœ¨å¯¹è±¡ææ„åæŒ‡å‘nilã€‚è¿™é‡Œå¿…é¡»ä¿å­˜å¼±å¼•ç”¨å˜é‡çš„åœ°å€ï¼Œæ‰èƒ½æŠŠå®ƒçš„æŒ‡å‘ç½®ä¸ºnil</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> WEAK_INLINE_COUNT 4</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> REFERRERS_OUT_OF_LINE 2</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __LP64__</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTR_MINUS_2 62</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> PTR_MINUS_2 30</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">weak_entry_t</span> &#123;</span></span><br><span class="line">  <span class="comment">// referentä¸­å­˜æ”¾çš„åŒ–èº«ä¸ºæ•´æ•°çš„objec_objectçš„å®ä¾‹çš„åœ°å€ï¼Œä¸‹é¢ä¿å­˜çš„å¼±å¼•ç”¨å˜é‡éƒ½æŒ‡å‘è¿™ä¸ªå¯¹è±¡</span></span><br><span class="line">  DisguisedPtr&lt;objc_object&gt; referent;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å½“æŒ‡å‘referentçš„å¼±å¼•ç”¨ä¸ªæ•°å°äºç­‰äº4æ—¶ä½¿ç”¨inline_referrersæ•°ç»„ä¿å­˜è¿™äº›å¼±å¼•ç”¨å˜é‡çš„åœ°å€</span></span><br><span class="line">  <span class="comment">// å¤§äº4ä»¥åç”¨referentè¿™ä¸ªå“ˆå¸Œæ•°ç»„ä¿å­˜</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å…¬ç”¨32ä¸ªå­—èŠ‚å†…å­˜ç©ºé—´çš„è”åˆä½“</span></span><br><span class="line">  <span class="keyword">union</span> &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="keyword">weak_referrer_t</span> *referrers;<span class="comment">//ä¿å­˜weak_referrer_tçš„å“ˆå¸Œæ•°ç»„</span></span><br><span class="line">        <span class="comment">// out_of_line_ness å’Œ num_refs æ„æˆä½åŸŸå­˜å‚¨ï¼Œå…±å 64ä½</span></span><br><span class="line">        <span class="keyword">uintptr_t</span>        out_of_line_ness : <span class="number">2</span>;<span class="comment">// 2ï¼Œæ ‡è®°å½“å‰ä½¿ç”¨å“ˆå¸Œæ•°ç»„è¿˜æ˜¯inline_referrersä¿å­˜weak_referrer_t</span></span><br><span class="line">        <span class="keyword">uintptr_t</span>        num_refs : PTR_MINUS_2;<span class="comment">// 62ï¼Œå½“å‰referrerså†…ä¿å­˜çš„weak_referrer_tæ•°é‡</span></span><br><span class="line">        <span class="keyword">uintptr_t</span>        mask;<span class="comment">// referrerså“ˆå¸Œæ•°ç»„æ€»é•¿åº¦-1ï¼Œä¼šå‚ä¸å“ˆå¸Œå‡½æ•°è®¡ç®—</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å¯èƒ½ä¼šå‘ç”Ÿhashå†²çªçš„æœ€å¤§æ¬¡æ•°ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å‡ºç°äº†é€»è¾‘é”™è¯¯ï¼Œï¼ˆhashè¡¨ä¸­çš„å†²çªæ¬¡æ•°ç»å¯¹ä¸ä¼šè¶…è¿‡è¯¥å€¼ï¼‰</span></span><br><span class="line">        <span class="comment">// è¯¥å€¼åœ¨æ–°å»ºweak_entry_tå’Œæ’å…¥æ–°çš„weak_referrer_tæ—¶ä¼šè¢«æ›´æ–°ï¼Œå®ƒä¸€ç›´è®°å½•çš„éƒ½æ˜¯æœ€å¤§åç§»é‡</span></span><br><span class="line">        <span class="keyword">uintptr_t</span>        max_hash_displacement;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        <span class="comment">// out_of_line_ness field is low bits of inline_referrers[1]</span></span><br><span class="line">        <span class="comment">// out_of_line_nesså’Œ inline_referrers[1]çš„ä½ä¸¤ä½çš„å†…å­˜ç©ºé—´é‡åˆ</span></span><br><span class="line">        <span class="comment">// é•¿åº¦ä¸º4çš„weak_referrer_tæ•°ç»„</span></span><br><span class="line">        <span class="keyword">weak_referrer_t</span>  inline_referrers[WEAK_INLINE_COUNT];</span><br><span class="line">      &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// è¿”å›trueè¡¨ç¤ºinline_referrersä¿å­˜ï¼Œè¿”å›falseè¡¨ç¤ºreferrersä¿å­˜weak_referrer_t</span></span><br><span class="line">  <span class="function"><span class="keyword">bool</span> <span class="title">out_of_line</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> (out_of_line_ness == REFERRERS_OUT_OF_LINE);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é‡è½½æ“ä½œç¬¦ï¼Œç›´æ¥ä½¿ç”¨memcpyæ‹·è´otheråˆ°this</span></span><br><span class="line">  <span class="keyword">weak_entry_t</span>&amp; <span class="keyword">operator</span>=(<span class="keyword">const</span> <span class="keyword">weak_entry_t</span>&amp; other) &#123;</span><br><span class="line">      <span class="built_in">memcpy</span>(<span class="keyword">this</span>, &amp;other, <span class="keyword">sizeof</span>(other));</span><br><span class="line">      <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// newReferentæ˜¯åŸå§‹å¯¹è±¡çš„æŒ‡é’ˆï¼ŒnewReferreræ˜¯æŒ‡å‘newReferentå¼±å¼•ç”¨å˜é‡çš„åœ°å€</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–åˆ—è¡¨</span></span><br><span class="line">  <span class="keyword">weak_entry_t</span>(objc_object *newReferent, objc_object **newReferrer)</span><br><span class="line">      : referent(newReferent)</span><br><span class="line">  &#123;</span><br><span class="line">      inline_referrers[<span class="number">0</span>] = newReferrer;</span><br><span class="line">      <span class="comment">// å°†inline_referrersæ•°ç»„ä¸­çš„å‰©ä½™3ä½éƒ½ç½®ä¸ºnil</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; WEAK_INLINE_COUNT; i++) &#123;</span><br><span class="line">          inline_referrers[i] = nil;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ä¹‹æ‰€ä»¥ä½¿ç”¨å®šé•¿/å“ˆå¸Œæ•°ç»„çš„åˆ‡æ¢ï¼Œåº”è¯¥æ˜¯è€ƒäº†åˆ°å®ä¾‹å¯¹è±¡çš„å¼±å¼•ç”¨å˜é‡ä¸ªæ•°ä¸€èˆ¬æ¯”è¾ƒå°‘ï¼Œè¿™æ˜¯ä½¿ç”¨å®šé•¿æ•°ç»„ä¸éœ€è¦åœ¨åŠ¨æ€ç”³è¯·å†…å­˜ç©ºé—´ï¼ˆunionä¸­ä¸¤ä¸ªç»“æ„ä½“å…¬ç”¨32ä¸ªå­—èŠ‚å†…å­˜ï¼‰ï¼Œè€Œæ˜¯ä½¿ç”¨weak_entry_tåˆå§‹åŒ–æ—¶åˆ†é…çš„ä¸€å—è¿ç»­å†…å­˜ç©ºé—´ï¼Œè¿™å›å¾—åˆ°å…è®¸æ•ˆç‡ä¸Šçš„æå‡ã€‚</p>
<h4 id="weak-referrer-t"><a href="#weak-referrer-t" class="headerlink" title="weak_referrer_t"></a>weak_referrer_t</h4><p>ç”¨äºä¼ªè£…__weakå˜é‡çš„åœ°å€ï¼Œå³ç”¨äºä¼ªè£…objc_object *çš„åœ°å€</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The address of a __weak variable.</span></span><br><span class="line"><span class="comment">// These pointers are stored disguised so memory analysis tools</span></span><br><span class="line"><span class="comment">// don't see lots of interior pointers from the weak table into objects.</span></span><br><span class="line"><span class="comment">// __weakå˜é‡çš„åœ°å€ï¼ˆobjc_object **ï¼‰ï¼Œè¿™äº›æŒ‡é’ˆæ˜¯ä¼ªè£…çš„ï¼Œå› æ­¤å†…å­˜åˆ†æå·¥å…·ä¸ä¼šçœ‹åˆ°ä»weak tableåˆ°objectçš„å¤§é‡å†…éƒ¨æŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">typedef</span> DisguisedPtr&lt;objc_object *&gt; <span class="keyword">weak_referrer_t</span>;</span><br></pre></td></tr></table></figure>

<h3 id="object-setIvar"><a href="#object-setIvar" class="headerlink" title="_object_setIvar"></a>_object_setIvar</h3><p>è®¾ç½®å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼Œæ ¹æ®æˆå‘˜å˜é‡è·å–å½“å‰æˆå‘˜å˜é‡ç±»å‹æ˜¯strongã€weakä»¥åŠ_unsafe_unretainedï¼Œè°ƒç”¨å¯¹è±¡å­˜å‚¨å‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _object_setIvar(id obj, Ivar ivar, id value, <span class="keyword">bool</span> assumeStrong)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj  ||  !ivar  ||  obj-&gt;isTaggedPointer()) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">ptrdiff_t</span> offset;</span><br><span class="line">    <span class="keyword">objc_ivar_memory_management_t</span> memoryManagement;</span><br><span class="line">    _class_lookUpIvar(obj-&gt;ISA(), ivar, offset, memoryManagement);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (memoryManagement == objc_ivar_memoryUnknown) &#123;</span><br><span class="line">        <span class="keyword">if</span> (assumeStrong) memoryManagement = objc_ivar_memoryStrong;</span><br><span class="line">        <span class="keyword">else</span> memoryManagement = objc_ivar_memoryUnretained;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    id *location = (id *)((<span class="keyword">char</span> *)obj + offset);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (memoryManagement) &#123;</span><br><span class="line">    <span class="keyword">case</span> objc_ivar_memoryWeak:       objc_storeWeak(location, value); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> objc_ivar_memoryStrong:     objc_storeStrong(location, value); <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> objc_ivar_memoryUnretained: *location = value; <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> objc_ivar_memoryUnknown:    _objc_fatal(<span class="string">"impossible"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="objc-storeWeak"><a href="#objc-storeWeak" class="headerlink" title="objc_storeWeak"></a>objc_storeWeak</h4><blockquote>
<p>æ›´æ–°æŒ‡é’ˆæŒ‡å‘ï¼Œåˆ›å»ºå¯¹åº”çš„å¼±å¼•ç”¨è¡¨</p>
<p>å¦‚æœå­˜åœ¨æ—§è¡¨ï¼Œä¹Ÿå­˜åœ¨æˆå‘˜å€¼ï¼Œéœ€è¦è¿›è¡Œæ¸…ç†æ“ä½œï¼Œå› ä¸ºè¿™ä¸ªå€¼å¯èƒ½æ˜¯nil</p>
<p>å¦‚æœæœ‰æ–°è¡¨ï¼Œèµ‹å€¼è¿™ä¸ªæ–°å€¼åˆ°å˜é‡ä¸­ï¼Œè¿™ä¸ªå€¼å¯èƒ½æ˜¯nil</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Update a weak variable.</span><br><span class="line">&#x2F;&#x2F; If HaveOld is true, the variable has an existing value </span><br><span class="line">&#x2F;&#x2F;   that needs to be cleaned up. This value might be nil.</span><br><span class="line">&#x2F;&#x2F; If HaveNew is true, there is a new value that needs to be </span><br><span class="line">&#x2F;&#x2F;   assigned into the variable. This value might be nil.</span><br><span class="line">&#x2F;&#x2F; If CrashIfDeallocating is true, the process is halted if newObj is </span><br><span class="line">&#x2F;&#x2F;   deallocating or newObj&#39;s class does not support weak references. </span><br><span class="line">&#x2F;&#x2F;   If CrashIfDeallocating is false, nil is stored instead.</span><br><span class="line">enum CrashIfDeallocating &#123;</span><br><span class="line">    DontCrashIfDeallocating &#x3D; false, DoCrashIfDeallocating &#x3D; true</span><br><span class="line">&#125;;</span><br><span class="line">template &lt;HaveOld haveOld, HaveNew haveNew,</span><br><span class="line">          CrashIfDeallocating crashIfDeallocating&gt;</span><br><span class="line">static id </span><br><span class="line">storeWeak(id *location, objc_object *newObj) &#123;</span><br><span class="line">	â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å‰ç½®æ¡ä»¶åˆ¤æ–­</li>
<li>å£°æ˜æ–°æ—§ä¸¤ä¸ªSideTable</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">if (haveOld) &#123;</span><br><span class="line">    oldObj &#x3D; *location;</span><br><span class="line">    oldTable &#x3D; &amp;SideTables()[oldObj];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    oldTable &#x3D; nil;</span><br><span class="line">&#125;</span><br><span class="line">if (haveNew) &#123;</span><br><span class="line">    newTable &#x3D; &amp;SideTables()[newObj];</span><br><span class="line">&#125; else &#123;</span><br><span class="line">    newTable &#x3D; nil;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ ¹æ®æ–°å€¼å’Œæ—§å€¼åˆ†åˆ«è·åŒºå…¨å±€çš„SideTablesè¡¨ä¸­çš„SideTable</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">if (haveNew  &amp;&amp;  newObj) &#123;</span><br><span class="line">        Class cls &#x3D; newObj-&gt;getIsa();</span><br><span class="line">        if (cls !&#x3D; previouslyInitializedClass  &amp;&amp;  </span><br><span class="line">            !((objc_class *)cls)-&gt;isInitialized()) </span><br><span class="line">        &#123;</span><br><span class="line">            SideTable::unlockTwo&lt;haveOld, haveNew&gt;(oldTable, newTable);</span><br><span class="line">            class_initialize(cls, (id)newObj);</span><br><span class="line"></span><br><span class="line">            &#x2F;&#x2F; If this class is finished with +initialize then we&#39;re good.</span><br><span class="line">            &#x2F;&#x2F; If this class is still running +initialize on this thread </span><br><span class="line">            &#x2F;&#x2F; (i.e. +initialize called storeWeak on an instance of itself)</span><br><span class="line">            &#x2F;&#x2F; then we may proceed but it will appear initializing and </span><br><span class="line">            &#x2F;&#x2F; not yet initialized to the check above.</span><br><span class="line">            &#x2F;&#x2F; Instead set previouslyInitializedClass to recognize it on retry.</span><br><span class="line">            previouslyInitializedClass &#x3D; cls;</span><br><span class="line"></span><br><span class="line">            goto retry;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>ç¡®ä¿å¯¹è±¡åœ¨å¼±å¼•ç”¨ä¹‹å‰ï¼Œä»¥åŠæˆåŠŸåˆå§‹åŒ–</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Clean up old value, if any.</span><br><span class="line">if (haveOld) &#123;</span><br><span class="line">  weak_unregister_no_lock(&amp;oldTable-&gt;weak_table, oldObj, location);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ¸…ç©ºæ—§å€¼</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Assign new value, if any.</span></span><br><span class="line"><span class="keyword">if</span> (haveNew) &#123;</span><br><span class="line">    newObj = (objc_object *)</span><br><span class="line">        weak_register_no_lock(&amp;newTable-&gt;weak_table, (<span class="keyword">id</span>)newObj, location, </span><br><span class="line">                              crashIfDeallocating);</span><br><span class="line">    <span class="comment">// weak_register_no_lock returns nil if weak store should be rejected</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set is-weakly-referenced bit in refcount table.</span></span><br><span class="line">    <span class="keyword">if</span> (newObj  &amp;&amp;  !newObj-&gt;isTaggedPointer()) &#123;</span><br><span class="line">        newObj-&gt;setWeaklyReferenced_nolock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Do not set *location anywhere else. That would introduce a race.</span></span><br><span class="line">    *location = (<span class="keyword">id</span>)newObj;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å­˜å‚¨æ–°å€¼<code>weak_register_no_lock</code>å‡½æ•°æ‰§è¡ŒçœŸæ­£çš„å­˜å‚¨é€»è¾‘</p>
<h4 id="weak-register-no-lock"><a href="#weak-register-no-lock" class="headerlink" title="weak_register_no_lock"></a>weak_register_no_lock</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">id </span><br><span class="line">weak_register_no_lock(weak_table_t *weak_table, id referent_id, </span><br><span class="line">                      id *referrer_id, bool crashIfDeallocating)</span><br><span class="line">&#123;</span><br><span class="line">		&#x2F;&#x2F; referentå¼±å¼•ç”¨å¯¹è±¡ï¼Œreferrer weakæŒ‡é’ˆçš„åœ°å€</span><br><span class="line">    objc_object *referent &#x3D; (objc_object *)referent_id;</span><br><span class="line">    objc_object **referrer &#x3D; (objc_object **)referrer_id;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; now remember it and where it is being stored</span><br><span class="line">    weak_entry_t *entry;</span><br><span class="line">    if ((entry &#x3D; weak_entry_for_referent(weak_table, referent))) &#123;</span><br><span class="line">        append_referrer(entry, referrer);</span><br><span class="line">    &#125; </span><br><span class="line">    else &#123;</span><br><span class="line">        weak_entry_t new_entry(referent, referrer);</span><br><span class="line">        weak_grow_maybe(weak_table);</span><br><span class="line">        weak_entry_insert(weak_table, &amp;new_entry);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Do not set *referrer. objc_storeWeak() requires that the </span><br><span class="line">    &#x2F;&#x2F; value not change.</span><br><span class="line"></span><br><span class="line">    return referent_id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å£°æ˜ä¸€ä¸ª<code>weak_entry_t</code>ç±»å‹å®ä½“ï¼Œè¿™é‡Œä¿å­˜äº†å‘—å¼±å¼•ç”¨å¯¹è±¡çš„æŒ‡é’ˆå’ŒweakæŒ‡é’ˆçš„åœ°å€</li>
<li>æ ¹æ®å¼±å¼•ç”¨å¯¹è±¡çš„æŒ‡é’ˆä»å…¨å±€<code>weak_table</code>ä¸­æŸ¥æ‰¾<code>entry</code>ï¼Œå¦‚æœæ‰¾åˆ°åˆ™æ‰§è¡Œæ’å…¥æ“ä½œã€‚</li>
<li>å¦‚æœ<code>weak_entry_for_referent</code>è¿”å›çš„entryå­˜å‚¨<code>weak</code>æŒ‡é’ˆçš„æ˜¯<code>inline_referrers</code>ç±»å‹ï¼Œä»Šå¤©é€šè¿‡ç›´æ¥æ“ä½œæ•°ç»„ä¸­çš„å…ƒç´ æ¥è¾¾åˆ°ä¿®æ”¹æ•°å€¼çš„ç›®çš„</li>
<li>å¦‚æœæ²¡æœ‰æŸ¥æ‰¾åˆ°<code>entry</code>ï¼Œåˆ™æ–°å»ºä¸€ä¸ª<code>weak_entry_t</code>ç»“æ„ä½“æ•°ç»„ï¼Œç›´æ¥å°†è¿™ä¸ª<code>weak_entry_t</code>æ’å…¥åˆ°<code>weak_table</code>è¡¨ä¸­</li>
</ul>
<blockquote>
<p><code>weak_table_t</code>è°ƒç”¨<code>weak_grow_maybe</code> å’Œ <code>weak_compact_maybe</code>è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œç”¨æ¥å½“<code>weak_table_t</code>å“ˆå¸Œæ•°ç»„è¿‡æ»¡æˆ–è€…ä¸ºç©ºçš„æƒ…å†µä¸‹åŠæ—¶è°ƒæ•´å…¶å¤§å°ï¼Œä¼˜åŒ–å†…å­˜çš„ä½¿ç”¨æ•ˆç‡ï¼Œå¹¶æé«˜æŸ¥æ‰¾æ•ˆç‡ã€‚è¿™ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯é€šè¿‡<code>weak_resize</code>å‡½æ•°æ¥è°ƒæ•´weak_table_tæ•°ç»„çš„å¤§å°</p>
</blockquote>
<h4 id="weak-grow-maybe"><a href="#weak-grow-maybe" class="headerlink" title="weak_grow_maybe"></a>weak_grow_maybe</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">#define TABLE_SIZE(entry) (entry-&gt;mask ? entry-&gt;mask + 1 : 0)</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; Grow the given zone&#39;s table of weak references if it is full.</span><br><span class="line">&#x2F;&#x2F; å¦‚æœç»™å®šåŒºåŸŸçš„å¼±å¼•ç”¨è¡¨å·²æ»¡ï¼Œåˆ™å¯¹é½è¿›è¡Œæ‰©å±•</span><br><span class="line">static void weak_grow_maybe(weak_table_t *weak_table)</span><br><span class="line">&#123;</span><br><span class="line">    size_t old_size &#x3D; TABLE_SIZE(weak_table);</span><br><span class="line"></span><br><span class="line">    &#x2F;&#x2F; Grow if at least 3&#x2F;4 full.</span><br><span class="line">    &#x2F;&#x2F; å¦‚æœç›®å‰å“ˆå¸Œæ•°ç»„ä¸­å­˜å‚¨çš„weak_entry_tæ•°é‡è¶…è¿‡äº†æ€»é•¿åº¦çš„3 &#x2F; 4ï¼Œåˆ™è¿›è¡Œæ‰©å®¹</span><br><span class="line">    if (weak_table-&gt;num_entries &gt;&#x3D; old_size * 3 &#x2F; 4) &#123;</span><br><span class="line">        &#x2F;&#x2F; å¦‚æœweak_tableæ˜¯æ–°å»ºçš„ï¼Œåˆ™å‡ºäº‹å…¶å“ˆå¸Œæ•°ç»„é•¿åº¦ä¸º64ï¼Œå¦‚æœæ˜¯éç©ºï¼Œåˆ™æ‰©å®¹ä¸ºä¹‹å‰é•¿åº¦çš„ä¸¤å€</span><br><span class="line">        weak_resize(weak_table, old_size ? old_size*2 : 64);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°ç”¨äºæ‰©å……<code>weak_table_t</code>çš„<code>weak_entry_t *weak_entries</code>é•¿åº¦ï¼Œæ‰©å……æ¡ä»¶æ˜¯<code>num_entries</code>é•¿åº¦è¶…è¿‡äº†mask+1çš„3 / 4ã€‚åˆå§‹åŒ–<code>weak_table</code>é•¿åº¦æ˜¯64ï¼Œæ¯æ¬¡æ‰©å……çš„é•¿åº¦åˆ™æ˜¯mask+1çš„ä¸¤å€ï¼Œæ‰©å®¹å®Œæ¯•åä¼šæŠŠåŸå“ˆå¸Œæ•°ç»„ä¸­çš„weak_entry_té‡æ–°å“ˆå¸ŒåŒ–æ’å…¥åˆ°æ–°ç©ºé—´å†…ï¼Œå¹¶æ›´æ–°weak_tabl_tå„æˆå‘˜å˜é‡ã€‚å æ®çš„å†…å­˜ç©ºé—´çš„æ€»å®¹é‡åˆ™æ˜¯<code>(mask+1) * sizeof(weak_entry_t)</code>å­—èŠ‚ã€‚ç»¼ä¸Šmask+1æ€»æ˜¯2çš„Næ¬¡æ–¹ï¼ˆ2^6=64 å³ N&gt;=6ï¼‰</p>
<h4 id="weak-compact-maybe"><a href="#weak-compact-maybe" class="headerlink" title="weak_compact_maybe"></a>weak_compact_maybe</h4><p>è¯¥å‡½æ•°ä¼šåœ¨weak_entry_removeå‡½æ•°ä¸­è°ƒç”¨ï¼Œæ—¨åœ¨<code>weak_entry_t</code>ä»<code>weak_table_t</code>çš„æ•°ç»„ä¸­ç§»é™¤åï¼Œç¼©å°<code>weak_entry_t *weak_entries</code>çš„ç©ºé—´</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shrink the table if it is mostly empty.</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> weak_compact_maybe(weak_table_t *weak_table)</span><br><span class="line">&#123;</span><br><span class="line">    size_t old_size = TABLE_SIZE(weak_table);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Shrink if larger than 1024 buckets and at most 1/16 full.</span></span><br><span class="line">    <span class="comment">// old_size è¶…è¿‡äº†1024 å¹¶ä¸”ä½äº1/16çš„ç©ºé—´å ç”¨ç‡ï¼Œåˆ™è¿›è¡Œç¼©å° </span></span><br><span class="line">    <span class="keyword">if</span> (old_size &gt;= <span class="number">1024</span>  &amp;&amp; old_size / <span class="number">16</span> &gt;= weak_table-&gt;num_entries) &#123;</span><br><span class="line">        <span class="comment">// ç¼©å°å®¹é‡ä¸º1/8</span></span><br><span class="line">        weak_resize(weak_table, old_size / <span class="number">8</span>);</span><br><span class="line">        <span class="comment">// leaves new table no more than 1/2 full</span></span><br><span class="line">        <span class="comment">// ç¼©å°å®¹é‡1/8 å’Œ ç©ºé—´å ç”¨ç‡å°‘äº1/16ï¼Œä¸¤ä¸ªæ¡ä»¶ç»„åˆåœ¨ä¸€èµ·ï¼Œä¿è¯ç¼©å°åçš„å®¹é‡å ç”¨å°‘äº1/2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼©å°<code>weak_entry_t *weak_entries</code>å®¹é‡çš„æ¡ä»¶æ˜¯ç›®å‰çš„æ€»é•¿åº¦è¶…è¿‡äº†1024 å’Œ å®¹é‡å ç”¨äº†å°‘äº1/16ï¼Œ<code>weak_entries</code>ç©ºé—´ç¼©å°ä¸ºå½“å‰ç©ºé—´çš„1/8</p>
<h4 id="weak-resize"><a href="#weak-resize" class="headerlink" title="weak_resize"></a>weak_resize</h4><p>æ‰©å¤§å’Œç¼©å°ç©ºé—´éƒ½ä¼šè°ƒç”¨çš„weak_resizeå…¬å…±å‡½æ•°</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> weak_resize(weak_table_t *weak_table, size_t new_size)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="comment">// old_size = mask+1;è¡¨ç¤ºåŸå§‹å“ˆå¸Œæ•°ç»„çš„æ€»é•¿åº¦</span></span><br><span class="line">  size_t old_size = TABLE_SIZE(weak_table);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ—§weak_entrieså“ˆå¸Œæ•°ç»„çš„èµ·å§‹åœ°å€</span></span><br><span class="line">  weak_entry_t *old_entries = weak_table-&gt;weak_entries;</span><br><span class="line">  <span class="comment">// ä¸ºæ–° weak_entries å“ˆå¸Œæ•°ç»„ç”³è¯·æŒ‡å®šé•¿åº¦çš„ç©ºé—´ï¼Œå¹¶æŠŠèµ·å§‹åœ°å€è¿”å›</span></span><br><span class="line">  <span class="comment">// å†…å­˜ç©ºé—´å¤§å°ä¸º new_size * sizeof(weak_entry_t)</span></span><br><span class="line">  weak_entry_t *new_entries = (weak_entry_t *)</span><br><span class="line">      calloc(new_size, <span class="keyword">sizeof</span>(weak_entry_t));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ›´æ–°mask,ä»æ˜¯new_size-1</span></span><br><span class="line">  weak_table-&gt;mask = new_size - <span class="number">1</span>;</span><br><span class="line">  <span class="comment">// æ›´æ–°å“ˆå¸Œæ•°ç»„èµ·å§‹åœ°å€</span></span><br><span class="line">  weak_table-&gt;weak_entries = new_entries;</span><br><span class="line">  <span class="comment">// æœ€å¤§å“ˆå¸Œå†²çªåç§»å€¼ï¼Œé»˜è®¤ä¸º0</span></span><br><span class="line">  weak_table-&gt;max_hash_displacement = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// å½“å‰å“ˆå¸Œæ•°ç»„çš„å ç”¨æ•°é‡ï¼Œé»˜è®¤ä¸º0</span></span><br><span class="line">  weak_table-&gt;num_entries = <span class="number">0</span>;  <span class="comment">// restored by weak_entry_insert below</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰æ—§çš„weak_entry_tï¼Œéœ€è¦æ”¾åœ¨æ–°çš„ç©ºé—´å†…</span></span><br><span class="line">  <span class="keyword">if</span> (old_entries) &#123;</span><br><span class="line">      weak_entry_t *entry;</span><br><span class="line">      weak_entry_t *end = old_entries + old_size;</span><br><span class="line">      <span class="keyword">for</span> (entry = old_entries; entry &lt; end; entry++) &#123;</span><br><span class="line">          <span class="keyword">if</span> (entry-&gt;referent) &#123;</span><br><span class="line">              weak_entry_insert(weak_table, entry);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      free(old_entries);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="weak-entry-insert"><a href="#weak-entry-insert" class="headerlink" title="weak_entry_insert"></a>weak_entry_insert</h4><p>å°†weak_entry_t<code>æ·»åŠ åˆ°</code>weak_table_t-&gt;weak_entriesä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** </span><br><span class="line"> * Add new_entry to the object&#39;s table of weak references.</span><br><span class="line"> * Does not check whether the referent is already in the table.</span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;&#x2F; æ·»åŠ ä¸€ä¸ªæ–°çš„weak_entry_tåˆ°å¯¹è±¡çš„å¼±å¼•ç”¨è¡¨ä¸­</span><br><span class="line">&#x2F;&#x2F; ä¸è¿›è¡Œæ£€æŸ¥å¼•ç”¨å¯¹è±¡æ˜¯å¦å·²å­˜åœ¨è¡¨ä¸­</span><br><span class="line">static void weak_entry_insert(weak_table_t *weak_table, weak_entry_t *new_entry)</span><br><span class="line">&#123;</span><br><span class="line">  &#x2F;&#x2F; å“ˆå¸Œæ•°ç»„çš„èµ·å§‹åœ°å€</span><br><span class="line">  weak_entry_t *weak_entries &#x3D; weak_table-&gt;weak_entries;</span><br><span class="line">  assert(weak_entries !&#x3D; nil);</span><br><span class="line">	&#x2F;&#x2F; è°ƒç”¨hashå‡½æ•°æ‰¾åˆ°new_entryåœ¨weak_table_tçš„å“ˆå¸Œæ•°ç»„ä¸­çš„ä½ç½®ï¼Œå¯èƒ½ä¼šå‘ç”Ÿhashå†²çª</span><br><span class="line">  size_t begin &#x3D; hash_pointer(new_entry-&gt;referent) &amp; (weak_table-&gt;mask);</span><br><span class="line">  size_t index &#x3D; begin;</span><br><span class="line">  size_t hash_displacement &#x3D; 0;</span><br><span class="line">  while (weak_entries[index].referent !&#x3D; nil) &#123;</span><br><span class="line">    	&#x2F;&#x2F; å¦‚æœå‘ç”Ÿhashå†²çª+1ï¼Œç»§ç»­å¾€ä¸‹æ¢æµ‹</span><br><span class="line">      index &#x3D; (index+1) &amp; weak_table-&gt;mask;</span><br><span class="line">      &#x2F;&#x2F; å¦‚æœindexæ¯æ¬¡+1åŠ åˆ°å€¼ç­‰äºbeginè¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°ç©ºä½ç½®ï¼Œåˆ™è§¦å‘bad_weak_tableè‡´å‘½é”™è¯¯</span><br><span class="line">      if (index &#x3D;&#x3D; begin) bad_weak_table(weak_entries);</span><br><span class="line">      &#x2F;&#x2F; è®°å½•åç§»é‡ ç”¨äºæ›´æ–°max_hash_displacement</span><br><span class="line">      hash_displacement++;</span><br><span class="line">  &#125;</span><br><span class="line">	&#x2F;&#x2F; new_entryæ”¾å…¥å“ˆå¸Œæ•°ç»„ä¸­</span><br><span class="line">  weak_entries[index] &#x3D; *new_entry;</span><br><span class="line">  &#x2F;&#x2F; æ›´æ–°num_entries</span><br><span class="line">  weak_table-&gt;num_entries++;</span><br><span class="line">	&#x2F;&#x2F; è®°å½•weak_table_tå“ˆå¸Œæ•°ç»„ä¸­å‘ç”Ÿå“ˆå¸Œå†²çªæ—¶çš„æœ€å¤§åç§»é‡</span><br><span class="line">  if (hash_displacement &gt; weak_table-&gt;max_hash_displacement) &#123;</span><br><span class="line">      weak_table-&gt;max_hash_displacement &#x3D; hash_displacement;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»¼åˆæ¥çœ‹ï¼Œweak_entry_insertå‡½æ•°å¯çŸ¥weak_resizeå‡½æ•°çš„æ•´ä½“å·¦å³ï¼Œè¯¥å‡½æ•°å¯¹å“ˆå¸Œæ•°ç»„è¿›è¡Œçš„æ‰©å¤§å’Œç¼©å°ï¼Œé¦–å…ˆæ ¹æ®new_sizeç”³è¯·ç›¸åº”å¤§å°çš„å†…å­˜ï¼Œnew_entriesæŒ‡é’ˆæŒ‡å‘è¿™å—æ–°ç”³è¯·çš„å†…å­˜ã€‚è®¾ç½®weak_tableçš„maskä¸ºnew_size-1ã€‚æ­¤å¤„maskçš„ä½œç”¨æ˜¯è®°å½•weak_table æ€»å®¹é‡çš„å†…å­˜è¾¹ç•Œï¼Œæ­¤å¤–maskè¿˜ç”¨åœ¨å“ˆå¸Œå‡½æ•°ä¸­ä¿è¯indexä¸ä¼šå“ˆå¸Œæ•°ç»„è¶Šç•Œã€‚</p>
<p>â€‹    weak_table_tçš„å“ˆå¸Œæ•°ç»„å¯èƒ½ä¼šå‘ç”Ÿå“ˆå¸Œç¢°æ’ï¼Œè€Œweak_table_té‡‡ç”¨äº†å¼€æ”¾åœ°å€å¯»å€æ³•æ¥å¤„ç†ç¢°æ’ã€‚å¦‚æœå‘ç”Ÿç¢°æ’çš„è¯ï¼Œå°†å¯»æ‰¾ç›¸é‚»ï¼ˆå¦‚æœå·²ç»åˆ°å°¾ç«¯çš„è¯ï¼Œåˆ™ä»å¤´å¼€å§‹ï¼‰çš„ä¸‹ä¸€ä¸ªç©ºä½ï¼Œä¾‹å¦‚weak_entry_for_referentå‡½æ•°ï¼Œå¯»æ‰¾ç»™å®šçš„referentåœ¨å¼±å¼•ç”¨è¡¨ä¸­çš„entryæ—¶ï¼Œå¦‚æœåœ¨å¾ªç¯è¿‡ç¨‹ä¸­hash_displacementçš„å€¼è¶…è¿‡äº†weak_table-&gt;max_hash_displacementåˆ™è¡¨ç¤ºï¼Œä¸å­˜åœ¨è¦æ‰¾çš„weak_entry_t</p>
<h4 id="weak-entry-for-referent"><a href="#weak-entry-for-referent" class="headerlink" title="weak_entry_for_referent"></a>weak_entry_for_referent</h4><blockquote>
<p>æ ¹æ®ç»™å®šçš„referent å’Œ weak_table_tå“ˆå¸Œè¡¨ï¼ŒæŸ¥æ‰¾å…¶ä¸­çš„weak_entry_tå¹¶è¿”å›ï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å›NULLã€‚</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;** </span><br><span class="line"> * Return the weak reference table entry for the given referent. </span><br><span class="line"> * If there is no entry for referent, return NULL. </span><br><span class="line"> * Performs a lookup.</span><br><span class="line"> *</span><br><span class="line"> * @param weak_table </span><br><span class="line"> * @param referent The object. Must not be nil.</span><br><span class="line"> * </span><br><span class="line"> * @return The table of weak referrers to this object. </span><br><span class="line"> *&#x2F;</span><br><span class="line">&#x2F;&#x2F; weak_tableé€šè¿‡&amp;SideTables()[referent]å¯ä»å…¨å±€çš„SideTablesä¸­æ‰¾åˆ°referentæ‰€å¤„çš„weak_table</span><br><span class="line">static weak_entry_t *</span><br><span class="line">weak_entry_for_referent(weak_table_t *weak_table, objc_object *referent)</span><br><span class="line">&#123;</span><br><span class="line">    assert(referent);</span><br><span class="line">		&#x2F;&#x2F; weak_table_tå“ˆå¸Œæ•°ç»„çš„å…¥å£</span><br><span class="line">    weak_entry_t *weak_entries &#x3D; weak_table-&gt;weak_entries;</span><br><span class="line"></span><br><span class="line">    if (!weak_entries) return nil;</span><br><span class="line"></span><br><span class="line">  	&#x2F;&#x2F; å“ˆå¸Œå‡½æ•°ï¼šhash_pointerå‡½æ•°è¿”å›å€¼ä¸maskåšä¸ï¼Œé˜²æ­¢indexè¶Šç•Œ</span><br><span class="line">    size_t begin &#x3D; hash_pointer(referent) &amp; weak_table-&gt;mask;</span><br><span class="line">    size_t index &#x3D; begin;</span><br><span class="line">    size_t hash_displacement &#x3D; 0;</span><br><span class="line">    &#x2F;&#x2F; å¦‚æœæœªå‘ç”Ÿå“ˆå¸Œå†²çªçš„è¯ï¼Œè¿™weak_table-&gt;weak_entries[index]å°±æ˜¯è¦æ‰¾çš„weak_entry_täº†</span><br><span class="line">    while (weak_table-&gt;weak_entries[index].referent !&#x3D; referent) &#123;</span><br><span class="line">        &#x2F;&#x2F; å¦‚æœå‘ç”Ÿäº†å“ˆå¸Œå†²çª + 1ï¼Œç»§ç»­å‘ä¸‹æ¢æµ‹ï¼ˆå¼€æ”¾åœ°å€å¯»å€æ³•ï¼‰</span><br><span class="line">        index &#x3D; (index+1) &amp; weak_table-&gt;mask;</span><br><span class="line">        if (index &#x3D;&#x3D; begin) bad_weak_table(weak_table-&gt;weak_entries);</span><br><span class="line">        &#x2F;&#x2F; è®°å½•æ¢æµ‹åç§»äº†å¤šè¿œ</span><br><span class="line">        hash_displacement++;</span><br><span class="line">        &#x2F;&#x2F; å¦‚æœæ¢æµ‹åç§»è¶…è¿‡äº† weak_table_t çš„ max_hash_displacementï¼Œåˆ™è¯´æ˜weak_tableä¸­æ²¡æœ‰referentçš„weak_entry_tï¼Œåˆ™è¿”å›nil</span><br><span class="line">        if (hash_displacement &gt; weak_table-&gt;max_hash_displacement) &#123;</span><br><span class="line">            return nil;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    return &amp;weak_table-&gt;weak_entries[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/10/27/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-Tagged-Pointer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/27/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-Tagged-Pointer/" class="post-title-link" itemprop="url">å†…å­˜ç®¡ç†-Tagged Pointer</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-27 19:18:37" itemprop="dateCreated datePublished" datetime="2020-10-27T19:18:37+08:00">2020-10-27</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-28 17:32:55" itemprop="dateModified" datetime="2020-10-28T17:32:55+08:00">2020-10-28</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è‹¹æœåœ¨iOSé‡‡ç”¨RCï¼ˆå¼•ç”¨è®¡æ•°å™¨ï¼‰è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œåœ¨MRCæ—¶ä»£éœ€è¦æˆ‘ä»¬æ‰‹åŠ¨è¿›è¡Œå†…å­˜ç®¡ç†è°ƒç”¨retainå’Œreleaseè¿›è¡Œå¼•ç”¨è®¡æ•°å™¨+1å’Œ-1ï¼ŒiOS5ä¹‹åè‹¹æœå¼•å…¥äº†ARCï¼Œé€šè¿‡LLVMå’ŒRuntimeè¿è¡Œæœºåˆ¶ç¼–è¯‘å™¨è‡ªåŠ¨å¸®å¿™æ·»åŠ ä¸Šretainã€releaseå’Œautoreleasepoolè¿›è¡Œå†…å­˜ç®¡ç†ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬å·²ç»ä¸ç”¨åœ¨ç®¡ç†å¼•ç”¨è®¡æ•°å™¨é—®é¢˜ã€‚</p>
<p>ä½†æ˜¯ä¸ºäº†äº†è§£ç³»ç»Ÿå†…å­˜ç®¡ç†çš„æœ¬è´¨ï¼Œéœ€è¦æˆ‘ä»¬é€šè¿‡æºç å»æ¢ç©¶ä¸€ä¸‹ã€‚</p>
<h3 id="Tagged-Pointer"><a href="#Tagged-Pointer" class="headerlink" title="Tagged Pointer"></a>Tagged Pointer</h3><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><h4 id="å­˜åœ¨é—®é¢˜"><a href="#å­˜åœ¨é—®é¢˜" class="headerlink" title="å­˜åœ¨é—®é¢˜"></a>å­˜åœ¨é—®é¢˜</h4><p>å¯¹è±¡åœ¨å†…å­˜ä¸­æ˜¯å¯¹é½çš„ï¼Œä»–ä»¬çš„åœ°å€æ€»æ˜¯æŒ‡é’ˆçš„æ•´æ•°å€ï¼Œé€šå¸¸ä¸º16å€æ•°</p>
<p>é€šå¸¸æƒ…å†µä¸‹ï¼Œå¯¹è±¡ã€æŒ‡é’ˆã€NSIntegerçš„å†…å­˜å ç”¨éƒ½ä¸å½“å‰CPUçš„ä½æ•°æœ‰å…³ï¼Œä¸€ä¸ªNSIntegerç±»å‹çš„å˜é‡åœ¨32ä½ä¸‹å 4ä¸ªå­—èŠ‚ï¼Œåœ¨64ä½ä¸‹å°±ä¼šå ç”¨8ä¸ªå­—èŠ‚ï¼ŒæŒ‡é’ˆä¹Ÿæ˜¯ï¼Œå¯¹è±¡åŒç†ï¼ŒåŒä¸€ä¸ªç¨‹åºä»32ä½æœºå™¨ä¸Šè¿ç§»åˆ°64ä½æœºå™¨ä¸Šï¼Œè™½ç„¶é€»è¾‘æ²¡å˜åŒ–ï¼Œä½†æ˜¯å†…å­˜å ç”¨ä¸Šä¼šç¿»å€ï¼ŒåŒæ—¶åœ¨æ•ˆç‡ä¸Šä¸ºäº†å­˜å‚¨å’Œè®¿é—®ä¸€ä¸ªNSNumberå¯¹è±¡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨å †ä¸Šä¸ºå®ƒåˆ†é…å†…å­˜ç»´æŠ¤å¼•ç”¨è®¡æ•°å™¨ï¼Œç®¡ç†å®ƒçš„ç”Ÿå‘½å‘¨æœŸï¼Œè¿™éƒ½å°†é€ æˆè¿è¡Œæ•ˆç‡ä¸Šçš„æŸå¤±ã€‚</p>
<h4 id="æ”¹è¿›æ–¹æ¡ˆ"><a href="#æ”¹è¿›æ–¹æ¡ˆ" class="headerlink" title="æ”¹è¿›æ–¹æ¡ˆ"></a>æ”¹è¿›æ–¹æ¡ˆ</h4><p>ä¸ºäº†æ”¹è¿›å†…å­˜å’Œæ•ˆç‡ä¸Šçš„é—®é¢˜ï¼Œè‹¹æœå¼•å…¥äº†Tagged Pointerï¼Œç”±äºNSNumberä¹‹ç±»çš„å˜é‡æœ¬èº«çš„å€¼éœ€è¦å ç”¨çš„å†…å­˜å¤§å°å¸¸å¸¸ä¸éœ€è¦8å­—èŠ‚ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªå¯¹è±¡æ‹†åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†ç›´æ¥ä¿å­˜æ•°æ®ï¼Œä¸€éƒ¨åˆ†ä½œä¸ºç‰¹æ®Šæ ‡è®°ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªç‰¹åˆ«çš„æŒ‡é’ˆä¸æŒ‡å‘ä»»ä½•ä¸€ä¸ªåœ°å€ã€‚</p>
<h3 id="Tagged-Pointerå®šä¹‰"><a href="#Tagged-Pointerå®šä¹‰" class="headerlink" title="Tagged Pointerå®šä¹‰"></a>Tagged Pointerå®šä¹‰</h3><h4 id="å®å®šä¹‰"><a href="#å®å®šä¹‰" class="headerlink" title="å®å®šä¹‰"></a>å®å®šä¹‰</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#if __LP64__</span><br><span class="line">#define OBJC_HAVE_TAGGED_POINTERS 1</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>64-bitï¼Œtagå­˜å‚¨åœ¨LSBï¼ˆLeast Significant Bitæœ€ä½ä½ï¼‰ã€‚å…¶ä»–æƒ…å†µæ¯”å¦‚çœŸæœºï¼Œtagå­˜å‚¨åœ¨MSBï¼ˆMost Significant Bitæœ€é«˜ä½ï¼‰</p>
<ul>
<li><code>MacOS</code>ä¸‹é‡‡ç”¨ LSBï¼ˆLeast Significant Bitï¼Œå³æœ€ä½æœ‰æ•ˆä½ï¼‰ä¸º<code>Tagged Pointer</code>æ ‡è¯†ä½ï¼›</li>
<li><code>iOS</code>ä¸‹åˆ™é‡‡ç”¨ MSBï¼ˆMost Significant Bitï¼Œå³æœ€é«˜æœ‰æ•ˆä½ï¼‰ä¸º<code>Tagged Pointer</code>æ ‡è¯†ä½ã€‚</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">#if (TARGET_OS_OSX || TARGET_OS_IOSMAC) &amp;&amp; __x86_64__</span><br><span class="line">    &#x2F;&#x2F; 64-bit Mac - tag bit is LSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 0</span><br><span class="line">#else</span><br><span class="line">    &#x2F;&#x2F; Everything else - tag bit is MSB</span><br><span class="line">#   define OBJC_MSB_TAGGED_POINTERS 1</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">#if OBJC_MSB_TAGGED_POINTERS</span><br><span class="line">#   define _OBJC_TAG_MASK (1UL&lt;&lt;63)</span><br><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 60</span><br><span class="line">#   define _OBJC_TAG_SLOT_SHIFT 60</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_LSHIFT 4</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_RSHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_MASK (0xfUL&lt;&lt;60)</span><br><span class="line">#   define _OBJC_TAG_EXT_INDEX_SHIFT 52</span><br><span class="line">#   define _OBJC_TAG_EXT_SLOT_SHIFT 52</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_LSHIFT 12</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_RSHIFT 12</span><br><span class="line">#else</span><br><span class="line">#   define _OBJC_TAG_MASK 1UL</span><br><span class="line">#   define _OBJC_TAG_INDEX_SHIFT 1</span><br><span class="line">#   define _OBJC_TAG_SLOT_SHIFT 0</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_LSHIFT 0</span><br><span class="line">#   define _OBJC_TAG_PAYLOAD_RSHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_MASK 0xfUL</span><br><span class="line">#   define _OBJC_TAG_EXT_INDEX_SHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_SLOT_SHIFT 4</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_LSHIFT 0</span><br><span class="line">#   define _OBJC_TAG_EXT_PAYLOAD_RSHIFT 12</span><br><span class="line">#endif</span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æ˜¯ä¸€ä¸ªæšä¸¾å®šä¹‰ï¼Œå®šä¹‰äº†é»˜è®¤ä½¿ç”¨äº†<code>Tagged Pointer</code>çš„ç±»ã€‚ä¾‹å¦‚NSStringã€NSNumberã€NSIndexPathã€NSDate</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __has_feature(objc_fixed_enum)  ||  __cplusplus &gt;= 201103L</span></span><br><span class="line"><span class="keyword">enum</span> <span class="keyword">objc_tag_index_t</span> : <span class="keyword">uint16_t</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">uint16_t</span> <span class="keyword">objc_tag_index_t</span>;</span><br><span class="line"><span class="keyword">enum</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 60-bit payloads</span></span><br><span class="line">    OBJC_TAG_NSAtom            = <span class="number">0</span>, </span><br><span class="line">    OBJC_TAG_1                 = <span class="number">1</span>, </span><br><span class="line">    OBJC_TAG_NSString          = <span class="number">2</span>, </span><br><span class="line">    OBJC_TAG_NSNumber          = <span class="number">3</span>, </span><br><span class="line">    OBJC_TAG_NSIndexPath       = <span class="number">4</span>, </span><br><span class="line">    OBJC_TAG_NSManagedObjectID = <span class="number">5</span>, </span><br><span class="line">    OBJC_TAG_NSDate            = <span class="number">6</span>,</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 60-bit reserved</span></span><br><span class="line">    OBJC_TAG_RESERVED_7        = <span class="number">7</span>, </span><br><span class="line"></span><br><span class="line">    <span class="comment">// 52-bit payloads</span></span><br><span class="line">    OBJC_TAG_Photos_1          = <span class="number">8</span>,</span><br><span class="line">    OBJC_TAG_Photos_2          = <span class="number">9</span>,</span><br><span class="line">    OBJC_TAG_Photos_3          = <span class="number">10</span>,</span><br><span class="line">    OBJC_TAG_Photos_4          = <span class="number">11</span>,</span><br><span class="line">    OBJC_TAG_XPC_1             = <span class="number">12</span>,</span><br><span class="line">    OBJC_TAG_XPC_2             = <span class="number">13</span>,</span><br><span class="line">    OBJC_TAG_XPC_3             = <span class="number">14</span>,</span><br><span class="line">    OBJC_TAG_XPC_4             = <span class="number">15</span>,</span><br><span class="line"></span><br><span class="line">    OBJC_TAG_First60BitPayload = <span class="number">0</span>, </span><br><span class="line">    OBJC_TAG_Last60BitPayload  = <span class="number">6</span>, </span><br><span class="line">    OBJC_TAG_First52BitPayload = <span class="number">8</span>, </span><br><span class="line">    OBJC_TAG_Last52BitPayload  = <span class="number">263</span>, </span><br><span class="line"></span><br><span class="line">    OBJC_TAG_RESERVED_264      = <span class="number">264</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> __has_feature(objc_fixed_enum)  &amp;&amp;  !defined(__cplusplus)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">enum</span> <span class="keyword">objc_tag_index_t</span> <span class="keyword">objc_tag_index_t</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h4 id="æ–¹æ³•å®šä¹‰"><a href="#æ–¹æ³•å®šä¹‰" class="headerlink" title="æ–¹æ³•å®šä¹‰"></a>æ–¹æ³•å®šä¹‰</h4><p>æ ¡éªŒæ˜¯å¦æ˜¯<code>tagged pointer</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">bool</span> </span><br><span class="line">_objc_isTaggedPointer(<span class="keyword">const</span> <span class="keyword">void</span> * _Nullable ptr)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">uintptr_t</span>)ptr &amp; _OBJC_TAG_MASK) == _OBJC_TAG_MASK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆä¸€ä¸ª<code>tagged pointer</code>ï¼Œæœ€é«˜å››ä½æ˜¯taggedï¼Œä½™ä¸‹æ˜¯æ•°æ®</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">void</span> * _Nonnull</span><br><span class="line">_objc_makeTaggedPointer(<span class="keyword">objc_tag_index_t</span> tag, <span class="keyword">uintptr_t</span> value)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// PAYLOAD_LSHIFT and PAYLOAD_RSHIFT are the payload extraction shifts.</span></span><br><span class="line">    <span class="comment">// They are reversed here for payload insertion.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// assert(_objc_taggedPointersEnabled());</span></span><br><span class="line">    <span class="keyword">if</span> (tag &lt;= OBJC_TAG_Last60BitPayload) &#123;</span><br><span class="line">        <span class="comment">// assert(((value &lt;&lt; _OBJC_TAG_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_LSHIFT) == value);</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> result =</span><br><span class="line">            (_OBJC_TAG_MASK | </span><br><span class="line">             ((<span class="keyword">uintptr_t</span>)tag &lt;&lt; _OBJC_TAG_INDEX_SHIFT) | </span><br><span class="line">             ((value &lt;&lt; _OBJC_TAG_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_PAYLOAD_LSHIFT));</span><br><span class="line">        <span class="keyword">return</span> _objc_encodeTaggedPointer(result);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// assert(tag &gt;= OBJC_TAG_First52BitPayload);</span></span><br><span class="line">        <span class="comment">// assert(tag &lt;= OBJC_TAG_Last52BitPayload);</span></span><br><span class="line">        <span class="comment">// assert(((value &lt;&lt; _OBJC_TAG_EXT_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_EXT_PAYLOAD_LSHIFT) == value);</span></span><br><span class="line">        <span class="keyword">uintptr_t</span> result =</span><br><span class="line">            (_OBJC_TAG_EXT_MASK |</span><br><span class="line">             ((<span class="keyword">uintptr_t</span>)(tag - OBJC_TAG_First52BitPayload) &lt;&lt; _OBJC_TAG_EXT_INDEX_SHIFT) |</span><br><span class="line">             ((value &lt;&lt; _OBJC_TAG_EXT_PAYLOAD_RSHIFT) &gt;&gt; _OBJC_TAG_EXT_PAYLOAD_LSHIFT));</span><br><span class="line">        <span class="keyword">return</span> _objc_encodeTaggedPointer(result);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»Tagged Pointerä¸­è·å–å€¼</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">objc_tag_index_t</span> </span><br><span class="line">_objc_getTaggedPointerTag(<span class="keyword">const</span> <span class="keyword">void</span> * _Nullable ptr) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// assert(_objc_isTaggedPointer(ptr));</span></span><br><span class="line">    <span class="keyword">uintptr_t</span> value = _objc_decodeTaggedPointer(ptr);</span><br><span class="line">    <span class="keyword">uintptr_t</span> basicTag = (value &gt;&gt; _OBJC_TAG_INDEX_SHIFT) &amp; _OBJC_TAG_INDEX_MASK;</span><br><span class="line">    <span class="keyword">uintptr_t</span> extTag =   (value &gt;&gt; _OBJC_TAG_EXT_INDEX_SHIFT) &amp; _OBJC_TAG_EXT_INDEX_MASK;</span><br><span class="line">    <span class="keyword">if</span> (basicTag == _OBJC_TAG_INDEX_MASK) &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">objc_tag_index_t</span>)(extTag + OBJC_TAG_First52BitPayload);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">objc_tag_index_t</span>)basicTag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h3><p>Tagged Pointerçš„å¼•å…¥ï¼Œç›´æ¥å°†å€¼å­˜å‚¨äºæŒ‡é’ˆæœ¬èº«ï¼Œä¸æ—¦å‡å°‘äº†å†…å­˜çš„å ç”¨ï¼Œè€Œä¸”å®ƒä¸å­˜åœ¨åœ¨å †ä¸­ï¼Œä¹Ÿä¸éœ€è¦mallocå’Œfreeï¼Œè¿˜æé«˜äº†è¿è¡Œæ•ˆç‡ã€‚</p>
<p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨ WWDC2013 çš„ã€ŠSession 404 Advanced in Objective-Cã€‹è§†é¢‘ä¸­ï¼Œçœ‹åˆ°è‹¹æœå¯¹äº<code>Tagged Pointer</code>ç‰¹ç‚¹çš„ä»‹ç»ï¼š</p>
<ul>
<li>Tagged Pointerä¸“é—¨ç”¨äºå­˜å‚¨å°çš„å¯¹è±¡ï¼Œä¾‹å¦‚NSNumberã€NSSting</li>
<li>Tagged Pointerçš„å€¼ä¸å†æ˜¯åœ°å€ï¼Œè€Œæ˜¯çœŸæ­£çš„å€¼ï¼Œæ‰€ä»¥ï¼Œå®ƒå®é™…ä¸å†æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªæŠ«ç€å¯¹è±¡çš®çš„æŒ‡é’ˆï¼Œæ‰€ä»¥å®ƒå¹¶ä¸å­˜å‚¨åœ¨å †ä¸­ï¼Œä¹Ÿä¸éœ€è¦mallocå’Œfree</li>
<li>åœ¨å†…å­˜è¯»å–ä¸Šæœ‰ç€3å€çš„é€Ÿåº¦ï¼Œåˆ›å»ºæ—¶ä¹Ÿæ¯”ä¹‹å‰å¿«106å€</li>
</ul>
<h5 id="å…³é—­tagged-pointerçš„æ•°æ®æ··æ·†"><a href="#å…³é—­tagged-pointerçš„æ•°æ®æ··æ·†" class="headerlink" title="å…³é—­tagged pointerçš„æ•°æ®æ··æ·†"></a>å…³é—­tagged pointerçš„æ•°æ®æ··æ·†</h5><p>åœ¨ç°åœ¨çš„ç‰ˆæœ¬ä¸­ï¼Œä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨ï¼Œè‹¹æœå¯¹tagged pointåšäº†æ•°æ®æ··æ·†ï¼Œå¼€å‘è€…é€šè¿‡æ‰“å°æŒ‡é’ˆæ— æ³•åˆ¤æ–­ä»–æ˜¯ä¸æ˜¯ä¸€ä¸ªtagged pointerï¼Œæ›´æ— æ³•è¯»å–å…¶å­˜å‚¨çš„æ•°æ®ã€‚</p>
<p>åœ¨åˆ†ætagged pointerä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŠŠ<code>tagged pointer</code>æ•°æ®æ··æ·†å…³é—­ï¼Œä»¥æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œè°ƒè¯•ã€‚é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡<code>OBJC_DISABLE_TAG_OBFUSCATION</code>ä¸º<code>YES</code></p>
<h4 id="iOSåº”ç”¨ä¸¾ä¾‹"><a href="#iOSåº”ç”¨ä¸¾ä¾‹" class="headerlink" title="iOSåº”ç”¨ä¸¾ä¾‹"></a>iOSåº”ç”¨ä¸¾ä¾‹</h4><h5 id="NSNumberåº”ç”¨"><a href="#NSNumberåº”ç”¨" class="headerlink" title="NSNumberåº”ç”¨"></a>NSNumberåº”ç”¨</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">NSNumber *charNumber &#x3D; [NSNumber numberWithChar:&#39;1&#39;];</span><br><span class="line">NSNumber *shortNumber &#x3D; [NSNumber numberWithShort:1];</span><br><span class="line">NSNumber *intNumber &#x3D; [NSNumber numberWithInt:1];</span><br><span class="line">NSNumber *floatNumber &#x3D; [NSNumber numberWithFloat:1.0];</span><br><span class="line">NSNumber *longNumber &#x3D; [NSNumber numberWithLong:1];</span><br><span class="line">NSNumber *doubleNumber &#x3D; [NSNumber numberWithDouble:1.0];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¾“å‡ºå˜é‡çš„æŒ‡é’ˆåœ°å€ï¼š</span><br><span class="line">&#x2F;&#x2F; charNumber 0xb000000000000310</span><br><span class="line">&#x2F;&#x2F; shortNumber 0xb000000000000011</span><br><span class="line">&#x2F;&#x2F; intNumber 0xb000000000000012</span><br><span class="line">&#x2F;&#x2F; floatNumber 0xb000000000000014</span><br><span class="line">&#x2F;&#x2F; longNumber 0xb000000000000013</span><br><span class="line">&#x2F;&#x2F; doubleNumber 0xb000000000000015</span><br></pre></td></tr></table></figure>

<p><img src="/Users/mikasa/Desktop/image_mark/image-20201028113927598.png" alt="image-20201028113927598"></p>
<p>è§„å¾‹éƒ½æ˜¯ä»¥0xb(1011å¼€å¤´)</p>
<ul>
<li>æœ€é«˜ä½æ˜¯1ï¼Œè¯´æ˜æŒ‡é’ˆæ˜¯ä¸€ä¸ªTagged Pointerç±»å‹</li>
<li>ç¬¬61-63ä½æ˜¯11ï¼ˆåè¿›åˆ¶å¯¹åº”çš„æ˜¯3ï¼‰ï¼Œæ ¹æ®ä¸Šè¯‰æšä¸¾å®šä¹‰ä¹Ÿå°±æ˜¯ï¼ˆOBJC_TAG_NSNumberï¼‰</li>
<li>ç¬¬1-4ä½æ˜¯NSNumberç±»å‹ï¼Œæ¯”å¦‚charæ˜¯0 shortæ˜¯1ï¼Œintæ˜¯2ï¼Œfloatæ˜¯4ï¼Œlongæ˜¯3ï¼Œdoubleæ˜¯5</li>
<li>å‰©ä¸‹56ä½å°±æ˜¯çœŸæ­£çš„å€¼äº†</li>
</ul>
<p><img src="/Users/mikasa/Desktop/image_mark/zufmtqnvbq.png" alt="zufmtqnvbq"></p>
<h5 id="NSStringåº”ç”¨"><a href="#NSStringåº”ç”¨" class="headerlink" title="NSStringåº”ç”¨"></a>NSStringåº”ç”¨</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NSString *str1 &#x3D; [NSString stringWithFormat:@&quot;a&quot;];</span><br><span class="line">NSString *str2 &#x3D; [NSString stringWithFormat:@&quot;ab&quot;];</span><br><span class="line"></span><br><span class="line">&#x2F;&#x2F; è¾“å‡ºå˜é‡çš„æŒ‡é’ˆåœ°å€ï¼š</span><br><span class="line">&#x2F;&#x2F; str1: 0xa000000000000611</span><br><span class="line">&#x2F;&#x2F; str2: 0xa000000000062612</span><br></pre></td></tr></table></figure>

<p><img src="/Users/mikasa/Desktop/image_mark/image-20201028114331053.png" alt="image-20201028114331053"></p>
<p>ä¸NSNumberç±»ä¼¼</p>
<ul>
<li>æœ€é«˜ä½æ˜¯1ï¼Œè¯´æ˜æŒ‡é’ˆæ˜¯ä¸€ä¸ªTagged Pointerç±»å‹</li>
<li>ç¬¬61-63ä½æ˜¯10ï¼ˆå¯¹åº”çš„åè¿›åˆ¶æ˜¯2ï¼‰ï¼Œæ ¹æ®ä¸Šè¿°æšä¸¾å®šä¹‰ç±»å‹ä¹Ÿå°±æ˜¯OBJC_TAG_NSString</li>
<li>ç¬¬1-4ä½æ˜¯å­—ç¬¦ä¸²é•¿åº¦</li>
<li>å‰©ä¸‹çš„56ä½å°±æ˜¯çœŸæ­£çš„å€¼äº†</li>
</ul>
<p>è¿›ä¸€æ­¥æ‰©å±•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">NSString *a &#x3D; @&quot;a&quot;;</span><br><span class="line">NSMutableString *b &#x3D; [a mutableCopy];</span><br><span class="line">NSString *c &#x3D; [a copy];</span><br><span class="line">NSString *d &#x3D; [[a mutableCopy] copy];</span><br><span class="line">NSString *e &#x3D; [NSString stringWithString:a];</span><br><span class="line">NSString *f &#x3D; [NSString stringWithFormat:@&quot;f&quot;];</span><br><span class="line">NSString *string1 &#x3D; [NSString stringWithFormat:@&quot;abcdefg&quot;];</span><br><span class="line">NSString *string2 &#x3D; [NSString stringWithFormat:@&quot;abcdefghi&quot;];</span><br><span class="line">NSString *string3 &#x3D; [NSString stringWithFormat:@&quot;abcdefghij&quot;];</span><br><span class="line"></span><br><span class="line">&#x2F;* MacOSæ‰“å°ç»“æœ</span><br><span class="line">a: 0x100002038, __NSCFConstantString, 18446744073709551615</span><br><span class="line">b: 0x10071f3c0, __NSCFString, 1</span><br><span class="line">c: 0x100002038, __NSCFConstantString, 18446744073709551615</span><br><span class="line">d: 0x6115, NSTaggedPointerString, 18446744073709551615</span><br><span class="line">e: 0x100002038, __NSCFConstantString, 18446744073709551615</span><br><span class="line">f: 0x6615, NSTaggedPointerString, 18446744073709551615</span><br><span class="line">string1: 0x6766656463626175, NSTaggedPointerString, 18446744073709551615</span><br><span class="line">string2: 0x880e28045a54195, NSTaggedPointerString, 18446744073709551615</span><br><span class="line">string3: 0x10071f6d0, __NSCFString, 1 *&#x2F;</span><br></pre></td></tr></table></figure>

<p>ä»æ‰“å°ç»“æœæ¥çœ‹ï¼Œæœ‰ä¸‰ç§NSStringç±»å‹ï¼š</p>
<table>
<thead>
<tr>
<th align="left">ç±»å‹</th>
<th align="left">æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td align="left">__NSCFConstantString</td>
<td align="left">å¸¸é‡å­—ç¬¦ä¸²ï¼Œå­˜å‚¨åœ¨å­—ç¬¦ä¸²å¸¸é‡åŒºï¼Œç»§æ‰¿äº __NSCFStringã€‚ç›¸åŒå†…å®¹çš„ __NSCFConstantString å¯¹è±¡çš„åœ°å€ç›¸åŒï¼Œä¹Ÿå°±æ˜¯è¯´å¸¸é‡å­—ç¬¦ä¸²å¯¹è±¡æ˜¯ä¸€ç§å•ä¾‹ï¼Œå¯ä»¥é€šè¿‡ == åˆ¤æ–­å­—ç¬¦ä¸²å†…å®¹æ˜¯å¦ç›¸åŒã€‚2. è¿™ç§å¯¹è±¡ä¸€èˆ¬é€šè¿‡å­—é¢å€¼@â€â€¦â€åˆ›å»ºã€‚å¦‚æœä½¿ç”¨ __NSCFConstantString æ¥åˆå§‹åŒ–ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™ä¸ªå­—ç¬¦ä¸²ä¹Ÿæ˜¯ç›¸åŒçš„ __NSCFConstantStringã€‚</td>
</tr>
<tr>
<td align="left">__NSCFString</td>
<td align="left">å­˜å‚¨åœ¨å †åŒºï¼Œéœ€è¦ç»´æŠ¤å…¶å¼•ç”¨è®¡æ•°ï¼Œç»§æ‰¿äº NSMutableStringã€‚2. é€šè¿‡stringWithFormat:ç­‰æ–¹æ³•åˆ›å»ºçš„NSStringå¯¹è±¡ï¼ˆä¸”å­—ç¬¦ä¸²å€¼è¿‡å¤§æ— æ³•ä½¿ç”¨Tagged Pointerå­˜å‚¨ï¼‰ä¸€èˆ¬éƒ½æ˜¯è¿™ç§ç±»å‹ã€‚</td>
</tr>
<tr>
<td align="left">NSTaggedPointerString</td>
<td align="left">Tagged Pointerï¼Œå­—ç¬¦ä¸²çš„å€¼ç›´æ¥å­˜å‚¨åœ¨äº†æŒ‡é’ˆä¸Šã€‚</td>
</tr>
</tbody></table>
<p>æ‰“å°ç»“æœåˆ†æï¼š</p>
<table>
<thead>
<tr>
<th align="left">NSString å¯¹è±¡</th>
<th align="left">ç±»å‹</th>
<th align="left">åˆ†æ</th>
</tr>
</thead>
<tbody><tr>
<td align="left">a</td>
<td align="left">__NSCFConstantString</td>
<td align="left">é€šè¿‡å­—é¢é‡@â€â€¦â€åˆ›å»º</td>
</tr>
<tr>
<td align="left">b</td>
<td align="left">__NSCFString</td>
<td align="left">a çš„æ·±æ‹·è´ï¼ŒæŒ‡å‘ä¸åŒçš„å†…å­˜åœ°å€ï¼Œè¢«æ‹·è´åˆ°å †åŒº</td>
</tr>
<tr>
<td align="left">c</td>
<td align="left">__NSCFConstantString</td>
<td align="left">a çš„æµ…æ‹·è´ï¼ŒæŒ‡å‘åŒä¸€å—å†…å­˜åœ°å€</td>
</tr>
<tr>
<td align="left">d</td>
<td align="left">NSTaggedPointerString</td>
<td align="left">å•ç‹¬å¯¹ a è¿›è¡Œ copyï¼ˆå¦‚ cï¼‰ï¼Œæµ…æ‹·è´æ˜¯æŒ‡å‘åŒä¸€å—å†…å­˜åœ°å€ï¼Œæ‰€ä»¥ä¸ä¼šäº§ç”ŸTagged Pointerï¼›å•ç‹¬å¯¹ a è¿›è¡Œ mutableCopyï¼ˆå¦‚ bï¼‰ï¼Œå¤åˆ¶å‡ºæ¥æ˜¯å¯å˜å¯¹è±¡ï¼Œå†…å®¹å¤§å°å¯ä»¥æ‰©å±•ï¼›è€ŒTagged Pointerå­˜å‚¨çš„å†…å®¹å¤§å°æœ‰é™ï¼Œå› æ­¤æ— æ³•æ»¡è¶³å¯å˜å¯¹è±¡çš„å­˜å‚¨è¦æ±‚ã€‚</td>
</tr>
<tr>
<td align="left">e</td>
<td align="left">__NSCFConstantString</td>
<td align="left">ä½¿ç”¨ __NSCFConstantString æ¥åˆå§‹åŒ–çš„å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td align="left">f</td>
<td align="left">NSTaggedPointerString</td>
<td align="left">é€šè¿‡stringWithFormat:æ–¹æ³•åˆ›å»ºï¼ŒæŒ‡é’ˆè¶³å¤Ÿå­˜å‚¨å­—ç¬¦ä¸²çš„å€¼ã€‚</td>
</tr>
<tr>
<td align="left">string1</td>
<td align="left">NSTaggedPointerString</td>
<td align="left">é€šè¿‡stringWithFormat:æ–¹æ³•åˆ›å»ºï¼ŒæŒ‡é’ˆè¶³å¤Ÿå­˜å‚¨å­—ç¬¦ä¸²çš„å€¼ã€‚</td>
</tr>
<tr>
<td align="left">string2</td>
<td align="left">NSTaggedPointerString</td>
<td align="left">é€šè¿‡stringWithFormat:æ–¹æ³•åˆ›å»ºï¼ŒæŒ‡é’ˆè¶³å¤Ÿå­˜å‚¨å­—ç¬¦ä¸²çš„å€¼ã€‚</td>
</tr>
<tr>
<td align="left">string3</td>
<td align="left">__NSCFString</td>
<td align="left">é€šè¿‡stringWithFormat:æ–¹æ³•åˆ›å»ºï¼ŒæŒ‡é’ˆä¸è¶³å¤Ÿå­˜å‚¨å­—ç¬¦ä¸²çš„å€¼ã€‚</td>
</tr>
</tbody></table>
<p><img src="/Users/mikasa/Desktop/image_mark/cj0aj4o1ul.png" alt="cj0aj4o1ul"></p>
<p>åœ¨objc4æºç ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šåœ¨å‡½æ•°ä¸­çœ‹è§tagged pointerã€‚æ¯”å¦‚objc_msgSendå‡½æ•°ï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/********************************************************************</span><br><span class="line"> *</span><br><span class="line"> * id objc_msgSend(id self, SEL _cmd, ...);</span><br><span class="line"> * IMP objc_msgLookup(id self, SEL _cmd, ...);</span><br><span class="line"> * </span><br><span class="line"> * objc_msgLookup ABI:</span><br><span class="line"> * IMP returned in x17</span><br><span class="line"> * x16 reserved for our use but not used</span><br><span class="line"> *</span><br><span class="line"> ********************************************************************/</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> SUPPORT_TAGGED_POINTERS</span></span><br><span class="line">	.data</span><br><span class="line">	.align 3</span><br><span class="line">	.globl _objc_debug_taggedpointer_classes</span><br><span class="line">_objc_debug_taggedpointer_classes:</span><br><span class="line">	.fill 16, 8, 0</span><br><span class="line">	.globl _objc_debug_taggedpointer_ext_classes</span><br><span class="line">_objc_debug_taggedpointer_ext_classes:</span><br><span class="line">	.fill 256, 8, 0</span><br><span class="line"><span class="meta">#</span><span class="bash">endif</span></span><br><span class="line"></span><br><span class="line">	ENTRY _objc_msgSend</span><br><span class="line">	UNWIND _objc_msgSend, NoFrame</span><br><span class="line"></span><br><span class="line">	cmp	p0, #0			// nil check and tagged pointer check</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">if</span> SUPPORT_TAGGED_POINTERS</span></span><br><span class="line">	b.le	LNilOrTagged		//  (MSB tagged pointer looks negative)</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="keyword">else</span></span></span><br><span class="line">	b.eq	LReturnZero</span><br><span class="line"><span class="meta">#</span><span class="bash">endif</span></span><br><span class="line">	ldr	p13, [x0]		// p13 = isa</span><br><span class="line">	GetClassFromIsa_p16 p13		// p16 = class</span><br><span class="line">LGetIsaDone:</span><br><span class="line">	CacheLookup NORMAL		// calls imp or objc_msgSend_uncached</span><br></pre></td></tr></table></figure>

<p><code>objc_msgSend</code>å‡½æ•°èƒ½å¤Ÿè¯†åˆ«<code>tagged pointer</code>ï¼Œæ¯”å¦‚<code>NSNumber</code>çš„<code>intValue</code>æ–¹æ³•ï¼Œç›´æ¥ä»æŒ‡é’ˆæå–æ•°æ®ï¼Œä¸ä¼šè¿›è¡Œ<code>objc_msgSend</code>çš„ä¸‰å¤§æµç¨‹ï¼ŒèŠ‚çœäº†è°ƒç”¨å¼€é”€ã€‚</p>
<p>å†…å­˜ç®¡ç†ç›¸å…³ï¼Œå¦‚<code>retain</code>æ–¹æ³•ä¸­çš„<code>rootRetain</code>ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ALWAYS_INLINE id </span><br><span class="line">objc_object::rootRetain(bool tryRetain, bool handleOverflow)</span><br><span class="line">&#123;</span><br><span class="line">    if (isTaggedPointer()) return (id)this;</span><br><span class="line">    â€¦â€¦</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿›è¡Œåˆ¤æ–­æ˜¯å¦æ˜¯tagged pointerä¼ªå¯¹è±¡</p>
<h4 id="Tagged-Pointeræ³¨æ„ç‚¹"><a href="#Tagged-Pointeræ³¨æ„ç‚¹" class="headerlink" title="Tagged Pointeræ³¨æ„ç‚¹"></a>Tagged Pointeræ³¨æ„ç‚¹</h4><p>å‰é¢çŸ¥é“ï¼Œtagged pointerå¹¶ä¸æ˜¯çœŸæ­£çš„å¯¹è±¡ï¼Œå®ƒæ²¡æœ‰isaæŒ‡é’ˆï¼Œæ‰€ä»¥ç›´æ¥è®¿é—®tagged pointerçš„isaæˆå‘˜çš„è¯ï¼Œåœ¨ç¼–è¯‘å™¨å°±ä¼šå‡ºç°è­¦å‘Šã€‚</p>
<p><strong>æ‰§è¡Œä»¥ä¸‹ä¸¤æ®µå¾…ä¼šï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼Ÿ</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (void)mm_tagged_no_pointer &#123;</span><br><span class="line">    dispatch_queue_t queue &#x3D; dispatch_get_global_queue(0, 0);</span><br><span class="line">    for (int i &#x3D; 0; i &lt; 1000; i++) &#123;</span><br><span class="line">        dispatch_async(queue, ^&#123;</span><br><span class="line">            self.name &#x3D; [NSString stringWithFormat:@&quot;abcdefghi1&quot;];</span><br><span class="line">            NSLog(@&quot;%p---%@&quot;,self.name,[self.name class]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼ŒCrash</p>
<figure class="highlight objc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">- (<span class="keyword">void</span>)mm_tagged_pointer &#123;</span><br><span class="line">    <span class="built_in">dispatch_queue_t</span> queue = dispatch_get_global_queue(<span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">        <span class="built_in">dispatch_async</span>(queue, ^&#123;</span><br><span class="line">            <span class="keyword">self</span>.name = [<span class="built_in">NSString</span> stringWithFormat:<span class="string">@"abcdefghi"</span>];</span><br><span class="line">            <span class="built_in">NSLog</span>(<span class="string">@"%p---%@"</span>,<span class="keyword">self</span>.name,[<span class="keyword">self</span>.name <span class="keyword">class</span>]);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œç»“æœï¼Œæ­£å¸¸</p>
<p>åˆ†åˆ«æ‰“å°ä¸¤æ®µä»£ç ä¸­çš„<code>self.name</code>ï¼Œå¯ä»¥å‘ç°ç¬¬ä¸€æ®µä»£ç ä¸­çš„<code>self.name</code>ç±»å‹ä¸º<code>CFString</code> ï¼Œç¬¬äºŒæ®µä»£ç ä¸­çš„ç±»å‹ä¸º<code>NSTaggedPointerString</code>ã€‚</p>
<p><img src="/Users/mikasa/Desktop/image_mark/image-20201028161517267.png" alt="image-20201028161517267"></p>
<p>è§‚å¯Ÿä¸€ä¸‹Crashå´©æºƒå‡½æ•°è°ƒç”¨ä¿¡æ¯ï¼Œä¸éš¾å‘ç°ï¼Œåœ¨çº¿ç¨‹é€€å‡ºçš„æ—¶å€™ï¼Œä¼šå¯¹å½“å‰çº¿ç¨‹ä¸­çš„TSDæ•°æ®ï¼ˆ<code>Autoreleasepool</code>åŠæ”¾å…¥å…¶ä¸­çš„å¯¹è±¡è¿›è¡Œ<code>release</code>ï¼‰ï¼Œå¤šæ¡çº¿ç¨‹å¹¶å‘æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯èƒ½å°±ä¼šå‡ºç°å¯¹ä¸€ä¸ªå¯¹è±¡å¤šæ¬¡è°ƒç”¨<code>release</code>é€ æˆå¯¹è±¡è¿‡åº¦é‡Šæ”¾ï¼Œå¯¼è‡´Crash</p>
<p><strong>è§£å†³åŠæ³•ï¼ˆä¿è¯å¤šçº¿ç¨‹æ•°æ®å®‰å…¨ï¼‰ï¼š</strong></p>
<ul>
<li>ä½¿ç”¨atomicå±æ€§å…³é”®å­—</li>
<li>åŠ é”</li>
<li>é˜Ÿåˆ—ä¸²è¡Œè®¿é—®</li>
<li>ä¿¡å·é‡</li>
</ul>
<p>è€Œç¬¬äºŒæ®µä»£ç ä¸­çš„NSStringç±»å‹ä¸º<code>NSTaggedPointerString</code>ç±»å‹ï¼Œåœ¨objc_releaseå‡½æ•°ä¼šåˆ¤æ–­æ˜¯å¦æ˜¯TaggedPointerç±»å‹ï¼Œæ˜¯çš„è¯å°±ä¸ä¼šè¿›è¡Œreleaseæ“ä½œï¼Œä¹Ÿå°±é¿å…äº†å› è¿‡åº¦é‡Šæ”¾å¯¹è±¡è€Œå¯¼è‡´çš„Crashã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> </span><br><span class="line">objc_release(id obj)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (!obj) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (obj-&gt;isTaggedPointer()) <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">return</span> obj-&gt;<span class="built_in">release</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="en">
    <link itemprop="mainEntityOfPage" href="https://dorisgit.github.io/2020/10/23/AutoreleasePool/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Doris AI">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="æ³¡æ³¡èŒ¶å£¶">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2020/10/23/AutoreleasePool/" class="post-title-link" itemprop="url">AutoreleasePool</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-10-23 14:18:49" itemprop="dateCreated datePublished" datetime="2020-10-23T14:18:49+08:00">2020-10-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-10-26 17:24:32" itemprop="dateModified" datetime="2020-10-26T17:24:32+08:00">2020-10-26</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h4 id="ARCå’ŒMRCä¸‹çš„autoreleasepool"><a href="#ARCå’ŒMRCä¸‹çš„autoreleasepool" class="headerlink" title="ARCå’ŒMRCä¸‹çš„autoreleasepool"></a>ARCå’ŒMRCä¸‹çš„autoreleasepool</h4><h5 id="MRCä¸­çš„autoreleasepool"><a href="#MRCä¸­çš„autoreleasepool" class="headerlink" title="MRCä¸­çš„autoreleasepool"></a>MRCä¸­çš„autoreleasepool</h5><p>åœ¨MRCç¯å¢ƒä¸‹ï¼Œå½“æˆ‘ä»¬åˆ›å»ºå’Œé‡Šæ”¾ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œéœ€æ‰‹åŠ¨ç®¡ç†å™¨å†…å­˜å‘¨æœŸï¼Œè°ƒç”¨<code>retain</code> å’Œ <code>release</code>æˆ–autoreleaseæ–¹æ³•æ¥é‡Šæ”¾å®ƒã€‚è°ƒç”¨retainä¼šè®©è®¡æ•°å™¨+1ï¼Œè°ƒç”¨<code>release</code>ä¼šè®©è®¡æ•°å™¨-1ï¼Œå½“å¯¹è±¡è®¡æ•°å™¨ä¸º0æ—¶ï¼Œå°±ä¼šè¢«é‡Šæ”¾ã€‚è°ƒç”¨<code>autorelease</code>çš„å¯¹è±¡ä¼šè¢«æ·»åŠ åˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼Œå®ƒä¼šåœ¨ä¸€ä¸ªåˆé€‚çš„æ—¶å€™ï¼ˆä¸‹æ–‡ï¼‰ä¸ºå¯¹è±¡è°ƒç”¨<code>release</code>äººï¼Œæ‰€ä»¥åŠ å…¥åˆ°<code>autorelease</code>ä¸­çš„å¯¹è±¡ä¼šè¢«å»¶è¿Ÿé‡Šæ”¾ã€‚</p>
<p><strong>release</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">NS_INLINE void _addAutoReleasePool1() &#123;</span><br><span class="line">    __weak MMPerson *person2 &#x3D; nil;</span><br><span class="line">    &#123;</span><br><span class="line">        MMPerson *person &#x3D; [[MMPerson alloc] init];</span><br><span class="line">        [person retain];</span><br><span class="line">        </span><br><span class="line">        person2 &#x3D; person;</span><br><span class="line">        [person release]</span><br><span class="line">    &#125;</span><br><span class="line">    NSLog(@&quot;%@&quot;,person2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“å°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">person dealloc</span><br><span class="line">(null)</span><br></pre></td></tr></table></figure>

<p><strong>autorelease</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NS_INLINE void _addAutoReleasePool1() &#123;</span><br><span class="line">    __weak MMPerson *person2 &#x3D; nil;</span><br><span class="line">    &#123;</span><br><span class="line">        MMPerson *person &#x3D; [[[MMPerson alloc] init] autoreleasepool];</span><br><span class="line">        person2 &#x3D; person;</span><br><span class="line">    &#125;</span><br><span class="line">    NSLog(@&quot;%@&quot;,person2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“å°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">person</span><br><span class="line">person dealloc</span><br></pre></td></tr></table></figure>

<p>å±€éƒ¨å˜é‡personè°ƒç”¨releaseåä¼šè¢«ç«‹å³é‡Šæ”¾ï¼Œè€Œå°†å¯¹è±¡åŠ å…¥åˆ°autoreleasepoolä¸­ä¸ä¼šç«‹å³é‡Šæ”¾ï¼Œé‡Šæ”¾æ—¶æœºè¢«å»¶è¿Ÿäº†ã€‚</p>
<h5 id="ARCä¸­autoreleasepool"><a href="#ARCä¸­autoreleasepool" class="headerlink" title="ARCä¸­autoreleasepool"></a>ARCä¸­autoreleasepool</h5><p>è‹¹æœåœ¨iOS5ä¸­å¼•å…¥äº†ARCï¼ˆAutomatic Reference Countingï¼‰è‡ªåŠ¨å¼•ç”¨è®¡æ•°å™¨ç®¡ç†æŠ€æœ¯ï¼Œé€šè¿‡LLVMç¼–è¯‘å™¨å’ŒRuntimeæœºåä½œè¿›è¡Œè‡ªåŠ¨ç®¡ç†å†…å­˜ã€‚LLVMä¼šåœ¨ç¼–è¯‘æ—¶åœ¨åˆé€‚çš„åœ°æ–¹ä¸ºOCå¯¹è±¡æ’å…¥retainã€releaseå’Œautoreleasepoolä»£ç ã€‚</p>
<p><strong>é€šè¿‡allocã€copyã€mutableCopyå’Œnewæ–¹å¼åˆ›å»ºå¯¹è±¡</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NS_INLINE void _addAutoReleasePool1() &#123;</span><br><span class="line">    __weak MMPerson *person2 &#x3D; nil;</span><br><span class="line">    &#123;</span><br><span class="line">        MMPerson *person &#x3D; [MMPerson new];</span><br><span class="line">        person2 &#x3D; person;</span><br><span class="line">    &#125;</span><br><span class="line">    NSLog(@&quot;%@&quot;,person2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹ï¼Œå¯¹è±¡å‡ºäº†ä½œç”¨åŸŸç«‹å³è¢«é‡Šæ”¾äº†ï¼Œç¼–è¯‘æ—¶æ’å…¥äº†release</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[20:53:54] -[MMPerson dealloc] [ç¬¬22è¡Œ] ğŸ’• MMPerson dealloc</span><br><span class="line">[20:53:54] _addAutoReleasePool1 [ç¬¬49è¡Œ] ğŸ’• (null)</span><br></pre></td></tr></table></figure>

<p><strong>é€šè¿‡ç³»ç»Ÿæä¾›å·¥å‚æ–¹æ³•åˆ›å»ºå¯¹è±¡</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">NS_INLINE void _addAutoReleasePool2() &#123;</span><br><span class="line">    __weak MMPerson *person2 &#x3D; nil;</span><br><span class="line">    &#123;</span><br><span class="line">        MMPerson *person &#x3D; [MMPerson buttonWithType:UIButtonTypeSystem];</span><br><span class="line">        person2 &#x3D; person;</span><br><span class="line">    &#125;</span><br><span class="line">    NSLog(@&quot;%@&quot;,person2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»“æœå¦‚ä¸‹ï¼Œå¯¹è±¡è¶…å‡ºäº†å…¶ä½œç”¨åŸŸè¿˜æ˜¯å­˜åœ¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´èµ·å†…éƒ¨è°ƒç”¨äº†autoreleaseæ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[20:53:54] _addAutoReleasePool2 [ç¬¬58è¡Œ] ğŸ’• &lt;MMPerson: 0x7fdbad51fe90; baseClass &#x3D; UIButton; frame &#x3D; (0 0; 0 0); opaque &#x3D; NO; layer &#x3D; &lt;CALayer: 0x6000002e6fc0&gt;&gt;</span><br><span class="line">[20:53:54] -[MMPerson dealloc] [ç¬¬22è¡Œ] ğŸ’• MMPerson dealloc</span><br></pre></td></tr></table></figure>

<p><strong>æ€»ç»“ï¼š</strong></p>
<p>ä»¥ <code>alloc</code>, <code>copy</code>, ,<code>mutableCopy</code>å’Œ<code>new</code>è¿™äº›æ–¹æ³•ä¼šè¢«é»˜è®¤æ ‡è®°ä¸º <code>__attribute((ns_returns_retained))</code> ï¼Œä»¥è¿™äº›æ–¹æ³•åˆ›å»ºçš„å¯¹è±¡,ç¼–è¯‘å™¨åœ¨ä¼šåœ¨è°ƒç”¨æ–¹æ³•å¤–å›´è¦åŠ ä¸Šå†…å­˜ç®¡ç†ä»£ç <code>retain/release</code>ï¼Œæ‰€ä»¥å…¶åœ¨ä½œç”¨åŸŸç»“æŸçš„æ—¶å€™å°±ä¼šé‡Šæ”¾ï¼Œè€Œä¸ä»¥è¿™äº›å…³é”®å­—å¼€å¤´çš„æ–¹æ³•ï¼Œä¼šè¢«é»˜è®¤æ ‡è®°ä¸º<code>__attribute((ns_returns_not_retained))</code>,ç¼–è¯‘å™¨ä¼šåœ¨æ–¹æ³•å†…éƒ¨è‡ªåŠ¨åŠ ä¸Š<code>autorelease</code>æ–¹æ³•ï¼Œè¿™æ—¶åˆ›å»ºçš„å¯¹è±¡å°±ä¼šè¢«æ³¨å†Œåˆ°è‡ªåŠ¨é‡Šæ”¾æ± ä¸­ï¼ŒåŒæ—¶å…¶é‡Šæ”¾ä¼šå»¶è¿Ÿï¼Œç­‰åˆ°è‡ªåŠ¨é‡Šæ”¾æ± é”€æ¯çš„æ—¶å€™æ‰é‡Šæ”¾ã€‚</p>
<h4 id="mainå…¥å£å‡½æ•°ä¸­çš„-autoreleasepool"><a href="#mainå…¥å£å‡½æ•°ä¸­çš„-autoreleasepool" class="headerlink" title="mainå…¥å£å‡½æ•°ä¸­çš„@autoreleasepool"></a>mainå…¥å£å‡½æ•°ä¸­çš„@autoreleasepool</h4><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹Xcode11ç‰ˆæœ¬ä¸­çš„main()å‡½æ•°ï¼Œä¸ä¹‹å‰ç‰ˆæœ¬çš„åŒºåˆ«</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Xcode 11</span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    NSString * appDelegateClassName;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        &#x2F;&#x2F; Setup code that might create autoreleased objects goes here.</span><br><span class="line">        appDelegateClassName &#x3D; NSStringFromClass([AppDelegate class]);</span><br><span class="line">    &#125;</span><br><span class="line">    return UIApplicationMain(argc, argv, nil, appDelegateClassName);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F; Xcode æ—§ç‰ˆæœ¬</span><br><span class="line">int main(int argc, char * argv[]) &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        return UIApplicationMain(argc, argv, nil, NSStringFromClass([AppDelegate class]));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>å€¼å¾—æ³¨æ„çš„ç‚¹æ˜¯</strong>ï¼ŒXcode11ä¹‹å‰æ˜¯å°†æ•´ä¸ªåº”ç”¨ç¨‹åºæ”¾åœ¨<code>@autoreleasepool</code>ä¸­ï¼Œç”±äº<code>runloop</code>çš„å­˜åœ¨ï¼Œè¦ç¨‹åºç»“æŸå<code>@autoreleasepool</code>ä½œç”¨åŸŸæ‰ä¼šç»“æŸï¼Œè¿™ä¹Ÿæ„å‘³ç€ç¨‹åºç»“æŸå<code>main</code>å‡½æ•°ä¸­çš„<code>@autoreleasepool</code>ä¸­çš„<code>autoreleasepool</code>å¯¹è±¡æ‰ä¼šé‡Šæ”¾</p>
<p>Xcode11ä¹‹åï¼Œè§¦å‘ä¸»çº¿ç¨‹çš„<code>UIApplicationMain</code>å‡½æ•°è¢«æ”¾ç½®åœ¨<code>@autoreleasepool</code>ä¹‹å¤–ï¼Œè¿™å¯ä»¥ä¿è¯<code>@autoreleasepool</code>ä¸­çš„autoreleasepoolå¯¹è±¡åœ¨ç¨‹åºå¯åŠ¨åå¯ä»¥è¢«ç«‹å³é‡Šæ”¾ã€‚</p>
<p><strong>ç½‘ä¸Šå¯¹äº<code>main()</code>å‡½æ•°ä¸­çš„<code>@autoreleasepool</code>æœ‰ä¸€ç§è§£é‡Š</strong>ï¼š</p>
<p>åœ¨iOSå·¥ç¨‹çš„<code>main()</code>å‡½æ•°ä¸­æœ‰ä¸€ä¸ª<code>@autoreleasepool</code>ï¼Œè¿™ä¸ª<code>@autoreleasepool</code>è´Ÿè´£åº”ç”¨ç¨‹åºæ‰€æœ‰<code>autoreleasepool</code>å¯¹è±¡çš„é‡Šæ”¾ã€‚</p>
<p><strong>è¿™ä¸ªè§£é‡Šæ˜¯é”™è¯¯çš„</strong></p>
<p>å¦‚æœä½ çš„ç¨‹åºä½¿ç”¨äº†AppKitæˆ–UIKitæ¡†æ¶ï¼Œç³»ç»Ÿåœ¨ä¸»çº¿ç¨‹çš„<code>RunLoop</code>é‡Œæ³¨å†Œäº†ä¸¤ä¸ª<code>Observer</code>ï¼Œå›è°ƒéƒ½æ˜¯<code>_wrapRunLoopWithAutoreleasePoolHandler</code> ï¼Œç¬¬ä¸€ä¸ª<code>Observer</code>çš„çŠ¶æ€æ˜¯<code>activities=0x1</code>ï¼Œç¬¬äºŒä¸ªObserverçš„çŠ¶æ€æ˜¯<code>activities=0xa0</code></p>
<p><code>0x1</code>ä»£è¡¨çš„æ˜¯<code>kCFRunLoopEntry</code>ï¼Œä¸»çº¿ç¨‹çš„<code>runloop</code>å°±ä¼šåœ¨å³å°†è¿›å…¥loopæ—¶ï¼Œ<code>Observe</code>ç›‘å¬çš„äº‹ä»¶ä¸ºEntryï¼Œå…¶å†…éƒ¨å›è°ƒå°±ä¼šè°ƒç”¨<code>_objc_autoreleasePoolPush()</code>åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨é‡Šæ”¾æ± ï¼Œä¼˜å…ˆçº§æœ€é«˜ï¼Œä¿è¯åˆ›å»ºè‡ªåŠ¨é‡Šæ”¾æ± å‘ç”Ÿåœ¨å…¶ä»–æ‰€æœ‰å›è°ƒä¹‹å‰</p>
<p><code>0xa0</code>ä»£è¡¨çš„æ˜¯<code>kCFRunLoopBeforeWaiting</code>å’Œ<code>kCFRunLoopExit</code>ï¼Œåœ¨<code>kCFRunLoopBeforeWaiting</code>äº‹ä»¶æ—¶è°ƒç”¨<code>_objc_autoreleasePoolPop</code>å’Œ<code>_objc_autoreleasePoolPush</code>ï¼Œé‡Šæ”¾æ—§çš„é‡Šæ”¾æ± å’Œå…¶ä¸­çš„èµ„æºå¹¶åˆ›å»ºæ–°çš„è‡ªåŠ¨é‡Šæ”¾æ± ï¼›åœ¨<code>kCFRunLoopExit</code>äº‹ä»¶æ—¶è°ƒç”¨<code>_objc_autoreleasePoolPop</code>æ¥é‡Šæ”¾è‡ªåŠ¨é‡Šæ”¾æ± ï¼ŒåŒæ—¶è¿™ä¸ª<code>Observer</code>çš„ä¼˜å…ˆçº§æœ€ä½ï¼Œä¿è¯å…¶è‡ªåŠ¨é‡Šæ”¾æ± çš„æ“ä½œå‘ç”Ÿåœ¨å…¶ä»–å›è°ƒä¹‹å.</p>
<p>ä¹Ÿå°±æ˜¯è¯´ä¸»çº¿ç¨‹çš„runLoopä¼šåœ¨æ¯æ¬¡äº‹ä»¶å¾ªç¯è¿­ä»£ä¸­åˆ›å»ºå¹¶å¤„ç†<code>@autoreleasepool</code>ï¼Œè€Œmainå‡½æ•°ä¸­çš„<code>@autoreleasepool</code>åªæ˜¯ç®¡ç†ä»–ä½œç”¨åŸŸä¸­çš„å¯¹è±¡ã€‚</p>
<p>ä»¥ä¸Šåœºæ™¯ä¸åµŒå¥—<code>@autoreleasepool</code>æƒ…å†µç±»ä¼¼ã€‚</p>
<h4 id="åµŒå¥—-autoreleasepool"><a href="#åµŒå¥—-autoreleasepool" class="headerlink" title="åµŒå¥—@autoreleasepool"></a>åµŒå¥—<code>@autoreleasepool</code></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">@interface MMPerson : UIButton</span><br><span class="line">@end</span><br><span class="line">@implementation MMPerson</span><br><span class="line">+ (instancetype)person &#123;</span><br><span class="line">    return [[MMPerson alloc] init];</span><br><span class="line">&#125;</span><br><span class="line">- (void)dealloc &#123;</span><br><span class="line">    NSLog(@&quot;MMPerson dealloc&quot;);</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br><span class="line">NS_INLINE void _addAutoReleasePool() &#123;</span><br><span class="line">    @autoreleasepool &#123;</span><br><span class="line">        MMPerson *person &#x3D; [MMPerson person];</span><br><span class="line">        @autoreleasepool &#123;</span><br><span class="line">            MMPerson *person1 &#x3D; person;</span><br><span class="line">            @autoreleasepool &#123;</span><br><span class="line">                MMPerson *person2 &#x3D; person;</span><br><span class="line">                NSLog(@&quot;current count %@&quot;,person);</span><br><span class="line">            &#125;</span><br><span class="line">            NSLog(@&quot;current count 2%@&quot;,person);</span><br><span class="line">        &#125;</span><br><span class="line">        NSLog(@&quot;current count 3%@&quot;,person);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰“å°ç»“æœ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[20:24:37] _addAutoReleasePool [ç¬¬68è¡Œ] ğŸ’• current count 1&lt;MMPerson: 0x7ffe76d22460; baseClass &#x3D; UIButton; frame &#x3D; (0 0; 0 0); opaque &#x3D; NO; layer &#x3D; &lt;CALayer: 0x60000224bce0&gt;&gt;</span><br><span class="line"></span><br><span class="line">[20:24:37] _addAutoReleasePool [ç¬¬70è¡Œ] ğŸ’• current count 2&lt;MMPerson: 0x7ffe76d22460; baseClass &#x3D; UIButton; frame &#x3D; (0 0; 0 0); opaque &#x3D; NO; layer &#x3D; &lt;CALayer: 0x60000224bce0&gt;&gt;</span><br><span class="line"></span><br><span class="line">[20:24:37] _addAutoReleasePool [ç¬¬72è¡Œ] ğŸ’• current count 3&lt;MMPerson: 0x7ffe76d22460; baseClass &#x3D; UIButton; frame &#x3D; (0 0; 0 0); opaque &#x3D; NO; layer &#x3D; &lt;CALayer: 0x60000224bce0&gt;&gt;</span><br><span class="line"></span><br><span class="line">[20:24:37] -[MMPerson dealloc] [ç¬¬22è¡Œ] ğŸ’• MMPerson dealloc</span><br></pre></td></tr></table></figure>

<p>å¯¹äºå¤šå±‚åµŒå¥—è€Œè¨€ï¼Œåœ¨<code>pop</code>çš„æ—¶å€™æ€»ä¼šé‡Šæ”¾åˆ°ä¸Šæ¬¡<code>push</code>çš„ä½ç½®ä¸ºæ­¢ï¼Œä¹Ÿå°±æ˜¯å“¨å…µä½ç½®ï¼Œå¤šå±‚<code>pool</code>å…¶å®å°±æ˜¯æ’å…¥å¤šä¸ªå“¨å…µå¯¹è±¡è€Œå·²ï¼Œç„¶åæ ¹æ®å“¨å…µå¯¹è±¡æ¥è¿›è¡Œé‡Šæ”¾ã€‚</p>
<p><strong>æ³¨æ„ï¼šå¦‚æœå°†ä¸€ä¸ªå¯¹è±¡åŠ å…¥åˆ°å¤šä¸ªpoolä¸­</strong>ï¼Œé‚£ä¹ˆå¯¹è±¡å†…å±‚poolæ‰§è¡Œpopæ“ä½œçš„æ—¶å€™å°±ä¼šè¢«releaseé‡Šæ”¾æ‰ï¼Œé‚£ä¹ˆå½“è°ƒç”¨<code>rootRelease()</code>çš„æ—¶å€™å°±ä¼šæŠ¥é”™ï¼Œå› ä¸ºå½“å‰å¯¹è±¡å·²ç»è¢«é‡Šæ”¾äº†ï¼Œé‚£ä¹ˆä¹Ÿå°±æ˜¯è¯´å¯¹äºæ·»åŠ åˆ°poolä¸­çš„å¯¹è±¡åªèƒ½è¢«é‡Šæ”¾ä¸€æ¬¡ï¼ˆåŒä¸€ä¸ªå¯¹è±¡ä¸èƒ½åå¤<code>autorelease</code>ï¼‰</p>
<h4 id="Autoreleasepoolçš„åº”ç”¨åœºæ™¯"><a href="#Autoreleasepoolçš„åº”ç”¨åœºæ™¯" class="headerlink" title="Autoreleasepoolçš„åº”ç”¨åœºæ™¯"></a>Autoreleasepoolçš„åº”ç”¨åœºæ™¯</h4><p>AppKitå’ŒUIkité€šå¸¸éƒ½ä¼šåœ¨RunLoopæ¯æ¬¡äº‹ä»¶å¾ªç¯è¿­ä»£ä¸­åˆ›å»ºå¹¶å¤„ç†<code>@autoreleasepool</code>ï¼Œå› æ­¤é€šå¸¸æˆ‘ä»¬ä¸å¿…è‡ªå·±åˆ›å»º<code>@autoreleasepool</code>ï¼Œä½†æœ‰äº›æƒ…å†µéœ€è¦æˆ‘ä»¬åˆ›å»º<code>@autoreleasepool</code></p>
<blockquote>
<p>è‹¹æœç»™å‡ºäº†ä¸‰ç§éœ€è¦æ‰‹åŠ¨æ·»åŠ <code>@autoreleasepool</code>çš„åœºæ™¯ï¼š</p>
<ul>
<li><p>å¦‚æœä½ ç¼–å†™çš„åº”ç”¨ç¨‹åºä¸æ˜¯åŸºäºUIæ¡†æ¶çš„ï¼Œæ¯”å¦‚è¯´å‘½ä»¤è¡Œå·¥å…·</p>
</li>
<li><p>å¦‚æœä½ ç¼–å†™çš„å¾ªç¯ä¸­åˆ›å»ºäº†å¤§é‡çš„ä¸´æ—¶å¯¹è±¡ï¼›</p>
<p>ä½ å¯ä»¥åœ¨å¾ªç¯ä¸­ä½¿ç”¨<code>@autoreleasepool</code>åœ¨ä¸‹ä¸€æ¬¡è¿­ä»£ä¹‹å‰å¤„ç†è¿™äº›å¯¹è±¡ï¼Œåœ¨å¾ªç¯ä¸­ä½¿ç”¨<code>@autoreleasepool</code>æœ‰åŠ©äºå‡å°‘åº”ç”¨ç¨‹åºçš„æœ€å¤§å†…å­˜å ç”¨</p>
</li>
<li><p>å¦‚æœä½ åˆ›å»ºäº†è¾…åŠ©çº¿ç¨‹</p>
<p>ä¸€æ—¦çº¿ç¨‹å¼€å§‹æ‰§è¡Œï¼Œå°±å¿…é¡»åˆ›å»ºè‡ªå·±çš„<code>@autoreleasepool</code>ï¼›å¦åˆ™ï¼Œä½ çš„åº”ç”¨ç¨‹åºå°†å­˜åœ¨å†…å­˜æ³„éœ²</p>
</li>
</ul>
</blockquote>
<p>ä¸¾ä¸ªğŸŒ°</p>
<p>forå¾ªç¯ä¸­åˆ›å»ºå¤§é‡ä¸´æ—¶å¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">+ (void)mm_circulateMemory &#123;</span><br><span class="line">    </span><br><span class="line">    for (int i &#x3D; 0; i &lt; 100000000; i ++) &#123;</span><br><span class="line">        NSString * str &#x3D; [NSString stringWithFormat:@&quot;no_AutoReleasePool&quot;];</span><br><span class="line">        NSString *tempstr &#x3D; str;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<img src="/Users/mikasa/Desktop/image_mark/image-20201026171701138.png" alt="image-20201026171701138" style="zoom:50%;" />

<p>forå¾ªç¯ä¸­ä½¿ç”¨<code>@autoreleasepool</code>å¤„ç†ä¸´æ—¶å¯¹è±¡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">+ (void)mm_circulateMemory_autorelease &#123;</span><br><span class="line">    </span><br><span class="line">    for (int i &#x3D; 0; i &lt; 100000000; i ++) &#123;</span><br><span class="line">        @autoreleasepool &#123;</span><br><span class="line">            NSString * str &#x3D; [NSString stringWithFormat:@&quot;have_AutoReleasePool&quot;];</span><br><span class="line">            NSString *tempstr &#x3D; str;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/Users/mikasa/Desktop/image_mark/image-20201026172111999.png" alt="image-20201026172111999"></p>
<p>ä½¿ç”¨<code>@autoreleasepool</code>è¿›è¡Œå¤„ç†ä¸´æ—¶å¯¹è±¡åï¼Œå†…å­˜æ²¡æœ‰æ˜æ˜¾å˜åŒ–ã€‚</p>
<h4 id="çº¿ç¨‹ç§æœ‰æ•°æ®ï¼ˆTSDï¼‰"><a href="#çº¿ç¨‹ç§æœ‰æ•°æ®ï¼ˆTSDï¼‰" class="headerlink" title="çº¿ç¨‹ç§æœ‰æ•°æ®ï¼ˆTSDï¼‰"></a>çº¿ç¨‹ç§æœ‰æ•°æ®ï¼ˆTSDï¼‰</h4><p>â€‹        çº¿ç¨‹ç§æœ‰æ•°æ®ï¼ˆThread-Specific Data æˆ– TSDï¼‰ã€‚</p>
<p>â€‹        åœ¨å•çº¿ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ç”¨åˆ°å…¨å±€å˜é‡æ¥å®ç°å¤šä¸ªå‡½æ•°é—´æ•°æ®å…±äº«ï¼Œç„¶è€Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œç”±äºæ•°æ®ç©ºé—´æ˜¯å…±äº«çš„ï¼Œå…¨å±€å˜é‡ä¹Ÿä¸ºå¤šä¸ªçº¿ç¨‹å¤šå…±äº«ã€‚ä½†æœ‰æ—¶åº”ç”¨ç¨‹åºéœ€è¦â€œçº¿ç¨‹ç§æœ‰çš„å…¨å±€å˜é‡ï¼Œä»…åœ¨å•ä¸ªçº¿ç¨‹æœ‰æ•ˆï¼Œä½†æ˜¯å´å¯ä»¥è·¨å¤šä¸ªå‡½æ•°è®¿é—®â€ï¼ŒPOSIXçº¿ç¨‹åº“ï¼Œå¬è¿‡ç»´æŠ¤ä¸€å®šçš„æ•°æ®ç»“æ„æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œçº¿ç¨‹ç§æœ‰æ•°æ®TSD</p>
<h5 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h5><p>â€‹        é¦–å…ˆåˆ›å»ºå…è®¸æ‰€æœ‰çº¿ç¨‹è®¿é—®çš„å…¨å±€å˜é‡keyï¼Œç„¶ååœ¨ä»»æ„ä¸€ä¸ªçº¿ç¨‹ä¸­è°ƒç”¨pthread_key_createæ¥å£åˆ›å»ºæ‰€æœ‰çº¿ç¨‹æœ‰å¯è§çš„çº¿ç¨‹ç‰¹å®šæ•°æ®çš„é”®å€¼keyï¼Œä½†æ˜¯è¿™ä¸ªé”®å€¼æ‰€æŒ‡å‘çš„çœŸå®æ•°æ®å´æ˜¯ä¸åŒï¼Œå®ƒå¹¶ä¸æŒ‡å‘åŒä¸€å—å†…å­˜ï¼Œè€Œæ˜¯æŒ‡å‘çš„å±äºè‡ªå·±æ•°æ®ï¼Œæ›´æ”¹çº¿ç¨‹0çš„keyä¸­æ‰€æŒ‡å‘çš„æ•°æ®ï¼Œå¹¶ä¸ä¼šå½±å“çº¿ç¨‹1keyä¸­æ‰€æŒ‡å‘çš„æ•°æ®ã€‚</p>
<p>â€‹        å„ä¸ªå­çº¿ç¨‹å¯ä»¥é€šè¿‡pthread_setspecific å’Œ get_specificæ¥å£ä½¿ç”¨è¿™ä¸ªkeyæ¥è·å–å’Œå­˜å‚¨æ•°æ®ï¼Œæ¯ä¸ªçº¿ç¨‹çš„æ“ä½œéƒ½åœ¨è‡ªå·±çš„ç§æœ‰çº¿ç¨‹æ•°æ®ä¸­å®Œæˆã€‚</p>
<h5 id="ç›¸å…³API"><a href="#ç›¸å…³API" class="headerlink" title="ç›¸å…³API"></a>ç›¸å…³API</h5><p><strong>åˆ›å»ºTSD</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">init <span class="title">pthread_key_create</span><span class="params">(<span class="keyword">pthread_key_t</span> *key, <span class="keyword">void</span>(*destr_function)(<span class="keyword">void</span> *))</span></span></span><br></pre></td></tr></table></figure>

<p>ä¸€ä¸ªè¿›ç¨‹è¢«å¯åŠ¨åï¼Œå¤šä¸ªçº¿ç¨‹è¢«åˆ›å»ºï¼Œå½“å…¶ä¸­ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨å‡½æ•°<code>pthread_key_create</code>ï¼ŒTSDåˆ†é…ä¸€é¡¹ç©ºé—´ï¼Œå¹¶å°†å…¶èµ‹å€¼ä¸ºkeyï¼Œç³»ç»Ÿåœ¨keyç»“æ„æ•°æ®ä¸­æ‰¾åˆ°ç¬¬ä¸€ä¸ªæœªä½¿ç”¨çš„å…ƒç´ ï¼Œå°†å…¶ç´¢å¼•è¿”å›ç»™è°ƒç”¨è€…ã€‚</p>
<p>å¦‚æœdestr_functionä¸ä¸ºç©ºï¼Œåœ¨çº¿ç¨‹é€€å‡ºï¼ˆpthread_exit()ï¼‰æ—¶ï¼Œå°†ä»¥keyæ‰€å…³è”çš„æ•°æ®ä¸ºå‚æ•°è°ƒç”¨<code>destr_function()</code>ï¼Œä»¥é‡Šæ”¾åˆ†é…çš„ç¼“å†²åŒºã€‚</p>
<p>æ— è®ºå“ªä¸ªçº¿ç¨‹è°ƒç”¨pthread_key_createè·å–çš„tsdæ•°æ®åŒºéƒ½æ˜¯æ‰€æœ‰çº¿ç¨‹å¯è®¿é—®çš„ï¼Œå„ä¸ªçº¿ç¨‹å¯æ ¹æ®éœ€è¦å­˜å‚¨ä¸åŒçš„æ•°æ®ã€‚</p>
<p><strong>æ³¨é”€TSD</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_key_delete</span><span class="params">(<span class="keyword">pthread_key_t</span> key)</span></span></span><br></pre></td></tr></table></figure>

<p>å‡½æ•°<code>pthread_key_delete</code>å¹¶ä¸ä¼šæ£€æŸ¥å½“å‰æ˜¯å¦æœ‰çº¿ç¨‹æ­£ä½¿ç”¨TSDï¼Œä¹Ÿä¸ä¼šè°ƒæ¸…ç†å‡½æ•°ï¼ˆdestr_functionï¼‰ï¼Œè€Œåªæ˜¯å°†TSDé‡Šæ”¾ä»¥ä¾›ä¸‹ä¸€æ¬¡è°ƒç”¨pthread_key_createä½¿ç”¨ã€‚</p>
<p><strong>è¯»å†™TSD</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_setspecific</span><span class="params">(<span class="keyword">pthreat_key_t</span> key, <span class="keyword">const</span> <span class="keyword">void</span> *pointer)</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pthread_getspecific</span><span class="params">(<span class="keyword">pthread_key_t</span> key)</span></span></span><br></pre></td></tr></table></figure>

<p>å†™å…¥pthread_setspecific()æ—¶ï¼Œå°†pointerçš„å€¼ï¼ˆä¸æ˜¯æ‰€æŒ‡å†…å®¹ï¼‰ä¸keyç›¸å…³è”ï¼Œè€Œç›¸åº”çš„è¯»å‡ºå‡½æ•°åˆ™å°†ä¸keyç›¸å…³è”çš„æ•°æ®è¯»å‡ºæ¥ã€‚</p>
<h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p><a href="https://woniuxiang.space/blog/post/lightime/å¤šçº¿ç¨‹ï¼ˆpthreadsï¼‰" target="_blank" rel="noopener">å¤šçº¿ç¨‹ï¼ˆpthreadï¼‰</a></p>
<p><a href="https://juejin.im/post/6844904094503567368#heading-21" target="_blank" rel="noopener">iOS - èŠèŠ autorelease å’Œ @autoreleasepool</a></p>
<p><a href="https://juejin.im/post/6844903971405086734#heading-13" target="_blank" rel="noopener">Autorelease &amp; AutoreleasePool</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Doris AI</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Doris AI</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v4.2.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme â€“ <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.7.0
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
